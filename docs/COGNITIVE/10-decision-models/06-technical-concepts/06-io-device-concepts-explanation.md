# IO 设备概念与技术名词论证

## 目录

- [目录](#目录)
- [01. 文档定位](#01-文档定位)
- [02. IO 设备拓扑结构](#02-io-设备拓扑结构)
  - [02.1 物理 IO 设备拓扑](#021-物理-io-设备拓扑)
    - [02.1.1 物理 IO 设备拓扑定义](#0211-物理-io-设备拓扑定义)
    - [02.1.2 物理 IO 设备拓扑在技术栈中的作用](#0212-物理-io-设备拓扑在技术栈中的作用)
  - [02.2 逻辑 IO 设备拓扑](#022-逻辑-io-设备拓扑)
    - [02.2.1 逻辑 IO 设备拓扑定义](#0221-逻辑-io-设备拓扑定义)
    - [02.2.2 逻辑 IO 设备拓扑在技术栈中的作用](#0222-逻辑-io-设备拓扑在技术栈中的作用)
  - [02.3 IO 设备拓扑映射](#023-io-设备拓扑映射)
    - [02.3.1 物理 IO 设备拓扑与逻辑 IO 设备拓扑映射](#0231-物理-io-设备拓扑与逻辑-io-设备拓扑映射)
    - [02.3.2 各范式 IO 设备拓扑结构映射](#0232-各范式-io-设备拓扑结构映射)
- [03. IO 设备访问模式](#03-io-设备访问模式)
  - [03.1 直接访问模式](#031-直接访问模式)
    - [03.1.1 直接访问模式定义](#0311-直接访问模式定义)
    - [03.1.2 直接访问模式在各范式中的应用](#0312-直接访问模式在各范式中的应用)
  - [03.2 虚拟化访问模式](#032-虚拟化访问模式)
    - [03.2.1 虚拟化访问模式定义](#0321-虚拟化访问模式定义)
    - [03.2.2 虚拟化访问模式在各范式中的应用](#0322-虚拟化访问模式在各范式中的应用)
  - [03.3 透传访问模式](#033-透传访问模式)
    - [03.3.1 透传访问模式定义](#0331-透传访问模式定义)
    - [03.3.2 透传访问模式在各范式中的应用](#0332-透传访问模式在各范式中的应用)
  - [03.4 IO 设备访问模式映射](#034-io-设备访问模式映射)
    - [03.4.1 IO 设备访问模式对比矩阵](#0341-io-设备访问模式对比矩阵)
    - [03.4.2 各范式 IO 设备访问模式映射](#0342-各范式-io-设备访问模式映射)
- [04. IO 设备通道模型](#04-io-设备通道模型)
  - [04.1 物理 IO 通道](#041-物理-io-通道)
    - [04.1.1 物理 IO 通道定义](#0411-物理-io-通道定义)
    - [04.1.2 物理 IO 通道在技术栈中的作用](#0412-物理-io-通道在技术栈中的作用)
  - [04.2 逻辑 IO 通道](#042-逻辑-io-通道)
    - [04.2.1 逻辑 IO 通道定义](#0421-逻辑-io-通道定义)
    - [04.2.2 逻辑 IO 通道在技术栈中的作用](#0422-逻辑-io-通道在技术栈中的作用)
  - [04.3 IO 设备通道映射](#043-io-设备通道映射)
    - [04.3.1 物理 IO 通道与逻辑 IO 通道映射](#0431-物理-io-通道与逻辑-io-通道映射)
    - [04.3.2 各范式 IO 设备通道模型映射](#0432-各范式-io-设备通道模型映射)
- [05. IO 设备模型](#05-io-设备模型)
  - [05.1 物理 IO 设备](#051-物理-io-设备)
    - [05.1.1 物理 IO 设备定义](#0511-物理-io-设备定义)
    - [05.1.2 物理 IO 设备在技术栈中的作用](#0512-物理-io-设备在技术栈中的作用)
  - [05.2 虚拟 IO 设备](#052-虚拟-io-设备)
    - [05.2.1 虚拟 IO 设备定义](#0521-虚拟-io-设备定义)
    - [05.2.2 虚拟 IO 设备在技术栈中的作用](#0522-虚拟-io-设备在技术栈中的作用)
  - [05.3 逻辑 IO 设备](#053-逻辑-io-设备)
    - [05.3.1 逻辑 IO 设备定义](#0531-逻辑-io-设备定义)
    - [05.3.2 逻辑 IO 设备在技术栈中的作用](#0532-逻辑-io-设备在技术栈中的作用)
  - [05.4 IO 设备模型映射](#054-io-设备模型映射)
    - [05.4.1 IO 设备模型对比矩阵](#0541-io-设备模型对比矩阵)
    - [05.4.2 各范式 IO 设备模型映射](#0542-各范式-io-设备模型映射)
- [06. IO 设备协议栈](#06-io-设备协议栈)
  - [06.1 IO 设备协议栈模型](#061-io-设备协议栈模型)
    - [06.1.1 IO 设备协议栈定义](#0611-io-设备协议栈定义)
    - [06.1.2 IO 设备协议栈在各范式中的映射](#0612-io-设备协议栈在各范式中的映射)
  - [06.2 IO 设备接口标准](#062-io-设备接口标准)
    - [06.2.1 IO 设备接口标准定义](#0621-io-设备接口标准定义)
    - [06.2.2 IO 设备接口标准在各范式中的应用](#0622-io-设备接口标准在各范式中的应用)
  - [06.3 各范式 IO 设备栈对比](#063-各范式-io-设备栈对比)
    - [06.3.1 IO 设备协议栈对比矩阵](#0631-io-设备协议栈对比矩阵)
- [07. 虚拟化 IO 设备架构](#07-虚拟化-io-设备架构)
  - [07.1 虚拟化 IO 设备拓扑](#071-虚拟化-io-设备拓扑)
    - [07.1.1 虚拟化 IO 设备拓扑结构](#0711-虚拟化-io-设备拓扑结构)
  - [07.2 虚拟化 IO 设备模型](#072-虚拟化-io-设备模型)
    - [07.2.1 虚拟化 IO 设备架构](#0721-虚拟化-io-设备架构)
  - [07.3 虚拟化 IO 设备隔离](#073-虚拟化-io-设备隔离)
    - [07.3.1 虚拟化 IO 设备隔离机制](#0731-虚拟化-io-设备隔离机制)
- [08. 容器化 IO 设备架构](#08-容器化-io-设备架构)
  - [08.1 容器化 IO 设备拓扑](#081-容器化-io-设备拓扑)
    - [08.1.1 容器化 IO 设备拓扑结构](#0811-容器化-io-设备拓扑结构)
  - [08.2 容器化 IO 设备模型](#082-容器化-io-设备模型)
    - [08.2.1 容器化 IO 设备架构](#0821-容器化-io-设备架构)
  - [08.3 容器化 IO 设备隔离](#083-容器化-io-设备隔离)
    - [08.3.1 容器化 IO 设备隔离机制](#0831-容器化-io-设备隔离机制)
- [09. 沙盒化 IO 设备架构](#09-沙盒化-io-设备架构)
  - [09.1 沙盒化 IO 设备拓扑](#091-沙盒化-io-设备拓扑)
    - [09.1.1 沙盒化 IO 设备拓扑结构](#0911-沙盒化-io-设备拓扑结构)
  - [09.2 沙盒化 IO 设备模型](#092-沙盒化-io-设备模型)
    - [09.2.1 沙盒化 IO 设备架构](#0921-沙盒化-io-设备架构)
  - [09.3 沙盒化 IO 设备隔离](#093-沙盒化-io-设备隔离)
    - [09.3.1 沙盒化 IO 设备隔离机制](#0931-沙盒化-io-设备隔离机制)
- [10. IO 设备架构对比矩阵](#10-io-设备架构对比矩阵)
  - [10.1 IO 设备拓扑对比矩阵](#101-io-设备拓扑对比矩阵)
  - [10.2 IO 设备访问模式对比矩阵](#102-io-设备访问模式对比矩阵)
  - [10.3 IO 设备通道模型对比矩阵](#103-io-设备通道模型对比矩阵)
  - [10.4 IO 设备模型对比矩阵](#104-io-设备模型对比矩阵)
  - [10.5 IO 设备协议栈对比矩阵](#105-io-设备协议栈对比矩阵)
- [11. 参考](#11-参考)

---

## 01. 文档定位

本文档系统化解释**虚拟化、容器化、沙盒化**的 IO 设备概念、拓扑结构、访问模式、通
道模型、设备模型，提供详细的 IO 设备架构论证和技术名词对应关系。

**核心内容**：

1. **IO 设备拓扑结构**：物理 IO 设备拓扑 vs 逻辑 IO 设备拓扑的映射关系
2. **IO 设备访问模式**：直接访问、虚拟化访问、透传访问的实现机制
3. **IO 设备通道模型**：物理 IO 通道 vs 逻辑 IO 通道的抽象关系
4. **IO 设备模型**：物理 IO 设备、虚拟 IO 设备、逻辑 IO 设备的技术实现
5. **IO 设备协议栈**：各范式在 IO 设备协议栈中的位置和作用
6. **IO 设备架构对比**：虚拟化、容器化、沙盒化的 IO 设备架构全面对比

**与其他文档的关系**：

- **网络概念论证**：网络作为 IO 设备的一种实现（网卡）
- **存储概念论证**：存储作为 IO 设备的一种实现（存储设备）
- **GPU/IO 设备概念论证**：GPU/IO 设备的综合讨论
- **本文档**：专门的 IO 设备概念论证，更详细和系统化

---

## 02. IO 设备拓扑结构

### 02.1 物理 IO 设备拓扑

#### 02.1.1 物理 IO 设备拓扑定义

**物理 IO 设备拓扑（Physical IO Device Topology）定义**：

物理 IO 设备拓扑是指物理 IO 设备（网络设备、存储设备、USB 设备、串口设备、输入设
备等）在硬件上的实际布局和连接关系。

**物理 IO 设备拓扑类型**：

1. **PCIe 设备拓扑**：

   - **结构**：通过 PCIe 总线连接的设备（网卡、存储控制器、GPU、扩展卡）
   - **特征**：点对点连接、高带宽（PCIe 3.0/4.0）、低延迟、可热插拔（部分）
   - **应用**：高性能设备连接、服务器扩展

2. **USB 设备拓扑**：

   - **结构**：通过 USB 总线连接的设备（USB 设备树形拓扑）
   - **特征**：树形拓扑、热插拔、即插即用、带宽共享（USB 2.0/3.0/3.1）
   - **应用**：外设连接、移动设备、即插即用设备

3. **串口设备拓扑**：

   - **结构**：通过串口（Serial Port）连接的设备（UART、RS-232、RS-485）
   - **特征**：串行通信、点对点连接、简单协议
   - **应用**：调试接口、工业设备、嵌入式系统

4. **输入设备拓扑**：

   - **结构**：通过 PS/2、USB 等连接的输入设备（键盘、鼠标）
   - **特征**：人机交互、低延迟、实时响应
   - **应用**：用户输入、交互设备

#### 02.1.2 物理 IO 设备拓扑在技术栈中的作用

**物理 IO 设备拓扑映射**：

```text
物理 IO 设备拓扑结构:

PCIe 设备拓扑:
├── PCIe Root Complex
│   ├── PCIe Bus 0
│   │   ├── Network Card (PCIe 3.0 x8)
│   │   │   ├── Ethernet 网卡 (1/10/25/100 Gbps)
│   │   │   └── InfiniBand 网卡 (200 Gbps+)
│   │   ├── Storage Controller (PCIe 3.0 x4)
│   │   │   ├── NVMe SSD Controller
│   │   │   └── SATA Controller
│   │   ├── GPU Card (PCIe 3.0 x16)
│   │   └── Extension Card
│   └── PCIe Bus 1
│       ├── USB Controller (PCIe 2.0 x1)
│       └── Other Controllers
└── PCIe 协议
    ├── 点对点连接
    ├── 高带宽（PCIe 3.0: 8 GT/s, PCIe 4.0: 16 GT/s）
    └── 低延迟（~1μs）

USB 设备拓扑:
├── USB Root Hub
│   ├── USB 2.0 Hub
│   │   ├── USB Device 0 (键盘)
│   │   ├── USB Device 1 (鼠标)
│   │   └── USB Device 2 (U盘)
│   ├── USB 3.0 Hub
│   │   ├── USB Device 3 (存储设备)
│   │   ├── USB Device 4 (摄像头)
│   │   └── USB Device 5 (打印机)
│   └── USB 3.1 Hub
│       └── USB-C 设备
└── USB 协议
    ├── 树形拓扑
    ├── 热插拔支持
    └── 带宽共享
    ├── USB 2.0: 480 Mbps
    ├── USB 3.0: 5 Gbps
    └── USB 3.1: 10 Gbps

串口设备拓扑:
├── UART (Universal Asynchronous Receiver-Transmitter)
│   ├── Serial Port 0 (COM1)
│   │   ├── RS-232 设备
│   │   └── 调试串口
│   ├── Serial Port 1 (COM2)
│   │   └── RS-485 设备
│   └── Serial Port 2 (COM3)
│       └── 工业设备
└── 串口协议
    ├── 点对点连接
    ├── 串行通信
    └── 简单协议
```

**物理 IO 设备拓扑特性**：

| 特性     | PCIe 设备     | USB 设备           | 串口设备         | 输入设备     |
| -------- | ------------- | ------------------ | ---------------- | ------------ |
| 连接方式 | 点对点        | 树形拓扑           | 点对点           | USB/PS2      |
| 带宽     | 高（32 GB/s） | 中（5/10/20 Gbps） | 低（115.2 Kbps） | 低（1 Mbps） |
| 延迟     | 低（~1μs）    | 中（~10μs）        | 中（~ms）        | 低（~ms）    |
| 热插拔   | 部分支持      | 是                 | 否               | 是（USB）    |
| 即插即用 | 部分支持      | 是                 | 否               | 是（USB）    |
| 典型应用 | 服务器设备    | 外设               | 调试、工业设备   | 人机交互     |

### 02.2 逻辑 IO 设备拓扑

#### 02.2.1 逻辑 IO 设备拓扑定义

**逻辑 IO 设备拓扑（Logical IO Device Topology）定义**：

逻辑 IO 设备拓扑是指操作系统或虚拟化层对 IO 设备的逻辑抽象和映射关系，包括设备节
点、设备驱动、设备文件系统等。

**逻辑 IO 设备拓扑类型**：

1. **设备节点抽象**：

   - **结构**：操作系统将 IO 设备抽象为设备节点（如
     `/dev/sda`、`/dev/eth0`、`/dev/ttyUSB0`）
   - **特征**：设备文件、设备驱动、设备管理
   - **应用**：设备访问、设备管理、设备控制

2. **设备驱动抽象**：

   - **结构**：设备驱动程序管理设备（字符设备驱动、块设备驱动、网络设备驱动）
   - **特征**：驱动加载、驱动卸载、驱动接口、中断处理
   - **应用**：设备控制、数据传输、设备初始化

3. **设备文件系统抽象**：

   - **sysfs（/sys）**：系统设备信息文件系统
   - **procfs（/proc）**：进程和设备信息文件系统
   - **devfs（/dev）**：设备文件系统
   - **特征**：设备信息查询、设备状态监控、设备配置

#### 02.2.2 逻辑 IO 设备拓扑在技术栈中的作用

**逻辑 IO 设备拓扑映射**：

```text
逻辑 IO 设备拓扑结构:

操作系统逻辑拓扑:
├── 设备节点 (/dev)
│   ├── 块设备节点
│   │   ├── /dev/sda (SATA 硬盘)
│   │   ├── /dev/nvme0 (NVMe SSD)
│   │   └── /dev/mmcblk0 (SD 卡)
│   ├── 字符设备节点
│   │   ├── /dev/ttyUSB0 (USB 串口)
│   │   ├── /dev/ttyS0 (串口)
│   │   └── /dev/input/mouse0 (鼠标)
│   ├── 网络设备节点
│   │   ├── /dev/net/tun (TUN 设备)
│   │   └── /dev/net/tap (TAP 设备)
│   └── 特殊设备节点
│       ├── /dev/null (空设备)
│       └── /dev/zero (零设备)
├── 设备驱动
│   ├── 块设备驱动 (block driver)
│   │   ├── SATA 驱动
│   │   ├── NVMe 驱动
│   │   └── USB 存储驱动
│   ├── 字符设备驱动 (char driver)
│   │   ├── 串口驱动
│   │   └── 输入设备驱动
│   └── 网络设备驱动 (net driver)
│       ├── Ethernet 驱动
│       └── InfiniBand 驱动
└── 设备文件系统
    ├── /sys (sysfs)
    │   ├── /sys/devices (设备信息)
    │   ├── /sys/class (设备分类)
    │   └── /sys/bus (总线信息)
    └── /proc (procfs)
        ├── /proc/devices (设备列表)
        └── /proc/interrupts (中断信息)

虚拟化逻辑拓扑:
├── 虚拟设备抽象
│   ├── vNIC (虚拟网卡)
│   │   ├── VirtIO Net
│   │   ├── E1000 模拟
│   │   └── vmxnet3
│   ├── vDisk (虚拟磁盘)
│   │   ├── VirtIO Block
│   │   ├── IDE 模拟
│   │   └── SCSI 模拟
│   ├── vUSB (虚拟 USB)
│   │   ├── USB 透传
│   │   └── USB 模拟
│   └── vSerial (虚拟串口)
│       └── 串口重定向
├── 设备模拟
│   ├── QEMU 设备模拟
│   │   ├── 软件设备模拟
│   │   └── 硬件设备仿真
│   └── VirtIO 设备
│       ├── 半虚拟化设备
│       └── 高性能虚拟设备
└── 设备透传
    ├── PCIe 透传 (PCIe Passthrough)
    ├── SR-IOV (单根 IO 虚拟化)
    └── USB 透传 (USB Passthrough)
```

### 02.3 IO 设备拓扑映射

#### 02.3.1 物理 IO 设备拓扑与逻辑 IO 设备拓扑映射

**映射关系**：

```text
物理 IO 设备拓扑 → 逻辑 IO 设备拓扑映射:

物理层:
├── 物理网卡 (PCIe)
│   ├── Ethernet 网卡
│   └── 以太网接口
├── 物理存储设备 (SATA)
│   ├── HDD (机械硬盘)
│   └── SSD (固态硬盘)
├── USB 设备 (USB)
│   ├── USB 外设
│   └── USB 存储设备
└── 串口设备 (UART)
    └── 串口接口

逻辑层:
├── 设备节点映射
│   ├── /dev/eth0 → 物理网卡
│   ├── /dev/sda → 物理存储设备
│   ├── /dev/ttyUSB0 → USB 设备
│   └── /dev/ttyS0 → 串口设备
├── 设备驱动映射
│   ├── 网络驱动 → 物理网卡
│   ├── 存储驱动 → 物理存储设备
│   ├── USB 驱动 → USB 设备
│   └── 串口驱动 → 串口设备
└── 设备文件系统映射
    ├── /sys/devices/pci0000:00 → PCIe 设备
    ├── /sys/devices/pci0000:00/0000:00:01.0 → 网卡
    └── /sys/devices/pci0000:00/0000:00:02.0 → 存储控制器
```

#### 02.3.2 各范式 IO 设备拓扑结构映射

**各范式 IO 设备拓扑映射矩阵**：

| 维度                 | 虚拟化                     | 容器化                   | 沙盒化                  |
| -------------------- | -------------------------- | ------------------------ | ----------------------- |
| **物理 IO 设备拓扑** | 直接访问或透传             | 直接访问                 | 间接访问（通过 Host）   |
| **逻辑 IO 设备拓扑** | Guest OS 独立 IO 设备抽象  | Host OS 共享 IO 设备抽象 | Runtime IO 抽象（有限） |
| **IO 设备抽象**      | vNIC、vDisk、vUSB、vSerial | Host OS 设备节点         | WASI 文件系统、网络 API |
| **IO 设备驱动**      | Guest OS 设备驱动          | Host OS 设备驱动         | Runtime IO API（有限）  |
| **设备透传**         | 支持（SR-IOV、PCIe 透传）  | 有限（设备绑定）         | 不支持                  |
| **设备模拟**         | 支持（QEMU、VirtIO）       | 不支持                   | 不支持                  |
| **IO 性能**          | 中等（虚拟化开销）         | 高（直接访问）           | 低（API 抽象开销）      |
| **设备隔离**         | 硬件级隔离（透传）         | 逻辑隔离（命名空间）     | 应用级隔离（API 限制）  |
| **设备共享**         | 支持（虚拟设备共享）       | 支持（容器共享设备）     | 不支持（API 限制）      |
| **热插拔支持**       | 支持（USB 透传）           | 支持（Host OS 管理）     | 有限（Runtime API）     |

---

## 03. IO 设备访问模式

### 03.1 直接访问模式

#### 03.1.1 直接访问模式定义

**直接访问模式（Direct Access Mode）定义**：

直接访问模式是指应用程序或容器直接访问物理 IO 设备，无需通过虚拟化层或中间抽象层
，设备驱动直接管理物理硬件。

**直接访问模式特征**：

1. **设备直接映射**：

   - 设备节点直接映射到物理设备（如 `/dev/sda` → 物理磁盘）
   - 设备驱动直接控制硬件（如 Ethernet 驱动 → 物理网卡）
   - 无中间抽象层，低延迟、高性能

2. **操作系统级访问**：

   - 通过操作系统设备驱动访问
   - 使用系统调用（`open()`、`read()`、`write()`、`ioctl()`）
   - 支持中断处理、DMA 传输

3. **设备所有权**：

   - 设备通常被单个进程或容器独占
   - 需要设备权限管理（设备绑定、设备隔离）
   - 支持设备热插拔（部分设备）

#### 03.1.2 直接访问模式在各范式中的应用

**容器化中的直接访问模式**：

```text
容器化直接访问模式:

容器直接访问物理 IO 设备:
├── 网络设备直接访问
│   ├── 容器绑定物理网卡 (--network host)
│   │   ├── /dev/net/tun (TUN 设备)
│   │   ├── /dev/net/tap (TAP 设备)
│   │   └── 物理网卡 eth0
│   └── 容器使用 Host 网络命名空间
│       └── 共享 Host OS 网络栈
├── 存储设备直接访问
│   ├── 容器绑定物理磁盘 (--device)
│   │   ├── /dev/sda → 容器内 /dev/sda
│   │   ├── /dev/nvme0 → 容器内 /dev/nvme0
│   │   └── 直接访问物理存储
│   └── 容器绑定设备卷
│       └── 设备块设备映射
├── USB 设备直接访问
│   ├── 容器绑定 USB 设备 (--device)
│   │   ├── /dev/ttyUSB0 → 容器内 /dev/ttyUSB0
│   │   ├── /dev/bus/usb → 容器内 /dev/bus/usb
│   │   └── USB 设备热插拔支持
│   └── USB 设备透传到容器
│       └── 容器独占 USB 设备
└── 串口设备直接访问
    ├── 容器绑定串口设备 (--device)
    │   ├── /dev/ttyS0 → 容器内 /dev/ttyS0
    │   └── 串口设备直接访问
    └── 串口设备透传到容器

特征:
├── 高性能: 无虚拟化开销
├── 低延迟: 直接访问物理硬件
├── 设备隔离: 通过命名空间和设备绑定
└── 设备共享: 支持设备共享（部分设备）
```

**沙盒化中的直接访问模式**：

```text
沙盒化直接访问模式（有限）:

Wasm 运行时间接访问 Host IO 设备:
├── 网络设备访问
│   ├── WASI Socket API (WASI 2.0)
│   │   ├── 通过 Runtime 访问网络
│   │   ├── TCP/UDP Socket 支持
│   │   └── 网络命名空间隔离
│   └── Host OS 网络栈
│       └── Runtime 转发网络请求
├── 文件系统访问
│   ├── WASI Filesystem API
│   │   ├── 通过 Runtime 访问文件系统
│   │   ├── 目录映射（Directory Mapping）
│   │   └── 文件访问抽象
│   └── Host OS 文件系统
│       └── Runtime 转发文件操作
├── 串口设备访问（有限）
│   ├── WASI 标准输入输出
│   │   ├── stdin/stdout/stderr
│   │   └── 控制台重定向
│   └── Host OS 串口设备
│       └── Runtime 转发串口操作
└── USB 设备访问（不支持）
    └── WASI 不提供 USB 设备 API

特征:
├── API 抽象: 通过 WASI API 访问
├── 受限访问: 仅支持标准 API
├── 高隔离: Runtime 层隔离
└── 低性能: API 抽象开销
```

### 03.2 虚拟化访问模式

#### 03.2.1 虚拟化访问模式定义

**虚拟化访问模式（Virtualized Access Mode）定义**：

虚拟化访问模式是指虚拟机通过虚拟 IO 设备（vNIC、vDisk、vUSB 等）访问物理 IO 设备
，Hypervisor 负责虚拟设备与物理设备的映射和管理。

**虚拟化访问模式特征**：

1. **虚拟设备抽象**：

   - Hypervisor 创建虚拟设备（vNIC、vDisk、vUSB、vSerial）
   - Guest OS 看到的是虚拟设备，而非物理设备
   - 支持设备模拟和半虚拟化（VirtIO）

2. **设备映射管理**：

   - Hypervisor 管理虚拟设备到物理设备的映射
   - 支持多个虚拟机共享物理设备（通过虚拟化）
   - 设备资源分配和调度

3. **性能隔离与共享**：

   - 虚拟化层提供设备隔离和资源分配
   - 支持设备 QoS（服务质量）控制
   - 设备资源共享和性能隔离

#### 03.2.2 虚拟化访问模式在各范式中的应用

**虚拟化中的虚拟化访问模式**：

```text
虚拟化虚拟设备访问模式:

虚拟机通过虚拟设备访问物理设备:
├── 虚拟网络设备 (vNIC)
│   ├── VirtIO Net
│   │   ├── 半虚拟化网卡
│   │   ├── 高性能虚拟网卡
│   │   └── Guest OS VirtIO 驱动
│   ├── E1000 模拟
│   │   ├── Intel 82540EM 网卡模拟
│   │   ├── Guest OS 标准驱动
│   │   └── 完全软件模拟
│   ├── vmxnet3
│   │   ├── VMware 高性能网卡
│   │   └── Guest OS vmxnet3 驱动
│   └── Hypervisor 网络映射
│       ├── vNIC → 物理网卡或虚拟交换机
│       └── 网络隔离和 QoS
├── 虚拟存储设备 (vDisk)
│   ├── VirtIO Block
│   │   ├── 半虚拟化块设备
│   │   ├── 高性能虚拟磁盘
│   │   └── Guest OS VirtIO 驱动
│   ├── IDE 模拟
│   │   ├── IDE 控制器模拟
│   │   ├── Guest OS 标准驱动
│   │   └── 完全软件模拟
│   ├── SCSI 模拟
│   │   ├── SCSI 控制器模拟
│   │   ├── Guest OS 标准驱动
│   │   └── 高性能模拟
│   └── Hypervisor 存储映射
│       ├── vDisk → 物理存储或存储池
│       └── 存储隔离和 QoS
├── 虚拟 USB 设备 (vUSB)
│   ├── USB 模拟
│   │   ├── USB 控制器模拟
│   │   ├── USB 设备模拟
│   │   └── Guest OS USB 驱动
│   ├── USB 透传（部分）
│   │   ├── USB 设备透传到虚拟机
│   │   └── 直接访问物理 USB 设备
│   └── Hypervisor USB 映射
│       ├── vUSB → 物理 USB 设备
│       └── USB 设备隔离
└── 虚拟串口设备 (vSerial)
    ├── 串口模拟
    │   ├── UART 控制器模拟
    │   └── Guest OS 串口驱动
    ├── 串口重定向
    │   ├── 串口输出重定向到文件/网络
    │   └── 串口调试和控制
    └── Hypervisor 串口映射
        └── vSerial → Host OS 串口

特征:
├── 设备虚拟化: 虚拟设备抽象
├── 设备隔离: 硬件级隔离
├── 设备共享: 支持虚拟设备共享
└── 中等性能: 虚拟化开销
```

### 03.3 透传访问模式

#### 03.3.1 透传访问模式定义

**透传访问模式（Passthrough Access Mode）定义**：

透传访问模式是指虚拟机通过设备透传技术（PCIe Passthrough、SR-IOV、USB
Passthrough）直接访问物理 IO 设备，绕过 Hypervisor 的设备虚拟化层，获得接近原生
性能。

**透传访问模式特征**：

1. **设备直接映射**：

   - 物理设备直接映射到虚拟机（Guest OS 直接访问物理设备）
   - Hypervisor 仅负责设备初始化和管理，不参与数据传输
   - 支持 DMA（直接内存访问）和中断直通

2. **性能优化**：

   - 绕过虚拟化层，减少虚拟化开销
   - 接近原生性能（95%+ 原生性能）
   - 适合高性能 IO 密集型应用

3. **设备独占**：

   - 物理设备通常被单个虚拟机独占
   - 不支持设备在多个虚拟机间共享
   - 设备管理复杂度较高

#### 03.3.2 透传访问模式在各范式中的应用

**虚拟化中的透传访问模式**：

```text
虚拟化设备透传访问模式:

虚拟机直接访问物理设备:
├── PCIe 透传 (PCIe Passthrough)
│   ├── 物理设备直接映射到虚拟机
│   │   ├── 网卡透传
│   │   │   ├── 物理网卡 → Guest OS
│   │   │   ├── 直接访问物理网卡
│   │   │   └── 高性能网络（接近原生）
│   │   ├── 存储控制器透传
│   │   │   ├── NVMe SSD 控制器 → Guest OS
│   │   │   ├── 直接访问物理存储
│   │   │   └── 高性能存储（接近原生）
│   │   └── GPU 透传
│   │       ├── 物理 GPU → Guest OS
│   │       └── 直接访问物理 GPU
│   ├── IOMMU/VT-d 支持
│   │   ├── Intel VT-d / AMD-Vi
│   │   ├── DMA 隔离和保护
│   │   └── 设备直接内存访问
│   └── 设备独占
│       ├── 设备被单个虚拟机独占
│       └── 不支持设备共享
├── SR-IOV (Single Root I/O Virtualization)
│   ├── 硬件级设备虚拟化
│   │   ├── 物理设备虚拟化为多个虚拟功能（VF）
│   │   ├── 每个 VF 可透传给不同虚拟机
│   │   └── 支持设备在多个虚拟机间共享
│   ├── 网卡 SR-IOV
│   │   ├── 物理网卡 → 多个虚拟网卡（VF）
│   │   ├── 每个 VF 透传给虚拟机
│   │   └── 高性能网络（接近原生）
│   ├── 存储控制器 SR-IOV
│   │   ├── NVMe SR-IOV
│   │   └── 存储设备虚拟化
│   └── 设备共享和隔离
│       ├── 多个虚拟机共享物理设备
│       └── 硬件级隔离
└── USB 透传 (USB Passthrough)
    ├── USB 设备透传到虚拟机
    │   ├── 物理 USB 设备 → Guest OS
    │   ├── 直接访问物理 USB 设备
    │   └── USB 设备热插拔支持
    ├── USB 设备独占
    │   ├── 设备被单个虚拟机独占
    │   └── 不支持设备共享
    └── USB 设备管理
        ├── USB 设备动态分配
        └── USB 设备状态监控

特征:
├── 高性能: 接近原生性能（95%+）
├── 设备独占: 设备被单个虚拟机独占（SR-IOV 除外）
├── 设备隔离: 硬件级隔离（IOMMU）
└── 管理复杂: 设备管理复杂度较高
```

**容器化中的透传访问模式（有限）**：

```text
容器化设备透传（有限支持）:

容器直接绑定物理设备:
├── 设备绑定 (Device Binding)
│   ├── 容器绑定物理设备 (--device)
│   │   ├── /dev/sda → 容器内设备
│   │   ├── /dev/ttyUSB0 → 容器内设备
│   │   └── 设备权限映射
│   └── 设备节点绑定
│       └── 容器直接访问设备节点
├── 网络设备绑定
│   ├── 容器绑定物理网卡 (--network host)
│   │   ├── 容器使用 Host 网络命名空间
│   │   └── 直接访问物理网卡
│   └── 网络设备共享
│       └── 多个容器共享物理网卡
└── 设备访问限制
    ├── 设备权限控制（cgroup）
    ├── 设备命名空间隔离
    └── 设备访问审计

特征:
├── 直接访问: 容器直接访问物理设备
├── 设备共享: 支持设备共享（多个容器）
├── 逻辑隔离: 通过命名空间隔离
└── 性能: 高（直接访问）
```

### 03.4 IO 设备访问模式映射

#### 03.4.1 IO 设备访问模式对比矩阵

**IO 设备访问模式对比矩阵**：

| 维度         | 直接访问模式               | 虚拟化访问模式                             | 透传访问模式                    |
| ------------ | -------------------------- | ------------------------------------------ | ------------------------------- |
| **访问路径** | 应用 → 设备驱动 → 物理设备 | Guest OS → vDevice → Hypervisor → 物理设备 | Guest OS → 物理设备（直接）     |
| **设备抽象** | 无（直接访问）             | 虚拟设备（vNIC/vDisk/vUSB）                | 无（设备透传）                  |
| **性能开销** | 无（原生性能）             | 中等（虚拟化开销）                         | 极低（接近原生性能，95%+）      |
| **设备隔离** | 逻辑隔离（容器）           | 硬件级隔离（虚拟机）                       | 硬件级隔离（IOMMU）             |
| **设备共享** | 支持（容器共享设备）       | 支持（虚拟设备共享）                       | 不支持（设备独占，SR-IOV 除外） |
| **适用场景** | 容器化、高性能 IO          | 虚拟化、设备虚拟化                         | 虚拟化、高性能 IO               |
| **设备管理** | 简单（设备绑定）           | 中等（虚拟设备管理）                       | 复杂（设备透传配置）            |
| **热插拔**   | 支持（Host OS 管理）       | 支持（虚拟设备热插拔）                     | 支持（USB 透传）                |
| **设备类型** | 所有 IO 设备               | 网络、存储、USB、串口                      | PCIe 设备、USB 设备             |

#### 03.4.2 各范式 IO 设备访问模式映射

**各范式 IO 设备访问模式映射矩阵**：

| 维度             | 虚拟化                     | 容器化           | 沙盒化              |
| ---------------- | -------------------------- | ---------------- | ------------------- |
| **直接访问**     | 不支持（需透传）           | 支持（设备绑定） | 有限（WASI API）    |
| **虚拟化访问**   | 支持（vNIC/vDisk/vUSB）    | 不支持           | 不支持              |
| **透传访问**     | 支持（PCIe/SR-IOV/USB）    | 有限（设备绑定） | 不支持              |
| **访问模式组合** | 虚拟化访问 + 透传访问      | 直接访问         | 直接访问（受限）    |
| **设备抽象层**   | 虚拟设备层                 | 无（直接访问）   | WASI API 层         |
| **性能开销**     | 中等（虚拟化）或低（透传） | 低（直接访问）   | 中等（API 抽象）    |
| **设备隔离**     | 硬件级隔离                 | 逻辑隔离         | 应用级隔离          |
| **设备共享**     | 支持（虚拟设备共享）       | 支持（设备共享） | 不支持（API 限制）  |
| **典型应用**     | 企业虚拟化、多云部署       | 容器编排、微服务 | Wasm 应用、边缘计算 |

---

## 04. IO 设备通道模型

### 04.1 物理 IO 通道

#### 04.1.1 物理 IO 通道定义

**物理 IO 通道（Physical IO Channel）定义**：

物理 IO 通道是指 CPU 与 IO 设备之间的物理连接和数据传输通道，包括 PCIe 总线、USB
总线、SATA/SAS 通道、串口通道等。

**物理 IO 通道类型**：

1. **PCIe 总线通道**：

   - **结构**：PCIe 3.0/4.0 总线（点对点连接、高带宽、低延迟）
   - **特征**：双向通信、串行传输、高速数据传输（32 GB/s PCIe 4.0 x16）
   - **应用**：高性能设备连接（网卡、存储控制器、GPU、扩展卡）

2. **USB 总线通道**：

   - **结构**：USB 2.0/3.0/3.1 总线（树形拓扑、热插拔、即插即用）
   - **特征**：双向通信、带宽共享、热插拔支持（USB 3.1: 10 Gbps）
   - **应用**：外设连接（USB 存储、USB 设备、移动设备）

3. **SATA/SAS 通道**：

   - **结构**：SATA 3.0/SAS 通道（串行传输、点对点连接）
   - **特征**：单向/双向通信、存储设备连接（SATA 3.0: 6 Gbps）
   - **应用**：存储设备连接（HDD、SSD）

4. **串口通道**：

   - **结构**：UART、RS-232、RS-485（串行通信、点对点连接）
   - **特征**：单向/双向通信、简单协议、低带宽（115.2 Kbps）
   - **应用**：调试接口、工业设备、嵌入式系统

#### 04.1.2 物理 IO 通道在技术栈中的作用

**物理 IO 通道映射**：

```text
物理 IO 通道结构:

PCIe 总线通道:
├── PCIe Root Complex
│   ├── PCIe Bus 0
│   │   ├── PCIe 设备 0 (x16)
│   │   │   ├── 带宽: 32 GB/s (PCIe 4.0 x16)
│   │   │   ├── 延迟: ~1μs
│   │   │   └── 点对点连接
│   │   ├── PCIe 设备 1 (x8)
│   │   │   ├── 带宽: 16 GB/s (PCIe 4.0 x8)
│   │   │   └── 点对点连接
│   │   └── PCIe 设备 2 (x4)
│   │       ├── 带宽: 8 GB/s (PCIe 4.0 x4)
│   │       └── 点对点连接
│   └── PCIe Bus 1
│       └── PCIe 设备 3 (x1)
│           ├── 带宽: 2 GB/s (PCIe 4.0 x1)
│           └── 点对点连接
└── PCIe 协议
    ├── 点对点连接
    ├── 串行传输
    └── 高速数据传输

USB 总线通道:
├── USB Root Hub
│   ├── USB 3.0 Hub
│   │   ├── USB Device 0
│   │   │   ├── 带宽: 5 Gbps (USB 3.0)
│   │   │   └── 热插拔支持
│   │   ├── USB Device 1
│   │   │   ├── 带宽: 5 Gbps (USB 3.0)
│   │   │   └── 热插拔支持
│   │   └── USB Device 2
│   │       ├── 带宽: 共享 5 Gbps
│   │       └── 热插拔支持
│   ├── USB 2.0 Hub
│   │   ├── USB Device 3
│   │   │   ├── 带宽: 480 Mbps (USB 2.0)
│   │   │   └── 热插拔支持
│   │   └── USB Device 4
│   │       ├── 带宽: 共享 480 Mbps
│   │       └── 热插拔支持
│   └── USB 3.1 Hub
│       └── USB Device 5
│           ├── 带宽: 10 Gbps (USB 3.1)
│           └── 热插拔支持
└── USB 协议
    ├── 树形拓扑
    ├── 带宽共享
    └── 热插拔支持

SATA/SAS 通道:
├── SATA 3.0 通道
│   ├── SATA Device 0
│   │   ├── 带宽: 6 Gbps
│   │   ├── 点对点连接
│   │   └── 存储设备连接
│   └── SATA Device 1
│       ├── 带宽: 6 Gbps
│       └── 点对点连接
├── SAS 通道
│   ├── SAS Device 0
│   │   ├── 带宽: 12 Gbps (SAS 3.0)
│   │   └── 存储设备连接
│   └── SAS Device 1
│       ├── 带宽: 12 Gbps
│       └── 存储设备连接
└── SATA/SAS 协议
    ├── 串行传输
    └── 点对点连接

串口通道:
├── UART 通道
│   ├── Serial Port 0 (COM1)
│   │   ├── 波特率: 115200 bps
│   │   ├── 点对点连接
│   │   └── 串行通信
│   ├── Serial Port 1 (COM2)
│   │   ├── 波特率: 115200 bps
│   │   └── 点对点连接
│   └── Serial Port 2 (COM3)
│       ├── 波特率: 115200 bps
│       └── 点对点连接
└── 串口协议
    ├── 串行通信
    └── 简单协议
```

**物理 IO 通道特性**：

| 特性         | PCIe 总线     | USB 总线           | SATA/SAS 通道   | 串口通道         |
| ------------ | ------------- | ------------------ | --------------- | ---------------- |
| 连接方式     | 点对点        | 树形拓扑           | 点对点          | 点对点           |
| 带宽         | 高（32 GB/s） | 中（5/10/20 Gbps） | 中（6/12 Gbps） | 低（115.2 Kbps） |
| 延迟         | 低（~1μs）    | 中（~10μs）        | 中（~ms）       | 中（~ms）        |
| 热插拔       | 部分支持      | 是                 | 否              | 否               |
| 即插即用     | 部分支持      | 是                 | 否              | 否               |
| 数据传输方向 | 双向          | 双向               | 双向            | 单向/双向        |
| 典型应用     | 服务器设备    | 外设               | 存储设备        | 调试、工业设备   |

### 04.2 逻辑 IO 通道

#### 04.2.1 逻辑 IO 通道定义

**逻辑 IO 通道（Logical IO Channel）定义**：

逻辑 IO 通道是指操作系统或虚拟化层对 IO 传输通道的逻辑抽象，包括设备驱动、中断处
理、DMA 传输、设备队列等。

**逻辑 IO 通道类型**：

1. **设备驱动通道**：

   - **结构**：设备驱动 → 物理设备（设备控制、数据传输、中断处理）
   - **特征**：驱动接口、设备控制、中断处理
   - **应用**：设备访问、IO 操作、设备管理

2. **中断处理通道**：

   - **结构**：硬件中断 → CPU → 中断处理程序（中断路由、中断亲和性、中断平衡）
   - **特征**：中断路由、中断亲和性、中断平衡
   - **应用**：IO 中断处理、异步 IO

3. **DMA 传输通道**：

   - **结构**：DMA（直接内存访问）传输（零拷贝、高带宽、CPU 卸载）
   - **特征**：零拷贝、高带宽、CPU 卸载
   - **应用**：大数据传输、高性能 IO

4. **设备队列通道**：

   - **结构**：设备请求队列（IO 调度、请求合并、请求排队）
   - **特征**：IO 调度、请求合并、请求排队
   - **应用**：块设备 IO、网络设备 IO

#### 04.2.2 逻辑 IO 通道在技术栈中的作用

**逻辑 IO 通道映射**：

```text
逻辑 IO 通道结构:

操作系统逻辑 IO 通道:
├── 设备驱动通道
│   ├── 块设备驱动
│   │   ├── SATA 驱动
│   │   │   ├── 设备控制
│   │   │   ├── 数据传输
│   │   │   └── 中断处理
│   │   ├── NVMe 驱动
│   │   │   ├── 设备控制
│   │   │   ├── 数据传输
│   │   │   └── 中断处理
│   │   └── USB 存储驱动
│   │       ├── 设备控制
│   │       └── 数据传输
│   ├── 字符设备驱动
│   │   ├── 串口驱动
│   │   │   ├── 设备控制
│   │   │   └── 数据传输
│   │   └── 输入设备驱动
│   │       └── 设备控制
│   └── 网络设备驱动
│       ├── Ethernet 驱动
│       │   ├── 设备控制
│       │   ├── 数据传输
│       │   └── 中断处理
│       └── InfiniBand 驱动
│           ├── 设备控制
│           └── 数据传输
├── 中断处理通道
│   ├── 中断路由
│   │   ├── 硬件中断 → CPU
│   │   └── 中断向量表
│   ├── 中断亲和性
│   │   ├── 中断绑定到特定 CPU
│   │   └── 中断负载均衡
│   └── 中断处理程序
│       ├── 上半部（Top Half）
│       └── 下半部（Bottom Half）
├── DMA 传输通道
│   ├── DMA 控制器
│   │   ├── 直接内存访问
│   │   ├── 零拷贝传输
│   │   └── CPU 卸载
│   ├── DMA 缓冲区
│   │   ├── 物理内存缓冲区
│   │   └── DMA 映射
│   └── DMA 完成中断
│       └── 传输完成通知
└── 设备队列通道
    ├── 块设备队列
    │   ├── IO 请求队列
    │   ├── IO 调度器
    │   │   ├── CFQ (Complete Fair Queuing)
    │   │   ├── Deadline
    │   │   └── Noop
    │   └── 请求合并和排队
    ├── 网络设备队列
    │   ├── 发送队列（TX Queue）
    │   ├── 接收队列（RX Queue）
    │   └── 队列管理
    └── USB 设备队列
        ├── USB 请求队列
        └── USB 传输管理

虚拟化逻辑 IO 通道:
├── 虚拟设备驱动通道
│   ├── VirtIO 设备驱动
│   │   ├── VirtIO Net 驱动
│   │   ├── VirtIO Block 驱动
│   │   └── VirtIO 队列管理
│   ├── 模拟设备驱动
│   │   ├── E1000 模拟驱动
│   │   ├── IDE 模拟驱动
│   │   └── SCSI 模拟驱动
│   └── Hypervisor 设备管理
│       ├── 虚拟设备映射
│       └── 设备资源分配
├── 虚拟中断通道
│   ├── 虚拟中断注入
│   │   ├── Hypervisor → Guest OS
│   │   └── 虚拟中断路由
│   ├── 中断虚拟化
│   │   ├── 中断转发
│   │   └── 中断模拟
│   └── 中断平衡
│       └── 虚拟中断负载均衡
└── 虚拟 DMA 通道
    ├── 虚拟 DMA 映射
    │   ├── Guest 物理地址 → Host 物理地址
    │   └── DMA 地址转换
    ├── 虚拟 DMA 传输
    │   └── Hypervisor DMA 管理
    └── 虚拟 DMA 完成
        └── 虚拟中断通知
```

### 04.3 IO 设备通道映射

#### 04.3.1 物理 IO 通道与逻辑 IO 通道映射

**映射关系**：

```text
物理 IO 通道 → 逻辑 IO 通道映射:

物理层:
├── PCIe 总线通道 (物理)
│   ├── PCIe 设备 ↔ CPU
│   └── 点对点连接
├── USB 总线通道 (物理)
│   ├── USB 设备 ↔ CPU
│   └── 树形拓扑
├── SATA/SAS 通道 (物理)
│   ├── 存储设备 ↔ CPU
│   └── 点对点连接
└── 串口通道 (物理)
    ├── 串口设备 ↔ CPU
    └── 点对点连接

逻辑层:
├── 设备驱动通道 (逻辑)
│   ├── 设备驱动 → 物理设备
│   └── 设备控制和数据传输
├── 中断处理通道 (逻辑)
│   ├── 硬件中断 → CPU → 中断处理程序
│   └── 中断路由和处理
├── DMA 传输通道 (逻辑)
│   ├── DMA → 物理内存
│   └── 直接内存访问
└── 设备队列通道 (逻辑)
    ├── IO 请求队列
    └── IO 调度和管理
```

#### 04.3.2 各范式 IO 设备通道模型映射

**各范式 IO 设备通道映射矩阵**：

| 维度             | 虚拟化                                  | 容器化               | 沙盒化                   |
| ---------------- | --------------------------------------- | -------------------- | ------------------------ |
| **物理 IO 通道** | 直接访问或透传                          | 直接访问             | 间接访问（通过 Host）    |
| **逻辑 IO 通道** | Guest OS 设备驱动 + Hypervisor 设备管理 | Host OS 设备驱动     | Runtime IO API（有限）   |
| **中断处理通道** | 虚拟中断注入 + 中断虚拟化               | Host OS 中断处理     | Runtime 中断处理（有限） |
| **DMA 传输通道** | 虚拟 DMA 映射 + DMA 地址转换            | Host OS DMA 传输     | Runtime DMA 传输（有限） |
| **设备队列通道** | 虚拟设备队列 + Hypervisor 队列管理      | Host OS 设备队列     | Runtime IO 队列（有限）  |
| **通道性能**     | 中等（虚拟化开销）                      | 高（直接访问）       | 低（API 抽象开销）       |
| **通道隔离**     | 硬件级隔离（透传）                      | 逻辑隔离（命名空间） | 应用级隔离（API 限制）   |
| **通道共享**     | 支持（虚拟通道共享）                    | 支持（容器共享通道） | 不支持（API 限制）       |

---

## 05. IO 设备模型

### 05.1 物理 IO 设备

#### 05.1.1 物理 IO 设备定义

**物理 IO 设备（Physical IO Device）定义**：

物理 IO 设备是实际存在的硬件 IO 设备，包括网络设备、存储设备、USB 设备、串口设备
、输入设备等。

**物理 IO 设备类型**：

1. **网络设备**：

   - **以太网网卡（Ethernet NIC）**：
     - **接口**：PCIe、PCIe x8、PCIe x16
     - **带宽**：1/10/25/100 Gbps
     - **应用**：服务器网络连接、高速网络
   - **InfiniBand 网卡**：
     - **接口**：PCIe x16
     - **带宽**：200/400 Gbps
     - **应用**：高性能计算、数据中心互联

2. **存储设备**：

   - **存储控制器**：
     - **接口**：PCIe、SATA、SAS
     - **功能**：存储设备管理、RAID、存储虚拟化
     - **应用**：存储系统、存储阵列

3. **USB 设备**：

   - **USB 控制器**：
     - **接口**：PCIe、USB Hub
     - **功能**：USB 设备管理、热插拔、即插即用
     - **应用**：USB 外设连接、移动设备

4. **串口设备**：

   - **串口控制器（UART）**：
     - **接口**：主板、PCIe
     - **功能**：串行通信、调试接口
     - **应用**：调试、工业设备、嵌入式系统

5. **输入设备**：

   - **键盘/鼠标**：
     - **接口**：USB、PS/2
     - **功能**：用户输入、人机交互
     - **应用**：用户交互、系统控制

#### 05.1.2 物理 IO 设备在技术栈中的作用

**物理 IO 设备位置**：

```text
物理 IO 设备在技术栈中的位置:

物理硬件层:
├── 网络设备
│   ├── Ethernet 网卡（PCIe）
│   │   ├── 1/10/25/100 Gbps
│   │   └── 服务器网络连接
│   └── InfiniBand 网卡（PCIe）
│       ├── 200/400 Gbps
│       └── 高性能计算网络
├── 存储设备
│   ├── 存储控制器（PCIe/SATA/SAS）
│   │   ├── SATA 控制器
│   │   ├── NVMe SSD 控制器
│   │   └── RAID 控制器
│   └── 存储设备
│       ├── HDD
│       └── SSD
├── USB 设备
│   ├── USB 控制器（PCIe）
│   │   ├── USB 3.0 控制器
│   │   └── USB 2.0 控制器
│   └── USB 设备
│       ├── USB 存储设备
│       └── USB 外设
├── 串口设备
│   ├── UART 控制器
│   │   ├── RS-232
│   │   └── RS-485
│   └── 串口设备
└── 输入设备
    ├── 键盘（USB/PS/2）
    └── 鼠标（USB/PS/2）

操作系统层:
├── 设备驱动程序
│   ├── 网络设备驱动
│   ├── 存储设备驱动
│   ├── USB 驱动
│   ├── 串口驱动
│   └── 输入设备驱动
└── 设备抽象
    ├── 设备节点（/dev）
    └── 设备文件系统（sysfs）
```

### 05.2 虚拟 IO 设备

#### 05.2.1 虚拟 IO 设备定义

**虚拟 IO 设备（Virtual IO Device）定义**：

虚拟 IO 设备是通过软件模拟的 IO 设备，为虚拟机提供 IO 连接功能，映射到物理 IO 设
备或虚拟 IO 资源池。

**虚拟 IO 设备类型**：

1. **虚拟网络设备（vNIC）**：

   - **VirtIO Net**：半虚拟化网卡（性能高）
   - **E1000 模拟**：Intel 82540EM 网卡模拟（兼容性好）
   - **vmxnet3**：VMware 高性能网卡（企业级）

2. **虚拟存储设备（vDisk）**：

   - **VirtIO Block**：半虚拟化块设备（性能高）
   - **IDE 模拟**：IDE 控制器模拟（兼容性好）
   - **SCSI 模拟**：SCSI 控制器模拟（企业级）

3. **虚拟 USB 设备（vUSB）**：

   - **USB 模拟**：USB 控制器模拟
   - **USB 透传**：USB 设备透传到虚拟机

4. **虚拟串口设备（vSerial）**：

   - **串口模拟**：UART 控制器模拟
   - **串口重定向**：串口输出重定向到文件/网络

#### 05.2.2 虚拟 IO 设备在技术栈中的作用

**虚拟 IO 设备映射**：

```text
虚拟化 IO 设备模型:

Hypervisor 层:
├── 虚拟 IO 设备池
│   ├── 物理 IO 设备聚合
│   ├── IO 设备池管理
│   └── 虚拟设备创建
└── 虚拟 IO 设备
    ├── 虚拟网络设备（vNIC）
    │   ├── VirtIO Net（半虚拟化，性能高）
    │   ├── E1000 模拟（全虚拟化，兼容性好）
    │   └── vmxnet3（企业级）
    ├── 虚拟存储设备（vDisk）
    │   ├── VirtIO Block（半虚拟化，性能高）
    │   ├── IDE 模拟（全虚拟化，兼容性好）
    │   └── SCSI 模拟（全虚拟化，企业级）
    ├── 虚拟 USB 设备（vUSB）
    │   ├── USB 模拟
    │   └── USB 透传
    └── 虚拟串口设备（vSerial）
        ├── 串口模拟
        └── 串口重定向

Guest OS 层:
├── 虚拟 IO 设备驱动
│   ├── VirtIO 驱动（Guest OS）
│   ├── 模拟设备驱动（Guest OS）
│   └── 设备透传驱动（Guest OS）
└── 虚拟设备抽象
    ├── 虚拟设备节点
    └── Guest OS 设备管理

映射关系:
├── vNIC → 物理网卡或虚拟交换机
├── vDisk → 物理存储或存储池
├── vUSB → 物理 USB 设备
└── vSerial → Host OS 串口或文件
```

### 05.3 逻辑 IO 设备

#### 05.3.1 逻辑 IO 设备定义

**逻辑 IO 设备（Logical IO Device）定义**：

逻辑 IO 设备是操作系统或容器层对 IO 设备的逻辑抽象，包括设备节点、设备驱动、设备
文件系统等。

**逻辑 IO 设备类型**：

1. **设备节点抽象**：

   - **块设备节点**：`/dev/sda`、`/dev/nvme0`（存储设备）
   - **字符设备节点**：`/dev/ttyUSB0`、`/dev/ttyS0`（串口设备）
   - **网络设备节点**：`/dev/net/tun`、`/dev/net/tap`（网络设备）

2. **设备驱动抽象**：

   - **块设备驱动**：SATA 驱动、NVMe 驱动、USB 存储驱动
   - **字符设备驱动**：串口驱动、输入设备驱动
   - **网络设备驱动**：Ethernet 驱动、InfiniBand 驱动

3. **设备文件系统抽象**：

   - **sysfs（/sys）**：系统设备信息文件系统
   - **procfs（/proc）**：进程和设备信息文件系统
   - **devfs（/dev）**：设备文件系统

#### 05.3.2 逻辑 IO 设备在技术栈中的作用

**逻辑 IO 设备映射**：

```text
容器化 IO 设备模型:

Host OS 层:
├── 设备节点（/dev）
│   ├── 块设备节点
│   │   ├── /dev/sda（SATA 硬盘）
│   │   ├── /dev/nvme0（NVMe SSD）
│   │   └── /dev/mmcblk0（SD 卡）
│   ├── 字符设备节点
│   │   ├── /dev/ttyUSB0（USB 串口）
│   │   ├── /dev/ttyS0（串口）
│   │   └── /dev/input/mouse0（鼠标）
│   └── 网络设备节点
│       ├── /dev/net/tun（TUN 设备）
│       └── /dev/net/tap（TAP 设备）
├── 设备驱动
│   ├── 块设备驱动
│   ├── 字符设备驱动
│   └── 网络设备驱动
└── 设备文件系统
    ├── /sys（sysfs）
    └── /proc（procfs）

容器层:
├── 容器设备映射
│   ├── Host 设备节点 → 容器设备节点
│   ├── 设备权限映射
│   └── 设备命名空间隔离
└── 容器设备访问
    ├── 直接访问 Host 设备
    └── 设备命名空间隔离
```

### 05.4 IO 设备模型映射

#### 05.4.1 IO 设备模型对比矩阵

**IO 设备模型对比矩阵**：

| 维度         | 物理 IO 设备   | 虚拟 IO 设备（vNIC/vDisk/vUSB） | 逻辑 IO 设备     |
| ------------ | -------------- | ------------------------------- | ---------------- |
| **抽象层级** | 硬件物理资源   | Hypervisor 虚拟抽象             | 操作系统逻辑抽象 |
| **资源隔离** | 物理隔离       | 硬件级隔离（虚拟机）            | 逻辑隔离（容器） |
| **IO 访问**  | 直接访问       | Hypervisor IO 管理              | Host OS IO 管理  |
| **IO 性能**  | 高（直接访问） | 中等（虚拟化开销）              | 高（直接访问）   |
| **设备共享** | 不支持         | 支持（虚拟设备共享）            | 支持（容器共享） |
| **设备类型** | 所有 IO 设备   | 网络、存储、USB、串口           | 所有 IO 设备     |
| **典型应用** | 物理服务器     | 虚拟化                          | 容器化           |

#### 05.4.2 各范式 IO 设备模型映射

**各范式 IO 设备模型映射矩阵**：

| 维度             | 虚拟化                  | 容器化           | 沙盒化                  |
| ---------------- | ----------------------- | ---------------- | ----------------------- |
| **物理 IO 设备** | 直接访问或透传          | 直接访问         | 间接访问（通过 Host）   |
| **虚拟 IO 设备** | 支持（vNIC/vDisk/vUSB） | 不支持           | 不支持                  |
| **逻辑 IO 设备** | Guest OS 设备抽象       | Host OS 设备抽象 | Runtime IO 抽象（有限） |
| **设备抽象层**   | 虚拟设备层              | 无（直接访问）   | WASI API 层             |
| **设备隔离**     | 硬件级隔离              | 逻辑隔离         | 应用级隔离              |
| **设备共享**     | 支持（虚拟设备共享）    | 支持（容器共享） | 不支持（API 限制）      |
| **设备透传**     | 支持（PCIe/SR-IOV/USB） | 有限（设备绑定） | 不支持                  |
| **典型应用**     | 企业虚拟化、多云部署    | 容器编排、微服务 | Wasm 应用、边缘计算     |

---

## 06. IO 设备协议栈

### 06.1 IO 设备协议栈模型

#### 06.1.1 IO 设备协议栈定义

**IO 设备协议栈（IO Device Protocol Stack）定义**：

IO 设备协议栈是指操作系统或虚拟化层管理 IO 设备的软件栈，包括硬件层、驱动层、操
作系统层、应用层等。

**IO 设备协议栈层级**：

1. **硬件层**：

   - **物理 IO 设备**：网卡、存储控制器、USB 控制器、串口控制器
   - **物理接口**：PCIe、USB、SATA、串口
   - **硬件协议**：PCIe 协议、USB 协议、SATA/SAS 协议、串口协议

2. **驱动层**：

   - **设备驱动**：网络设备驱动、存储设备驱动、USB 驱动、串口驱动
   - **驱动接口**：设备控制、数据传输、中断处理
   - **驱动管理**：驱动加载、驱动卸载、驱动版本管理

3. **操作系统层**：

   - **设备抽象**：设备节点、设备文件系统、设备命名空间
   - **设备管理**：设备发现、设备初始化、设备热插拔
   - **IO 管理**：IO 调度、IO 队列、IO 权限管理

4. **应用层**：

   - **应用接口**：系统调用（`open()`、`read()`、`write()`、`ioctl()`）
   - **应用抽象**：文件抽象、网络抽象、设备抽象
   - **应用管理**：应用 IO 请求、应用权限控制

#### 06.1.2 IO 设备协议栈在各范式中的映射

**虚拟化 IO 设备协议栈**：

```text
虚拟化 IO 设备协议栈:

应用层:
├── Guest OS 应用
│   ├── 系统调用（Guest OS）
│   └── 应用 IO 请求
└── Guest OS 设备抽象
    ├── 设备节点（Guest OS）
    └── 设备文件系统（Guest OS）

操作系统层:
├── Guest OS 内核
│   ├── Guest OS 设备管理
│   ├── Guest OS IO 调度
│   └── Guest OS 设备命名空间
└── Guest OS 设备抽象
    ├── 虚拟设备节点
    └── Guest OS 设备管理

驱动层:
├── Guest OS 设备驱动
│   ├── VirtIO 驱动（Guest OS）
│   ├── 模拟设备驱动（Guest OS）
│   └── 设备透传驱动（Guest OS）
└── 虚拟设备驱动接口
    ├── VirtIO 接口
    └── 设备模拟接口

虚拟化层:
├── Hypervisor
│   ├── 虚拟设备管理
│   ├── 虚拟设备映射
│   └── 虚拟设备资源分配
└── 虚拟设备抽象
    ├── vNIC/vDisk/vUSB/vSerial
    └── 虚拟设备队列

驱动层（Host）:
├── Host OS 设备驱动
│   ├── 物理设备驱动（Host OS）
│   └── 设备管理驱动（Host OS）
└── 物理设备驱动接口
    ├── PCIe 驱动
    └── USB 驱动

硬件层:
├── 物理 IO 设备
│   ├── 物理网卡
│   ├── 物理存储设备
│   ├── 物理 USB 设备
│   └── 物理串口设备
└── 物理接口
    ├── PCIe 总线
    ├── USB 总线
    ├── SATA/SAS 接口
    └── 串口接口
```

**容器化 IO 设备协议栈**：

```text
容器化 IO 设备协议栈:

应用层:
├── 容器应用
│   ├── 系统调用（Host OS）
│   └── 应用 IO 请求
└── 容器设备抽象
    ├── 容器设备映射
    └── 容器设备访问

操作系统层:
├── Host OS 内核
│   ├── Host OS 设备管理
│   ├── Host OS IO 调度
│   └── 容器设备命名空间
└── 容器设备抽象
    ├── 容器设备节点
    └── 容器设备隔离

驱动层:
├── Host OS 设备驱动
│   ├── 网络设备驱动
│   ├── 存储设备驱动
│   ├── USB 驱动
│   └── 串口驱动
└── 设备驱动接口
    ├── 块设备驱动
    ├── 字符设备驱动
    └── 网络设备驱动

硬件层:
├── 物理 IO 设备
│   ├── 物理网卡
│   ├── 物理存储设备
│   ├── 物理 USB 设备
│   └── 物理串口设备
└── 物理接口
    ├── PCIe 总线
    ├── USB 总线
    ├── SATA/SAS 接口
    └── 串口接口
```

**沙盒化 IO 设备协议栈**：

```text
沙盒化 IO 设备协议栈:

应用层:
├── Wasm 应用
│   ├── WASI API 调用
│   └── Wasm 模块 IO 请求
└── Wasm Runtime IO 抽象
    ├── WASI Filesystem
    ├── WASI Socket
    └── WASI 标准输入输出

Runtime 层:
├── Wasm Runtime
│   ├── WASI 实现
│   ├── Runtime IO 管理
│   └── Runtime 设备抽象
└── Runtime IO 接口
    ├── WASI Filesystem API
    ├── WASI Socket API
    └── WASI 标准 IO API

操作系统层:
├── Host OS 内核
│   ├── Host OS 设备管理
│   ├── Host OS IO 调度
│   └── Runtime 设备命名空间
└── Host OS 设备抽象
    ├── Host OS 设备节点
    └── Host OS 设备管理

驱动层:
├── Host OS 设备驱动
│   ├── 网络设备驱动
│   ├── 存储设备驱动
│   └── 串口驱动
└── 设备驱动接口
    └── Host OS 驱动接口

硬件层:
├── 物理 IO 设备（Host）
│   ├── 物理网卡
│   ├── 物理存储设备
│   └── 物理串口设备
└── 物理接口
    ├── PCIe 总线
    ├── USB 总线
    └── SATA/SAS 接口
```

### 06.2 IO 设备接口标准

#### 06.2.1 IO 设备接口标准定义

**IO 设备接口标准（IO Device Interface Standard）定义**：

IO 设备接口标准是指操作系统或虚拟化层提供的 IO 设备访问接口标准，包括系统调用接
口、设备驱动接口、设备抽象接口等。

**IO 设备接口标准类型**：

1. **系统调用接口**：

   - **文件 IO**：`open()`、`read()`、`write()`、`close()`、`ioctl()`
   - **网络
     IO**：`socket()`、`bind()`、`listen()`、`accept()`、`send()`、`recv()`
   - **设备 IO**：`ioctl()`、设备节点访问

2. **设备驱动接口**：

   - **块设备接口**：块设备驱动接口、IO 请求接口
   - **字符设备接口**：字符设备驱动接口、字符流接口
   - **网络设备接口**：网络设备驱动接口、数据包接口

3. **设备抽象接口**：

   - **设备节点接口**：`/dev` 设备节点访问
   - **sysfs 接口**：`/sys` 设备信息接口
   - **procfs 接口**：`/proc` 设备和进程信息接口

#### 06.2.2 IO 设备接口标准在各范式中的应用

**虚拟化中的 IO 设备接口**：

- **Guest OS 系统调用**：Guest OS 应用通过 Guest OS 系统调用访问虚拟设备
- **VirtIO 接口**：Guest OS 通过 VirtIO 接口与 Hypervisor 通信
- **设备模拟接口**：Guest OS 通过设备模拟接口访问模拟设备

**容器化中的 IO 设备接口**：

- **Host OS 系统调用**：容器应用通过 Host OS 系统调用访问物理设备
- **设备节点接口**：容器通过设备节点接口访问 Host OS 设备
- **设备命名空间接口**：容器通过设备命名空间隔离设备访问

**沙盒化中的 IO 设备接口**：

- **WASI API**：Wasm 应用通过 WASI API 访问 IO 设备（文件系统、网络、标准 IO）
- **Runtime IO 接口**：Wasm Runtime 提供 IO 抽象接口
- **Host OS 接口**：Runtime 通过 Host OS 接口访问物理设备

### 06.3 各范式 IO 设备栈对比

#### 06.3.1 IO 设备协议栈对比矩阵

**IO 设备协议栈对比矩阵**：

| 维度             | 虚拟化                                  | 容器化                   | 沙盒化                            |
| ---------------- | --------------------------------------- | ------------------------ | --------------------------------- |
| **协议栈层级**   | Hypervisor + Guest OS（两级）           | Host OS（单级）          | Runtime + Host OS（应用级+单级）  |
| **设备驱动层级** | Guest OS 驱动 + Hypervisor 驱动（两级） | Host OS 驱动（单级）     | Runtime API + Host OS 驱动        |
| **设备抽象层级** | 虚拟设备 + Guest OS 设备抽象（两级）    | Host OS 设备抽象（单级） | Runtime IO API + Host OS 设备抽象 |
| **性能开销**     | 高（两级协议栈开销）                    | 低（单级协议栈开销）     | 中等（Runtime + Host OS）         |
| **设备隔离**     | 硬件级隔离（透传）                      | 逻辑隔离（容器）         | 应用级隔离（API 限制）            |
| **设备共享**     | 支持（虚拟设备共享）                    | 支持（容器共享设备）     | 不支持（API 限制）                |
| **设备透传**     | 支持（PCIe/SR-IOV/USB）                 | 有限（设备绑定）         | 不支持                            |
| **设备模拟**     | 支持（QEMU、VirtIO）                    | 不支持                   | 不支持                            |
| **典型应用**     | 企业虚拟化、多云部署                    | 容器编排、微服务         | Wasm 应用、边缘计算               |

---

## 07. 虚拟化 IO 设备架构

### 07.1 虚拟化 IO 设备拓扑

#### 07.1.1 虚拟化 IO 设备拓扑结构

**虚拟化 IO 设备拓扑结构**：

```text
虚拟化 IO 设备拓扑:

物理层:
├── 物理 IO 设备
│   ├── 物理网卡（PCIe）
│   ├── 物理存储设备（SATA/SAS/PCIe）
│   ├── 物理 USB 设备（USB）
│   └── 物理串口设备（UART）

Hypervisor 层:
├── 虚拟 IO 设备池
│   ├── 物理 IO 设备聚合
│   ├── IO 设备池管理
│   └── 虚拟设备创建
└── 虚拟 IO 设备
    ├── 虚拟网络设备（vNIC）
    │   ├── VirtIO Net
    │   ├── E1000 模拟
    │   └── vmxnet3
    ├── 虚拟存储设备（vDisk）
    │   ├── VirtIO Block
    │   ├── IDE 模拟
    │   └── SCSI 模拟
    ├── 虚拟 USB 设备（vUSB）
    │   ├── USB 模拟
    │   └── USB 透传
    └── 虚拟串口设备（vSerial）
        ├── 串口模拟
        └── 串口重定向

Guest OS 层:
├── Guest OS 设备抽象
│   ├── Guest OS 设备节点
│   └── Guest OS 设备管理
└── Guest OS 设备驱动
    ├── VirtIO 驱动（Guest OS）
    ├── 模拟设备驱动（Guest OS）
    └── 设备透传驱动（Guest OS）
```

### 07.2 虚拟化 IO 设备模型

#### 07.2.1 虚拟化 IO 设备架构

**虚拟化 IO 设备架构**：

```text
虚拟化 IO 设备架构:

设备抽象层:
├── 虚拟网络设备（vNIC）
│   ├── VirtIO Net（半虚拟化）
│   │   ├── 高性能虚拟网卡
│   │   ├── Guest OS VirtIO 驱动
│   │   └── Hypervisor VirtIO 后端
│   ├── E1000 模拟（全虚拟化）
│   │   ├── Intel 82540EM 网卡模拟
│   │   ├── Guest OS 标准驱动
│   │   └── Hypervisor 软件模拟
│   └── vmxnet3（企业级）
│       ├── VMware 高性能网卡
│       └── Guest OS vmxnet3 驱动
├── 虚拟存储设备（vDisk）
│   ├── VirtIO Block（半虚拟化）
│   │   ├── 高性能虚拟磁盘
│   │   ├── Guest OS VirtIO 驱动
│   │   └── Hypervisor VirtIO 后端
│   ├── IDE 模拟（全虚拟化）
│   │   ├── IDE 控制器模拟
│   │   ├── Guest OS 标准驱动
│   │   └── Hypervisor 软件模拟
│   └── SCSI 模拟（全虚拟化）
│       ├── SCSI 控制器模拟
│       ├── Guest OS 标准驱动
│       └── Hypervisor 软件模拟
├── 虚拟 USB 设备（vUSB）
│   ├── USB 模拟
│   │   ├── USB 控制器模拟
│   │   └── Guest OS USB 驱动
│   └── USB 透传
│       ├── 物理 USB 设备透传
│       └── Guest OS USB 驱动
└── 虚拟串口设备（vSerial）
    ├── 串口模拟
    │   ├── UART 控制器模拟
    │   └── Guest OS 串口驱动
    └── 串口重定向
        ├── 串口输出重定向到文件
        └── 串口输出重定向到网络

设备映射层:
├── vNIC → 物理网卡或虚拟交换机
├── vDisk → 物理存储或存储池
├── vUSB → 物理 USB 设备
└── vSerial → Host OS 串口或文件
```

### 07.3 虚拟化 IO 设备隔离

#### 07.3.1 虚拟化 IO 设备隔离机制

**虚拟化 IO 设备隔离**：

1. **硬件级隔离**：

   - **设备透传隔离**：通过 IOMMU/VT-d 实现设备透传隔离
   - **DMA 隔离**：IOMMU 提供 DMA 隔离和保护
   - **设备独占**：透传设备被单个虚拟机独占

2. **虚拟设备隔离**：

   - **虚拟设备抽象**：每个虚拟机拥有独立的虚拟设备
   - **设备资源分配**：Hypervisor 分配设备资源给虚拟机
   - **设备 QoS**：支持设备 QoS（服务质量）控制

3. **设备透传隔离**：

   - **PCIe 透传**：通过 IOMMU 实现 PCIe 设备透传隔离
   - **SR-IOV**：通过硬件虚拟化实现设备共享和隔离
   - **USB 透传**：USB 设备透传到虚拟机并隔离

---

## 08. 容器化 IO 设备架构

### 08.1 容器化 IO 设备拓扑

#### 08.1.1 容器化 IO 设备拓扑结构

**容器化 IO 设备拓扑结构**：

```text
容器化 IO 设备拓扑:

物理层:
├── 物理 IO 设备
│   ├── 物理网卡（PCIe）
│   ├── 物理存储设备（SATA/SAS/PCIe）
│   ├── 物理 USB 设备（USB）
│   └── 物理串口设备（UART）

Host OS 层:
├── 设备节点（/dev）
│   ├── 块设备节点
│   ├── 字符设备节点
│   └── 网络设备节点
├── 设备驱动
│   ├── 块设备驱动
│   ├── 字符设备驱动
│   └── 网络设备驱动
└── 设备文件系统
    ├── /sys（sysfs）
    └── /proc（procfs）

容器层:
├── 容器设备映射
│   ├── Host 设备节点 → 容器设备节点
│   ├── 设备权限映射
│   └── 设备命名空间隔离
└── 容器设备访问
    ├── 直接访问 Host 设备
    └── 设备命名空间隔离
```

### 08.2 容器化 IO 设备模型

#### 08.2.1 容器化 IO 设备架构

**容器化 IO 设备架构**：

```text
容器化 IO 设备架构:

设备抽象层:
├── 容器设备映射
│   ├── 块设备映射
│   │   ├── Host /dev/sda → 容器 /dev/sda
│   │   ├── Host /dev/nvme0 → 容器 /dev/nvme0
│   │   └── 设备权限映射
│   ├── 字符设备映射
│   │   ├── Host /dev/ttyUSB0 → 容器 /dev/ttyUSB0
│   │   ├── Host /dev/ttyS0 → 容器 /dev/ttyS0
│   │   └── 设备权限映射
│   └── 网络设备映射
│       ├── Host 网络命名空间共享
│       └── 容器网络命名空间隔离
├── 设备命名空间
│   ├── 设备命名空间隔离
│   ├── 设备权限控制
│   └── 设备访问审计
└── 设备访问控制
    ├── cgroup 设备控制
    ├── 设备权限管理
    └── 设备访问限制

设备共享层:
├── 容器设备共享
│   ├── 多个容器共享物理设备
│   ├── 设备命名空间隔离
│   └── 设备权限控制
└── 设备资源管理
    ├── 设备资源分配
    └── 设备资源限制
```

### 08.3 容器化 IO 设备隔离

#### 08.3.1 容器化 IO 设备隔离机制

**容器化 IO 设备隔离**：

1. **设备命名空间隔离**：

   - **设备命名空间**：每个容器拥有独立的设备命名空间
   - **设备节点隔离**：容器内的设备节点与 Host OS 隔离
   - **设备权限隔离**：通过设备权限控制实现设备隔离

2. **设备访问控制**：

   - **cgroup 设备控制**：通过 cgroup 控制容器设备访问
   - **设备权限管理**：限制容器设备访问权限
   - **设备访问审计**：记录容器设备访问日志

3. **设备绑定隔离**：

   - **设备绑定**：容器绑定特定设备节点
   - **设备权限映射**：Host 设备权限映射到容器
   - **设备共享隔离**：多个容器共享设备时进行权限隔离

---

## 09. 沙盒化 IO 设备架构

### 09.1 沙盒化 IO 设备拓扑

#### 09.1.1 沙盒化 IO 设备拓扑结构

**沙盒化 IO 设备拓扑结构**：

```text
沙盒化 IO 设备拓扑:

物理层:
├── 物理 IO 设备（Host）
│   ├── 物理网卡（PCIe）
│   ├── 物理存储设备（SATA/SAS/PCIe）
│   └── 物理串口设备（UART）

Host OS 层:
├── 设备节点（/dev）
│   ├── 块设备节点
│   ├── 字符设备节点
│   └── 网络设备节点
├── 设备驱动
│   ├── 块设备驱动
│   ├── 字符设备驱动
│   └── 网络设备驱动
└── 设备文件系统
    ├── /sys（sysfs）
    └── /proc（procfs）

Runtime 层:
├── Wasm Runtime
│   ├── WASI 实现
│   ├── Runtime IO 管理
│   └── Runtime 设备抽象
└── Runtime IO 接口
    ├── WASI Filesystem API
    ├── WASI Socket API
    └── WASI 标准 IO API

Wasm Module 层:
├── Wasm Module
│   ├── WASI API 调用
│   └── Wasm 模块 IO 请求
└── Wasm IO 抽象
    ├── WASI Filesystem
    ├── WASI Socket
    └── WASI 标准输入输出
```

### 09.2 沙盒化 IO 设备模型

#### 09.2.1 沙盒化 IO 设备架构

**沙盒化 IO 设备架构**：

```text
沙盒化 IO 设备架构:

设备抽象层:
├── WASI Filesystem
│   ├── 文件系统抽象
│   │   ├── 目录映射（Directory Mapping）
│   │   ├── 文件访问抽象
│   │   └── 权限控制
│   └── 函数调用拦截
│       ├── 文件操作函数拦截
│       ├── 目录操作函数拦截
│       └── 权限检查
├── WASI Socket
│   ├── 网络抽象
│   │   ├── TCP/UDP Socket 支持
│   │   ├── 网络命名空间隔离
│   │   └── 权限控制
│   └── 函数调用拦截
│       ├── Socket 操作函数拦截
│       └── 权限检查
└── WASI 标准输入输出
    ├── 标准 IO 抽象
    │   ├── stdin/stdout/stderr
    │   └── 控制台重定向
    └── 函数调用拦截
        └── 标准 IO 函数拦截

设备访问层:
├── Runtime IO 接口
│   ├── WASI Filesystem API → Host OS 文件系统
│   ├── WASI Socket API → Host OS 网络栈
│   └── WASI 标准 IO API → Host OS 标准 IO
└── Host OS 设备访问
    ├── Runtime 转发文件操作
    ├── Runtime 转发网络请求
    └── Runtime 转发标准 IO
```

### 09.3 沙盒化 IO 设备隔离

#### 09.3.1 沙盒化 IO 设备隔离机制

**沙盒化 IO 设备隔离**：

1. **WASI API 隔离**：

   - **API 限制**：Wasm 模块只能通过 WASI API 访问 IO 设备
   - **权限控制**：通过 WASI 权限控制设备访问
   - **最小权限原则**：只授予必要的 IO 设备权限

2. **函数调用拦截**：

   - **系统调用拦截**：Runtime 拦截文件系统、网络相关的系统调用
   - **权限检查**：在系统调用层面进行权限检查
   - **访问控制**：限制 Wasm 模块的 IO 设备访问范围

3. **目录映射隔离**：

   - **目录隔离**：每个 Wasm 模块拥有独立的目录映射
   - **路径隔离**：Wasm 模块的路径与 Host OS 路径隔离
   - **访问控制**：限制 Wasm 模块的访问范围

---

## 10. IO 设备架构对比矩阵

### 10.1 IO 设备拓扑对比矩阵

**IO 设备拓扑对比**：

| 拓扑维度        | 虚拟化                     | 容器化                   | 沙盒化                  |
| --------------- | -------------------------- | ------------------------ | ----------------------- |
| **物理拓扑**    | 直接访问或透传             | 直接访问                 | 间接访问（通过 Host）   |
| **逻辑拓扑**    | Guest OS 独立 IO 设备抽象  | Host OS 共享 IO 设备抽象 | Runtime IO 抽象（有限） |
| **IO 设备抽象** | vNIC、vDisk、vUSB、vSerial | Host OS 设备节点         | WASI 文件系统、网络 API |
| **设备隔离**    | 硬件级隔离（透传）         | 逻辑隔离（命名空间）     | 应用级隔离（API 限制）  |
| **设备共享**    | 支持（虚拟设备共享）       | 支持（容器共享设备）     | 不支持（API 限制）      |

### 10.2 IO 设备访问模式对比矩阵

**IO 设备访问模式对比**：

| 访问模式     | 虚拟化                         | 容器化             | 沙盒化                       |
| ------------ | ------------------------------ | ------------------ | ---------------------------- |
| **主要模式** | 虚拟化访问、透传访问           | 直接访问           | 直接访问（受限，WASI API）   |
| **实现方式** | vNIC/vDisk/vUSB/vSerial        | 设备绑定、设备共享 | WASI Filesystem、WASI Socket |
| **性能损失** | 15-25%（虚拟化）或 <5%（透传） | <5%（直接访问）    | 10-15%（API 抽象）           |
| **设备透传** | 支持（PCIe/SR-IOV/USB）        | 有限（设备绑定）   | 不支持                       |

### 10.3 IO 设备通道模型对比矩阵

**IO 设备通道模型对比**：

| 通道类型     | 虚拟化                                  | 容器化                    | 沙盒化                   |
| ------------ | --------------------------------------- | ------------------------- | ------------------------ |
| **物理通道** | PCIe/USB/SATA（直接访问或透传）         | PCIe/USB/SATA（直接访问） | 间接访问（通过 Host）    |
| **逻辑通道** | Guest OS 设备驱动 + Hypervisor 设备管理 | Host OS 设备驱动          | Runtime IO API（有限）   |
| **中断处理** | 虚拟中断注入 + 中断虚拟化               | Host OS 中断处理          | Runtime 中断处理（有限） |
| **DMA 传输** | 虚拟 DMA 映射 + DMA 地址转换            | Host OS DMA 传输          | Runtime DMA 传输（有限） |
| **设备队列** | 虚拟设备队列 + Hypervisor 队列管理      | Host OS 设备队列          | Runtime IO 队列（有限）  |

### 10.4 IO 设备模型对比矩阵

**IO 设备模型对比**：

| 设备类型     | 虚拟化                                  | 容器化                   | 沙盒化                       |
| ------------ | --------------------------------------- | ------------------------ | ---------------------------- |
| **设备模型** | 虚拟 IO 设备（vNIC/vDisk/vUSB/vSerial） | 逻辑 IO 设备（设备节点） | Runtime IO 抽象（WASI API）  |
| **实现方式** | VirtIO、设备模拟、设备透传              | 设备绑定、设备共享       | WASI Filesystem、WASI Socket |
| **性能**     | 15-25% 性能损失（虚拟化）或 <5%（透传） | <5% 性能损失             | 10-15% 性能损失              |
| **隔离强度** | 硬件级隔离                              | 逻辑隔离                 | 应用级隔离                   |
| **设备共享** | 支持（虚拟设备共享）                    | 支持（容器共享设备）     | 不支持（API 限制）           |

### 10.5 IO 设备协议栈对比矩阵

**IO 设备协议栈对比**：

| 协议栈层次     | 虚拟化                        | 容器化               | 沙盒化                           |
| -------------- | ----------------------------- | -------------------- | -------------------------------- |
| **应用层**     | Guest OS App                  | Container App        | Wasm Module                      |
| **设备抽象层** | Guest OS 设备抽象             | Host OS 设备抽象     | Runtime IO API                   |
| **驱动层**     | Guest OS 驱动 + Hypervisor    | Host OS 驱动         | Runtime API + Host OS 驱动       |
| **硬件层**     | 物理 IO 设备                  | 物理 IO 设备（共享） | 物理 IO 设备（共享，通过 Host）  |
| **协议栈层级** | Hypervisor + Guest OS（两级） | Host OS（单级）      | Runtime + Host OS（应用级+单级） |
| **性能开销**   | 高（两级协议栈开销）          | 低（单级协议栈开销） | 中等（Runtime + Host OS）        |

---

## 11. 参考

**关联文档**：

- **[理论模型](../01-theory-models/)** - 技术范式背后的理论模型
- **[技术名词概念论证](technical-concepts-explanation.md)** - 技术名词概念论证
- **[网络概念论证](02-network-concepts-explanation.md)** - 网络架构论证
- **[存储概念论证](03-storage-concepts-explanation.md)** - 存储架构论证
- **[GPU/IO 设备概念论证](05-gpu-io-concepts-explanation.md)** - GPU/IO 设备综合
  论证

**外部参考**：

- [PCIe](https://en.wikipedia.org/wiki/PCI_Express)
- [USB](https://en.wikipedia.org/wiki/USB)
- [VirtIO](https://www.linux-kvm.org/page/Virtio)
- [SR-IOV](https://en.wikipedia.org/wiki/Single-root_input/output_virtualization)
- [WASI](https://wasi.dev/)
- [Device Passthrough](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF)

---

**文档版本**：v1.0 **最后更新**：2025-11-03 **维护者**：文档维护团队

---

\_本文档为 IO 设备概念与技术名词论证的核心文档，持续更新和完善中。\_\_
