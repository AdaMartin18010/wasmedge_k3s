# 14. 性能基线：体积/启动/内存/密度/CPU 尖峰

## 目录

- [目录](#目录)
- [14.1 文档定位](#141-文档定位)
- [14.2 性能指标维度](#142-性能指标维度)
  - [14.2.1 性能指标矩阵](#1421-性能指标矩阵)
  - [14.2.2 性能指标说明](#1422-性能指标说明)
- [14.3 容器 vs Wasm 性能对比](#143-容器-vs-wasm-性能对比)
  - [14.3.1 启动性能对比](#1431-启动性能对比)
  - [14.3.2 资源占用对比](#1432-资源占用对比)
  - [14.3.3 密度对比](#1433-密度对比)
  - [14.3.4 性能对比分析](#1434-性能对比分析)
- [14.4 Kubernetes vs K3s 性能对比](#144-kubernetes-vs-k3s-性能对比)
  - [14.4.1 控制平面性能](#1441-控制平面性能)
  - [14.4.2 节点性能](#1442-节点性能)
  - [14.4.3 规模对比](#1443-规模对比)
  - [14.4.4 性能对比分析](#1444-性能对比分析)
- [14.5 OPA 性能对比](#145-opa-性能对比)
  - [14.5.1 OPA 原生 vs OPA-Wasm](#1451-opa-原生-vs-opa-wasm)
  - [14.5.2 性能提升分析](#1452-性能提升分析)
- [14.6 性能基准要求](#146-性能基准要求)
  - [14.6.1 数据来源要求](#1461-数据来源要求)
  - [14.6.2 版本和日期要求](#1462-版本和日期要求)
  - [14.6.3 测试环境要求](#1463-测试环境要求)
- [14.7 性能优化建议](#147-性能优化建议)
  - [14.7.1 启动性能优化](#1471-启动性能优化)
  - [14.7.2 资源占用优化](#1472-资源占用优化)
  - [14.7.3 部署密度优化](#1473-部署密度优化)
- [14.8 参考](#148-参考)

---

## 14.1 文档定位

本文档记录各种技术栈的性能基线和基准测试数据，包括体积、启动时间、内存占用、部署
密度、CPU 尖峰等指标。**每项指标必须附来源、时间、版本信息**。

**文档结构**：

- **性能指标维度**：体积、启动、内存、密度、CPU 尖峰
- **性能对比**：容器 vs Wasm、Kubernetes vs K3s、OPA 原生 vs OPA-Wasm
- **基准要求**：数据来源、版本日期、测试环境要求
- **优化建议**：性能优化建议和最佳实践

## 14.2 性能指标维度

### 14.2.1 性能指标矩阵

| 指标类别 | 指标名称        | 说明                      | 单位     |
| -------- | --------------- | ------------------------- | -------- |
| **体积** | 镜像体积        | 镜像文件大小              | MB       |
| **启动** | 启动时间        | 容器/应用启动时间         | ms/s     |
| **内存** | 内存基线        | 运行时的内存占用          | MB       |
| **内存** | 内存峰值        | 峰值内存占用              | MB       |
| **密度** | 单节点 Pod 数   | 单个节点可部署的 Pod 数   | Pod/Node |
| **CPU**  | 冷启动 CPU 尖峰 | 冷启动时的 CPU 使用率峰值 | %        |
| **CPU**  | 运行 CPU 基线   | 运行时的 CPU 使用率基线   | %        |

### 14.2.2 性能指标说明

**体积指标**：

- **镜像体积**：镜像文件大小，影响拉取和存储成本
- **体积优化**：使用多阶段构建、Distroless/Scratch 减小体积

**启动指标**：

- **启动时间**：从创建到就绪的时间，影响弹性扩缩容速度
- **启动优化**：使用 Wasm、零 rootfs 优化启动时间

**内存指标**：

- **内存基线**：运行时的基础内存占用
- **内存峰值**：峰值内存占用，影响资源规划

**密度指标**：

- **单节点 Pod 数**：单个节点可部署的 Pod 数量，影响资源利用率

**CPU 指标**：

- **冷启动 CPU 尖峰**：冷启动时的 CPU 使用率峰值
- **运行 CPU 基线**：运行时的 CPU 使用率基线

## 14.3 容器 vs Wasm 性能对比

### 14.3.1 启动性能对比

**对比数据（同硬件 4C8G，100 并发冷启动）**：

| 指标                | 传统容器（alpine） | WasmEdge + crun | 提升倍数      | 来源/版本                |
| ------------------- | ------------------ | --------------- | ------------- | ------------------------ |
| **启动时间**        | 1.2s               | 6ms             | **200× 更快** | WasmEdge 0.14.0, 2025-01 |
| **启动延迟（p99）** | 2.5s               | 12ms            | **208× 更快** | WasmEdge 0.14.0, 2025-01 |

> **注**：具体指标需附来源/时间/版本，见 [REFERENCES.md](../REFERENCES.md)

### 14.3.2 资源占用对比

**对比数据（同硬件 4C8G，100 并发）**：

| 指标              | 传统容器（alpine） | WasmEdge + crun | 提升倍数      | 来源/版本                |
| ----------------- | ------------------ | --------------- | ------------- | ------------------------ |
| **镜像体积**      | 13 MB              | 0.9 MB          | **14× 更小**  | WasmEdge 0.14.0, 2025-01 |
| **内存基线**      | 18 MB              | 2.1 MB          | **8.5× 更小** | WasmEdge 0.14.0, 2025-01 |
| **内存峰值**      | 35 MB              | 5 MB            | **7× 更小**   | WasmEdge 0.14.0, 2025-01 |
| **运行 CPU 基线** | 2%                 | 0.5%            | **4× 更低**   | WasmEdge 0.14.0, 2025-01 |

### 14.3.3 密度对比

**对比数据（单节点 4C8G）**：

| 指标                | 传统容器（alpine） | WasmEdge + crun | 提升倍数     | 来源/版本                |
| ------------------- | ------------------ | --------------- | ------------ | ------------------------ |
| **单节点密度**      | 300 Pod            | 3000 Pod        | **10× 更高** | WasmEdge 0.14.0, 2025-01 |
| **冷启动 CPU 尖峰** | 80%                | 3%              | **26× 更低** | WasmEdge 0.14.0, 2025-01 |

### 14.3.4 性能对比分析

**性能优势论证**：

- **启动速度**：Wasm 启动 < 10ms，比容器快 200 倍
- **资源占用**：Wasm 内存 ~2MB，比容器小 8.5 倍
- **部署密度**：单节点可部署 3000 Pod，比容器高 10 倍
- **CPU 占用**：Wasm CPU 尖峰 3%，比容器低 26 倍

**性能模型**：
$$P_{\text{improvement}} = \frac{P_{\text{container}} - P_{\text{wasm}}}{P_{\text{container}}} \times 100\%$$

其中 $P$ 可以是启动时间、内存占用、CPU 占用等指标。

## 14.4 Kubernetes vs K3s 性能对比

### 14.4.1 控制平面性能

**对比数据（单节点）**：

| 指标             | Kubernetes      | K3s                | 提升倍数     | 来源/版本           |
| ---------------- | --------------- | ------------------ | ------------ | ------------------- |
| **控制平面内存** | ~512 MB         | ~250 MB            | **2× 更小**  | K3s 1.30.4, 2025-01 |
| **启动时间**     | ~30s            | ~10s               | **3× 更快**  | K3s 1.30.4, 2025-01 |
| **二进制大小**   | ~1 GB（多组件） | ~60 MB（单二进制） | **16× 更小** | K3s 1.30.4, 2025-01 |

### 14.4.2 节点性能

**对比数据（边缘节点 4C4G）**：

| 指标                | Kubernetes        | K3s               | 提升倍数     | 来源/版本           |
| ------------------- | ----------------- | ----------------- | ------------ | ------------------- |
| **节点内存**        | ~512 MB           | ~250 MB           | **2× 更小**  | K3s 1.30.4, 2025-01 |
| **存储延迟**        | etcd 网络往返 2ms | sqlite 本地 0.1ms | **20× 更快** | K3s 1.30.4, 2025-01 |
| **list-watch 压力** | 100%              | 60%               | **40% 降低** | K3s 1.30.4, 2025-01 |

### 14.4.3 规模对比

**对比数据（边缘场景，低 Pod 密度）**：

| 指标           | Kubernetes  | K3s         | 说明           | 来源/版本           |
| -------------- | ----------- | ----------- | -------------- | ------------------- |
| **最大节点数** | > 1000      | 1000        | K3s 限制       | K3s 1.30.4, 2025-01 |
| **Pod 密度**   | 50 Pod/Node | 10 Pod/Node | 边缘场景典型值 | K3s 1.30.4, 2025-01 |
| **总对象数**   | > 10 万     | ≈1 万       | 边缘场景典型值 | K3s 1.30.4, 2025-01 |

### 14.4.4 性能对比分析

**K3s 性能优势论证**：

- **控制平面**：内存占用减少 50%，启动时间快 3 倍
- **节点性能**：存储延迟低 20 倍，list-watch 压力降低 40%
- **边缘场景**：适合边缘场景（< 1000 节点，低 Pod 密度）

## 14.5 OPA 性能对比

### 14.5.1 OPA 原生 vs OPA-Wasm

**对比数据（同策略、同硬件）**：

| 指标         | OPA（原生） | OPA-Wasm | 提升倍数     | 来源/版本                            |
| ------------ | ----------- | -------- | ------------ | ------------------------------------ |
| **启动时间** | 100ms       | 6ms      | **16× 更快** | OPA 0.58.0, WasmEdge 0.14.0, 2025-01 |
| **内存占用** | 50 MB       | 2 MB     | **25× 更小** | OPA 0.58.0, WasmEdge 0.14.0, 2025-01 |
| **评估延迟** | 10ms        | 1ms      | **10× 更快** | OPA 0.58.0, WasmEdge 0.14.0, 2025-01 |

### 14.5.2 性能提升分析

**OPA-Wasm 性能优势论证**：

- **启动时间**：Wasm 启动 < 10ms，比原生快 16 倍
- **内存占用**：Wasm 内存 ~2MB，比原生小 25 倍
- **评估延迟**：Wasm 评估 < 1ms，比原生快 10 倍

## 14.6 性能基准要求

### 14.6.1 数据来源要求

**数据来源要求**：

- ✅ **官方文档**：技术官方文档的性能数据
- ✅ **基准测试**：公开的基准测试结果
- ✅ **生产数据**：生产环境的实测数据（需注明）

**数据来源格式**：

```text
[指标名称]: [数值] | 来源: [官方文档/基准测试/生产数据] | 版本: [x.y.z] | 日期: [YYYY-MM-DD]
```

### 14.6.2 版本和日期要求

**版本要求**：

- ✅ **技术版本**：必须注明技术版本（如 WasmEdge 0.14.0）
- ✅ **Kubernetes 版本**：必须注明 Kubernetes/K3s 版本
- ✅ **测试工具版本**：必须注明测试工具版本

**日期要求**：

- ✅ **测试日期**：必须注明测试日期（如 2025-01-15）
- ✅ **数据有效性**：性能数据可能随时间变化，需定期更新

### 14.6.3 测试环境要求

**测试环境要求**：

- ✅ **硬件规格**：必须注明硬件规格（CPU、内存、存储）
- ✅ **软件环境**：必须注明操作系统、内核版本
- ✅ **测试条件**：必须注明测试条件（并发数、负载等）

**测试环境格式**：

```text
硬件: [CPU 型号] [核心数]C [内存]G
软件: [OS 版本] [内核版本]
条件: [并发数] 并发, [负载类型]
```

## 14.7 性能优化建议

### 14.7.1 启动性能优化

**启动性能优化建议**：

- **使用 Wasm**：Wasm 启动 < 10ms，比容器快 200 倍
- **零 rootfs**：使用 scratch 镜像，无需加载文件系统
- **Pod 预热**：保持最小 Pod 数，避免冷启动

### 14.7.2 资源占用优化

**资源占用优化建议**：

- **使用 Wasm**：Wasm 内存 ~2MB，比容器小 8.5 倍
- **多阶段构建**：减小镜像体积，减少存储占用
- **资源限制**：精确设置资源限制，避免资源浪费

### 14.7.3 部署密度优化

**部署密度优化建议**：

- **使用 Wasm**：单节点可部署 3000 Pod，比容器高 10 倍
- **资源优化**：合理设置资源限制，最大化资源利用率
- **调度优化**：使用亲和性和反亲和性，优化 Pod 调度

## 14.8 参考

> 完整参考列表见 [REFERENCES.md](../REFERENCES.md) > **重要提醒**：本文档所有性
> 能数据必须附来源、时间、版本信息。数据可能随时间变化，需定期更新和验证。
