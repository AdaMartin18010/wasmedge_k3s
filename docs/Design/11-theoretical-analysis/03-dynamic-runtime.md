# ä¸‰ã€åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†çš„æ§åˆ¶è®ºå®ç°

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0 **æœ€åæ›´æ–°ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

---

## ğŸ“‘ ç›®å½•

- [ä¸‰ã€åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†çš„æ§åˆ¶è®ºå®ç°](#ä¸‰åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†çš„æ§åˆ¶è®ºå®ç°)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [3.1 å¼¹æ€§ä¼¸ç¼©çš„é—­ç¯æ§åˆ¶](#31-å¼¹æ€§ä¼¸ç¼©çš„é—­ç¯æ§åˆ¶)
    - [å½¢å¼åŒ–æ§åˆ¶æ¨¡å‹](#å½¢å¼åŒ–æ§åˆ¶æ¨¡å‹)
    - [ä¼¸ç¼©å»¶è¿Ÿå·®å¼‚çš„æ ¹å› åˆ†æ](#ä¼¸ç¼©å»¶è¿Ÿå·®å¼‚çš„æ ¹å› åˆ†æ)
  - [3.2 è´Ÿè½½å‡è¡¡çš„ç»Ÿä¸€ä¸å·®å¼‚](#32-è´Ÿè½½å‡è¡¡çš„ç»Ÿä¸€ä¸å·®å¼‚)
    - [è´Ÿè½½å‡è¡¡å½¢å¼åŒ–æ¨¡å‹](#è´Ÿè½½å‡è¡¡å½¢å¼åŒ–æ¨¡å‹)
    - [è´Ÿè½½å‡è¡¡æ€§èƒ½å¯¹æ¯”](#è´Ÿè½½å‡è¡¡æ€§èƒ½å¯¹æ¯”)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
  - [2025 å¹´æœ€æ–°å®è·µ](#2025-å¹´æœ€æ–°å®è·µ)
    - [åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†æœ€ä½³å®è·µï¼ˆ2025ï¼‰](#åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†æœ€ä½³å®è·µ2025)
  - [å®é™…åº”ç”¨æ¡ˆä¾‹](#å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [æ¡ˆä¾‹ 1ï¼šå¼¹æ€§ä¼¸ç¼©é…ç½®ï¼ˆ2025ï¼‰](#æ¡ˆä¾‹-1å¼¹æ€§ä¼¸ç¼©é…ç½®2025)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»æ§åˆ¶è®ºçš„è§’åº¦åˆ†æåŠ¨æ€è¿è¡Œæ—¶ç®¡ç†çš„å®ç°ï¼Œå±•ç¤ºå¦‚ä½•é€šè¿‡é—­ç¯æ§åˆ¶å®ç°å¼¹æ€§ä¼¸ç¼©å’Œ
è´Ÿè½½å‡è¡¡ã€‚

## 3.1 å¼¹æ€§ä¼¸ç¼©çš„é—­ç¯æ§åˆ¶

### å½¢å¼åŒ–æ§åˆ¶æ¨¡å‹

**é—­ç¯æ§åˆ¶ç³»ç»Ÿå½¢å¼åŒ–å®šä¹‰**ï¼š

```text
è®¾å¼¹æ€§ä¼¸ç¼©ç³»ç»Ÿä¸ºï¼š
áº‹(t) = f(x(t), u(t), d(t))
y(t) = g(x(t))
e(t) = r(t) - y(t)
u(t) = KÂ·e(t)

å…¶ä¸­ï¼š
- x(t) âˆˆ â„â¿ï¼šå½“å‰å‰¯æœ¬æ•°ã€èµ„æºä½¿ç”¨é‡
- r(t) âˆˆ â„ï¼šæœŸæœ›èµ„æºä½¿ç”¨ç‡ï¼ˆå¦‚ 70% CPUï¼‰
- y(t) âˆˆ â„ï¼šå®é™…èµ„æºä½¿ç”¨ç‡
- e(t) âˆˆ â„ï¼šè¯¯å·®ä¿¡å·
- u(t) âˆˆ â„¤ï¼šæ§åˆ¶è¾“å‡ºï¼ˆå‰¯æœ¬æ•°è°ƒæ•´ï¼‰
- Kï¼šæ§åˆ¶å¢ç›Šï¼ˆHPA ç®—æ³•å‚æ•°ï¼‰
- d(t)ï¼šæ‰°åŠ¨é¡¹ï¼ˆè´Ÿè½½æ³¢åŠ¨ã€èŠ‚ç‚¹æ•…éšœï¼‰
```

**HPA æ§åˆ¶å™¨å·¥ä½œæµç¨‹**ï¼ˆå®¹å™¨ä¸ VM å¯¹æ¯”ï¼‰ï¼š

```mermaid
sequenceDiagram
    participant Metrics as Metrics Server
    participant HPA as HPA Controller
    participant API as K8s API
    participant Pod as Pod/VMI
    participant Node as Node Agent

    loop æ¯15ç§’
        HPA->>Metrics: GET /apis/metrics.k8s.io/v1beta1
        Metrics-->>HPA: CPU/Memoryä½¿ç”¨ç‡
        HPA->>HPA: è®¡ç®—æœŸæœ›å‰¯æœ¬æ•°<br/>desiredReplicas = ceil(currentReplicas * (currentMetricValue / desiredMetricValue))
    end

    alt å®¹å™¨ä¼¸ç¼©
        HPA->>API: PATCH /deployments/scale
        API->>Pod: åˆ›å»º/åˆ é™¤Pod
        Node->>Pod: kubeletå¯åŠ¨/ç»ˆæ­¢å®¹å™¨ï¼ˆç§’çº§ï¼‰
    else VMä¼¸ç¼©
        HPA->>API: PATCH /virtualmachineinstancereplicasets/scale
        API->>Pod: åˆ›å»º/åˆ é™¤VMI
        Node->>Pod: virt-handlerå¯åŠ¨VMIï¼ˆåˆ†é’Ÿçº§ï¼‰
        Note over Node,Pod: éœ€ç­‰å¾…GuestOSå¯åŠ¨
    end
```

---

### ä¼¸ç¼©å»¶è¿Ÿå·®å¼‚çš„æ ¹å› åˆ†æ

**å½¢å¼åŒ–å»¶è¿Ÿæ¨¡å‹**ï¼š

```text
è®¾ä¼¸ç¼©å»¶è¿Ÿä¸ºï¼š
T_scale = T_prepare + T_start + T_ready

å…¶ä¸­ï¼š
- T_prepareï¼šé•œåƒ/ç£ç›˜å‡†å¤‡æ—¶é—´
- T_startï¼šè¿è¡Œæ—¶å¯åŠ¨æ—¶é—´
- T_readyï¼šåº”ç”¨å°±ç»ªæ—¶é—´

å®¹å™¨å»¶è¿Ÿæ¨¡å‹ï¼š
T_container = T_image + T_fork + T_app
å…¶ä¸­ T_image âˆˆ [0, 5s], T_fork âˆˆ [1, 2s], T_app âˆˆ [5, 30s]

è™šæ‹Ÿæœºå»¶è¿Ÿæ¨¡å‹ï¼š
T_vm = T_disk + T_qemu + T_app
å…¶ä¸­ T_disk âˆˆ [30, 180s], T_qemu âˆˆ [20, 45s], T_app âˆˆ [5, 30s]

åŒæ„æ€§ï¼šT_container << T_vmï¼ˆ10-180 å€å·®å¼‚ï¼‰
```

| **é˜¶æ®µ**   | **å®¹å™¨è€—æ—¶**      | **è™šæ‹Ÿæœºè€—æ—¶**             | **API åŒæ„ä»£ä»·**     | **å½¢å¼åŒ–è¡¨ç¤º**      |
| ---------- | ----------------- | -------------------------- | -------------------- | ------------------- |
| é•œåƒå‡†å¤‡   | 0-5sï¼ˆå±‚ç¼“å­˜ï¼‰    | 30-180sï¼ˆç£ç›˜é•œåƒä¸‹è½½ï¼‰    | CDI é¢„åŠ è½½ä¼˜åŒ–       | T_image << T_disk   |
| è¿è¡Œæ—¶å¯åŠ¨ | 1-2sï¼ˆè¿›ç¨‹ forkï¼‰ | 20-45sï¼ˆQEMU åˆå§‹åŒ–+BIOSï¼‰ | ä½¿ç”¨ QEMU å¿«ç…§åŠ é€Ÿ   | T_fork << T_qemu    |
| åº”ç”¨å°±ç»ª   | 5-30sï¼ˆåº”ç”¨å¯åŠ¨ï¼‰ | 5-30sï¼ˆåº”ç”¨å¯åŠ¨ï¼‰          | ç»Ÿä¸€ ReadinessProbe  | T_app â‰ˆ T_app       |
| **æ€»è®¡**   | **6-37s**         | **55-255s**                | **ä¼¸ç¼©ç­–ç•¥éœ€å·®å¼‚åŒ–** | T_container << T_vm |

**æœç´¢ç»“æœéªŒè¯**ï¼š"å®¹å™¨è½»é‡ä¸”éƒ¨ç½²é€Ÿåº¦å¿«...è™šæ‹Ÿæœºæ¯ä¸ªå®ä¾‹çš„å¤§å°å¯èƒ½ä¸º GBï¼Œè€Œå®¹å™¨
çš„å¤§å°å¯èƒ½ä»…ä¸º MB" â†’ **ä¼¸ç¼©ç­–ç•¥å¿…é¡»è€ƒè™‘å¯åŠ¨æ—¶é—´å·®å¼‚**

---

## 3.2 è´Ÿè½½å‡è¡¡çš„ç»Ÿä¸€ä¸å·®å¼‚

### è´Ÿè½½å‡è¡¡å½¢å¼åŒ–æ¨¡å‹

**ç»Ÿä¸€è´Ÿè½½å‡è¡¡æŠ½è±¡**ï¼š

```text
è®¾è´Ÿè½½å‡è¡¡å™¨ä¸ºå‡½æ•°ï¼š
LB: Request â†’ Backend

å…¶ä¸­ï¼š
- Request âˆˆ {HTTP_Request, TCP_Connection, ...}
- Backend âˆˆ {Pod_IP:Port, VMI_IP:Port, ...}

è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
LB(request) = select_backend(request, backends, strategy)

å…¶ä¸­ strategy âˆˆ {RoundRobin, LeastConn, IPHash, ...}
```

**Service è´Ÿè½½å‡è¡¡æ¶æ„**ï¼š

```mermaid
graph LR
    subgraph "ç»Ÿä¸€æœåŠ¡æŠ½è±¡"
        A[Kubernetes Service] --> B[Endpoints Controller]
        B --> C[Endpointså¯¹è±¡]
        C --> D[IP:Portåˆ—è¡¨]
    end

    subgraph "åç«¯å®ç°å·®å¼‚"
        D --> E[å®¹å™¨Pod]
        D --> F[VMI via virt-handler]

        E --> G[kube-proxy iptables]
        F --> H[åå‘ä»£ç†æœºåˆ¶]

        G --> I[ç›´æ¥DNAT]
        H --> J[è½¬å‘åˆ°virt-launcher Pod]
        J --> K[QEMUç”¨æˆ·æ¨¡å¼ç½‘ç»œ]
        K --> L[GuestOSå†…åº”ç”¨]
    end

    subgraph "å¥åº·æ£€æŸ¥"
        M[ReadinessProbe] --> E
        N[Guest Agent] --> F
        N --> O[å‘¨æœŸæ€§Report]
        O --> P[VMI Conditionæ›´æ–°]
    end
```

---

### è´Ÿè½½å‡è¡¡æ€§èƒ½å¯¹æ¯”

**å½¢å¼åŒ–æ€§èƒ½æ¨¡å‹**ï¼š

```text
è®¾è´Ÿè½½å‡è¡¡æ€§èƒ½ä¸ºï¼š
P = (Latency, Throughput, Connections)

å®¹å™¨æ€§èƒ½ï¼š
P_container = (L_dnat, T_dnat, C_dnat)
å…¶ä¸­ L_dnat â‰ˆ 0.1ms, T_dnat â‰¥ 10Gbps, C_dnat â‰¥ 100k

è™šæ‹Ÿæœºæ€§èƒ½ï¼š
P_vm = (L_proxy, T_proxy, C_proxy)
å…¶ä¸­ L_proxy âˆˆ [0.5, 1ms], T_proxy âˆˆ [2, 5Gbps], C_proxy âˆˆ [20k, 50k]

æ€§èƒ½æŸå¤±ï¼š
Î”L = L_proxy / L_dnat â‰ˆ 5-10
Î”T = T_proxy / T_dnat â‰ˆ 0.2-0.5
Î”C = C_proxy / C_dnat â‰ˆ 0.2-0.5
```

| **æŒ‡æ ‡** | **å®¹å™¨ï¼ˆDNATï¼‰** | **è™šæ‹Ÿæœºï¼ˆåå‘ä»£ç†ï¼‰** | **æ€§èƒ½æŸå¤±** | **ä¼˜åŒ–æ–¹æ¡ˆ**     | **å½¢å¼åŒ–è¡¨ç¤º** |
| -------- | ---------------- | ---------------------- | ------------ | ---------------- | -------------- |
| å»¶è¿Ÿ     | 0.1ms            | 0.5-1ms                | 5-10 å€      | SR-IOV ç›´é€š      | Î”L â‰ˆ 5-10      |
| ååé‡   | 10Gbps+          | 2-5Gbps                | 50-80%       | DPDK åŠ é€Ÿ        | Î”T â‰ˆ 0.2-0.5   |
| è¿æ¥æ•°   | 100k+            | 20k-50k                | 50-80%       | ä½¿ç”¨ HostNetwork | Î”C â‰ˆ 0.2-0.5   |

**æœç´¢ç»“æœéªŒè¯**ï¼š"è”ç½‘éå¸¸å›°éš¾ï¼Œéœ€è¦ç½‘æ¡¥æˆ– macvlan é©±åŠ¨ç¨‹åºå°†å®¹å™¨ç½‘ç»œæ¥å£æ˜ å°„åˆ°
ä¸»æœºæ¥å£" â†’ KubeVirt é€šè¿‡`virt-handler`è§£å†³è¯¥é—®é¢˜ï¼Œä½†å¼•å…¥é¢å¤–è½¬å‘å¼€é”€

---

## ç›¸å…³æ–‡æ¡£

- [æ ¸å¿ƒåŠŸèƒ½æ¶æ„çŸ©é˜µå¯¹æ¯”](../01-core-architecture/01-architecture-matrix.md) - åŠŸ
  èƒ½åŸŸå¯¹æ¯”çŸ©é˜µ
- [ç³»ç»ŸåŠ¨æ€ç®¡ç†ä¸æ§åˆ¶çš„ç†è®ºæ˜ å°„](../11-theoretical-analysis/01-control-theory-mapping.md) -
  æ§åˆ¶ç†è®ºæ˜ å°„
- [å¤šç§Ÿæˆ·æ¶æ„æ·±åº¦å‰–æ](../11-theoretical-analysis/02-multi-tenant-architecture.md) -
  å¤šç§Ÿæˆ·æ¶æ„
- [å­˜å‚¨ IO è·¯å¾„çš„åŒæ„ä¸æ€§èƒ½åšå¼ˆ](../11-theoretical-analysis/04-storage-io-path.md) -
  å­˜å‚¨ IO è·¯å¾„

---

## 2025 å¹´æœ€æ–°å®è·µ

### åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†æœ€ä½³å®è·µï¼ˆ2025ï¼‰

**2025 å¹´è¶‹åŠ¿**ï¼šåŠ¨æ€è¿è¡Œæ—¶ç®¡ç†çš„æ·±åº¦ä¼˜åŒ–

**å®è·µè¦ç‚¹**ï¼š

- **å¼¹æ€§ä¼¸ç¼©**ï¼šä½¿ç”¨ HPA å®ç°å¼¹æ€§ä¼¸ç¼©
- **è´Ÿè½½å‡è¡¡**ï¼šä½¿ç”¨ Service å’Œ Ingress å®ç°è´Ÿè½½å‡è¡¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–ä¼¸ç¼©å»¶è¿Ÿå’Œè´Ÿè½½å‡è¡¡æ€§èƒ½

**ä»£ç ç¤ºä¾‹**ï¼š

```python
# 2025 å¹´åŠ¨æ€è¿è¡Œæ—¶ç®¡ç†å·¥å…·
class DynamicRuntimeManager:
    def __init__(self):
        self.hpa_manager = HPAManager()
        self.lb_manager = LoadBalancerManager()
        self.metrics_manager = MetricsManager()

    def manage_runtime(self, workload_config):
        """ç®¡ç†è¿è¡Œæ—¶"""
        # å¼¹æ€§ä¼¸ç¼©
        hpa = self.hpa_manager.create_hpa(workload_config)

        # è´Ÿè½½å‡è¡¡
        lb = self.lb_manager.create_load_balancer(workload_config)

        # æ€§èƒ½ç›‘æ§
        metrics = self.metrics_manager.collect_metrics(workload_config)

        return hpa, lb, metrics
```

## å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå¼¹æ€§ä¼¸ç¼©é…ç½®ï¼ˆ2025ï¼‰

**åœºæ™¯**ï¼šä½¿ç”¨ HPA å®ç°å¼¹æ€§ä¼¸ç¼©

**å®ç°æ–¹æ¡ˆ**ï¼š

```yaml
# HPA é…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app
  minReplicas: 1
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

**æ•ˆæœ**ï¼š

- å¼¹æ€§ä¼¸ç¼©ï¼šä½¿ç”¨ HPA å®ç°å¼¹æ€§ä¼¸ç¼©
- è´Ÿè½½å‡è¡¡ï¼šä½¿ç”¨ Service å’Œ Ingress å®ç°è´Ÿè½½å‡è¡¡
- æ€§èƒ½ä¼˜åŒ–ï¼šä¼˜åŒ–ä¼¸ç¼©å»¶è¿Ÿå’Œè´Ÿè½½å‡è¡¡æ€§èƒ½

---

**æœ€åæ›´æ–°**ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
