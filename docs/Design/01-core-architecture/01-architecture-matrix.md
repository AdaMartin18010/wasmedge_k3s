# ä¸€ã€æ ¸å¿ƒåŠŸèƒ½æ¶æ„çŸ©é˜µå¯¹æ¯”

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1 **æœ€åæ›´æ–°ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

---

## ğŸ“‘ ç›®å½•

- [ä¸€ã€æ ¸å¿ƒåŠŸèƒ½æ¶æ„çŸ©é˜µå¯¹æ¯”](#ä¸€æ ¸å¿ƒåŠŸèƒ½æ¶æ„çŸ©é˜µå¯¹æ¯”)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [åŠŸèƒ½åŸŸå¯¹æ¯”çŸ©é˜µ](#åŠŸèƒ½åŸŸå¯¹æ¯”çŸ©é˜µ)
    - [æ ¸å¿ƒæ¶æ„å±‚å¯¹æ¯”](#æ ¸å¿ƒæ¶æ„å±‚å¯¹æ¯”)
    - [æ€§èƒ½ä¸èµ„æºå¯¹æ¯”](#æ€§èƒ½ä¸èµ„æºå¯¹æ¯”)
    - [å®‰å…¨ä¸éš”ç¦»å¯¹æ¯”](#å®‰å…¨ä¸éš”ç¦»å¯¹æ¯”)
    - [è¿ç»´ä¸ç®¡ç†å¯¹æ¯”](#è¿ç»´ä¸ç®¡ç†å¯¹æ¯”)
  - [è®¾è®¡åŒæ„æ€§åˆ†æ](#è®¾è®¡åŒæ„æ€§åˆ†æ)
    - [API å…¥å£å±‚åŒæ„æ€§](#api-å…¥å£å±‚åŒæ„æ€§)
    - [æ§åˆ¶å¹³é¢åŒæ„æ€§](#æ§åˆ¶å¹³é¢åŒæ„æ€§)
    - [èŠ‚ç‚¹ä»£ç†åŒæ„æ€§](#èŠ‚ç‚¹ä»£ç†åŒæ„æ€§)
    - [è¿è¡Œæ—¶éš”ç¦»åŒæ„æ€§](#è¿è¡Œæ—¶éš”ç¦»åŒæ„æ€§)
  - [å…³é”®æŠ€æœ¯è¦ç‚¹](#å…³é”®æŠ€æœ¯è¦ç‚¹)
    - [1. CRD æ‰©å±•æœºåˆ¶](#1-crd-æ‰©å±•æœºåˆ¶)
    - [2. æ§åˆ¶å™¨æ¨¡å¼](#2-æ§åˆ¶å™¨æ¨¡å¼)
    - [3. DaemonSet éƒ¨ç½²](#3-daemonset-éƒ¨ç½²)
    - [4. Pod æ˜ å°„æœºåˆ¶](#4-pod-æ˜ å°„æœºåˆ¶)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## æ¦‚è¿°

åŸºäº Kubernetes ç”Ÿæ€çš„è™šæ‹ŸåŒ–å®¹å™¨åŒ–é›†ç¾¤ç®¡ç† API å±•ç°å‡ºé«˜åº¦çš„åŒæ„æ€§è®¾è®¡ã€‚ä»¥ä¸‹ä»å¤š
ç»´åº¦è¿›è¡Œç³»ç»Ÿæ€§æ¢³ç†ï¼š

## åŠŸèƒ½åŸŸå¯¹æ¯”çŸ©é˜µ

### æ ¸å¿ƒæ¶æ„å±‚å¯¹æ¯”

| **åŠŸèƒ½åŸŸ**     | **Kubernetes åŸç”Ÿ**     | **KubeVirt æ‰©å±•**               | **OpenShift CNV å¢å¼º**      | **åä¸ºäº‘ UCS** | **è®¾è®¡åŒæ„æ€§**           |
| -------------- | ----------------------- | ------------------------------- | --------------------------- | -------------- | ------------------------ |
| **API å…¥å£å±‚** | kube-apiserver          | virt-api (RESTful)              | cnstack-virt-api            | VMRuntime API  | ç»Ÿä¸€ REST é£æ ¼ï¼ŒCRD æ‰©å±• |
| **æ§åˆ¶å¹³é¢**   | kube-controller-manager | virt-controller                 | OpenShift æ§åˆ¶å™¨            | UCS ç»Ÿä¸€æ§åˆ¶å™¨ | æ§åˆ¶å™¨æ¨¡å¼å¤ç”¨           |
| **èŠ‚ç‚¹ä»£ç†**   | kubelet                 | virt-handler (DaemonSet)        | virt-handler                | èŠ‚ç‚¹ä»£ç†       | DaemonSet éƒ¨ç½²æ¨¡å¼       |
| **è¿è¡Œæ—¶éš”ç¦»** | Container Runtime       | libvirt/QEMU                    | libvirt/QEMU                | KVM/QEMU       | Pod æ˜ å°„ä¸º VMI           |
| **ç½‘ç»œæ¨¡å‹**   | CNI æ’ä»¶                | Multus å¤šç½‘ç»œ                   | NetworkAttachmentDefinition | ç»Ÿä¸€ CNI       | å¤ç”¨ CNI ç”Ÿæ€            |
| **å­˜å‚¨æ¨¡å‹**   | CSI/PVC                 | CDI æ•°æ®å¯¼å…¥å™¨                  | CDI+æœ¬åœ° PV                 | ç»Ÿä¸€ CSI       | PVC å…±äº«æœºåˆ¶             |
| **å¤šç§Ÿæˆ·**     | Namespace+RBAC          | å¤ç”¨ K8s æœºåˆ¶                   | IAM Gateway                 | ç»Ÿä¸€ IAM       | å®Œå…¨å¤ç”¨ K8s åŸè¯­        |
| **é…é¢ç®¡ç†**   | ResourceQuota           | å¤ç”¨ K8s é…é¢                   | CPU/å†…å­˜é™åˆ¶æ‰©å±•            | ç»Ÿä¸€é…é¢       | åŒæ„çº¦æŸ                 |
| **æ‰©ç¼©å®¹**     | HPA/VPA                 | VMIRS æ§åˆ¶å™¨                    | æ‰‹åŠ¨+è‡ªåŠ¨æ‰©ç¼©å®¹             | VM å¼¹æ€§ä¼¸ç¼©    | ç»Ÿä¸€ä¼¸ç¼©æ¥å£             |
| **è´Ÿè½½å‡è¡¡**   | Service/Ingress         | å¤ç”¨ Service                    | ä¸ Pod å…±äº« LB              | ç»Ÿä¸€ Service   | å®Œå…¨ä¸€è‡´                 |
| **åŠ¨æ€è¿ç§»**   | Pod é‡å»º                | VirtualMachineInstanceMigration | å®æ—¶è¿ç§»(Migration CRD)     | çƒ­è¿ç§»æ”¯æŒ     | æ–°å¢è¿ç§» CRD             |
| **é…ç½®ç®¡ç†**   | ConfigMap/Secret        | CloudInitNoCloud                | cloud-init é›†æˆ             | ç»Ÿä¸€é…ç½®       | å¤ç”¨ K8s é…ç½®            |

### æ€§èƒ½ä¸èµ„æºå¯¹æ¯”

| **ç»´åº¦**      | **å®¹å™¨**          | **è™šæ‹Ÿæœº**            | **æ€§èƒ½å·®å¼‚** | **ä¼˜åŒ–æ–¹æ¡ˆ**           |
| ------------- | ----------------- | --------------------- | ------------ | ---------------------- |
| **å¯åŠ¨æ—¶é—´**  | 1-5 ç§’            | 30-180 ç§’             | 10-180 å€    | VM æ± ã€å¿«ç…§å¯åŠ¨        |
| **å†…å­˜å¼€é”€**  | 10-100MB          | 100MB-2GBï¼ˆGuestOSï¼‰  | 10-200 å€    | å†…å­˜æ°”çƒã€å…±äº«å†…å­˜     |
| **CPU å¼€é”€**  | 1-5%              | 5-15%ï¼ˆè™šæ‹ŸåŒ–å±‚ï¼‰     | 5-15%        | CPU Pinningã€NUMA æ„ŸçŸ¥ |
| **ç½‘ç»œå»¶è¿Ÿ**  | 0.1ms             | 0.5-1msï¼ˆç”¨æˆ·æ€ç½‘ç»œï¼‰ | 5-10 å€      | SR-IOV ç›´é€š            |
| **å­˜å‚¨ IOPS** | 95% è£¸æœºæ€§èƒ½      | 70% è£¸æœºæ€§èƒ½ï¼ˆQCOW2ï¼‰ | 25% æŸå¤±     | Raw æ ¼å¼ã€å—è®¾å¤‡ç›´é€š   |
| **èµ„æºå¯†åº¦**  | 100-1000 Pod/èŠ‚ç‚¹ | 10-50 VM/èŠ‚ç‚¹         | 10-100 å€    | è½»é‡çº§ VMã€å®¹å™¨åŒ– VM   |

### å®‰å…¨ä¸éš”ç¦»å¯¹æ¯”

| **ç»´åº¦**       | **å®¹å™¨**             | **è™šæ‹Ÿæœº**                   | **éš”ç¦»å¼ºåº¦** | **å®‰å…¨åŠ å›ºæ–¹æ¡ˆ**           |
| -------------- | -------------------- | ---------------------------- | ------------ | -------------------------- |
| **å†…æ ¸éš”ç¦»**   | å…±äº«å†…æ ¸ï¼ˆCVE é£é™©ï¼‰ | ç‹¬ç«‹å†…æ ¸ï¼ˆå®Œå…¨éš”ç¦»ï¼‰         | å¼± vs å¼º     | Seccompã€AppArmorã€SELinux |
| **èµ„æºå¯è§æ€§** | /proc ä¿¡æ¯æ³„æ¼é£é™©   | å®Œå…¨éš”ç¦»                     | å¼± vs å¼º     | å‘½åç©ºé—´éš”ç¦»ã€cgroup é™åˆ¶  |
| **ç½‘ç»œéš”ç¦»**   | NetworkPolicy        | vSwitch ç‹¬ç«‹ + NetworkPolicy | ä¸­ vs å¼º     | Multus å¤šç½‘ç»œå¹³é¢          |
| **å­˜å‚¨éš”ç¦»**   | OverlayFS è”åˆæŒ‚è½½   | å—è®¾å¤‡éš”ç¦»                   | ä¸­ vs å¼º     | PVC åˆ†ç¦»ã€åŠ å¯†å­˜å‚¨         |
| **æ€§èƒ½å¹²æ‰°**   | noisy neighbor é—®é¢˜  | æ— å¹²æ‰°ï¼ˆå®Œå…¨éš”ç¦»ï¼‰           | æœ‰ vs æ—      | CPU Managerã€èµ„æºé¢„ç•™      |
| **é€ƒé€¸é£é™©**   | å®¹å™¨é€ƒé€¸ï¼ˆCVEï¼‰      | è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆæä½ï¼‰           | ä¸­ vs æä½   | å®‰å…¨åŠ å›ºã€æœ€å°æƒé™åŸåˆ™     |

### è¿ç»´ä¸ç®¡ç†å¯¹æ¯”

| **ç»´åº¦**     | **å®¹å™¨**           | **è™šæ‹Ÿæœº**                      | **ç»Ÿä¸€æ–¹æ¡ˆ**        |
| ------------ | ------------------ | ------------------------------- | ------------------- |
| **ç›‘æ§æŒ‡æ ‡** | cgroup ç»Ÿè®¡        | libvirt ç»Ÿè®¡ + GuestOS ç›‘æ§     | Prometheus ç»Ÿä¸€é‡‡é›† |
| **æ—¥å¿—é‡‡é›†** | å®¹å™¨æ—¥å¿—ï¼ˆstdoutï¼‰ | VM ä¸²å£æ—¥å¿— + virt-handler ä»£ç† | EFK Stack ç»Ÿä¸€é‡‡é›†  |
| **äº‹ä»¶ç®¡ç†** | Kubernetes Events  | Kubernetes Events + è¿ç§»äº‹ä»¶    | ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿ        |
| **CLI å·¥å…·** | kubectl            | virtctl/vmctl                   | ç»Ÿä¸€ CLI å·¥å…·       |
| **è°ƒåº¦ç­–ç•¥** | é€šç”¨è°ƒåº¦å™¨         | NUMA æ„ŸçŸ¥è°ƒåº¦                   | è°ƒåº¦å™¨æ‰©å±•          |
| **æ•…éšœæ¢å¤** | RestartPolicy      | QEMU watchdog + çƒ­è¿ç§»          | ç»Ÿä¸€æ¢å¤ç­–ç•¥        |

---

## è®¾è®¡åŒæ„æ€§åˆ†æ

### API å…¥å£å±‚åŒæ„æ€§

**ç»Ÿä¸€ REST é£æ ¼ï¼ŒCRD æ‰©å±•**ï¼š

- **Kubernetes åŸç”Ÿ**ï¼š`kube-apiserver` æä¾›ç»Ÿä¸€çš„ RESTful API æ¥å£
- **KubeVirt æ‰©å±•**ï¼š`virt-api` é€šè¿‡ CRD æ‰©å±• Kubernetes APIï¼Œä¿æŒ REST é£æ ¼ä¸€è‡´
  æ€§
- **OpenShift CNV**ï¼š`cnstack-virt-api` åœ¨ OpenShift å¹³å°ä¸Šæä¾›å¢å¼ºçš„è™šæ‹Ÿæœº API
- **åä¸ºäº‘ UCS**ï¼š`VMRuntime API` æä¾›ç»Ÿä¸€çš„è™šæ‹Ÿæœºè¿è¡Œæ—¶ API

**åŒæ„è®¾è®¡è¦ç‚¹**ï¼š

1. **API é£æ ¼ç»Ÿä¸€**ï¼šæ‰€æœ‰å®ç°éƒ½éµå¾ª RESTful API è®¾è®¡è§„èŒƒ
2. **CRD æ‰©å±•æœºåˆ¶**ï¼šé€šè¿‡ Kubernetes CRD æœºåˆ¶æ‰©å±• APIï¼Œä¸ä¿®æ”¹æ ¸å¿ƒä»£ç 
3. **å‘åå…¼å®¹**ï¼šä¿æŒä¸ Kubernetes åŸç”Ÿ API çš„å…¼å®¹æ€§

### æ§åˆ¶å¹³é¢åŒæ„æ€§

**æ§åˆ¶å™¨æ¨¡å¼å¤ç”¨**ï¼š

- **Kubernetes åŸç”Ÿ**ï¼š`kube-controller-manager` ä½¿ç”¨æ§åˆ¶å™¨æ¨¡å¼ç®¡ç†èµ„æº
- **KubeVirt æ‰©å±•**ï¼š`virt-controller` å¤ç”¨ Kubernetes æ§åˆ¶å™¨æ¨¡å¼
- **OpenShift CNV**ï¼šOpenShift æ§åˆ¶å™¨æ‰©å±• KubeVirt æ§åˆ¶å™¨åŠŸèƒ½
- **åä¸ºäº‘ UCS**ï¼šUCS ç»Ÿä¸€æ§åˆ¶å™¨ç®¡ç†å®¹å™¨å’Œè™šæ‹Ÿæœºèµ„æº

**åŒæ„è®¾è®¡è¦ç‚¹**ï¼š

1. **æ§åˆ¶å™¨æ¨¡å¼**ï¼šæ‰€æœ‰å®ç°éƒ½ä½¿ç”¨å£°æ˜å¼ API + æ§åˆ¶å™¨å¾ªç¯æ¨¡å¼
2. **çŠ¶æ€åŒæ­¥**ï¼šé€šè¿‡ Watch API ç›‘å¬èµ„æºå˜åŒ–ï¼Œå®ç°æœŸæœ›çŠ¶æ€ä¸å®é™…çŠ¶æ€çš„åŒæ­¥
3. **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäº Kubernetes Events æœºåˆ¶å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„

### èŠ‚ç‚¹ä»£ç†åŒæ„æ€§

**DaemonSet éƒ¨ç½²æ¨¡å¼**ï¼š

- **Kubernetes åŸç”Ÿ**ï¼š`kubelet` ä½œä¸ºèŠ‚ç‚¹ä»£ç†ï¼Œç®¡ç† Pod ç”Ÿå‘½å‘¨æœŸ
- **KubeVirt æ‰©å±•**ï¼š`virt-handler` ä½œä¸º DaemonSet éƒ¨ç½²ï¼Œç®¡ç† VMI ç”Ÿå‘½å‘¨æœŸ
- **OpenShift CNV**ï¼š`virt-handler` åœ¨ OpenShift èŠ‚ç‚¹ä¸Šè¿è¡Œ
- **åä¸ºäº‘ UCS**ï¼šèŠ‚ç‚¹ä»£ç†ç»Ÿä¸€ç®¡ç†å®¹å™¨å’Œè™šæ‹Ÿæœºèµ„æº

**åŒæ„è®¾è®¡è¦ç‚¹**ï¼š

1. **DaemonSet éƒ¨ç½²**ï¼šæ‰€æœ‰èŠ‚ç‚¹ä»£ç†éƒ½é€šè¿‡ DaemonSet æ–¹å¼éƒ¨ç½²
2. **çŠ¶æ€åŒæ­¥**ï¼šèŠ‚ç‚¹ä»£ç†å®šæœŸåŒæ­¥èµ„æºçŠ¶æ€åˆ° API Server
3. **å¥åº·æ£€æŸ¥**ï¼šé€šè¿‡å¥åº·æ£€æŸ¥æœºåˆ¶ç¡®ä¿èŠ‚ç‚¹ä»£ç†æ­£å¸¸è¿è¡Œ

### è¿è¡Œæ—¶éš”ç¦»åŒæ„æ€§

**Pod æ˜ å°„ä¸º VMI**ï¼š

- **Kubernetes åŸç”Ÿ**ï¼šContainer Runtime ç®¡ç†å®¹å™¨è¿è¡Œæ—¶
- **KubeVirt æ‰©å±•**ï¼šlibvirt/QEMU ç®¡ç†è™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œé€šè¿‡ virt-launcher Pod æ˜ å°„
- **OpenShift CNV**ï¼šlibvirt/QEMU åœ¨ OpenShift å¹³å°ä¸Šè¿è¡Œ
- **åä¸ºäº‘ UCS**ï¼šKVM/QEMU æä¾›è™šæ‹Ÿæœºè¿è¡Œæ—¶æ”¯æŒ

**åŒæ„è®¾è®¡è¦ç‚¹**ï¼š

1. **Pod æ˜ å°„**ï¼šæ¯ä¸ª VMI å¯¹åº”ä¸€ä¸ª virt-launcher Podï¼Œå®ç° 1:1 æ˜ å°„
2. **è¿è¡Œæ—¶æŠ½è±¡**ï¼šé€šè¿‡ CRI æ¥å£ç»Ÿä¸€ç®¡ç†å®¹å™¨å’Œè™šæ‹Ÿæœºè¿è¡Œæ—¶
3. **èµ„æºéš”ç¦»**ï¼šé€šè¿‡ cgroup å’Œ namespace å®ç°èµ„æºéš”ç¦»

---

## å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. CRD æ‰©å±•æœºåˆ¶

KubeVirt é€šè¿‡ CRD æ‰©å±• Kubernetes APIï¼Œä¸ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼š

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: virtualmachines.kubevirt.io
spec:
  group: kubevirt.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Namespaced
  names:
    plural: virtualmachines
    singular: virtualmachine
    kind: VirtualMachine
```

### 2. æ§åˆ¶å™¨æ¨¡å¼

æ‰€æœ‰æ§åˆ¶å™¨éƒ½éµå¾ª Kubernetes æ§åˆ¶å™¨æ¨¡å¼ï¼š

```go
// æ§åˆ¶å™¨å¾ªç¯
for {
    // 1. è·å–æœŸæœ›çŠ¶æ€ï¼ˆSpecï¼‰
    desired := getDesiredState(key)

    // 2. è·å–å®é™…çŠ¶æ€ï¼ˆStatusï¼‰
    actual := getActualState(key)

    // 3. è®¡ç®—å·®å¼‚ï¼ˆDeltaï¼‰
    delta := computeDelta(desired, actual)

    // 4. æ‰§è¡Œè°ƒè°ï¼ˆReconcileï¼‰
    reconcile(delta)
}
```

### 3. DaemonSet éƒ¨ç½²

virt-handler é€šè¿‡ DaemonSet éƒ¨ç½²åˆ°æ¯ä¸ªèŠ‚ç‚¹ï¼š

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: virt-handler
spec:
  selector:
    matchLabels:
      kubevirt.io: virt-handler
  template:
    metadata:
      labels:
        kubevirt.io: virt-handler
    spec:
      containers:
        - name: virt-handler
          image: kubevirt/virt-handler:latest
```

### 4. Pod æ˜ å°„æœºåˆ¶

æ¯ä¸ª VMI å¯¹åº”ä¸€ä¸ª virt-launcher Podï¼š

```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
metadata:
  name: test-vmi
spec:
  domain:
    resources:
      requests:
        memory: "1Gi"
        cpu: "1"
```

å¯¹åº”çš„ virt-launcher Podï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: virt-launcher-test-vmi-xxxxx
  labels:
    kubevirt.io: virt-launcher
spec:
  containers:
    - name: compute
      image: kubevirt/virt-launcher:latest
```

---

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„æ€ç»´å¯¼å›¾](../01-core-architecture/02-system-architecture.md) - ç³»ç»Ÿæ¶
  æ„å¯è§†åŒ–
- [æ ¸å¿ƒåŠŸèƒ½çŸ¥è¯†å›¾è°±](../01-core-architecture/03-knowledge-graph.md) - åŠŸèƒ½çŸ¥è¯†å›¾
  è°±
- [ç½‘ç»œåŠŸèƒ½åŒæ„çŸ©é˜µ](../02-isomorphic-functions/01-network-isomorphism.md) - ç½‘
  ç»œåŠŸèƒ½åŒæ„åˆ†æ
- [å­˜å‚¨åŠŸèƒ½åŒæ„çŸ©é˜µ](../02-isomorphic-functions/02-storage-isomorphism.md) - å­˜
  å‚¨åŠŸèƒ½åŒæ„åˆ†æ
- [å¤šç§Ÿæˆ·ä¸é…é¢åŒæ„](../02-isomorphic-functions/03-multi-tenant-quota.md) - å¤šç§Ÿ
  æˆ·é…é¢åŒæ„åˆ†æ
- [è¿è¡Œæ—¶ç®¡ç†åŒæ„](../02-isomorphic-functions/04-runtime-management.md) - è¿è¡Œæ—¶
  ç®¡ç†åŒæ„åˆ†æ

---

**æœ€åæ›´æ–°ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
