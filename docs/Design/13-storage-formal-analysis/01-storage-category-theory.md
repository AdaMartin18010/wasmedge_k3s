# ä¸€ã€å­˜å‚¨æ¥å£çš„å‡½å­åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0 **æœ€åæ›´æ–°ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

---

## ğŸ“‘ ç›®å½•

- [ä¸€ã€å­˜å‚¨æ¥å£çš„å‡½å­åŒ–](#ä¸€å­˜å‚¨æ¥å£çš„å‡½å­åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [ä¸€ã€å­˜å‚¨èŒƒç•´ S çš„å®šä¹‰](#ä¸€å­˜å‚¨èŒƒç•´-s-çš„å®šä¹‰)
    - [1.1 å¯¹è±¡ï¼ˆObjectsï¼‰å®šä¹‰](#11-å¯¹è±¡objectså®šä¹‰)
    - [1.2 æ€å°„ï¼ˆMorphismsï¼‰å®šä¹‰](#12-æ€å°„morphismså®šä¹‰)
    - [1.3 æ€å°„å¤åˆå¾‹](#13-æ€å°„å¤åˆå¾‹)
  - [äºŒã€CSI å‡½å­æ˜ å°„](#äºŒcsi-å‡½å­æ˜ å°„)
    - [2.1 CSI å‡½å­å®šä¹‰](#21-csi-å‡½å­å®šä¹‰)
    - [2.2 CSI æ“ä½œç±»å‹](#22-csi-æ“ä½œç±»å‹)
    - [2.3 CSI å‡½å­çš„è‡ªç„¶æ€§](#23-csi-å‡½å­çš„è‡ªç„¶æ€§)
  - [ä¸‰ã€å­˜å‚¨å·çš„ç±»å‹è®ºæ„é€ ](#ä¸‰å­˜å‚¨å·çš„ç±»å‹è®ºæ„é€ )
    - [3.1 è®¿é—®æ¨¡å¼çš„å’Œç±»å‹](#31-è®¿é—®æ¨¡å¼çš„å’Œç±»å‹)
    - [3.2 å·æ¨¡å¼çš„å’Œç±»å‹](#32-å·æ¨¡å¼çš„å’Œç±»å‹)
    - [3.3 ä¾èµ–ç±»å‹è¯æ˜](#33-ä¾èµ–ç±»å‹è¯æ˜)
  - [å››ã€æ€§èƒ½èŒƒç•´çš„æ‹‰å›æ„é€ ](#å››æ€§èƒ½èŒƒç•´çš„æ‹‰å›æ„é€ )
    - [4.1 æ‹‰å›å›¾å®šä¹‰](#41-æ‹‰å›å›¾å®šä¹‰)
    - [4.2 æµ‹åº¦å‡½å­](#42-æµ‹åº¦å‡½å­)
    - [4.3 æ€§èƒ½æ˜ å°„](#43-æ€§èƒ½æ˜ å°„)
  - [äº”ã€å½¢å¼åŒ–éªŒè¯](#äº”å½¢å¼åŒ–éªŒè¯)
    - [5.1 ç±»å‹å®‰å…¨æ€§éªŒè¯](#51-ç±»å‹å®‰å…¨æ€§éªŒè¯)
    - [5.2 è®¿é—®æ¨¡å¼éªŒè¯](#52-è®¿é—®æ¨¡å¼éªŒè¯)
  - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»**èŒƒç•´è®º**å’Œ**ç±»å‹è®º**çš„è§†è§’å½¢å¼åŒ–åˆ†æè™šæ‹ŸåŒ–å®¹å™¨åŒ–é›†ç¾¤ç®¡ç†ä¸­çš„å­˜å‚¨ç³»ç»Ÿï¼Œ
å°†å­˜å‚¨å·ã€å­˜å‚¨æ¥å£ã€IO è·¯å¾„ç­‰æ¦‚å¿µæŠ½è±¡ä¸ºèŒƒç•´è®ºä¸­çš„å¯¹è±¡ã€æ€å°„ã€å‡½å­ç­‰æ•°å­¦ç»“æ„ï¼Œå»º
ç«‹ä¸¥æ ¼çš„æ•°å­¦æ¨¡å‹ã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨èŒƒç•´è®ºå’Œç±»å‹è®ºåˆ†æå­˜å‚¨ç³»ç»Ÿï¼Ÿ**

èŒƒç•´è®ºå’Œç±»å‹è®ºæä¾›äº†ç»Ÿä¸€çš„æ•°å­¦æ¡†æ¶æ¥æè¿°å­˜å‚¨ç³»ç»Ÿçš„ç»“æ„å’Œè¡Œä¸ºï¼š

1. **ç»Ÿä¸€æŠ½è±¡**ï¼šå°†å­˜å‚¨å·ã€å­˜å‚¨æ¥å£ã€å­˜å‚¨æ“ä½œç­‰æŠ½è±¡ä¸ºèŒƒç•´ä¸­çš„å¯¹è±¡å’Œæ€å°„ï¼Œå®ç°ç»Ÿ
   ä¸€çš„æ•°å­¦æè¿°
2. **ç»“æ„ä¿æŒ**ï¼šé€šè¿‡å‡½å­ä¿æŒå­˜å‚¨æ“ä½œçš„ç»“æ„ï¼Œç¡®ä¿å­˜å‚¨è½¬æ¢çš„æ­£ç¡®æ€§
3. **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡ç±»å‹è®ºç¡®ä¿å­˜å‚¨å·çš„è®¿é—®æ¨¡å¼å’Œå·æ¨¡å¼çš„ç±»å‹å®‰å…¨æ€§

**èŒƒç•´è®ºå’Œç±»å‹è®ºåœ¨å­˜å‚¨ç³»ç»Ÿä¸­çš„åº”ç”¨**ï¼š

- **å¯¹è±¡ï¼ˆObjectsï¼‰**ï¼šå­˜å‚¨å·ã€æŒä¹…åŒ–å·ã€æŒä¹…åŒ–å·å£°æ˜ã€å­˜å‚¨ç±»ã€å·å¿«ç…§ã€å·é™„åŠ 
- **æ€å°„ï¼ˆMorphismsï¼‰**ï¼šå­˜å‚¨æ“ä½œï¼Œå¦‚åˆ›å»ºå·ã€åˆ é™¤å·ã€é™„åŠ å·ã€åˆ†ç¦»å·ã€æŒ‚è½½å·ã€å¸
  è½½å·ã€åˆ›å»ºå¿«ç…§ã€æ¢å¤å¿«ç…§
- **å‡½å­ï¼ˆFunctorsï¼‰**ï¼šCSI é©±åŠ¨ï¼Œå°†å­˜å‚¨å·æ˜ å°„åˆ° Kubernetes
- **ç±»å‹ï¼ˆTypesï¼‰**ï¼šè®¿é—®æ¨¡å¼ã€å·æ¨¡å¼çš„å’Œç±»å‹

**æ ¸å¿ƒå†…å®¹**ï¼š

1. **å­˜å‚¨èŒƒç•´ S**ï¼šå®šä¹‰å­˜å‚¨å·ã€å­˜å‚¨æ¥å£ã€å­˜å‚¨æ“ä½œç­‰ä¸ºèŒƒç•´å¯¹è±¡å’Œæ€å°„
2. **CSI å‡½å­æ˜ å°„**ï¼šCSI é©±åŠ¨ä½œä¸ºå‡½å­ `CSI: S â†’ K8s`
3. **å­˜å‚¨å·çš„ç±»å‹è®ºæ„é€ **ï¼šè®¿é—®æ¨¡å¼ã€å·æ¨¡å¼çš„å’Œç±»å‹
4. **æ€§èƒ½èŒƒç•´çš„æ‹‰å›æ„é€ **ï¼šå­˜å‚¨ IO æ€§èƒ½é€šè¿‡æ‹‰å›å‡½å­æ˜ å°„
5. **å½¢å¼åŒ–éªŒè¯**ï¼šç±»å‹å®‰å…¨æ€§ã€è®¿é—®æ¨¡å¼éªŒè¯

---

## ä¸€ã€å­˜å‚¨èŒƒç•´ S çš„å®šä¹‰

### 1.1 å¯¹è±¡ï¼ˆObjectsï¼‰å®šä¹‰

**å­˜å‚¨èŒƒç•´** **S** çš„å¯¹è±¡ä¸ºå­˜å‚¨å·ï¼š

```haskell
-- å­˜å‚¨å·ç±»å‹
data Volume = Volume {
    volumeId :: VolumeId,
    capacity :: Capacity,
    accessMode :: AccessMode,
    volumeMode :: VolumeMode
}

-- å­˜å‚¨å¯¹è±¡ç±»å‹
data StorageObject =
    PersistentVolume PVId
  | PersistentVolumeClaim PVCId
  | StorageClass SCId
  | VolumeSnapshot SnapshotId
  | VolumeAttachment AttachmentId
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
Obj(S) = {Volume, PersistentVolume, PersistentVolumeClaim, StorageClass, VolumeSnapshot, VolumeAttachment}
```

å…¶ä¸­ï¼š

- **Volume**ï¼šå­˜å‚¨å·ï¼ŒåŒ…å«å· IDã€å®¹é‡ã€è®¿é—®æ¨¡å¼ã€å·æ¨¡å¼
- **PersistentVolume**ï¼šæŒä¹…åŒ–å·ï¼Œé›†ç¾¤çº§åˆ«çš„å­˜å‚¨èµ„æº
- **PersistentVolumeClaim**ï¼šæŒä¹…åŒ–å·å£°æ˜ï¼Œç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚
- **StorageClass**ï¼šå­˜å‚¨ç±»ï¼Œæè¿°å­˜å‚¨çš„"ç±»åˆ«"
- **VolumeSnapshot**ï¼šå·å¿«ç…§ï¼Œå­˜å‚¨å·çš„æ—¶é—´ç‚¹å‰¯æœ¬
- **VolumeAttachment**ï¼šå·é™„åŠ ï¼Œå°†å·é™„åŠ åˆ°èŠ‚ç‚¹

**ä¸ºä»€ä¹ˆå°†å­˜å‚¨å·å®šä¹‰ä¸ºèŒƒç•´å¯¹è±¡ï¼Ÿ**

å°†å­˜å‚¨å·å®šä¹‰ä¸ºèŒƒç•´å¯¹è±¡æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç»Ÿä¸€æŠ½è±¡**ï¼šæ‰€æœ‰å­˜å‚¨å®ä½“éƒ½åœ¨åŒä¸€ä¸ªæ•°å­¦ç»“æ„ä¸­ï¼Œä¾¿äºç»Ÿä¸€åˆ†æå’ŒéªŒè¯
2. **å…³ç³»æ˜ç¡®**ï¼šé€šè¿‡æ€å°„ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®æè¿°å­˜å‚¨å·ä¹‹é—´çš„å…³ç³»
3. **ç»„åˆæ€§**ï¼šé€šè¿‡æ€å°„å¤åˆï¼Œæˆ‘ä»¬å¯ä»¥æè¿°å¤æ‚çš„å­˜å‚¨æ“ä½œ

**å­˜å‚¨å¯¹è±¡çš„æ•°å­¦æ€§è´¨**ï¼š

å­˜å‚¨å¯¹è±¡å…·æœ‰ä»¥ä¸‹æ•°å­¦æ€§è´¨ï¼š

1. **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªå­˜å‚¨å¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆå¦‚ VolumeIdã€PVIdã€PVCId ç­‰ï¼‰
2. **å¯ç»„åˆæ€§**ï¼šå­˜å‚¨å¯¹è±¡å¯ä»¥é€šè¿‡æ€å°„ç»„åˆå½¢æˆå¤æ‚çš„å­˜å‚¨æ“ä½œ
3. **å¯éªŒè¯æ€§**ï¼šå­˜å‚¨å¯¹è±¡çš„æ€§è´¨å¯ä»¥é€šè¿‡å½¢å¼åŒ–æ–¹æ³•éªŒè¯

**å­˜å‚¨å¯¹è±¡çš„å®é™…åº”ç”¨**ï¼š

å­˜å‚¨å¯¹è±¡åœ¨å®é™…åº”ç”¨ä¸­æœ‰ä»¥ä¸‹ç”¨é€”ï¼š

1. **å­˜å‚¨ç®¡ç†**ï¼šé€šè¿‡å­˜å‚¨å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç®¡ç†å­˜å‚¨èµ„æº
2. **å­˜å‚¨æ“ä½œ**ï¼šé€šè¿‡å­˜å‚¨å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå­˜å‚¨æ“ä½œ
3. **å­˜å‚¨éªŒè¯**ï¼šé€šè¿‡å­˜å‚¨å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯å­˜å‚¨ç³»ç»Ÿçš„æ­£ç¡®æ€§

### 1.2 æ€å°„ï¼ˆMorphismsï¼‰å®šä¹‰

**æ€å°„**ï¼šå­˜å‚¨æ“ä½œ `StorageOperation: StorageObject â†’ StorageObject`

```haskell
-- å­˜å‚¨æ“ä½œæ€å°„
data StorageMorphism =
    CreateVolume VolumeSpec -> Volume
  | DeleteVolume VolumeId -> ()
  | AttachVolume (VolumeId, NodeId) -> VolumeAttachment
  | DetachVolume VolumeAttachment -> ()
  | MountVolume (VolumeId, Path) -> MountPoint
  | UnmountVolume MountPoint -> ()
  | CreateSnapshot VolumeId -> VolumeSnapshot
  | RestoreSnapshot VolumeSnapshot -> Volume
```

**æ€å°„ç±»å‹**ï¼š

| **æ€å°„åç§°**        | **ç±»å‹ç­¾å**                      | **å®ç°æŠ€æœ¯** | **èŒƒç•´è®ºè§£é‡Š** |
| ------------------- | --------------------------------- | ------------ | -------------- |
| **CreateVolume**    | `VolumeSpec â†’ Volume`             | CSI Create   | åˆ›å»ºå­˜å‚¨å·     |
| **DeleteVolume**    | `VolumeId â†’ ()`                   | CSI Delete   | åˆ é™¤å­˜å‚¨å·     |
| **AttachVolume**    | `(VolumeId, NodeId) â†’ Attachment` | CSI Attach   | å°†å·é™„åŠ åˆ°èŠ‚ç‚¹ |
| **DetachVolume**    | `Attachment â†’ ()`                 | CSI Detach   | ä»èŠ‚ç‚¹åˆ†ç¦»å·   |
| **MountVolume**     | `(VolumeId, Path) â†’ MountPoint`   | CSI Mount    | æŒ‚è½½å·åˆ°è·¯å¾„   |
| **UnmountVolume**   | `MountPoint â†’ ()`                 | CSI Unmount  | å¸è½½å·         |
| **CreateSnapshot**  | `VolumeId â†’ Snapshot`             | CSI Snapshot | åˆ›å»ºå·å¿«ç…§     |
| **RestoreSnapshot** | `Snapshot â†’ Volume`               | CSI Restore  | ä»å¿«ç…§æ¢å¤å·   |

**æ€å°„å¤åˆå¾‹**ï¼š

```text
UnmountVolume âˆ˜ MountVolume âˆ˜ AttachVolume: VolumeId â†’ MountPoint
```

**ä¸ºä»€ä¹ˆæ€å°„å¤åˆå¾‹é‡è¦ï¼Ÿ**

æ€å°„å¤åˆå¾‹å…è®¸æˆ‘ä»¬æè¿°å¤æ‚çš„å­˜å‚¨æ“ä½œï¼Œä¾‹å¦‚ï¼š

1. **å·é™„åŠ è·¯å¾„**ï¼š`AttachVolume: (VolumeId, NodeId) â†’ VolumeAttachment`
2. **å·æŒ‚è½½è·¯
   å¾„**ï¼š`MountVolume âˆ˜ AttachVolume: (VolumeId, NodeId, Path) â†’ MountPoint`
3. **å®Œæ•´çš„å­˜å‚¨è·¯
   å¾„**ï¼š`UnmountVolume âˆ˜ MountVolume âˆ˜ AttachVolume: VolumeId â†’ MountPoint`

**æ€å°„å¤åˆçš„æ•°å­¦æ€§è´¨**ï¼š

æ€å°„å¤åˆæ»¡è¶³ä»¥ä¸‹æ•°å­¦æ€§è´¨ï¼š

1. **ç»“åˆå¾‹**ï¼šå¯¹äºä»»æ„æ€å°„ `f: A â†’ B`ã€`g: B â†’ C`ã€`h: C â†’ D`ï¼Œæœ‰
   `(h âˆ˜ g) âˆ˜ f = h âˆ˜ (g âˆ˜ f)`
2. **å•ä½å¾‹**ï¼šå¯¹äºä»»æ„å¯¹è±¡ `A`ï¼Œå­˜åœ¨å•ä½æ€å°„ `id_A: A â†’ A`ï¼Œä½¿å¾—å¯¹äºä»»æ„æ€å°„
   `f: A â†’ B`ï¼Œæœ‰ `f âˆ˜ id_A = f = id_B âˆ˜ f`

**æ€å°„å¤åˆçš„å®é™…åº”ç”¨**ï¼š

æ€å°„å¤åˆåœ¨å®é™…åº”ç”¨ä¸­æœ‰ä»¥ä¸‹ç”¨é€”ï¼š

1. **å­˜å‚¨æ“ä½œæè¿°**ï¼šé€šè¿‡æ€å°„å¤åˆï¼Œæˆ‘ä»¬å¯ä»¥æè¿°å¤æ‚çš„å­˜å‚¨æ“ä½œ
2. **å­˜å‚¨è·¯å¾„åˆ†æ**ï¼šé€šè¿‡æ€å°„å¤åˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æå­˜å‚¨æ“ä½œçš„è·¯å¾„
3. **å­˜å‚¨æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡æ€å°„å¤åˆï¼Œæˆ‘ä»¬å¯ä»¥ä¼˜åŒ–å­˜å‚¨æ“ä½œçš„æ€§èƒ½

### 1.3 æ€å°„å¤åˆå¾‹

**å­˜å‚¨è·¯å¾„çš„æ€å°„å¤åˆ**ï¼š

```haskell
-- å®¹å™¨å­˜å‚¨è·¯å¾„
containerPath :: VolumeId -> NodeId -> Path -> MountPoint
containerPath = unmount âˆ˜ mount âˆ˜ attach âˆ˜ create

-- è™šæ‹Ÿæœºå­˜å‚¨è·¯å¾„
vmPath :: VolumeId -> NodeId -> Path -> MountPoint
vmPath = unmount âˆ˜ mount âˆ˜ stage âˆ˜ attach âˆ˜ create
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
å®¹å™¨å­˜å‚¨ï¼šCreateVolume âˆ˜ AttachVolume âˆ˜ MountVolume: VolumeSpec â†’ MountPoint
è™šæ‹Ÿæœºå­˜å‚¨ï¼šCreateVolume âˆ˜ AttachVolume âˆ˜ NodeStage âˆ˜ MountVolume: VolumeSpec â†’ MountPoint
```

**äº¤æ¢å¾‹éªŒè¯**ï¼š

```text
âˆ€v âˆˆ Volume, n âˆˆ Node:
MountVolume(AttachVolume(CreateVolume(v), n)) = MountPoint
```

---

## äºŒã€CSI å‡½å­æ˜ å°„

### 2.1 CSI å‡½å­å®šä¹‰

**CSI å‡½å­** `CSI: Storage â†’ Kubernetes`ï¼š

```haskell
-- CSI å‡½å­ç±»å‹
data CSIFunctor = CSI {
    createVolume :: VolumeCapability -> IO Volume,
    deleteVolume :: VolumeId -> IO (),
    controllerPublish :: (VolumeId, NodeId) -> IO (),
    controllerUnpublish :: (VolumeId, NodeId) -> IO (),
    nodeStage :: (VolumeId, StagePath) -> IO MountPoint,
    nodeUnstage :: (VolumeId, StagePath) -> IO (),
    nodePublish :: (MountPoint, TargetPath) -> IO (),
    nodeUnpublish :: (MountPoint, TargetPath) -> IO ()
}

-- CSI å‡½å­å®ä¾‹
instance Functor CSI where
    fmap f (CSI create delete attach detach stage unstage mount unmount) =
        CSI (f . create) delete attach detach stage unstage mount unmount
```

**å‡½å­æ˜ å°„å…³ç³»**ï¼š

```text
CSI: Storage â†’ Kubernetes
CSI(Volume) = (PV, PVC, Pod)
```

å…¶ä¸­ï¼š

- **è¾“å…¥å¯¹è±¡**ï¼š`Storage`ï¼ˆå­˜å‚¨å·ï¼‰
- **è¾“å‡ºå¯¹è±¡**ï¼š`Kubernetes`ï¼ˆK8s èµ„æºï¼‰

### 2.2 CSI æ“ä½œç±»å‹

**CSI æ“ä½œç±»å‹ç­¾å**ï¼š

```ocaml
(* CSIæ¥å£çš„ç±»å‹ç­¾å *)
type CSIOperation =
  | CreateVolume of VolumeCapability -> Volume
  | DeleteVolume of VolumeId -> unit
  | ControllerPublish of (VolumeId, NodeId) -> unit
  | ControllerUnpublish of (VolumeId, NodeId) -> unit
  | NodeStage of (VolumeId, StagePath) -> MountPoint
  | NodeUnstage of (VolumeId, StagePath) -> unit
  | NodePublish of (MountPoint, TargetPath) -> unit
  | NodeUnpublish of (MountPoint, TargetPath) -> unit
```

**å®¹å™¨å­˜å‚¨è·¯å¾„**ï¼š

```ocaml
(* å®¹å™¨å­˜å‚¨è·¯å¾„ *)
let container_path =
  CSI.NodePublish(vol, "/var/lib/kubelet/pods/...")
```

**è™šæ‹Ÿæœºå­˜å‚¨è·¯å¾„**ï¼š

```ocaml
(* è™šæ‹Ÿæœºå­˜å‚¨è·¯å¾„ *)
let vm_path =
  CSI.NodeStage(vol, "/var/lib/libvirt/images")
  >> QEMU.Mount(virtio_blk, "/dev/vda")
```

### 2.3 CSI å‡½å­çš„è‡ªç„¶æ€§

**CSI å‡½å­çš„è‡ªç„¶æ€§**ï¼š

```text
âˆ€vâ‚, vâ‚‚ âˆˆ Volume:
CSI(vâ‚ âˆ˜ vâ‚‚) = CSI(vâ‚) âˆ˜ CSI(vâ‚‚)
```

**CSI å‡½å­æ˜ å°„å›¾**ï¼š

```mermaid
graph LR
    A[VolumeSpec] -->|CSI.CreateVolume| B[Volume]
    B -->|CSI.ControllerPublish| C[VolumeAttachment]
    C -->|CSI.NodeStage| D[MountPoint]
    D -->|CSI.NodePublish| E[TargetPath]
```

---

## ä¸‰ã€å­˜å‚¨å·çš„ç±»å‹è®ºæ„é€ 

### 3.1 è®¿é—®æ¨¡å¼çš„å’Œç±»å‹

**è®¿é—®æ¨¡å¼çš„å’Œç±»å‹**ï¼š

```haskell
-- è®¿é—®æ¨¡å¼å’Œç±»å‹
data AccessMode =
    ReadWriteOnce  -- RWOï¼šå•èŠ‚ç‚¹è¯»å†™
  | ReadOnlyMany   -- ROMï¼šå¤šèŠ‚ç‚¹åªè¯»
  | ReadWriteMany  -- RWMï¼šå¤šèŠ‚ç‚¹è¯»å†™
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
AccessMode = ReadWriteOnce | ReadOnlyMany | ReadWriteMany
```

**ç±»å‹å®‰å…¨æ€§è¯æ˜**ï¼š

```haskell
-- ä¾èµ–ç±»å‹ç¡®ä¿è®¿é—®å®‰å…¨
mount :: (v: Volume) -> (m: AccessMode) ->
         {p: Path | validMode(v, m)} -> IO ()
```

### 3.2 å·æ¨¡å¼çš„å’Œç±»å‹

**å·æ¨¡å¼çš„å’Œç±»å‹**ï¼š

```haskell
-- å·æ¨¡å¼å’Œç±»å‹
data VolumeMode =
    Filesystem  -- æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼
  | Block       -- å—è®¾å¤‡æ¨¡å¼
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
VolumeMode = Filesystem | Block
```

**ç±»å‹å®‰å…¨æ€§è¯æ˜**ï¼š

```coq
(* å­˜å‚¨å·çš„ç±»å‹å®‰å…¨æ€§ *)
Inductive VolumeSafe : VolumeMode -> Type :=
| FilesystemSafe : forall fs, mounted fs -> VolumeSafe Filesystem
| BlockSafe : forall dev, exclusiveAccess dev -> VolumeSafe Block

(* å®¹å™¨å·æŒ‚è½½è¯æ˜ *)
Theorem container_mount_safe :
  forall vol, VolumeSafe (BlockMode vol) ->
  exists c, containerCanMount c vol.

(* è™šæ‹Ÿæœºç£ç›˜é™„åŠ è¯æ˜ *)
Theorem vm_attach_safe :
  forall vol, VolumeSafe (BlockMode vol) ->
  exists vm, vmCanAttach vm vol.
```

### 3.3 ä¾èµ–ç±»å‹è¯æ˜

**ä¾èµ–ç±»å‹ç­¾å**ï¼š

```haskell
-- ä¾èµ–ç±»å‹ç¡®ä¿è®¿é—®å®‰å…¨
mount :: (v: Volume) -> (m: AccessMode) ->
         {p: Path | validMode(v, m)} -> IO ()
```

**å½¢å¼åŒ–éªŒè¯**ï¼š

```text
âˆ€v âˆˆ Volume, m âˆˆ AccessMode:
validMode(v, m) â‡’ âˆƒp âˆˆ Path, mount(v, m, p) æˆåŠŸ
```

---

## å››ã€æ€§èƒ½èŒƒç•´çš„æ‹‰å›æ„é€ 

### 4.1 æ‹‰å›å›¾å®šä¹‰

**æ€§èƒ½èŒƒç•´çš„æ‹‰å›ï¼ˆPullbackï¼‰**ï¼šå­˜å‚¨ IO æ€§èƒ½é€šè¿‡æ‹‰å›å‡½å­
`Pullback(CSI) â†’ Performance` æ˜ å°„ï¼š

```mermaid
graph TD
    subgraph "å­˜å‚¨æ€§èƒ½æ‹‰å›å›¾"
        A[Storage] -->|T_IO| B[Performance]
        C[K8s] -->|Î¼| D[Latency]
        A -->|CSI| C
        B -->|measure| D
    end
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
           T_IO
S ---------> Perf
|            |
| CSI        | measure
v            v
K8s --------> Latency
           Î¼
```

å…¶ä¸­ï¼š

- **S**ï¼šå­˜å‚¨èŒƒç•´
- **K8s**ï¼šKubernetes èŒƒç•´
- **Perf**ï¼šæ€§èƒ½èŒƒç•´
- **Latency**ï¼šå»¶è¿ŸèŒƒç•´
- **T_IO**ï¼šIO æ€§èƒ½æ˜ å°„å‡½å­
- **Î¼**ï¼šæµ‹åº¦å‡½å­

### 4.2 æµ‹åº¦å‡½å­

**æµ‹åº¦å‡½å­** `Î¼: Performance â†’ Latency`ï¼š

```haskell
-- æµ‹åº¦å‡½å­ç±»å‹
data MeasureFunctor = Measure {
    measure :: Performance -> Latency,
    distribution :: Latency -> Distribution
}

-- æµ‹åº¦å‡½å­å®ä¾‹
instance Functor Measure where
    fmap f (Measure measure distribution) =
        Measure (f . measure) distribution
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
Î¼: Performance â†’ Latency
Î¼(p) = âˆ« latency(p) dÎ¼
```

### 4.3 æ€§èƒ½æ˜ å°„

**IO æ€§èƒ½æ˜ å°„å‡½å­** `T_IO: Storage â†’ Performance`ï¼š

```haskell
-- IO æ€§èƒ½æ˜ å°„å‡½å­ç±»å‹
data IOPerformanceFunctor = IOPerf {
    mapIO :: Storage -> Performance,
    measureLatency :: Storage -> Latency
}

-- IO æ€§èƒ½æ˜ å°„å‡½å­å®ä¾‹
instance Functor IOPerf where
    fmap f (IOPerf mapIO measureLatency) =
        IOPerf (f . mapIO) (f . measureLatency)
```

**å½¢å¼åŒ–å®šä¹‰**ï¼š

```text
T_IO: Storage â†’ Performance
T_IO(s) = (throughput(s), latency(s), iops(s))
```

---

## äº”ã€å½¢å¼åŒ–éªŒè¯

### 5.1 ç±»å‹å®‰å…¨æ€§éªŒè¯

**ç±»å‹å®‰å…¨æ€§å®šç†**ï¼š

```text
âˆ€v âˆˆ Volume, m âˆˆ AccessMode:
validMode(v, m) â‡’ mount(v, m) ç±»å‹å®‰å…¨
```

**è¯æ˜**ï¼šé€šè¿‡ä¾èµ–ç±»å‹ç³»ç»Ÿä¿è¯è®¿é—®æ¨¡å¼ä¸å·æ¨¡å¼çš„å…¼å®¹æ€§ã€‚

### 5.2 è®¿é—®æ¨¡å¼éªŒè¯

**è®¿é—®æ¨¡å¼ä¸€è‡´æ€§éªŒè¯**ï¼š

```text
â–¡(âˆ€v âˆˆ Volume, m âˆˆ AccessMode:
  mounted(v, m) â‡’ validMode(v, m))
```

ä¿è¯æ‰€æœ‰å·²æŒ‚è½½çš„å·éƒ½æ»¡è¶³è®¿é—®æ¨¡å¼çº¦æŸã€‚

**å·æ¨¡å¼ä¸€è‡´æ€§éªŒè¯**ï¼š

```text
â–¡(âˆ€v âˆˆ Volume, mode âˆˆ VolumeMode:
  attached(v, mode) â‡’ validMode(v, mode))
```

ä¿è¯æ‰€æœ‰å·²é™„åŠ çš„å·éƒ½æ»¡è¶³å·æ¨¡å¼çº¦æŸã€‚

---

## ç›¸å…³æ–‡æ¡£

- [å­˜å‚¨åŠŸèƒ½åŒæ„çŸ©é˜µ](../02-isomorphic-functions/02-storage-isomorphism.md) - å­˜
  å‚¨åŠŸèƒ½åŒæ„åˆ†æ
- [å­˜å‚¨ IO ä¼˜åŒ–](../09-performance-optimization/03-storage-io-optimization.md) -
  å­˜å‚¨ IO ä¼˜åŒ–ç­–ç•¥
- [å­˜å‚¨ IO è·¯å¾„çš„å½¢å¼åŒ–éªŒè¯](./02-storage-io-path.md) - å­˜å‚¨ IO è·¯å¾„éªŒè¯
- [åŠ¨æ€é…é¢æ§åˆ¶çš„èŒƒç•´è®ºå®ç°](./03-quota-control-category.md) - é…é¢æ§åˆ¶èŒƒç•´è®º
- [å­˜å‚¨æ€§èƒ½æµ‹åº¦ç©ºé—´](./04-storage-performance-measure.md) - å­˜å‚¨æ€§èƒ½æµ‹åº¦åˆ†æ

---

**æœ€åæ›´æ–°ï¼š2025-11-15 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
