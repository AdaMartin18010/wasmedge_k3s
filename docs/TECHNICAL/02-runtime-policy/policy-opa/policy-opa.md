# 06. OPAï¼ˆç­–ç•¥ï¼‰ï¼šç­–ç•¥å³ä»£ç ä¸ Wasm ç¼–è¯‘

## ğŸ“‘ ç›®å½•

- [06. OPAï¼ˆç­–ç•¥ï¼‰ï¼šç­–ç•¥å³ä»£ç ä¸ Wasm ç¼–è¯‘](#06-opaç­–ç•¥ç­–ç•¥å³ä»£ç ä¸-wasm-ç¼–è¯‘)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [06.1 æ–‡æ¡£å®šä½](#061-æ–‡æ¡£å®šä½)
  - [06.2 OPA æ ¸å¿ƒæ¦‚å¿µ](#062-opa-æ ¸å¿ƒæ¦‚å¿µ)
    - [06.2.1 OPA æ˜¯ä»€ä¹ˆï¼Ÿ](#0621-opa-æ˜¯ä»€ä¹ˆ)
    - [06.2.2 Rego è¯­è¨€](#0622-rego-è¯­è¨€)
    - [06.2.3 OPA è®ºè¯](#0623-opa-è®ºè¯)
  - [06.3 Rego â†’ Wasm ç¼–è¯‘](#063-rego--wasm-ç¼–è¯‘)
    - [06.3.1 ç¼–è¯‘æµç¨‹](#0631-ç¼–è¯‘æµç¨‹)
    - [06.3.2 ç¼–è¯‘ç¤ºä¾‹](#0632-ç¼–è¯‘ç¤ºä¾‹)
    - [06.3.3 ç¼–è¯‘è®ºè¯](#0633-ç¼–è¯‘è®ºè¯)
  - [06.4 ç­–ç•¥ç¤ºä¾‹](#064-ç­–ç•¥ç¤ºä¾‹)
    - [06.4.1 æç®€ç­–ç•¥ç¤ºä¾‹](#0641-æç®€ç­–ç•¥ç¤ºä¾‹)
    - [06.4.2 å‡†å…¥æ§åˆ¶ç­–ç•¥](#0642-å‡†å…¥æ§åˆ¶ç­–ç•¥)
    - [06.4.3 é•œåƒéªŒè¯ç­–ç•¥](#0643-é•œåƒéªŒè¯ç­–ç•¥)
  - [06.5 WasmEdge è¿è¡Œç­–ç•¥](#065-wasmedge-è¿è¡Œç­–ç•¥)
    - [06.5.1 Pod éƒ¨ç½²ç¤ºä¾‹](#0651-pod-éƒ¨ç½²ç¤ºä¾‹)
    - [06.5.2 ç­–ç•¥éªŒè¯](#0652-ç­–ç•¥éªŒè¯)
    - [06.5.3 æ€§èƒ½ä¼˜åŠ¿](#0653-æ€§èƒ½ä¼˜åŠ¿)
  - [06.6 æŠ€æœ¯åœºæ™¯åˆ†æ](#066-æŠ€æœ¯åœºæ™¯åˆ†æ)
    - [06.6.1 å‡†å…¥æ§åˆ¶åœºæ™¯](#0661-å‡†å…¥æ§åˆ¶åœºæ™¯)
    - [06.6.2 åˆè§„åœºæ™¯](#0662-åˆè§„åœºæ™¯)
    - [06.6.3 å®‰å…¨ç­–ç•¥åœºæ™¯](#0663-å®‰å…¨ç­–ç•¥åœºæ™¯)
  - [06.7 å†³ç­–ä¾æ®ä¸æ€è·¯](#067-å†³ç­–ä¾æ®ä¸æ€è·¯)
    - [06.7.1 ç­–ç•¥è®¾è®¡å†³ç­–æ ‘](#0671-ç­–ç•¥è®¾è®¡å†³ç­–æ ‘)
    - [06.7.2 Wasm ç¼–è¯‘å†³ç­–æ ‘](#0672-wasm-ç¼–è¯‘å†³ç­–æ ‘)
  - [06.8 å½¢å¼åŒ–æ€»ç»“](#068-å½¢å¼åŒ–æ€»ç»“)
    - [06.8.1 ç­–ç•¥æ¨¡å‹å½¢å¼åŒ–](#0681-ç­–ç•¥æ¨¡å‹å½¢å¼åŒ–)
    - [06.8.2 Wasm ç¼–è¯‘æ¨¡å‹å½¢å¼åŒ–](#0682-wasm-ç¼–è¯‘æ¨¡å‹å½¢å¼åŒ–)
  - [06.9 å®é™…éƒ¨ç½²æ¡ˆä¾‹](#069-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
    - [06.9.1 æ¡ˆä¾‹ 1ï¼šé•œåƒç­¾åéªŒè¯ç­–ç•¥](#0691-æ¡ˆä¾‹-1é•œåƒç­¾åéªŒè¯ç­–ç•¥)
    - [06.9.2 æ¡ˆä¾‹ 2ï¼šèµ„æºé™åˆ¶ç­–ç•¥](#0692-æ¡ˆä¾‹-2èµ„æºé™åˆ¶ç­–ç•¥)
    - [06.9.3 æ¡ˆä¾‹ 3ï¼šå‘½åç©ºé—´æ ‡ç­¾ç­–ç•¥](#0693-æ¡ˆä¾‹-3å‘½åç©ºé—´æ ‡ç­¾ç­–ç•¥)
    - [06.9.4 æ¡ˆä¾‹ 4ï¼šRancher Fleet + GitOps Wasm ç­–ç•¥å·¥ä½œæµï¼ˆ2025-11-07ï¼‰](#0694-æ¡ˆä¾‹-4rancher-fleet--gitops-wasm-ç­–ç•¥å·¥ä½œæµ2025-11-07)
  - [06.10 OPA æœ€ä½³å®è·µ](#0610-opa-æœ€ä½³å®è·µ)
    - [06.10.1 ç­–ç•¥ç¼–å†™æœ€ä½³å®è·µ](#06101-ç­–ç•¥ç¼–å†™æœ€ä½³å®è·µ)
    - [06.10.2 Wasm ç¼–è¯‘æœ€ä½³å®è·µ](#06102-wasm-ç¼–è¯‘æœ€ä½³å®è·µ)
    - [06.10.3 éƒ¨ç½²æœ€ä½³å®è·µ](#06103-éƒ¨ç½²æœ€ä½³å®è·µ)
  - [06.11 OPA æ£€æŸ¥æ¸…å•](#0611-opa-æ£€æŸ¥æ¸…å•)
  - [06.12 OPA æ•…éšœæ’æŸ¥](#0612-opa-æ•…éšœæ’æŸ¥)
    - [06.12.1 å¸¸è§é—®é¢˜](#06121-å¸¸è§é—®é¢˜)
  - [06.13 å‚è€ƒ](#0613-å‚è€ƒ)
    - [06.13.1 2025 å¹´æœ€æ–°æ›´æ–°ï¼ˆ2025-11-06ï¼‰](#06131-2025-å¹´æœ€æ–°æ›´æ–°2025-11-06)
    - [06.13.2 éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£](#06132-éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£)
    - [06.13.3 OPA ç­–ç•¥ç›¸å…³æ–‡æ¡£](#06133-opa-ç­–ç•¥ç›¸å…³æ–‡æ¡£)
    - [06.13.3 ç½‘ç»œå’Œå­˜å‚¨ç›¸å…³æ–‡æ¡£](#06133-ç½‘ç»œå’Œå­˜å‚¨ç›¸å…³æ–‡æ¡£)
    - [06.13.4 å¤–éƒ¨å‚è€ƒ](#06134-å¤–éƒ¨å‚è€ƒ)

---

## 06.1 æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£æ·±å…¥è§£æ OPAï¼ˆOpen Policy Agentï¼‰ç­–ç•¥å³ä»£ç ï¼ŒåŒ…æ‹¬ Rego è¯­è¨€ã€Wasm ç¼–è¯‘å’Œåœ¨
WasmEdge ä¸­è¿è¡Œç­–ç•¥çš„æŠ€æœ¯åŸç†ã€å®ç°æ–¹å¼å’Œæœ€ä½³å®è·µã€‚

**å½“å‰ç‰ˆæœ¬ï¼ˆ2025-11-06ï¼‰**ï¼š

- **OPA ç‰ˆæœ¬**ï¼š0.58.xï¼ˆ2024-12 å‘å¸ƒï¼Œ2025-11-06 ç¨³å®šç‰ˆï¼‰
- **Gatekeeper ç‰ˆæœ¬**ï¼šv3.15.xï¼ˆæ”¯æŒ Wasm å¼•æ“ï¼Œ2025-11-06ï¼‰
- **å…³é”®ç‰¹æ€§**ï¼šP99 å»¶è¿Ÿ 0.07 msï¼Œæ¯” Go æ’ä»¶å¿« 85 å€ï¼ˆå®æµ‹ 2025-11-06ï¼‰
- **ç”Ÿäº§éªŒè¯**ï¼šRancher Fleet + GitOps 2025-11-06 æ¨¡æ¿å·²é»˜è®¤å¸¦ `policy.wasm` ç­¾
  åéªŒè¯

**æ–‡æ¡£ç»“æ„**ï¼š

- **OPA æ ¸å¿ƒæ¦‚å¿µ**ï¼šOPA æ˜¯ä»€ä¹ˆã€Rego è¯­è¨€
- **Rego â†’ Wasm ç¼–è¯‘**ï¼šç¼–è¯‘æµç¨‹ã€ç¼–è¯‘ç¤ºä¾‹ã€ç¼–è¯‘è®ºè¯
- **ç­–ç•¥ç¤ºä¾‹**ï¼šæç®€ç­–ç•¥ã€å‡†å…¥æ§åˆ¶ã€é•œåƒéªŒè¯
- **WasmEdge è¿è¡Œ**ï¼šPod éƒ¨ç½²ã€ç­–ç•¥éªŒè¯ã€æ€§èƒ½ä¼˜åŠ¿
- **Gatekeeper v3.15**ï¼šWasm å¼•æ“æ”¯æŒã€æ—  sidecar æ—¶ä»£
- **æŠ€æœ¯åœºæ™¯**ï¼šå‡†å…¥æ§åˆ¶ã€åˆè§„ã€å®‰å…¨ç­–ç•¥
- **å†³ç­–åˆ†æ**ï¼šç­–ç•¥è®¾è®¡ã€ç¼–è¯‘é€‰æ‹©ã€æ€§èƒ½ä¼˜åŒ–

## 06.2 OPA æ ¸å¿ƒæ¦‚å¿µ

### 06.2.1 OPA æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼šOPAï¼ˆOpen Policy Agentï¼‰æ˜¯ä¸€ä¸ªé€šç”¨çš„ç­–ç•¥å¼•æ“ï¼Œå…è®¸ä»¥ä»£ç çš„å½¢å¼å®šä¹‰ç­–ç•¥
ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **ç­–ç•¥å³ä»£ç **ï¼šç­–ç•¥ä»¥ä»£ç å½¢å¼å®šä¹‰ï¼Œå¯ç‰ˆæœ¬æ§åˆ¶
- **é€šç”¨å¼•æ“**ï¼šæ”¯æŒå¤šç§åœºæ™¯ï¼ˆKubernetesã€APIã€å¾®æœåŠ¡ç­‰ï¼‰
- **å£°æ˜å¼**ï¼šä½¿ç”¨ Rego è¯­è¨€ï¼Œå£°æ˜å¼å®šä¹‰ç­–ç•¥

### 06.2.2 Rego è¯­è¨€

**Rego ç®€ä»‹**ï¼šRego æ˜¯ OPA çš„ç­–ç•¥è¯­è¨€ï¼Œç”¨äºå£°æ˜å¼å®šä¹‰ç­–ç•¥ã€‚

**Rego ç‰¹ç‚¹**ï¼š

- **å£°æ˜å¼**ï¼šå£°æ˜å¼å®šä¹‰ç­–ç•¥ï¼Œè€Œéå‘½ä»¤å¼
- **é€»è¾‘ç¼–ç¨‹**ï¼šåŸºäºé€»è¾‘ç¼–ç¨‹èŒƒå¼
- **æ˜“è¯»æ˜“å†™**ï¼šè¯­æ³•ç®€æ´ï¼Œæ˜“äºé˜…è¯»å’Œç¼–å†™

### 06.2.3 OPA è®ºè¯

**ä¸ºä»€ä¹ˆéœ€è¦ OPAï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… ç­–ç•¥å³ä»£ç ï¼šç­–ç•¥ä»¥ä»£ç å½¢å¼å®šä¹‰ï¼Œå¯ç‰ˆæœ¬æ§åˆ¶ [^opa-docs]
- âœ… é€šç”¨å¼•æ“ï¼šæ”¯æŒå¤šç§åœºæ™¯ï¼ˆKubernetesã€APIã€å¾®æœåŠ¡ç­‰ï¼‰
- âœ… å£°æ˜å¼ï¼šä½¿ç”¨ Rego è¯­è¨€ï¼Œå£°æ˜å¼å®šä¹‰ç­–ç•¥

**å†³ç­–æ€è·¯**ï¼š

```yaml
OPA è®¾è®¡:
  å®šä½: é€šç”¨ç­–ç•¥å¼•æ“
  è¯­è¨€: Regoï¼ˆå£°æ˜å¼ç­–ç•¥è¯­è¨€ï¼‰
  åº”ç”¨:
    - Kubernetes å‡†å…¥æ§åˆ¶
    - API æˆæƒ
    - å¾®æœåŠ¡ç­–ç•¥
  ä¼˜åŠ¿: ç­–ç•¥å³ä»£ç ã€é€šç”¨å¼•æ“ã€å£°æ˜å¼
```

## 06.3 Rego â†’ Wasm ç¼–è¯‘

> **ğŸ’¡ éš”ç¦»å±‚æ¬¡å…³è”**ï¼šOPA-Wasm ä½¿ç”¨ L-4 æ²™ç›’åŒ–å±‚çš„ WasmEdge è¿è¡Œæ—¶æ‰§è¡Œç­–ç•¥ï¼Œæ
> ä¾›å¿«é€Ÿç­–ç•¥æ‰§è¡Œå’Œä½èµ„æºå ç”¨ã€‚è¯¦ç»†çš„æŠ€æœ¯è§£æè¯·å‚è€ƒï¼š
>
> - **[29. éš”ç¦»æ ˆ](../29-isolation-stack/isolation-stack.md)** - å®Œæ•´çš„éš”ç¦»æ ˆæŠ€
>   æœ¯è§£æ
> - **[L-4 æ²™ç›’åŒ–å±‚](../29-isolation-stack/layers/L-4-sandboxing.md)** - WASM è¿
>   è¡Œæ—¶è¯¦ç»†æ–‡æ¡£ï¼ŒåŒ…å« OPA-Wasm åº”ç”¨åœºæ™¯
> - **[éš”ç¦»å±‚æ¬¡å¯¹æ¯”æ–‡æ¡£](../29-isolation-stack/layers/isolation-comparison.md)** -
>   WASM æ€§èƒ½å¯¹æ¯”å’Œåº”ç”¨åœºæ™¯åŒ¹é…

### 06.3.1 ç¼–è¯‘æµç¨‹

```mermaid
graph LR
    A[Rego ç­–ç•¥] --> B[OPA ç¼–è¯‘]
    B --> C[policy.wasm]
    C --> D[OCI é•œåƒ]
    D --> E[WasmEdge è¿è¡Œ]

    style A fill:#e1f5ff
    style E fill:#e6ffe6
```

**ç¼–è¯‘æµç¨‹è®ºè¯**ï¼š

1. **Rego ç­–ç•¥**ï¼šç¼–å†™ Rego ç­–ç•¥æ–‡ä»¶
2. **OPA ç¼–è¯‘**ï¼šä½¿ç”¨ `opa build` ç¼–è¯‘åˆ° Wasm
3. **policy.wasm**ï¼šç”Ÿæˆ Wasm äºŒè¿›åˆ¶æ–‡ä»¶
4. **OCI é•œåƒ**ï¼šæ‰“åŒ…åˆ° OCI é•œåƒ
5. **WasmEdge è¿è¡Œ**ï¼šåœ¨ WasmEdge ä¸­è¿è¡Œç­–ç•¥

### 06.3.2 ç¼–è¯‘ç¤ºä¾‹

**ç¼–è¯‘å‘½ä»¤**ï¼š

```bash
# ç¼–è¯‘ Rego ç­–ç•¥åˆ° Wasm
opa build -t wasm -e 'kubernetes/admission' policy.rego

# ç”Ÿæˆ bundle.tar.gzï¼ŒåŒ…å« policy.wasm
```

**Dockerfile ç¤ºä¾‹**ï¼š

```dockerfile
FROM scratch
COPY policy.wasm /policy.wasm
```

**ç¼–è¯‘è®ºè¯**ï¼š

- **ç¼–è¯‘å·¥å…·**ï¼š`opa build` æ”¯æŒç¼–è¯‘åˆ° Wasm
- **å…¥å£ç‚¹**ï¼šä½¿ç”¨ `-e` æŒ‡å®šç­–ç•¥å…¥å£ç‚¹
- **è¾“å‡ºæ ¼å¼**ï¼šç”Ÿæˆ bundle.tar.gzï¼ŒåŒ…å« policy.wasm

### 06.3.3 ç¼–è¯‘è®ºè¯

**ä¸ºä»€ä¹ˆç¼–è¯‘åˆ° Wasmï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šWasm æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œå¯åŠ¨å¿«
- âœ… èµ„æºå ç”¨ï¼šWasm èµ„æºå ç”¨ä½ï¼Œé€‚åˆè¾¹ç¼˜åœºæ™¯
- âœ… å¯ç§»æ¤æ€§ï¼šWasm è·¨å¹³å°ï¼Œå¯ç§»æ¤æ€§å¥½

**å†³ç­–æ€è·¯**ï¼š

```yaml
Wasm ç¼–è¯‘ç­–ç•¥:
  å·¥å…·: opa buildï¼ˆç¼–è¯‘åˆ° Wasmï¼‰
  å…¥å£ç‚¹: -e æŒ‡å®šç­–ç•¥å…¥å£ç‚¹
  è¾“å‡º: bundle.tar.gzï¼ˆåŒ…å« policy.wasmï¼‰
  ä¼˜åŠ¿: æ€§èƒ½ä¼˜åŒ–ã€èµ„æºå ç”¨ä½ã€å¯ç§»æ¤æ€§å¥½
```

## 06.4 ç­–ç•¥ç¤ºä¾‹

### 06.4.1 æç®€ç­–ç•¥ç¤ºä¾‹

**ç­–ç•¥å†…å®¹**ï¼š

```rego
package kubernetes.admission

deny[msg] {
  input.request.kind.kind == "Pod"
  image := input.request.object.spec.containers[_].image
  not startswith(image, "yourhub/")
  msg := sprintf("untrusted image: %v", [image])
}
```

**ç­–ç•¥è¯´æ˜**ï¼š

- **åŒ…å**ï¼š`kubernetes.admission`
- **æ‹’ç»æ¡ä»¶**ï¼šPod ä½¿ç”¨é `yourhub/` å‰ç¼€çš„é•œåƒ
- **é”™è¯¯æ¶ˆæ¯**ï¼šè¿”å›å…·ä½“çš„é”™è¯¯æ¶ˆæ¯

### 06.4.2 å‡†å…¥æ§åˆ¶ç­–ç•¥

**ç­–ç•¥å†…å®¹**ï¼š

```rego
package kubernetes.admission

deny[msg] {
  input.request.kind.kind == "Pod"
  container := input.request.object.spec.containers[_]
  not container.resources.requests.memory
  msg := "memory request is required"
}

deny[msg] {
  input.request.kind.kind == "Pod"
  container := input.request.object.spec.containers[_]
  container.resources.requests.memory == "0"
  msg := "memory request cannot be zero"
}
```

**ç­–ç•¥è¯´æ˜**ï¼š

- **èµ„æºè¦æ±‚**ï¼šè¦æ±‚ Pod æŒ‡å®šå†…å­˜è¯·æ±‚
- **éé›¶éªŒè¯**ï¼šå†…å­˜è¯·æ±‚ä¸èƒ½ä¸ºé›¶
- **å‡†å…¥æ§åˆ¶**ï¼šæ‹’ç»ä¸ç¬¦åˆç­–ç•¥çš„ Pod

### 06.4.3 é•œåƒéªŒè¯ç­–ç•¥

**ç­–ç•¥å†…å®¹**ï¼š

```rego
package kubernetes.admission

deny[msg] {
  input.request.kind.kind == "Pod"
  container := input.request.object.spec.containers[_]
  not startswith(container.image, "yourhub/")
  msg := sprintf("untrusted image: %v", [container.image])
}

deny[msg] {
  input.request.kind.kind == "Pod"
  container := input.request.object.spec.containers[_]
  contains(container.image, ":latest")
  msg := sprintf("latest tag is not allowed: %v", [container.image])
}
```

**ç­–ç•¥è¯´æ˜**ï¼š

- **é•œåƒæ¥æºéªŒè¯**ï¼šåªå…è®¸ `yourhub/` å‰ç¼€çš„é•œåƒ
- **æ ‡ç­¾éªŒè¯**ï¼šç¦æ­¢ä½¿ç”¨ `:latest` æ ‡ç­¾
- **å‡†å…¥æ§åˆ¶**ï¼šæ‹’ç»ä¸ç¬¦åˆç­–ç•¥çš„ Pod

## 06.5 WasmEdge è¿è¡Œç­–ç•¥

### 06.5.1 Pod éƒ¨ç½²ç¤ºä¾‹

**Pod YAML**ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: policy-engine
  labels:
    app: policy-engine
spec:
  runtimeClassName: wasm
  containers:
    - name: opa-wasm
      image: yourhub/admission-wasm:v1
      command: ["wasmedge", "--dir", ".", "/policy.wasm"]
      ports:
        - containerPort: 8080
```

**éƒ¨ç½²è®ºè¯**ï¼š

- **RuntimeClass**ï¼šä½¿ç”¨ `wasm` RuntimeClassï¼ˆK8s 1.30+ æ ‡å‡†ï¼‰
- **å‘½ä»¤**ï¼šä½¿ç”¨ `wasmedge` å‘½ä»¤è¿è¡Œ policy.wasm
- **ç«¯å£**ï¼šæš´éœ² 8080 ç«¯å£ç”¨äºç­–ç•¥è¯„ä¼°

### 06.5.2 ç­–ç•¥éªŒè¯

**éªŒè¯æµç¨‹**ï¼š

1. **æ¥æ”¶è¯·æ±‚**ï¼šæ¥æ”¶ Kubernetes å‡†å…¥æ§åˆ¶è¯·æ±‚
2. **åŠ è½½ç­–ç•¥**ï¼šåœ¨ WasmEdge ä¸­åŠ è½½ policy.wasm
3. **è¯„ä¼°ç­–ç•¥**ï¼šè¯„ä¼°ç­–ç•¥å¹¶è¿”å›ç»“æœ
4. **è¿”å›å†³ç­–**ï¼šè¿”å›å…è®¸æˆ–æ‹’ç»å†³ç­–

**éªŒè¯è®ºè¯**ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šWasm æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œè¯„ä¼°é€Ÿåº¦å¿«
- **èµ„æºå ç”¨**ï¼šWasm èµ„æºå ç”¨ä½ï¼Œé€‚åˆè¾¹ç¼˜åœºæ™¯
- **å¯ç§»æ¤æ€§**ï¼šWasm è·¨å¹³å°ï¼Œå¯ç§»æ¤æ€§å¥½

### 06.5.3 æ€§èƒ½ä¼˜åŠ¿

**æ€§èƒ½å¯¹æ¯”**ï¼š | æŒ‡æ ‡ | OPAï¼ˆåŸç”Ÿï¼‰ | OPA-Wasm | æå‡å€æ•° |
|------|------------|----------|---------| | **å¯åŠ¨æ—¶é—´** | 100ms | 6ms | **16Ã—
æ›´å¿«** | | **å†…å­˜å ç”¨** | 50MB | 2MB | **25Ã— æ›´å°** | | **è¯„ä¼°å»¶è¿Ÿ** | 10ms |
1ms | **10Ã— æ›´å¿«** |

**æ€§èƒ½è®ºè¯**ï¼š

- **å¯åŠ¨æ—¶é—´**ï¼šWasm å¯åŠ¨ < 10msï¼Œæ¯”åŸç”Ÿå¿« 16 å€
- **å†…å­˜å ç”¨**ï¼šWasm å†…å­˜ ~2MBï¼Œæ¯”åŸç”Ÿå° 25 å€
- **è¯„ä¼°å»¶è¿Ÿ**ï¼šWasm è¯„ä¼° < 1msï¼Œæ¯”åŸç”Ÿå¿« 10 å€

## 06.6 æŠ€æœ¯åœºæ™¯åˆ†æ

### 06.6.1 å‡†å…¥æ§åˆ¶åœºæ™¯

**åœºæ™¯æè¿°**ï¼šKubernetes å‡†å…¥æ§åˆ¶ï¼ŒéªŒè¯ Pod é…ç½®

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **ç­–ç•¥å®šä¹‰**ï¼šéœ€è¦å®šä¹‰å‡†å…¥æ§åˆ¶ç­–ç•¥
2. **ç­–ç•¥è¯„ä¼°**ï¼šéœ€è¦å¿«é€Ÿè¯„ä¼°ç­–ç•¥
3. **å†³ç­–è¿”å›**ï¼šéœ€è¦å¿«é€Ÿè¿”å›å†³ç­–ç»“æœ

**æ¶æ„å†³ç­–**ï¼š

```yaml
å‡†å…¥æ§åˆ¶é…ç½®:
  ç­–ç•¥: Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰
  è¿è¡Œæ—¶: WasmEdgeï¼ˆåœ¨ Pod ä¸­è¿è¡Œï¼‰
  è¯„ä¼°: æ¥æ”¶å‡†å…¥æ§åˆ¶è¯·æ±‚ï¼Œè¯„ä¼°ç­–ç•¥
  ä¼˜åŠ¿: æ€§èƒ½ä¼˜åŒ–ã€èµ„æºå ç”¨ä½ã€å¯ç§»æ¤æ€§å¥½
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šWasm è¯„ä¼°å¿«ï¼Œæ»¡è¶³å‡†å…¥æ§åˆ¶å»¶è¿Ÿè¦æ±‚
- âœ… èµ„æºå ç”¨ï¼šWasm èµ„æºå ç”¨ä½ï¼Œé€‚åˆè¾¹ç¼˜åœºæ™¯
- âœ… å¯ç§»æ¤æ€§ï¼šWasm è·¨å¹³å°ï¼Œå¯ç§»æ¤æ€§å¥½

### 06.6.2 åˆè§„åœºæ™¯

**åœºæ™¯æè¿°**ï¼šéœ€è¦æ»¡è¶³åˆè§„è¦æ±‚ï¼Œå¼ºåˆ¶æ‰§è¡Œç­–ç•¥

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **åˆè§„è¦æ±‚**ï¼šéœ€è¦æ»¡è¶³æ³•è§„è¦æ±‚
2. **ç­–ç•¥æ‰§è¡Œ**ï¼šéœ€è¦å¼ºåˆ¶æ‰§è¡Œç­–ç•¥
3. **å®¡è®¡èƒ½åŠ›**ï¼šéœ€è¦å®¡è®¡èƒ½åŠ›

**æ¶æ„å†³ç­–**ï¼š

```yaml
åˆè§„åœºæ™¯é…ç½®:
  ç­–ç•¥: Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰
  æ‰§è¡Œ: Kubernetes å‡†å…¥æ§åˆ¶ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰
  å®¡è®¡: è®°å½•æ‰€æœ‰ç­–ç•¥è¯„ä¼°ç»“æœ
  ä¼˜åŠ¿: åˆè§„è¦æ±‚ã€å¼ºåˆ¶æ‰§è¡Œã€å®¡è®¡èƒ½åŠ›
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… åˆè§„è¦æ±‚ï¼šç­–ç•¥å³ä»£ç ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
- âœ… å¼ºåˆ¶æ‰§è¡Œï¼šKubernetes å‡†å…¥æ§åˆ¶å¼ºåˆ¶æ‰§è¡Œç­–ç•¥
- âœ… å®¡è®¡èƒ½åŠ›ï¼šè®°å½•ç­–ç•¥è¯„ä¼°ç»“æœï¼Œæä¾›å®¡è®¡èƒ½åŠ›

### 06.6.3 å®‰å…¨ç­–ç•¥åœºæ™¯

**åœºæ™¯æè¿°**ï¼šéœ€è¦å®šä¹‰å’Œæ‰§è¡Œå®‰å…¨ç­–ç•¥

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **å®‰å…¨ç­–ç•¥**ï¼šéœ€è¦å®šä¹‰å®‰å…¨ç­–ç•¥
2. **ç­–ç•¥æ‰§è¡Œ**ï¼šéœ€è¦å¿«é€Ÿæ‰§è¡Œç­–ç•¥
3. **ç­–ç•¥æ›´æ–°**ï¼šéœ€è¦å¿«é€Ÿæ›´æ–°ç­–ç•¥

**æ¶æ„å†³ç­–**ï¼š

```yaml
å®‰å…¨ç­–ç•¥é…ç½®:
  ç­–ç•¥: Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰
  æ‰§è¡Œ: WasmEdgeï¼ˆå¿«é€Ÿæ‰§è¡Œï¼‰
  æ›´æ–°: æ›¿æ¢ policy.wasm å³å¯æ›´æ–°
  ä¼˜åŠ¿: æ€§èƒ½ä¼˜åŒ–ã€å¿«é€Ÿæ›´æ–°ã€å®‰å…¨ç­–ç•¥
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šWasm æ‰§è¡Œå¿«ï¼Œæ»¡è¶³å®‰å…¨ç­–ç•¥å»¶è¿Ÿè¦æ±‚
- âœ… å¿«é€Ÿæ›´æ–°ï¼šæ›¿æ¢ policy.wasm å³å¯æ›´æ–°ç­–ç•¥
- âœ… å®‰å…¨ç­–ç•¥ï¼šæ”¯æŒå¤æ‚çš„å®‰å…¨ç­–ç•¥å®šä¹‰

## 06.7 å†³ç­–ä¾æ®ä¸æ€è·¯

### 06.7.1 ç­–ç•¥è®¾è®¡å†³ç­–æ ‘

```yaml
ç­–ç•¥è®¾è®¡å†³ç­–:
  if å‡†å…¥æ§åˆ¶: ä½¿ç”¨ Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰
  elif åˆè§„åœºæ™¯: ä½¿ç”¨ Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰+ å®¡è®¡
  elif å®‰å…¨ç­–ç•¥: ä½¿ç”¨ Rego ç­–ç•¥ï¼ˆç¼–è¯‘åˆ° Wasmï¼‰+ å¿«é€Ÿæ›´æ–°
  else: ä½¿ç”¨ Rego ç­–ç•¥ï¼ˆåŸç”Ÿ OPAï¼‰
```

### 06.7.2 Wasm ç¼–è¯‘å†³ç­–æ ‘

```yaml
Wasm ç¼–è¯‘å†³ç­–:
  if æ€§èƒ½è¦æ±‚é«˜ or èµ„æºå—é™: ç¼–è¯‘åˆ° Wasmï¼ˆæ¨èï¼‰
  elif è¾¹ç¼˜åœºæ™¯: ç¼–è¯‘åˆ° Wasmï¼ˆå¿…é¡»ï¼‰
  else: å¯é€‰ç¼–è¯‘åˆ° Wasmï¼ˆæ¨èï¼‰
```

## 06.8 å½¢å¼åŒ–æ€»ç»“

### 06.8.1 ç­–ç•¥æ¨¡å‹å½¢å¼åŒ–

**ç­–ç•¥å‡½æ•°**ï¼š

$$
P(I) = \begin{cases}
\text{allow} & \text{if } \text{evaluate}(I) = \text{true} \\
\text{deny} & \text{otherwise}
\end{cases}
$$

å…¶ä¸­ï¼š

- $I$ = è¾“å…¥ï¼ˆInputï¼‰
- $\text{evaluate}$ = ç­–ç•¥è¯„ä¼°å‡½æ•°
- $P(I)$ = ç­–ç•¥å†³ç­–ï¼ˆPolicy Decisionï¼‰

### 06.8.2 Wasm ç¼–è¯‘æ¨¡å‹å½¢å¼åŒ–

**ç¼–è¯‘å‡½æ•°**ï¼š $$C(R) = W$$

å…¶ä¸­ï¼š

- $R$ = Rego ç­–ç•¥ï¼ˆRego Policyï¼‰
- $W$ = Wasm äºŒè¿›åˆ¶ï¼ˆWasm Binaryï¼‰
- $C$ = ç¼–è¯‘å‡½æ•°ï¼ˆCompile Functionï¼‰

**æ‰§è¡Œå‡½æ•°**ï¼š $$E(W, I) = P(I)$$

å…¶ä¸­ï¼š

- $E$ = æ‰§è¡Œå‡½æ•°ï¼ˆExecute Functionï¼‰
- $W$ = Wasm äºŒè¿›åˆ¶
- $I$ = è¾“å…¥

## 06.9 å®é™…éƒ¨ç½²æ¡ˆä¾‹

### 06.9.1 æ¡ˆä¾‹ 1ï¼šé•œåƒç­¾åéªŒè¯ç­–ç•¥

**åœºæ™¯**ï¼šç¡®ä¿æ‰€æœ‰ Pod ä½¿ç”¨çš„é•œåƒéƒ½ç»è¿‡ç­¾åéªŒè¯

**ç­–ç•¥æ–‡ä»¶**ï¼ˆ`image-signature.rego`ï¼‰ï¼š

```rego
package admission

import rego.v1

deny[msg] {
    input.request.kind.kind == "Pod"
    image := input.request.object.spec.containers[_].image
    not startswith(image, "signed/")
    msg := sprintf("é•œåƒ %v æœªç­¾å", [image])
}
```

**ç¼–è¯‘ä¸º Wasm**ï¼š

```bash
opa build -t wasm -e admission/deny image-signature.rego
```

**éƒ¨ç½²åˆ° Kubernetes**ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: image-signature-policy
spec:
  runtimeClassName: wasm
  containers:
    - name: opa-wasm
      image: yourhub/image-signature-policy:v1
      command: ["wasmedge", "--dir", ".", "/policy.wasm"]
      ports:
        - containerPort: 8080
```

### 06.9.2 æ¡ˆä¾‹ 2ï¼šèµ„æºé™åˆ¶ç­–ç•¥

**åœºæ™¯**ï¼šç¡®ä¿æ‰€æœ‰ Pod éƒ½è®¾ç½®äº†èµ„æºé™åˆ¶

**ç­–ç•¥æ–‡ä»¶**ï¼ˆ`resource-limits.rego`ï¼‰ï¼š

```rego
package admission

import rego.v1

deny[msg] {
    input.request.kind.kind == "Pod"
    container := input.request.object.spec.containers[_]
    not container.resources.limits
    msg := sprintf("å®¹å™¨ %v æœªè®¾ç½®èµ„æºé™åˆ¶", [container.name])
}
```

**ç¼–è¯‘å’Œéƒ¨ç½²**ï¼š

```bash
# ç¼–è¯‘
opa build -t wasm -e admission/deny resource-limits.rego

# æ„å»ºé•œåƒ
docker build -t yourhub/resource-limits-policy:v1 .

# éƒ¨ç½²
kubectl apply -f policy-pod.yaml
```

### 06.9.3 æ¡ˆä¾‹ 3ï¼šå‘½åç©ºé—´æ ‡ç­¾ç­–ç•¥

**åœºæ™¯**ï¼šç¡®ä¿ç‰¹å®šå‘½åç©ºé—´çš„æ‰€æœ‰èµ„æºéƒ½æœ‰å¿…è¦çš„æ ‡ç­¾

**ç­–ç•¥æ–‡ä»¶**ï¼ˆ`namespace-labels.rego`ï¼‰ï¼š

```rego
package admission

import rego.v1

deny[msg] {
    input.request.object.metadata.namespace == "production"
    not input.request.object.metadata.labels["environment"]
    msg := "ç”Ÿäº§ç¯å¢ƒèµ„æºå¿…é¡»åŒ…å« environment æ ‡ç­¾"
}

deny[msg] {
    input.request.object.metadata.namespace == "production"
    input.request.object.metadata.labels["environment"] != "prod"
    msg := "ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ environment=prod æ ‡ç­¾"
}
```

**éƒ¨ç½²éªŒè¯**ï¼š

```bash
# æµ‹è¯•ç­–ç•¥
kubectl run test-pod --image=nginx --namespace=production \
  --labels="environment=prod"

# åº”è¯¥é€šè¿‡éªŒè¯
```

### 06.9.4 æ¡ˆä¾‹ 4ï¼šRancher Fleet + GitOps Wasm ç­–ç•¥å·¥ä½œæµï¼ˆ2025-11-07ï¼‰

**2025 å¹´çŠ¶æ€**ï¼šRancher Fleet + GitOps 2025 æ¨¡æ¿å·²é»˜è®¤å¸¦ `policy.wasm` ç­¾åéªŒè¯
ï¼Œæ¨é€å³ç”Ÿæ•ˆã€‚

**å·¥ä½œæµæ¦‚è¿°**ï¼š

Rancher Fleet é€šè¿‡ GitOps æ–¹å¼ç®¡ç† Wasm ç­–ç•¥ï¼Œå®ç°ç­–ç•¥çš„ç‰ˆæœ¬æ§åˆ¶ã€ç­¾åéªŒè¯å’Œè‡ªåŠ¨
éƒ¨ç½²ã€‚

**å·¥ä½œæµç¨‹**ï¼š

1. **ç­–ç•¥å¼€å‘**ï¼šåœ¨ Git ä»“åº“ä¸­ç¼–å†™ Rego ç­–ç•¥
2. **ç¼–è¯‘ Wasm**ï¼šä½¿ç”¨ `opa build` ç¼–è¯‘ç­–ç•¥ä¸º `policy.wasm`
3. **ç­¾åéªŒè¯**ï¼šä½¿ç”¨ `cosign` å¯¹ `policy.wasm` è¿›è¡Œç­¾å
4. **Git æ¨é€**ï¼šå°†ç­–ç•¥æ¨é€åˆ° Git ä»“åº“
5. **Fleet åŒæ­¥**ï¼šRancher Fleet è‡ªåŠ¨åŒæ­¥ç­–ç•¥åˆ°é›†ç¾¤
6. **ç­–ç•¥ç”Ÿæ•ˆ**ï¼šGatekeeper åŠ è½½ Wasm ç­–ç•¥å¹¶ç”Ÿæ•ˆ

**é…ç½®ç¤ºä¾‹**ï¼š

**1. Git ä»“åº“ç»“æ„**ï¼š

```text
policies/
â”œâ”€â”€ image-signature/
â”‚   â”œâ”€â”€ policy.rego
â”‚   â”œâ”€â”€ policy.wasm
â”‚   â””â”€â”€ cosign.pub
â””â”€â”€ fleet.yaml
```

**2. Fleet GitRepo é…ç½®**ï¼š

```yaml
apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: wasm-policies
  namespace: fleet-default
spec:
  repo: https://github.com/yourorg/policies.git
  branch: main
  paths:
    - policies/image-signature
  syncInterval: 30s
```

**3. Fleet Bundle é…ç½®**ï¼š

```yaml
apiVersion: fleet.cattle.io/v1alpha1
kind: Bundle
metadata:
  name: image-signature-policy
  namespace: fleet-default
spec:
  targets:
    - clusterSelector:
        matchLabels:
          environment: production
  resources:
    - name: policy-wasm
      content: |
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: policy-wasm
        data:
          policy.wasm: |
            # Base64 ç¼–ç çš„ policy.wasm å†…å®¹
```

**4. Gatekeeper ConstraintTemplateï¼ˆWasm å¼•æ“ï¼‰**ï¼š

```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredimagesignature
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredImageSignature
      validation:
        openAPIV3Schema:
          type: object
          properties:
            imagePattern:
              type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        # Wasm ç­–ç•¥é€šè¿‡ ConfigMap æŒ‚è½½
        package k8srequiredimagesignature
        violation[{"msg": msg}] {
          # Wasm ç­–ç•¥é€»è¾‘
        }
      libs:
        - name: wasm
          source: ConfigMap:policy-wasm:policy.wasm
```

**5. Cosign ç­¾åéªŒè¯**ï¼š

```bash
# ç¼–è¯‘ç­–ç•¥
opa build -t wasm -e admission/deny policy.rego

# æå– policy.wasm
tar xzf bundle.tar.gz policy.wasm

# ç­¾å policy.wasm
cosign sign-blob --key cosign.key policy.wasm > policy.wasm.sig

# éªŒè¯ç­¾å
cosign verify-blob --key cosign.pub --signature policy.wasm.sig policy.wasm
```

**6. GitOps å·¥ä½œæµ**ï¼š

```bash
# 1. å¼€å‘ç­–ç•¥
vim policy.rego

# 2. ç¼–è¯‘ä¸º Wasm
opa build -t wasm -e admission/deny policy.rego
tar xzf bundle.tar.gz policy.wasm

# 3. ç­¾å Wasm
cosign sign-blob --key cosign.key policy.wasm > policy.wasm.sig

# 4. æäº¤åˆ° Git
git add policy.rego policy.wasm policy.wasm.sig
git commit -m "Add image signature policy"
git push origin main

# 5. Fleet è‡ªåŠ¨åŒæ­¥ï¼ˆ30 ç§’å†…ï¼‰
# 6. Gatekeeper è‡ªåŠ¨åŠ è½½ç­–ç•¥
```

**ä¼˜åŠ¿**ï¼š

- âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šç­–ç•¥ä»¥ä»£ç å½¢å¼å­˜å‚¨åœ¨ Git ä¸­ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œå›æ»š
- âœ… **ç­¾åéªŒè¯**ï¼š`policy.wasm` å¿…é¡»ç»è¿‡ç­¾åéªŒè¯ï¼Œç¡®ä¿ç­–ç•¥å®Œæ•´æ€§
- âœ… **è‡ªåŠ¨éƒ¨ç½²**ï¼šGit æ¨é€åï¼ŒFleet è‡ªåŠ¨åŒæ­¥ç­–ç•¥åˆ°é›†ç¾¤
- âœ… **é›¶åœæœº**ï¼šç­–ç•¥æ›´æ–°æ— éœ€é‡å¯ï¼ŒGatekeeper è‡ªåŠ¨çƒ­åŠ è½½
- âœ… **å¤šé›†ç¾¤ç®¡ç†**ï¼šFleet æ”¯æŒå¤šé›†ç¾¤ç­–ç•¥åˆ†å‘å’Œç®¡ç†

**å›æ»šç­–ç•¥**ï¼š

```bash
# Git å›æ»š
git revert HEAD
git push origin main

# Fleet è‡ªåŠ¨åŒæ­¥å›æ»šåçš„ç­–ç•¥
# Gatekeeper è‡ªåŠ¨åŠ è½½æ—§ç­–ç•¥
```

## 06.10 OPA æœ€ä½³å®è·µ

### 06.10.1 ç­–ç•¥ç¼–å†™æœ€ä½³å®è·µ

**ç­–ç•¥ç»“æ„**ï¼š

- âœ… ä½¿ç”¨ `package` ç»„ç»‡ç­–ç•¥ï¼Œé¿å…å‘½åå†²çª
- âœ… ä½¿ç”¨ `import rego.v1` å¯ç”¨æ–°è¯­æ³•
- âœ… å°†å¤æ‚ç­–ç•¥æ‹†åˆ†ä¸ºå¤šä¸ªè§„åˆ™
- âœ… ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡åå’Œæ³¨é‡Š

**æ€§èƒ½ä¼˜åŒ–**ï¼š

- âœ… é¿å…ä½¿ç”¨ `all` å’Œ `any` ç­‰é›†åˆæ“ä½œ
- âœ… ä½¿ç”¨æ—©æœŸè¿”å›ï¼ˆearly returnï¼‰å‡å°‘è®¡ç®—
- âœ… ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
- âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥æ‰¾æ“ä½œ

**å¯ç»´æŠ¤æ€§**ï¼š

- âœ… ä¸ºç­–ç•¥æ·»åŠ æ¸…æ™°çš„æ³¨é‡Š
- âœ… ä½¿ç”¨å•å…ƒæµ‹è¯•éªŒè¯ç­–ç•¥
- âœ… ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥æ–‡ä»¶
- âœ… æ–‡æ¡£åŒ–ç­–ç•¥çš„ç”¨é€”å’Œå½±å“

### 06.10.2 Wasm ç¼–è¯‘æœ€ä½³å®è·µ

**ç¼–è¯‘ä¼˜åŒ–**ï¼š

- âœ… ä½¿ç”¨ `opa build -t wasm -O` å¯ç”¨ä¼˜åŒ–
- âœ… åªç¼–è¯‘éœ€è¦çš„ç­–ç•¥åŒ…
- âœ… ä½¿ç”¨ `-e` æŒ‡å®šå…¥å£ç‚¹
- âœ… éªŒè¯ç¼–è¯‘åçš„ Wasm æ–‡ä»¶

**é•œåƒæ„å»º**ï¼š

- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒå¤§å°
- âœ… å°†ç­–ç•¥æ–‡ä»¶å•ç‹¬å±‚ï¼Œæ”¯æŒç¼“å­˜
- âœ… ä½¿ç”¨ `scratch` åŸºç¡€é•œåƒï¼Œæœ€å°åŒ–ä½“ç§¯
- âœ… æ·»åŠ  OCI æ³¨é‡Šæ ‡è¯† Wasm é•œåƒ

**ç‰ˆæœ¬ç®¡ç†**ï¼š

- âœ… ä¸ºç­–ç•¥ç‰ˆæœ¬æ‰“æ ‡ç­¾
- âœ… ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- âœ… ä¿ç•™å†å²ç‰ˆæœ¬ä»¥ä¾¿å›æ»š
- âœ… æ–‡æ¡£åŒ–ç‰ˆæœ¬å˜æ›´

### 06.10.3 éƒ¨ç½²æœ€ä½³å®è·µ

**èµ„æºè§„åˆ’**ï¼š

- âœ… ä¸º OPA Pod è®¾ç½®åˆç†çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶
- âœ… ä½¿ç”¨ `runtimeClassName: wasm` å‡å°‘èµ„æºå ç”¨
- âœ… ç›‘æ§ç­–ç•¥è¯„ä¼°æ€§èƒ½
- âœ… æ ¹æ®è´Ÿè½½è°ƒæ•´å‰¯æœ¬æ•°

**é«˜å¯ç”¨æ€§**ï¼š

- âœ… éƒ¨ç½²å¤šä¸ª OPA Pod å®ä¾‹
- âœ… ä½¿ç”¨ Service è´Ÿè½½å‡è¡¡
- âœ… é…ç½®å¥åº·æ£€æŸ¥
- âœ… è®¾ç½® PodDisruptionBudget

**å®‰å…¨é…ç½®**ï¼š

- âœ… ä½¿ç”¨ RBAC é™åˆ¶è®¿é—®æƒé™
- âœ… åŠ å¯†ç­–ç•¥æ–‡ä»¶ä¼ è¾“
- âœ… å®šæœŸæ›´æ–° OPA ç‰ˆæœ¬
- âœ… å®¡è®¡ç­–ç•¥å˜æ›´

## 06.11 OPA æ£€æŸ¥æ¸…å•

**OPA å®‰è£…æ£€æŸ¥**ï¼š

- [ ] OPA å·²æ­£ç¡®å®‰è£…ï¼ˆopa versionï¼‰
- [ ] Gatekeeper å·²å®‰è£…ï¼ˆå¦‚ä½¿ç”¨ Gatekeeperï¼‰
- [ ] Gatekeeper Webhook è¿è¡Œæ­£å¸¸ï¼ˆkubectl get pods -n gatekeeper-systemï¼‰
- [ ] OPA æˆ– Gatekeeper é…ç½®æ­£ç¡®

**ç­–ç•¥ç¼–å†™æ£€æŸ¥**ï¼š

- [ ] Rego è¯­æ³•æ­£ç¡®ï¼ˆopa check policy.regoï¼‰
- [ ] ç­–ç•¥é€»è¾‘æ­£ç¡®ï¼ˆopa test policy.regoï¼‰
- [ ] ç­–ç•¥æ³¨é‡Šæ¸…æ™°
- [ ] ç­–ç•¥å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ç­–ç•¥ç‰ˆæœ¬ç®¡ç†è§„èŒƒ

**Wasm ç¼–è¯‘æ£€æŸ¥**ï¼š

- [ ] ç­–ç•¥æˆåŠŸç¼–è¯‘ä¸º Wasmï¼ˆopa build -t wasmï¼‰
- [ ] Wasm æ–‡ä»¶å¤§å°åˆç†
- [ ] Wasm æ–‡ä»¶éªŒè¯é€šè¿‡
- [ ] ç¼–è¯‘ä¼˜åŒ–å·²å¯ç”¨ï¼ˆ-O é€‰é¡¹ï¼‰
- [ ] å…¥å£ç‚¹é…ç½®æ­£ç¡®ï¼ˆ-e é€‰é¡¹ï¼‰

**ç­–ç•¥é•œåƒæ£€æŸ¥**ï¼š

- [ ] ç­–ç•¥é•œåƒå·²æ„å»º
- [ ] é•œåƒåŒ…å« Wasm æ–‡ä»¶
- [ ] é•œåƒ OCI æ³¨é‡Šæ­£ç¡®ï¼ˆmodule.wasm.image/variantï¼‰
- [ ] é•œåƒå·²æ¨é€åˆ°é•œåƒä»“åº“
- [ ] é•œåƒç‰ˆæœ¬æ ‡ç­¾æ­£ç¡®

**ç­–ç•¥éƒ¨ç½²æ£€æŸ¥**ï¼š

- [ ] ConstraintTemplate å·²åˆ›å»ºï¼ˆå¦‚ä½¿ç”¨ Gatekeeperï¼‰
- [ ] Constraint èµ„æºå·²åˆ›å»º
- [ ] OPA Pod ä½¿ç”¨æ­£ç¡®çš„ Wasm é•œåƒ
- [ ] OPA Pod ä½¿ç”¨ `runtimeClassName: wasm`
- [ ] OPA Pod è¿è¡Œæ­£å¸¸

**ç­–ç•¥åŠŸèƒ½æ£€æŸ¥**ï¼š

- [ ] ç­–ç•¥è¯„ä¼°åŠŸèƒ½æ­£å¸¸
- [ ] ç­–ç•¥æ‹’ç»ä¸åˆè§„èµ„æº
- [ ] ç­–ç•¥å…è®¸åˆè§„èµ„æº
- [ ] ç­–ç•¥é”™è¯¯æ¶ˆæ¯æ¸…æ™°
- [ ] ç­–ç•¥æ€§èƒ½æ»¡è¶³éœ€æ±‚

**OPA ç›‘æ§æ£€æŸ¥**ï¼š

- [ ] OPA æŒ‡æ ‡æ­£å¸¸æ”¶é›†
- [ ] OPA æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] ç­–ç•¥è¯„ä¼°æ€§èƒ½ç›‘æ§é…ç½®å®Œæˆ
- [ ] å‘Šè­¦è§„åˆ™å·²é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰

**OPA å®‰å…¨æ£€æŸ¥**ï¼š

- [ ] RBAC æƒé™é…ç½®æ­£ç¡®
- [ ] ç­–ç•¥æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶
- [ ] ç­–ç•¥å˜æ›´å®¡è®¡æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] OPA ç‰ˆæœ¬å®šæœŸæ›´æ–°

---

## 06.12 OPA æ•…éšœæ’æŸ¥

### 06.12.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šç­–ç•¥ç¼–è¯‘å¤±è´¥**:

```bash
# æ£€æŸ¥ Rego è¯­æ³•
opa check policy.rego

# éªŒè¯ç­–ç•¥é€»è¾‘
opa test policy.rego

# æ£€æŸ¥ç¼–è¯‘é€‰é¡¹
opa build -t wasm -e admission/deny policy.rego --debug
```

**é—®é¢˜ 2ï¼šç­–ç•¥è¯„ä¼°è¿”å›é”™è¯¯**:

```bash
# æ£€æŸ¥ Wasm æ–‡ä»¶
wasmedge --version

# æµ‹è¯•ç­–ç•¥è¯„ä¼°
opa eval -d policy.wasm -i input.json "data.admission.deny"

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
kubectl logs <opa-pod-name>
```

**é—®é¢˜ 3ï¼šGatekeeper æ— æ³•åŠ è½½ Wasm ç­–ç•¥**:

```bash
# æ£€æŸ¥ Gatekeeper é…ç½®
kubectl get config -n gatekeeper-system

# æ£€æŸ¥ ConstraintTemplate
kubectl get constrainttemplate

# æ£€æŸ¥ Wasm é•œåƒ
docker inspect <policy-image> | grep -i wasm

# æ£€æŸ¥ Gatekeeper æ—¥å¿—
kubectl logs -n gatekeeper-system -l control-plane=controller-manager
```

**é—®é¢˜ 4ï¼šç­–ç•¥æ€§èƒ½é—®é¢˜**:

```bash
# æ£€æŸ¥ç­–ç•¥è¯„ä¼°æ—¶é—´
opa bench -d policy.wasm -i input.json

# æ£€æŸ¥èµ„æºä½¿ç”¨
kubectl top pod <opa-pod-name>

# ä¼˜åŒ–ç­–ç•¥
# - å‡å°‘é›†åˆæ“ä½œ
# - ä½¿ç”¨ç´¢å¼•
# - ç¼“å­˜ç»“æœ
```

---

## 06.13 å‚è€ƒ

### 06.13.1 2025 å¹´æœ€æ–°æ›´æ–°ï¼ˆ2025-11-06ï¼‰

- **[27. 2025 è¶‹åŠ¿ - 2025-11-06 æœ€æ–°æ›´æ–°](../27-2025-trends/2025-trends.md#2714-2025-å¹´-11-æœˆ-6-æ—¥æœ€æ–°æ›´æ–°)** -
  æŠ€æœ¯ç‰ˆæœ¬æ›´æ–°ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µã€å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
  - **OPA 0.58.1**ï¼šWasm ç¼–è¯‘æ€§èƒ½æå‡ 40%ï¼Œå†…å­˜å ç”¨é™ä½ 25%
  - **Gatekeeper v3.15.1**ï¼šWasm å¼•æ“çƒ­æ›´æ–°æ”¯æŒï¼Œç­–ç•¥åˆ‡æ¢é›¶åœæœº
  - **OPA-Wasm ç­–ç•¥ä¼˜åŒ–**ï¼šç­–ç•¥ç¼–è¯‘ä¸º Wasm æ ¼å¼ï¼Œæ‰§è¡Œå»¶è¿Ÿé™ä½ 85%
  - **å·²çŸ¥é—®é¢˜**ï¼šOPA-Wasm ç­–ç•¥å†…å­˜æ³„æ¼ï¼ˆå·²æä¾›è§£å†³æ–¹æ¡ˆå’Œä¸´æ—¶æ–¹æ¡ˆï¼‰
  - **å®‰å…¨æ›´æ–°**ï¼šOPA-Wasm å›½å¯†æ”¯æŒï¼ˆSM4 ç®—æ³•å·²ç¼–è¯‘è¿› wasmï¼‰

**OPA-Wasm æœ€ä½³å®è·µï¼ˆ2025-11-06ï¼‰**ï¼š

- **ç­–ç•¥æ–‡ä»¶å¤§å°**ï¼šå»ºè®® <500 KBï¼Œé¿å…å†…å­˜å ç”¨è¿‡é«˜
- **å†…å­˜æ± ä½¿ç”¨**ï¼šå‡çº§åˆ° OPA 0.58.1+ï¼Œä½¿ç”¨ Wasm å†…å­˜æ± å¤ç”¨
- **ç­–ç•¥çƒ­æ›´æ–°**ï¼šGatekeeper v3.15.1+ æ”¯æŒç­–ç•¥çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯
- **ç­–ç•¥ç­¾å**ï¼šæ‰€æœ‰ Wasm ç­–ç•¥æ¨¡å—å¿…é¡»ä½¿ç”¨ cosign ç­¾åéªŒè¯
- **SBOM è¦æ±‚**ï¼šWasm ç­–ç•¥æ¨¡å—å¿…é¡»åŒ…å« SBOMï¼ˆSoftware Bill of Materialsï¼‰

### 06.13.2 éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£

- **[29. éš”ç¦»æ ˆ](../29-isolation-stack/isolation-stack.md)** - å®Œæ•´çš„éš”ç¦»æ ˆæŠ€æœ¯
  è§£æï¼ŒåŒ…æ‹¬ OPA-Wasm åº”ç”¨åœºæ™¯
- **[L-4 æ²™ç›’åŒ–å±‚](../29-isolation-stack/layers/L-4-sandboxing.md)** - WASM è¿è¡Œ
  æ—¶è¯¦ç»†æ–‡æ¡£ï¼ŒåŒ…å« OPA-Wasm æœ€ä½³å®è·µ
- **[éš”ç¦»å±‚æ¬¡å¯¹æ¯”æ–‡æ¡£](../29-isolation-stack/layers/isolation-comparison.md)** -
  WASM æ€§èƒ½å¯¹æ¯”å’Œåº”ç”¨åœºæ™¯åŒ¹é…

### 06.13.3 OPA ç­–ç•¥ç›¸å…³æ–‡æ¡£

- **[09. å®‰å…¨åˆè§„](../09-security-compliance/security-compliance.md)** - å®‰å…¨ä¸
  åˆè§„æœ€ä½³å®è·µï¼ˆåŒ…å« OPA-Wasm æ•°æ®è„±æ•ï¼‰
- **[03. WasmEdge](../03-wasm-edge/wasmedge.md)** - WasmEdge è¿è¡Œæ—¶å’Œ Wasm å®¹å™¨
  åŒ–
- **[10. å®‰è£…éƒ¨ç½²](../10-installation/installation.md)** - K3s + WasmEdge + OPA
  å®Œæ•´å®‰è£…æŒ‡å—
- **[04. ç¼–æ’è¿è¡Œæ—¶](../04-orchestration-runtime/orchestration-runtime.md)** -
  CRI å’Œ RuntimeClass é…ç½®
- **[17. GitOps å’ŒæŒç»­äº¤ä»˜](../17-gitops-cicd/gitops-cicd.md)** - GitOps Wasm ç­–
  ç•¥éƒ¨ç½²

### 06.13.3 ç½‘ç»œå’Œå­˜å‚¨ç›¸å…³æ–‡æ¡£

- **[12. ç½‘ç»œæŠ€æœ¯è§„æ ¼](../12-network-stack/network-stack.md)** -
  CNIã€Serviceã€Ingress ç­‰æŠ€æœ¯è§„æ ¼
- **[è™šæ‹ŸåŒ–ä¸å®¹å™¨åŒ–ç½‘ç»œå¯¹æ¯”åˆ†æ](../12-network-stack/virtualization-comparison.md)** -
  ç½‘ç»œèŒƒå¼è½¬æ¢ã€æ¶æ„å¯¹æ¯”ã€æ€§èƒ½åˆ†æï¼ˆ2025-11-07ï¼‰
- **[15. å­˜å‚¨æŠ€æœ¯è§„æ ¼](../15-storage-stack/storage-stack.md)** - CSIã€PV/PVC ç­‰
  æŠ€æœ¯è§„æ ¼
- **[è™šæ‹ŸåŒ–ä¸å®¹å™¨åŒ–å­˜å‚¨å¯¹æ¯”åˆ†æ](../15-storage-stack/virtualization-comparison.md)** -
  å­˜å‚¨èŒƒå¼è½¬æ¢ã€æ¶æ„å¯¹æ¯”ã€æ€§èƒ½åˆ†æï¼ˆ2025-11-07ï¼‰

### 06.13.4 å¤–éƒ¨å‚è€ƒ

- [OPA å®˜æ–¹æ–‡æ¡£](https://www.openpolicyagent.org/docs/)
- [Gatekeeper å®˜æ–¹æ–‡æ¡£](https://open-policy-agent.github.io/gatekeeper/)
- [Rego è¯­è¨€å‚è€ƒ](https://www.openpolicyagent.org/docs/latest/policy-language/)
- [OPA Wasm æ”¯æŒ](https://www.openpolicyagent.org/docs/latest/wasm/)
- [OPA 0.58.1 å‘å¸ƒè¯´æ˜](https://github.com/open-policy-agent/opa/releases/tag/v0.58.1)
- [Gatekeeper v3.15.1 å‘å¸ƒè¯´æ˜](https://github.com/open-policy-agent/gatekeeper/releases/tag/v3.15.1)

---

**æœ€åæ›´æ–°**ï¼š2025-11-07 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
