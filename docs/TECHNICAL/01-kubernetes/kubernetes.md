# 01. Kubernetesï¼šé›†ç¾¤ç¼–æ’æ¶æ„ä¸å®è·µ

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [01.1 æ–‡æ¡£å®šä½](#011-æ–‡æ¡£å®šä½)
- [01.2 Kubernetes æ¶æ„](#012-kubernetes-æ¶æ„)
  - [01.2.1 ç³»ç»Ÿæ¶æ„å…¨æ™¯](#0121-ç³»ç»Ÿæ¶æ„å…¨æ™¯)
  - [01.2.2 æ§åˆ¶å¹³é¢ç»„ä»¶](#0122-æ§åˆ¶å¹³é¢ç»„ä»¶)
  - [01.2.3 èŠ‚ç‚¹ç»„ä»¶](#0123-èŠ‚ç‚¹ç»„ä»¶)
  - [01.2.4 æ¶æ„è®¾è®¡è®ºè¯](#0124-æ¶æ„è®¾è®¡è®ºè¯)
- [01.3 å¯¹è±¡æ¨¡å‹](#013-å¯¹è±¡æ¨¡å‹)
  - [01.3.1 GVR æ¨¡å‹](#0131-gvr-æ¨¡å‹)
  - [01.3.2 å¯¹è±¡ç»“æ„](#0132-å¯¹è±¡ç»“æ„)
  - [01.3.3 å¯¹è±¡å…³ç³»æ¨¡å‹](#0133-å¯¹è±¡å…³ç³»æ¨¡å‹)
  - [01.3.4 æ ‡ç­¾ä¸é€‰æ‹©å™¨](#0134-æ ‡ç­¾ä¸é€‰æ‹©å™¨)
- [01.4 æ§åˆ¶é—­ç¯æœºåˆ¶](#014-æ§åˆ¶é—­ç¯æœºåˆ¶)
  - [01.4.1 Informer æ¨¡å¼](#0141-informer-æ¨¡å¼)
  - [01.4.2 Controller å·¥ä½œæµç¨‹](#0142-controller-å·¥ä½œæµç¨‹)
  - [01.4.3 æ§åˆ¶å¾ªç¯æ”¶æ•›](#0143-æ§åˆ¶å¾ªç¯æ”¶æ•›)
- [01.5 æ ¸å¿ƒå¯¹è±¡è¯¦è§£](#015-æ ¸å¿ƒå¯¹è±¡è¯¦è§£)
  - [01.5.1 Pod](#0151-pod)
  - [01.5.2 Deployment](#0152-deployment)
  - [01.5.3 Service](#0153-service)
  - [01.5.4 Ingress](#0154-ingress)
  - [01.5.5 ConfigMap ä¸ Secret](#0155-configmap-ä¸-secret)
- [01.6 ç½‘ç»œæ¨¡å‹](#016-ç½‘ç»œæ¨¡å‹)
  - [01.6.1 ç½‘ç»œåŸåˆ™](#0161-ç½‘ç»œåŸåˆ™)
  - [01.6.2 CNI æ’ä»¶](#0162-cni-æ’ä»¶)
  - [01.6.3 ç½‘ç»œåœºæ™¯ä¸å†³ç­–](#0163-ç½‘ç»œåœºæ™¯ä¸å†³ç­–)
- [01.7 å­˜å‚¨æ¨¡å‹](#017-å­˜å‚¨æ¨¡å‹)
  - [01.7.1 å­˜å‚¨æŠ½è±¡](#0171-å­˜å‚¨æŠ½è±¡)
  - [01.7.2 CSI æ’ä»¶](#0172-csi-æ’ä»¶)
  - [01.7.3 å­˜å‚¨åœºæ™¯ä¸å†³ç­–](#0173-å­˜å‚¨åœºæ™¯ä¸å†³ç­–)
- [01.8 è°ƒåº¦æœºåˆ¶](#018-è°ƒåº¦æœºåˆ¶)
  - [01.8.1 è°ƒåº¦æµç¨‹](#0181-è°ƒåº¦æµç¨‹)
  - [01.8.2 è°ƒåº¦ç­–ç•¥](#0182-è°ƒåº¦ç­–ç•¥)
  - [01.8.3 è°ƒåº¦åœºæ™¯ä¸å†³ç­–](#0183-è°ƒåº¦åœºæ™¯ä¸å†³ç­–)
- [01.9 æŠ€æœ¯åœºæ™¯åˆ†æ](#019-æŠ€æœ¯åœºæ™¯åˆ†æ)
  - [01.9.1 å¤§è§„æ¨¡é›†ç¾¤åœºæ™¯](#0191-å¤§è§„æ¨¡é›†ç¾¤åœºæ™¯)
  - [01.9.2 å¤šç§Ÿæˆ·åœºæ™¯](#0192-å¤šç§Ÿæˆ·åœºæ™¯)
  - [01.9.3 æ··åˆäº‘åœºæ™¯](#0193-æ··åˆäº‘åœºæ™¯)
- [01.10 èµ„æºç®¡ç†](#0110-èµ„æºç®¡ç†)
  - [01.10.1 èµ„æºé…é¢ï¼ˆResourceQuotaï¼‰](#01101-èµ„æºé…é¢resourcequota)
  - [01.10.2 èµ„æºé™åˆ¶ï¼ˆLimitRangeï¼‰](#01102-èµ„æºé™åˆ¶limitrange)
  - [01.10.3 å¤šç§Ÿæˆ·èµ„æºéš”ç¦»](#01103-å¤šç§Ÿæˆ·èµ„æºéš”ç¦»)
- [01.11 è°ƒåº¦å™¨æ‰©å±•](#0111-è°ƒåº¦å™¨æ‰©å±•)
  - [01.11.1 è°ƒåº¦å™¨æ’ä»¶æœºåˆ¶](#01111-è°ƒåº¦å™¨æ’ä»¶æœºåˆ¶)
  - [01.11.2 è‡ªå®šä¹‰è°ƒåº¦å™¨å¼€å‘](#01112-è‡ªå®šä¹‰è°ƒåº¦å™¨å¼€å‘)
  - [01.11.3 è°ƒåº¦ç­–ç•¥æ‰©å±•](#01113-è°ƒåº¦ç­–ç•¥æ‰©å±•)
  - [01.11.4 è¾¹ç¼˜åœºæ™¯è°ƒåº¦ä¼˜åŒ–](#01114-è¾¹ç¼˜åœºæ™¯è°ƒåº¦ä¼˜åŒ–)
- [01.12 å†³ç­–ä¾æ®ä¸æ€è·¯](#0112-å†³ç­–ä¾æ®ä¸æ€è·¯)
  - [01.12.1 ä½•æ—¶é€‰æ‹© Kubernetesï¼Ÿ](#01121-ä½•æ—¶é€‰æ‹©-kubernetes)
  - [01.12.2 ç½‘ç»œæ’ä»¶é€‰æ‹©](#01122-ç½‘ç»œæ’ä»¶é€‰æ‹©)
  - [01.12.3 å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©](#01123-å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©)
- [01.13 å½¢å¼åŒ–æ€»ç»“](#0113-å½¢å¼åŒ–æ€»ç»“)
  - [01.13.1 å¯¹è±¡æ¨¡å‹å½¢å¼åŒ–](#01131-å¯¹è±¡æ¨¡å‹å½¢å¼åŒ–)
  - [01.13.2 è°ƒåº¦å†³ç­–å‡½æ•°](#01132-è°ƒåº¦å†³ç­–å‡½æ•°)
  - [01.13.3 æ§åˆ¶å¾ªç¯æ”¶æ•›å®šç†](#01133-æ§åˆ¶å¾ªç¯æ”¶æ•›å®šç†)
- [01.14 å®é™…éƒ¨ç½²æ¡ˆä¾‹](#0114-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
  - [01.14.1 æ¡ˆä¾‹ 1ï¼šä½¿ç”¨ kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤](#01141-æ¡ˆä¾‹-1ä½¿ç”¨-kubeadm-éƒ¨ç½²-kubernetes-é›†ç¾¤)
  - [01.14.2 æ¡ˆä¾‹ 2ï¼šéƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡](#01142-æ¡ˆä¾‹-2éƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡)
  - [01.14.3 æ¡ˆä¾‹ 3ï¼šé…ç½® ConfigMap å’Œ Secret](#01143-æ¡ˆä¾‹-3é…ç½®-configmap-å’Œ-secret)
- [01.15 Kubernetes æ•…éšœæ’æŸ¥](#0115-kubernetes-æ•…éšœæ’æŸ¥)
  - [01.15.1 å¸¸è§é—®é¢˜](#01151-å¸¸è§é—®é¢˜)
- [01.16 å‚è€ƒ](#0116-å‚è€ƒ)

---

## 01.1 æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£æ·±å…¥è§£æ Kubernetes çš„æ¶æ„è®¾è®¡ã€å¯¹è±¡æ¨¡å‹ã€æ§åˆ¶é—­ç¯æœºåˆ¶ï¼Œä»¥åŠä¸åŒæŠ€æœ¯åœºæ™¯ä¸‹
çš„å†³ç­–ä¾æ®å’Œå†³ç­–æ€è·¯ã€‚

**æ–‡æ¡£ç»“æ„**ï¼š

- **æ¶æ„è®¾è®¡**ï¼šæ§åˆ¶å¹³é¢ã€èŠ‚ç‚¹ç»„ä»¶ã€ç½‘ç»œå­˜å‚¨æŠ½è±¡
- **å¯¹è±¡æ¨¡å‹**ï¼šGVRã€æ ‡ç­¾é€‰æ‹©å™¨ã€å¯¹è±¡å…³ç³»
- **æ§åˆ¶é—­ç¯**ï¼šInformerã€Controllerã€æ§åˆ¶å¾ªç¯
- **æŠ€æœ¯åœºæ™¯**ï¼šå¤§è§„æ¨¡é›†ç¾¤ã€å¤šç§Ÿæˆ·ã€æ··åˆäº‘
- **å†³ç­–åˆ†æ**ï¼šæ¶æ„é€‰æ‹©ã€ç½‘ç»œå­˜å‚¨é€‰æ‹©ã€è°ƒåº¦ç­–ç•¥é€‰æ‹©

## 01.2 Kubernetes æ¶æ„

### 01.2.1 ç³»ç»Ÿæ¶æ„å…¨æ™¯

```mermaid
graph TB
    subgraph "æ§åˆ¶å¹³é¢"
        A[kube-api-server] --> B[etcd]
        A --> C[Controller Manager]
        A --> D[Scheduler]
    end

    subgraph "èŠ‚ç‚¹"
        E[kubelet] --> F[kube-proxy]
        E --> G[å®¹å™¨è¿è¡Œæ—¶<br/>CRI]
        E --> H[ç½‘ç»œæ’ä»¶<br/>CNI]
        E --> I[å­˜å‚¨æ’ä»¶<br/>CSI]
    end

    A --> E
    C --> E
    D --> E

    style A fill:#e1f5ff
    style B fill:#ffe6e6
    style E fill:#fff4e1
```

**æ¶æ„å±‚æ¬¡åˆ†æ**ï¼š

1. **æ§åˆ¶å¹³é¢å±‚**ï¼šAPI Server ä¸ºä¸­å¿ƒï¼Œetcd å­˜å‚¨çŠ¶æ€ï¼ŒController å’Œ Scheduler å¤„
   ç†é€»è¾‘
2. **èŠ‚ç‚¹å±‚**ï¼škubelet ä¸ºæ ¸å¿ƒï¼Œåè°ƒå®¹å™¨è¿è¡Œæ—¶ã€ç½‘ç»œã€å­˜å‚¨
3. **é€šä¿¡å±‚**ï¼šæ§åˆ¶å¹³é¢é€šè¿‡ API Server ä¸èŠ‚ç‚¹é€šä¿¡

### 01.2.2 æ§åˆ¶å¹³é¢ç»„ä»¶

| ç»„ä»¶                        | èŒè´£                     | æŠ€æœ¯ç‰¹ç‚¹                |
| --------------------------- | ------------------------ | ----------------------- |
| **kube-api-server**         | API ç½‘å…³ï¼ŒéªŒè¯å’Œå­˜å‚¨å¯¹è±¡ | RESTful APIï¼Œæ”¯æŒ Watch |
| **etcd**                    | åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨           | Raft å…±è¯†ï¼Œå¼ºä¸€è‡´æ€§     |
| **kube-controller-manager** | è¿è¡Œæ§åˆ¶å™¨é€»è¾‘           | æ§åˆ¶å¾ªç¯ï¼Œè‡ªåŠ¨ä¿®å¤      |
| **kube-scheduler**          | Pod è°ƒåº¦å†³ç­–             | è¿‡æ»¤+æ‰“åˆ†+ç»‘å®š          |

**æ§åˆ¶å¹³é¢è®¾è®¡è®ºè¯**ï¼š

- **API Server ä¸­å¿ƒåŒ–**ï¼šæ‰€æœ‰ç»„ä»¶é€šè¿‡ API Server äº¤äº’ï¼Œé¿å…ç›´æ¥è®¿é—® etcd
- **etcd çŠ¶æ€å­˜å‚¨**ï¼šä½¿ç”¨ etcd å­˜å‚¨é›†ç¾¤çŠ¶æ€ï¼Œä¿è¯ä¸€è‡´æ€§
- **æ§åˆ¶å™¨åˆ†ç¦»**ï¼šController å’Œ Scheduler åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°
- **Watch æœºåˆ¶**ï¼šé€šè¿‡ Watch å®ç°äº‹ä»¶é©±åŠ¨ï¼Œå®æ—¶å“åº”å˜åŒ–

### 01.2.3 èŠ‚ç‚¹ç»„ä»¶

| ç»„ä»¶           | èŒè´£               | æŠ€æœ¯ç‰¹ç‚¹                |
| -------------- | ------------------ | ----------------------- |
| **kubelet**    | èŠ‚ç‚¹ä»£ç†ï¼Œç®¡ç† Pod | CRI æ¥å£ï¼Œå¥åº·æ£€æŸ¥      |
| **kube-proxy** | ç½‘ç»œä»£ç†ï¼ŒæœåŠ¡å‘ç° | iptables/ipvsï¼Œè´Ÿè½½å‡è¡¡ |
| **CRI æ’ä»¶**   | å®¹å™¨è¿è¡Œæ—¶æ¥å£     | containerd/CRI-O        |
| **CNI æ’ä»¶**   | ç½‘ç»œæ¥å£           | Calico/Flannel/Cilium   |
| **CSI æ’ä»¶**   | å­˜å‚¨æ¥å£           | åŠ¨æ€å·ç®¡ç†              |

**èŠ‚ç‚¹ç»„ä»¶è®¾è®¡è®ºè¯**ï¼š

- **kubelet æ ¸å¿ƒ**ï¼škubelet ä½œä¸ºèŠ‚ç‚¹æ ¸å¿ƒï¼Œç»Ÿä¸€ç®¡ç†å®¹å™¨ã€ç½‘ç»œã€å­˜å‚¨
- **æ’ä»¶åŒ–è®¾è®¡**ï¼šCRI/CNI/CSI æ¥å£å®ç°æ’ä»¶åŒ–ï¼Œè§£è€¦æ ¸å¿ƒå’Œå®ç°
- **ç½‘ç»œä»£ç†åˆ†ç¦»**ï¼škube-proxy ç‹¬ç«‹è¿è¡Œï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡

### 01.2.4 æ¶æ„è®¾è®¡è®ºè¯

**ä¸ºä»€ä¹ˆé‡‡ç”¨ä¸­å¿ƒåŒ–æ¶æ„ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… çŠ¶æ€ä¸€è‡´æ€§ï¼šä¸­å¿ƒåŒ–å­˜å‚¨ä¿è¯é›†ç¾¤çŠ¶æ€ä¸€è‡´
- âœ… æ§åˆ¶ç®€åŒ–ï¼šç»Ÿä¸€å…¥å£ç®€åŒ–æ§åˆ¶é€»è¾‘
- âœ… å¯æ‰©å±•æ€§ï¼šæ’ä»¶åŒ–è®¾è®¡æ”¯æŒæ‰©å±•

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ¶æ„é€‰æ‹©:
  æ¨¡å¼: ä¸­å¿ƒåŒ–æ¶æ„
  åŸå› :
    - çŠ¶æ€ä¸€è‡´æ€§éœ€æ±‚
    - æ§åˆ¶ç®€åŒ–éœ€æ±‚
    - å¯æ‰©å±•æ€§éœ€æ±‚
  æƒè¡¡:
    - API Server æˆä¸ºå•ç‚¹ï¼ˆé€šè¿‡ HA è§£å†³ï¼‰
    - etcd æ€§èƒ½ç“¶é¢ˆï¼ˆé€šè¿‡ä¼˜åŒ–è§£å†³ï¼‰
```

**ä¸ºä»€ä¹ˆåˆ†ç¦» Controller å’Œ Schedulerï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… èŒè´£åˆ†ç¦»ï¼šController è´Ÿè´£çŠ¶æ€ç®¡ç†ï¼ŒScheduler è´Ÿè´£è°ƒåº¦å†³ç­–
- âœ… å¯æ‰©å±•æ€§ï¼šå„è‡ªå¯ä»¥ç‹¬ç«‹æ‰©å±•å’Œä¼˜åŒ–
- âœ… è§£è€¦è®¾è®¡ï¼šé™ä½ç»„ä»¶é—´è€¦åˆ

## 01.3 å¯¹è±¡æ¨¡å‹

### 01.3.1 GVR æ¨¡å‹

**å®šä¹‰**ï¼šæ¯ä¸ª Kubernetes èµ„æºéµå¾ªç»Ÿä¸€çš„ GVRï¼ˆGroup/Version/Resourceï¼‰æ¨¡å¼ã€‚

```text
èµ„æºç±»å‹ = Group/Version/Resource

ç¤ºä¾‹ï¼š
- core/v1/Pod          # core ç»„ï¼Œv1 ç‰ˆæœ¬ï¼ŒPod èµ„æº
- apps/v1/Deployment    # apps ç»„ï¼Œv1 ç‰ˆæœ¬ï¼ŒDeployment èµ„æº
- networking.k8s.io/v1/Ingress  # networking ç»„ï¼Œv1 ç‰ˆæœ¬ï¼ŒIngress èµ„æº
```

**GVR æ¨¡å‹è®ºè¯**ï¼š

- **Group**ï¼šèµ„æºåˆ†ç»„ï¼Œä¾¿äºç®¡ç†å’Œæ‰©å±•
- **Version**ï¼šç‰ˆæœ¬ç®¡ç†ï¼Œæ”¯æŒ API æ¼”è¿›
- **Resource**ï¼šèµ„æºç±»å‹ï¼Œæ˜ç¡®èµ„æºè¯­ä¹‰

### 01.3.2 å¯¹è±¡ç»“æ„

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default
  labels:
    app: nginx
  uid: "abc-123"
  ownerReferences: [] # ä¾èµ–å…³ç³»
spec:
  replicas: 3 # æœŸæœ›çŠ¶æ€
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
status:
  replicas: 3 # å®é™…çŠ¶æ€
  readyReplicas: 3
  conditions: []
```

**å¯¹è±¡ç»“æ„åˆ†æ**ï¼š

- **metadata**ï¼šå…ƒæ•°æ®ï¼ŒåŒ…å«åç§°ã€æ ‡ç­¾ã€UIDã€æ‰€æœ‰è€…å¼•ç”¨
- **spec**ï¼šæœŸæœ›çŠ¶æ€ï¼Œå®šä¹‰èµ„æºçš„æœŸæœ›é…ç½®
- **status**ï¼šå®é™…çŠ¶æ€ï¼Œè®°å½•èµ„æºçš„å½“å‰çŠ¶æ€

### 01.3.3 å¯¹è±¡å…³ç³»æ¨¡å‹

```mermaid
graph TD
    A[Deployment] -->|OwnerReference| B[ReplicaSet]
    B -->|OwnerReference| C[Pod]
    A -->|Label Selector| C
    C -->|Label| D[Service]
    D -->|Label Selector| C

    E[ConfigMap] -->|Volume Mount| C
    F[Secret] -->|Volume Mount| C

    G[PersistentVolumeClaim] -->|Volume| C

    style A fill:#e1f5ff
    style D fill:#fff4e1
```

**å¯¹è±¡å…³ç³»è®ºè¯**ï¼š

- **OwnerReference**ï¼šå®šä¹‰å¯¹è±¡ä¾èµ–å…³ç³»ï¼Œå®ç°çº§è”åˆ é™¤
- **Label Selector**ï¼šå®ç°æ¾è€¦åˆçš„æœåŠ¡å‘ç°å’Œé€‰æ‹©
- **Volume Mount**ï¼šå®ç°é…ç½®å’Œå­˜å‚¨çš„æŒ‚è½½

### 01.3.4 æ ‡ç­¾ä¸é€‰æ‹©å™¨

**æ ¸å¿ƒæœºåˆ¶**ï¼šæ‰€æœ‰å¯¹è±¡é€šè¿‡ Label åšæ¾æ•£è€¦åˆï¼Œç±»æ¯”"æ•°æ®åº“ç´¢å¼•"ã€‚

```yaml
# Label ç¤ºä¾‹
metadata:
  labels:
    app: nginx
    version: v1
    tier: frontend
    env: production

# Selector ç¤ºä¾‹
spec:
  selector:
    matchLabels:
      app: nginx
    matchExpressions:
      - key: version
        operator: In
        values: [v1, v2]
```

**æ ‡ç­¾é€‰æ‹©å™¨è®ºè¯**ï¼š

- **æ¾è€¦åˆ**ï¼šé€šè¿‡æ ‡ç­¾å®ç°æœåŠ¡é—´æ¾è€¦åˆ
- **é«˜æ•ˆæŸ¥è¯¢**ï¼šæ ‡ç­¾é€‰æ‹©å™¨æ”¯æŒé«˜æ•ˆçš„å¯¹è±¡æŸ¥è¯¢
- **çµæ´»åŒ¹é…**ï¼šæ”¯æŒç²¾ç¡®åŒ¹é…å’Œè¡¨è¾¾å¼åŒ¹é…

## 01.4 æ§åˆ¶é—­ç¯æœºåˆ¶

### 01.4.1 Informer æ¨¡å¼

```mermaid
sequenceDiagram
    participant C as Controller
    participant I as Informer
    participant A as API Server
    participant E as etcd
    participant W as Work Queue

    C->>I: å¯åŠ¨ Informer
    I->>A: List-Watch èµ„æº
    A->>E: è¯»å–åˆå§‹çŠ¶æ€
    E-->>A: è¿”å›åˆ—è¡¨
    A-->>I: åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜

    loop æŒç»­ç›‘å¬
        A->>I: Watch äº‹ä»¶ï¼ˆAdded/Modified/Deletedï¼‰
        I->>I: æ›´æ–°æœ¬åœ°ç¼“å­˜
        I->>W: äº‹ä»¶å…¥é˜Ÿ
        W->>C: å–å‡ºäº‹ä»¶
        C->>C: Reconcile
    end
```

**Informer æ¨¡å¼è®ºè¯**ï¼š

- **æœ¬åœ°ç¼“å­˜**ï¼šå‡å°‘ API Server å‹åŠ›ï¼Œæé«˜å“åº”é€Ÿåº¦
- **Watch æœºåˆ¶**ï¼šå®æ—¶ç›‘å¬å˜åŒ–ï¼Œé¿å…è½®è¯¢å¼€é”€
- **å·¥ä½œé˜Ÿåˆ—**ï¼šå¼‚æ­¥å¤„ç†äº‹ä»¶ï¼Œé¿å…é˜»å¡

### 01.4.2 Controller å·¥ä½œæµç¨‹

1. **Informer List-Watch**ï¼šä» etcd åŒæ­¥èµ„æºåˆ°æœ¬åœ°ç¼“å­˜
2. **æœ¬åœ°ç¼“å­˜**ï¼šå‡å°‘ API Server å‹åŠ›
3. **äº‹ä»¶å…¥é˜Ÿ**ï¼šäº‹ä»¶è¿›å…¥ Work Queue
4. **Reconcile**ï¼šè®¡ç®—æœŸæœ›çŠ¶æ€ä¸å®é™…çŠ¶æ€å·®å¼‚
5. **æ‰§è¡Œå˜æ›´**ï¼šä¸‹å‘å‘½ä»¤åˆ° API Server
6. **æŒç»­å·¡æ£€**ï¼šå¾ªç¯æ‰§è¡Œä¸Šè¿°æ­¥éª¤

### 01.4.3 æ§åˆ¶å¾ªç¯æ”¶æ•›

**æ”¶æ•›æ€§å®šç†**ï¼šåœ¨æœ‰é™æ—¶é—´å†…ï¼Œå®é™…çŠ¶æ€ä¼šæ”¶æ•›åˆ°æœŸæœ›çŠ¶æ€ã€‚

$$\lim_{t \to \infty} |S_a(t) - S_e(t)| = 0$$

**è¯æ˜æ€è·¯**ï¼š

1. Controller æ¯æ¬¡æ“ä½œéƒ½ä¼šå‡å° $|S_a(t) - S_e(t)|$
2. åœ¨èµ„æºå¯ç”¨çš„æƒ…å†µä¸‹ï¼Œå·®å¼‚ä¼šå•è°ƒé€’å‡
3. å½“ $|S_a(t) - S_e(t)| < \epsilon$ æ—¶ï¼Œç³»ç»Ÿè¾¾åˆ°æ”¶æ•›çŠ¶æ€

## 01.5 æ ¸å¿ƒå¯¹è±¡è¯¦è§£

### 01.5.1 Pod

**æœ¬è´¨**ï¼šé€»è¾‘ä¸»æœºï¼Œå…±äº«ç½‘ç»œã€IPCã€å­˜å‚¨ã€‚

**åœºæ™¯ 1ï¼šå•å®¹å™¨ Pod**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… åº”ç”¨ç‹¬ç«‹è¿è¡Œ
- âœ… æ— éœ€è¿›ç¨‹é—´é€šä¿¡

**å†³ç­–æ€è·¯**ï¼š

```yaml
å•å®¹å™¨ Pod:
  åœºæ™¯: Web åº”ç”¨ã€API æœåŠ¡
  é…ç½®: 1 ä¸ªå®¹å™¨
  ä¼˜åŠ¿: ç®€å•ã€æ˜“ç®¡ç†
```

**åœºæ™¯ 2ï¼šå¤šå®¹å™¨ Pod**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… ç´§è€¦åˆè¿›ç¨‹ç»„
- âœ… éœ€è¦å…±äº«å­˜å‚¨æˆ–ç½‘ç»œ

**å†³ç­–æ€è·¯**ï¼š

```yaml
å¤šå®¹å™¨ Pod:
  åœºæ™¯: Sidecar æ¨¡å¼ã€æ—¥å¿—æ”¶é›†
  é…ç½®: å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œ
  ä¼˜åŠ¿: èµ„æºå…±äº«ã€ååŒå·¥ä½œ
```

### 01.5.2 Deployment

**æœ¬è´¨**ï¼šæœŸæœ›å‰¯æœ¬é›†ï¼Œç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚

**åœºæ™¯ 1ï¼šæ— çŠ¶æ€æœåŠ¡**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… åº”ç”¨æ— çŠ¶æ€
- âœ… éœ€è¦æ»šåŠ¨æ›´æ–°
- âœ… éœ€è¦è‡ªåŠ¨æ‰©å®¹

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ— çŠ¶æ€æœåŠ¡:
  kind: Deployment
  ç­–ç•¥:
    type: RollingUpdate
    maxSurge: 1
    maxUnavailable: 0
  HPA: å¯ç”¨
```

**åœºæ™¯ 2ï¼šæœ‰çŠ¶æ€æœåŠ¡**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… åº”ç”¨æœ‰çŠ¶æ€
- âœ… éœ€è¦æœ‰åºéƒ¨ç½²
- âœ… éœ€è¦æŒä¹…åŒ–å­˜å‚¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
æœ‰çŠ¶æ€æœåŠ¡:
  kind: StatefulSet # ä¸ä½¿ç”¨ Deployment
  ç‰¹ç‚¹:
    - æœ‰åºéƒ¨ç½²
    - ç¨³å®šç½‘ç»œæ ‡è¯†
    - æŒä¹…åŒ–å­˜å‚¨
```

### 01.5.3 Service

**æœ¬è´¨**ï¼šç¨³å®šç½‘ç»œæ ‡è¯†ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚

**åœºæ™¯ 1ï¼šClusterIPï¼ˆé»˜è®¤ï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… é›†ç¾¤å†…éƒ¨è®¿é—®
- âœ… ä¸éœ€è¦å¤–éƒ¨è®¿é—®

**å†³ç­–æ€è·¯**ï¼š

```yaml
ClusterIP Service:
  åœºæ™¯: å†…éƒ¨æœåŠ¡é€šä¿¡
  type: ClusterIP
  è®¿é—®æ–¹å¼: é›†ç¾¤å†…é€šè¿‡ Service IP
```

**åœºæ™¯ 2ï¼šNodePort**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦èŠ‚ç‚¹ç«¯å£è®¿é—®
- âœ… ç®€å•çš„å¤–éƒ¨è®¿é—®æ–¹å¼

**å†³ç­–æ€è·¯**ï¼š

```yaml
NodePort Service:
  åœºæ™¯: å¼€å‘æµ‹è¯•ã€ç®€å•éƒ¨ç½²
  type: NodePort
  è®¿é—®æ–¹å¼: NodeIP:NodePort
```

**åœºæ™¯ 3ï¼šLoadBalancer**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… ç”Ÿäº§ç¯å¢ƒå¤–éƒ¨è®¿é—®
- âœ… äº‘å¹³å°æ”¯æŒ

**å†³ç­–æ€è·¯**ï¼š

```yaml
LoadBalancer Service:
  åœºæ™¯: ç”Ÿäº§ç¯å¢ƒ
  type: LoadBalancer
  è®¿é—®æ–¹å¼: äº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨ IP
```

### 01.5.4 Ingress

**æœ¬è´¨**ï¼šHTTP/HTTPS è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚

**åœºæ™¯ 1ï¼šå•åŸŸåå¤šè·¯å¾„**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¤šä¸ªæœåŠ¡å…±äº«åŸŸå
- âœ… è·¯å¾„åŒºåˆ†æœåŠ¡

**å†³ç­–æ€è·¯**ï¼š

```yaml
Ingress é…ç½®:
  host: api.example.com
  paths:
    - path: /api
      service: api-service
    - path: /admin
      service: admin-service
```

**åœºæ™¯ 2ï¼šå¤šåŸŸå**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… ä¸åŒæœåŠ¡ä½¿ç”¨ä¸åŒåŸŸå
- âœ… éœ€è¦ SSL ç»ˆæ­¢

**å†³ç­–æ€è·¯**ï¼š

```yaml
Ingress é…ç½®:
  rules:
    - host: api.example.com
      tls:
        secretName: api-tls
    - host: www.example.com
      tls:
        secretName: www-tls
```

### 01.5.5 ConfigMap ä¸ Secret

**åœºæ™¯ 1ï¼šé…ç½®æ–‡ä»¶ç®¡ç†**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… é…ç½®éœ€è¦ä»é•œåƒåˆ†ç¦»
- âœ… é…ç½®éœ€è¦çƒ­æ›´æ–°

**å†³ç­–æ€è·¯**ï¼š

```yaml
ConfigMap ä½¿ç”¨:
  kind: ConfigMap
  æ•°æ®: é…ç½®æ–‡ä»¶å†…å®¹
  æŒ‚è½½æ–¹å¼: Volume Mount
  æ›´æ–°æ–¹å¼: é‡å¯ Pod
```

**åœºæ™¯ 2ï¼šæ•æ„Ÿä¿¡æ¯ç®¡ç†**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
- âœ… éœ€è¦åŠ å¯†å­˜å‚¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
Secret ä½¿ç”¨:
  kind: Secret
  ç±»å‹: Opaque/TLS/Docker-registry
  å­˜å‚¨: base64 ç¼–ç ï¼ˆéåŠ å¯†ï¼‰
  å»ºè®®: ä½¿ç”¨å¤–éƒ¨ Secret ç®¡ç†ï¼ˆVaultï¼‰
```

## 01.6 ç½‘ç»œæ¨¡å‹

### 01.6.1 ç½‘ç»œåŸåˆ™

1. **ä»»æ„ Pod ä¸ Pod ç›´è¿**ï¼Œæ— éœ€ NAT
2. **èŠ‚ç‚¹ä¸ Pod ç›´è¿**ï¼Œæ— éœ€ NAT
3. **Pod çœ‹åˆ°è‡ªå·±çš„ IP**ï¼Œä¸å¤–éƒ¨çœ‹åˆ°çš„ä¸€è‡´

### 01.6.2 CNI æ’ä»¶

| æ’ä»¶        | å®ç°æ–¹å¼      | ç‰¹ç‚¹             | é€‚ç”¨åœºæ™¯   |
| ----------- | ------------- | ---------------- | ---------- |
| **Flannel** | VXLAN/host-gw | ç®€å•æ˜“ç”¨         | å°è§„æ¨¡é›†ç¾¤ |
| **Calico**  | BGP/IPIP      | é«˜æ€§èƒ½ã€ç½‘ç»œç­–ç•¥ | å¤§è§„æ¨¡é›†ç¾¤ |
| **Cilium**  | eBPF          | é«˜æ€§èƒ½ã€å®‰å…¨     | ç°ä»£é›†ç¾¤   |

### 01.6.3 ç½‘ç»œåœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šå°è§„æ¨¡é›†ç¾¤ï¼ˆ< 100 èŠ‚ç‚¹ï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… ç®€å•æ˜“ç”¨ä¼˜å…ˆ
- âœ… æ€§èƒ½è¦æ±‚ä¸é«˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  CNI: Flannel
  åŸå› : ç®€å•æ˜“ç”¨ï¼Œé…ç½®ç®€å•
  æƒè¡¡: æ€§èƒ½ç›¸å¯¹è¾ƒä½
```

**åœºæ™¯ 2ï¼šå¤§è§„æ¨¡é›†ç¾¤ï¼ˆ> 500 èŠ‚ç‚¹ï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½è¦æ±‚é«˜
- âœ… ç½‘ç»œç­–ç•¥éœ€æ±‚

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  CNI: Calico æˆ– Cilium
  åŸå› : é«˜æ€§èƒ½ã€ç½‘ç»œç­–ç•¥æ”¯æŒ
  æƒè¡¡: é…ç½®ç›¸å¯¹å¤æ‚
```

**åœºæ™¯ 3ï¼šå®‰å…¨è¦æ±‚é«˜**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦ç»†ç²’åº¦ç½‘ç»œç­–ç•¥
- âœ… éœ€è¦ L7 ç­–ç•¥

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  CNI: Cilium
  åŸå› : eBPF å®ç° L7 ç­–ç•¥
  æƒè¡¡: éœ€è¦å†…æ ¸æ”¯æŒ
```

## 01.7 å­˜å‚¨æ¨¡å‹

### 01.7.1 å­˜å‚¨æŠ½è±¡

**æŠ½è±¡å±‚æ¬¡**ï¼š

- **PVï¼ˆPersistentVolumeï¼‰**ï¼šé›†ç¾¤çº§åˆ«çš„å­˜å‚¨èµ„æº
- **PVCï¼ˆPersistentVolumeClaimï¼‰**ï¼šç”¨æˆ·çº§åˆ«çš„å­˜å‚¨è¯·æ±‚
- **StorageClass**ï¼šåŠ¨æ€ä¾›ç»™ç­–ç•¥

### 01.7.2 CSI æ’ä»¶

**ä¸ºä»€ä¹ˆéœ€è¦ CSIï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… in-tree é©±åŠ¨ç‰ˆæœ¬è€¦åˆ
- âœ… å‡çº§å›°éš¾
- âœ… äºŒè¿›åˆ¶ä½“ç§¯å¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š

- CSI å°†é©±åŠ¨æ‹†åˆ°å¤–éƒ¨ Pod
- å¯ç‹¬ç«‹å‡çº§
- é™ä½æ ¸å¿ƒäºŒè¿›åˆ¶ä½“ç§¯

### 01.7.3 å­˜å‚¨åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæœ¬åœ°å­˜å‚¨ï¼ˆLocalï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å•èŠ‚ç‚¹å­˜å‚¨éœ€æ±‚
- âœ… æ€§èƒ½è¦æ±‚é«˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨æ–¹æ¡ˆ:
  type: Local PV
  ç‰¹ç‚¹: æœ¬åœ°ç£ç›˜ï¼Œé«˜æ€§èƒ½
  é™åˆ¶: èŠ‚ç‚¹ç»‘å®šï¼Œæ— æ³•è¿ç§»
```

**åœºæ™¯ 2ï¼šç½‘ç»œå­˜å‚¨ï¼ˆNFS/Cephï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… è·¨èŠ‚ç‚¹å­˜å‚¨éœ€æ±‚
- âœ… éœ€è¦å…±äº«å­˜å‚¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨æ–¹æ¡ˆ:
  type: Network PV
  ç‰¹ç‚¹: ç½‘ç»œå­˜å‚¨ï¼Œå¯å…±äº«
  æƒè¡¡: æ€§èƒ½ç›¸å¯¹è¾ƒä½
```

**åœºæ™¯ 3ï¼šäº‘å­˜å‚¨ï¼ˆEBS/Azure Diskï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… äº‘å¹³å°éƒ¨ç½²
- âœ… éœ€è¦åŠ¨æ€ä¾›ç»™

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨æ–¹æ¡ˆ:
  type: Cloud PV
  ç‰¹ç‚¹: åŠ¨æ€ä¾›ç»™ï¼Œé«˜å¯ç”¨
  ä¼˜åŠ¿: è‡ªåŠ¨ç®¡ç†ï¼ŒæŒ‰éœ€æ‰©å®¹
```

## 01.8 è°ƒåº¦æœºåˆ¶

### 01.8.1 è°ƒåº¦æµç¨‹

```mermaid
graph TD
    A[å¾…è°ƒåº¦ Pod] --> B[è¿‡æ»¤é˜¶æ®µ<br/>Predicates]
    B --> C{èŠ‚ç‚¹å€™é€‰é›†}
    C -->|ä» N åˆ° â‰¤100| D[æ‰“åˆ†é˜¶æ®µ<br/>Priorities]
    D --> E[è®¡ç®—åˆ†æ•°]
    E --> F[é€‰æ‹©æœ€é«˜åˆ†èŠ‚ç‚¹]
    F --> G[ç»‘å®šé˜¶æ®µ<br/>Binding]
    G --> H[Pod è¿è¡Œ]

    style B fill:#ffe6e6
    style D fill:#fff4e1
```

**è°ƒåº¦æµç¨‹è®ºè¯**ï¼š

1. **è¿‡æ»¤é˜¶æ®µ**ï¼šä» N ä¸ªèŠ‚ç‚¹ç­›é€‰åˆ° â‰¤100 ä¸ªå€™é€‰èŠ‚ç‚¹
2. **æ‰“åˆ†é˜¶æ®µ**ï¼šè®¡ç®—æ¯ä¸ªå€™é€‰èŠ‚ç‚¹çš„åˆ†æ•°
3. **ç»‘å®šé˜¶æ®µ**ï¼šé€‰æ‹©æœ€é«˜åˆ†èŠ‚ç‚¹å¹¶ç»‘å®š

### 01.8.2 è°ƒåº¦ç­–ç•¥

| é˜¶æ®µ     | ç®—æ³•                           | ç›®æ ‡                              |
| -------- | ------------------------------ | --------------------------------- |
| **è¿‡æ»¤** | èŠ‚ç‚¹èµ„æºæ£€æŸ¥ã€äº²å’Œæ€§æ£€æŸ¥       | ä» N ä¸ªèŠ‚ç‚¹ç­›é€‰åˆ° â‰¤100 ä¸ªå€™é€‰èŠ‚ç‚¹ |
| **æ‰“åˆ†** | èµ„æºç¢ç‰‡åŒ–æœ€å°åŒ–ã€é•œåƒæœ¬åœ°å­˜åœ¨ | é€‰å‡ºæœ€ä¼˜èŠ‚ç‚¹                      |
| **ç»‘å®š** | å¼‚æ­¥ç»‘å®šåˆ°èŠ‚ç‚¹                 | æ›´æ–° Pod çŠ¶æ€                     |

### 01.8.3 è°ƒåº¦åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šèµ„æºä¼˜åŒ–**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æœ€å¤§åŒ–èµ„æºåˆ©ç”¨ç‡
- âœ… å‡å°‘èµ„æºç¢ç‰‡

**å†³ç­–æ€è·¯**ï¼š

```yaml
è°ƒåº¦ç­–ç•¥:
  priority: èµ„æºç¢ç‰‡åŒ–æœ€å°
  åœºæ™¯: èµ„æºç´§å¼ ç¯å¢ƒ
  æ•ˆæœ: æé«˜èµ„æºåˆ©ç”¨ç‡
```

**åœºæ™¯ 2ï¼šæ€§èƒ½ä¼˜åŒ–**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… é•œåƒæœ¬åœ°å·²å­˜åœ¨
- âœ… èŠ‚ç‚¹äº²å’Œæ€§

**å†³ç­–æ€è·¯**ï¼š

```yaml
è°ƒåº¦ç­–ç•¥:
  priority: é•œåƒæœ¬åœ°å­˜åœ¨
  åœºæ™¯: å¤§è§„æ¨¡éƒ¨ç½²
  æ•ˆæœ: å‡å°‘é•œåƒæ‹‰å–æ—¶é—´
```

**åœºæ™¯ 3ï¼šé«˜å¯ç”¨**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… Pod åäº²å’Œæ€§
- âœ… åŒºåŸŸåˆ†æ•£

**å†³ç­–æ€è·¯**ï¼š

```yaml
è°ƒåº¦ç­–ç•¥:
  affinity: PodAntiAffinity
  åœºæ™¯: é«˜å¯ç”¨æœåŠ¡
  æ•ˆæœ: Pod åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹
```

## 01.9 æŠ€æœ¯åœºæ™¯åˆ†æ

### 01.9.1 å¤§è§„æ¨¡é›†ç¾¤åœºæ™¯

**åœºæ™¯æè¿°**ï¼š> 1000 èŠ‚ç‚¹ï¼Œ> 10 ä¸‡ Pod

**æŒ‘æˆ˜åˆ†æ**ï¼š

1. **API Server å‹åŠ›**ï¼šå¤§é‡ Watch è¯·æ±‚
2. **etcd æ€§èƒ½**ï¼šå¤§é‡å†™å…¥æ“ä½œ
3. **è°ƒåº¦æ€§èƒ½**ï¼šè°ƒåº¦å»¶è¿Ÿå¢åŠ 

**è§£å†³æ–¹æ¡ˆ**ï¼š

```yaml
å¤§è§„æ¨¡é›†ç¾¤ä¼˜åŒ–:
  API Server:
    - å¯ç”¨ API Server å‰¯æœ¬
    - ä½¿ç”¨æœ¬åœ° Informer ç¼“å­˜
  etcd:
    - ä¼˜åŒ– etcd é…ç½®
    - ä½¿ç”¨ etcd åˆ†ç‰‡
  è°ƒåº¦å™¨:
    - å¯ç”¨å¤šä¸ªè°ƒåº¦å™¨
    - ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§é¢„é€‰
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½è¦æ±‚é«˜
- âœ… å¯ç”¨æ€§è¦æ±‚é«˜

### 01.9.2 å¤šç§Ÿæˆ·åœºæ™¯

**åœºæ™¯æè¿°**ï¼šå¤šä¸ªå›¢é˜Ÿå…±äº«é›†ç¾¤ï¼Œéœ€è¦éš”ç¦»

**æŒ‘æˆ˜åˆ†æ**ï¼š

1. **èµ„æºéš”ç¦»**ï¼šéœ€è¦ ResourceQuota
2. **ç½‘ç»œéš”ç¦»**ï¼šéœ€è¦ NetworkPolicy
3. **æƒé™éš”ç¦»**ï¼šéœ€è¦ RBAC

**è§£å†³æ–¹æ¡ˆ**ï¼š

```yaml
å¤šç§Ÿæˆ·é…ç½®:
  èµ„æºéš”ç¦»:
    - ResourceQuotaï¼ˆèµ„æºé…é¢ï¼‰
    - LimitRangeï¼ˆèµ„æºé™åˆ¶ï¼‰
  ç½‘ç»œéš”ç¦»:
    - NetworkPolicyï¼ˆç½‘ç»œç­–ç•¥ï¼‰
  æƒé™éš”ç¦»:
    - RBACï¼ˆè§’è‰²è®¿é—®æ§åˆ¶ï¼‰
    - Namespaceï¼ˆå‘½åç©ºé—´ï¼‰
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å®‰å…¨éš”ç¦»éœ€æ±‚
- âœ… èµ„æºå…¬å¹³åˆ†é…éœ€æ±‚

### 01.9.3 æ··åˆäº‘åœºæ™¯

**åœºæ™¯æè¿°**ï¼šåº”ç”¨éƒ¨ç½²åœ¨å¤šä¸ªäº‘å¹³å°æˆ–æœ¬åœ°

**æŒ‘æˆ˜åˆ†æ**ï¼š

1. **ç½‘ç»œè¿é€š**ï¼šè·¨äº‘ç½‘ç»œé€šä¿¡
2. **å­˜å‚¨ç®¡ç†**ï¼šä¸åŒäº‘å­˜å‚¨ç­–ç•¥
3. **ç»Ÿä¸€ç®¡ç†**ï¼šç»Ÿä¸€ API å…¥å£

**è§£å†³æ–¹æ¡ˆ**ï¼š

```yaml
æ··åˆäº‘æ–¹æ¡ˆ:
  ç½‘ç»œ:
    - ä½¿ç”¨ VPN æˆ–ä¸“çº¿
    - ä½¿ç”¨ Service Mesh
  å­˜å‚¨:
    - ä½¿ç”¨æŠ½è±¡å­˜å‚¨å±‚
    - ä½¿ç”¨å¯¹è±¡å­˜å‚¨
  ç®¡ç†:
    - ä½¿ç”¨ Kubernetes Federation
    - ä½¿ç”¨ç»Ÿä¸€ API Gateway
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¤šäº‘éƒ¨ç½²éœ€æ±‚
- âœ… ç»Ÿä¸€ç®¡ç†éœ€æ±‚

## 01.10 èµ„æºç®¡ç†

### 01.10.1 èµ„æºé…é¢ï¼ˆResourceQuotaï¼‰

**ResourceQuota å®šä¹‰**ï¼š

ResourceQuota ç”¨äºé™åˆ¶å‘½åç©ºé—´ä¸­çš„èµ„æºä½¿ç”¨ï¼ŒåŒ…æ‹¬è®¡ç®—èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰ã€å­˜å‚¨èµ„æº
ã€å¯¹è±¡æ•°é‡ç­‰ã€‚

**ResourceQuota æŠ€æœ¯è§„æ ¼**ï¼š

| èµ„æºç±»å‹     | è¯´æ˜                     | ç¤ºä¾‹                      |
| ------------ | ------------------------ | ------------------------- |
| **CPU**      | CPU è¯·æ±‚å’Œé™åˆ¶           | `requests.cpu: "4"`       |
| **å†…å­˜**     | å†…å­˜è¯·æ±‚å’Œé™åˆ¶           | `requests.memory: 8Gi`    |
| **å­˜å‚¨**     | PVC å­˜å‚¨å¤§å°             | `requests.storage: 100Gi` |
| **å¯¹è±¡æ•°é‡** | å„ç±» Kubernetes å¯¹è±¡æ•°é‡ | `pods: "10"`              |

**ResourceQuota é…ç½®ç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources
  namespace: production
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    persistentvolumeclaims: "10"
    pods: "20"
```

**ResourceQuota åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šå¤šç§Ÿæˆ·èµ„æºéš”ç¦»**:

- **éœ€æ±‚**ï¼šä¸ºä¸åŒå›¢é˜Ÿåˆ†é…å›ºå®šçš„èµ„æºé…é¢
- **æ–¹æ¡ˆ**ï¼šä¸ºæ¯ä¸ªå‘½åç©ºé—´åˆ›å»º ResourceQuota
- **ä¼˜ç‚¹**ï¼šèµ„æºéš”ç¦»ã€é˜²æ­¢èµ„æºè€—å°½
- **ç¼ºç‚¹**ï¼šéœ€è¦ç²¾ç»†é…ç½®

**åœºæ™¯ 2ï¼šå¼€å‘ç¯å¢ƒèµ„æºé™åˆ¶**:

- **éœ€æ±‚**ï¼šé™åˆ¶å¼€å‘ç¯å¢ƒçš„èµ„æºä½¿ç”¨
- **æ–¹æ¡ˆ**ï¼šè®¾ç½®è¾ƒå°çš„ ResourceQuota
- **ä¼˜ç‚¹**ï¼šæˆæœ¬æ§åˆ¶ã€èµ„æºå…¬å¹³åˆ†é…
- **ç¼ºç‚¹**ï¼šå¯èƒ½å½±å“å¼€å‘ä½“éªŒ

**åœºæ™¯ 3ï¼šç”Ÿäº§ç¯å¢ƒèµ„æºä¿éšœ**:

- **éœ€æ±‚**ï¼šä¿éšœå…³é”®åº”ç”¨æœ‰è¶³å¤Ÿèµ„æº
- **æ–¹æ¡ˆ**ï¼šç»“åˆ ResourceQuota å’Œ PriorityClass
- **ä¼˜ç‚¹**ï¼šèµ„æºä¿éšœã€é«˜å¯ç”¨
- **ç¼ºç‚¹**ï¼šé…ç½®å¤æ‚

**ResourceQuota æœ€ä½³å®è·µ**ï¼š

1. **åˆç†è®¾ç½®é…é¢**ï¼šæ ¹æ®å®é™…éœ€æ±‚è®¾ç½®ï¼Œé¿å…è¿‡ç´§æˆ–è¿‡æ¾
2. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼šå®šæœŸæ£€æŸ¥ ResourceQuota ä½¿ç”¨æƒ…å†µ
3. **åˆ†çº§ç®¡ç†**ï¼šä¸ºä¸åŒç¯å¢ƒè®¾ç½®ä¸åŒçš„é…é¢ç­–ç•¥
4. **ç»“åˆ LimitRange**ï¼šä¸ LimitRange é…åˆä½¿ç”¨ï¼Œè®¾ç½®é»˜è®¤èµ„æºé™åˆ¶

### 01.10.2 èµ„æºé™åˆ¶ï¼ˆLimitRangeï¼‰

**LimitRange å®šä¹‰**ï¼š

LimitRange ç”¨äºè®¾ç½®å‘½åç©ºé—´ä¸­èµ„æºçš„é»˜è®¤è¯·æ±‚å’Œé™åˆ¶ï¼Œä»¥åŠå¯¹å•ä¸ªå¯¹è±¡çš„èµ„æºé™åˆ¶ã€‚

**LimitRange æŠ€æœ¯è§„æ ¼**ï¼š

| é™åˆ¶ç±»å‹                 | è¯´æ˜               | åº”ç”¨èŒƒå›´      |
| ------------------------ | ------------------ | ------------- |
| **Default**              | é»˜è®¤èµ„æºè¯·æ±‚å’Œé™åˆ¶ | Pod           |
| **DefaultRequest**       | é»˜è®¤èµ„æºè¯·æ±‚       | Pod           |
| **Max**                  | æœ€å¤§èµ„æºé™åˆ¶       | Pod/Container |
| **Min**                  | æœ€å°èµ„æºè¯·æ±‚       | Pod/Container |
| **MaxLimitRequestRatio** | é™åˆ¶/è¯·æ±‚æ¯”ä¾‹ä¸Šé™  | Container     |

**LimitRange é…ç½®ç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: compute-limits
  namespace: production
spec:
  limits:
    - default:
        cpu: "1"
        memory: 1Gi
      defaultRequest:
        cpu: "0.5"
        memory: 512Mi
      max:
        cpu: "2"
        memory: 2Gi
      min:
        cpu: "100m"
        memory: 128Mi
      type: Container
    - max:
        cpu: "4"
        memory: 4Gi
      min:
        cpu: "200m"
        memory: 256Mi
      type: Pod
```

**LimitRange åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šè®¾ç½®é»˜è®¤èµ„æºé™åˆ¶**:

- **éœ€æ±‚**ï¼šä¸ºæœªæŒ‡å®šèµ„æºé™åˆ¶çš„å®¹å™¨è®¾ç½®é»˜è®¤å€¼
- **æ–¹æ¡ˆ**ï¼šé…ç½® LimitRange çš„ default å’Œ defaultRequest
- **ä¼˜ç‚¹**ï¼šèµ„æºè§„èŒƒã€é˜²æ­¢èµ„æºæµªè´¹
- **ç¼ºç‚¹**ï¼šå¯èƒ½ä¸é€‚ç”¨äºæ‰€æœ‰åº”ç”¨

**åœºæ™¯ 2ï¼šé˜²æ­¢èµ„æºè¿‡åº¦åˆ†é…**:

- **éœ€æ±‚**ï¼šé˜²æ­¢å•ä¸ªå®¹å™¨æˆ– Pod ä½¿ç”¨è¿‡å¤šèµ„æº
- **æ–¹æ¡ˆ**ï¼šè®¾ç½® max é™åˆ¶
- **ä¼˜ç‚¹**ï¼šèµ„æºä¿æŠ¤ã€é›†ç¾¤ç¨³å®š
- **ç¼ºç‚¹**ï¼šå¯èƒ½é™åˆ¶é«˜æ€§èƒ½åº”ç”¨

**åœºæ™¯ 3ï¼šèµ„æºè¯·æ±‚æœ€å°å€¼ä¿éšœ**:

- **éœ€æ±‚**ï¼šç¡®ä¿å®¹å™¨æœ‰æœ€å°èµ„æºè¯·æ±‚
- **æ–¹æ¡ˆ**ï¼šè®¾ç½® min é™åˆ¶
- **ä¼˜ç‚¹**ï¼šèµ„æºä¿éšœã€æ€§èƒ½åŸºçº¿
- **ç¼ºç‚¹**ï¼šå¯èƒ½å¢åŠ èµ„æºå ç”¨

**LimitRange æœ€ä½³å®è·µ**ï¼š

1. **åˆç†è®¾ç½®é»˜è®¤å€¼**ï¼šæ ¹æ®åº”ç”¨ç±»å‹è®¾ç½®åˆç†çš„é»˜è®¤èµ„æº
2. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼šå®šæœŸæ£€æŸ¥ LimitRange çš„æ•ˆæœ
3. **åˆ†å±‚è®¾ç½®**ï¼šä¸ºä¸åŒå‘½åç©ºé—´è®¾ç½®ä¸åŒçš„é™åˆ¶
4. **ä¸ ResourceQuota é…åˆ**ï¼šç»“åˆä½¿ç”¨å®ç°å®Œæ•´çš„èµ„æºç®¡ç†

### 01.10.3 å¤šç§Ÿæˆ·èµ„æºéš”ç¦»

**å¤šç§Ÿæˆ·èµ„æºéš”ç¦»å®šä¹‰**ï¼š

é€šè¿‡ ResourceQuotaã€LimitRangeã€NetworkPolicy ç­‰æŠ€æœ¯å®ç°ä¸åŒç§Ÿæˆ·ä¹‹é—´çš„èµ„æºéš”ç¦»ã€‚

**å¤šç§Ÿæˆ·èµ„æºéš”ç¦»å±‚æ¬¡**ï¼š

| å±‚æ¬¡         | æŠ€æœ¯              | éš”ç¦»èŒƒå›´     |
| ------------ | ----------------- | ------------ |
| **å‘½åç©ºé—´** | Namespace         | é€»è¾‘éš”ç¦»     |
| **èµ„æºé…é¢** | ResourceQuota     | è®¡ç®—èµ„æºéš”ç¦» |
| **èµ„æºé™åˆ¶** | LimitRange        | å®¹å™¨èµ„æºé™åˆ¶ |
| **ç½‘ç»œéš”ç¦»** | NetworkPolicy     | ç½‘ç»œæµé‡éš”ç¦» |
| **å­˜å‚¨éš”ç¦»** | StorageClass + PV | å­˜å‚¨èµ„æºéš”ç¦» |

**å¤šç§Ÿæˆ·èµ„æºéš”ç¦»æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ 1ï¼šå‘½åç©ºé—´éš”ç¦»**:

- **é…ç½®**ï¼šæ¯ä¸ªç§Ÿæˆ·ä¸€ä¸ªå‘½åç©ºé—´
- **ä¼˜ç‚¹**ï¼šç®€å•æ˜“ç”¨ã€é€»è¾‘æ¸…æ™°
- **ç¼ºç‚¹**ï¼šéœ€è¦ç®¡ç†å¤šä¸ªå‘½åç©ºé—´

**æ–¹æ¡ˆ 2ï¼šResourceQuota + LimitRange**:

- **é…ç½®**ï¼šä¸ºæ¯ä¸ªå‘½åç©ºé—´è®¾ç½® ResourceQuota å’Œ LimitRange
- **ä¼˜ç‚¹**ï¼šèµ„æºä¿éšœã€æˆæœ¬æ§åˆ¶
- **ç¼ºç‚¹**ï¼šé…ç½®å¤æ‚

**æ–¹æ¡ˆ 3ï¼šå¤šå±‚çº§èµ„æºéš”ç¦»**:

- **é…ç½®**ï¼šç»“åˆ Namespaceã€ResourceQuotaã€NetworkPolicy
- **ä¼˜ç‚¹**ï¼šå…¨é¢éš”ç¦»ã€å®‰å…¨æ€§é«˜
- **ç¼ºç‚¹**ï¼šç®¡ç†å¤æ‚

**å¤šç§Ÿæˆ·èµ„æºéš”ç¦»å†³ç­–æ ‘**ï¼š

```yaml
å¤šç§Ÿæˆ·éš”ç¦»å†³ç­–:
  if éœ€è¦å®Œå…¨éš”ç¦»:
    ä½¿ç”¨: Namespace + ResourceQuota + NetworkPolicy
  elif ä»…éœ€èµ„æºéš”ç¦»:
    ä½¿ç”¨: Namespace + ResourceQuota
  elif ä»…éœ€ç½‘ç»œéš”ç¦»:
    ä½¿ç”¨: Namespace + NetworkPolicy
  else:
    ä½¿ç”¨: ä»… Namespace
```

## 01.11 è°ƒåº¦å™¨æ‰©å±•

### 01.11.1 è°ƒåº¦å™¨æ’ä»¶æœºåˆ¶

**è°ƒåº¦å™¨æ’ä»¶å®šä¹‰**ï¼š

Kubernetes è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–æ¶æ„ï¼Œé€šè¿‡è°ƒåº¦å™¨æ’ä»¶ï¼ˆScheduler Pluginsï¼‰æ‰©å±•è°ƒåº¦åŠŸèƒ½
ã€‚

**è°ƒåº¦å™¨æ’ä»¶ç±»å‹**ï¼š

| æ’ä»¶ç±»å‹      | è¯´æ˜       | ç¤ºä¾‹                            |
| ------------- | ---------- | ------------------------------- |
| **QueueSort** | æ’åºæ’ä»¶   | PrioritySortã€NodeAffinitySort  |
| **PreFilter** | é¢„è¿‡æ»¤æ’ä»¶ | NodeResourcesFit                |
| **Filter**    | è¿‡æ»¤æ’ä»¶   | NodePortsã€NodeAffinity         |
| **PreScore**  | é¢„è¯„åˆ†æ’ä»¶ | NodeAffinity                    |
| **Score**     | è¯„åˆ†æ’ä»¶   | NodeResourcesBalancedAllocation |
| **Bind**      | ç»‘å®šæ’ä»¶   | DefaultBinder                   |
| **Reserve**   | é¢„ç•™æ’ä»¶   | VolumeBinding                   |
| **Permit**    | å…è®¸æ’ä»¶   | -                               |
| **PreBind**   | é¢„ç»‘å®šæ’ä»¶ | VolumeBinding                   |
| **PostBind**  | åç»‘å®šæ’ä»¶ | -                               |

**è°ƒåº¦å™¨æ’ä»¶é…ç½®ç¤ºä¾‹**ï¼š

```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
profiles:
  - schedulerName: default-scheduler
    plugins:
      queueSort:
        enabled:
          - name: PrioritySort
      preFilter:
        enabled:
          - name: NodeResourcesFit
          - name: NodeAffinity
      filter:
        enabled:
          - name: NodeResourcesFit
          - name: NodeAffinity
      preScore:
        enabled:
          - name: NodeAffinity
      score:
        enabled:
          - name: NodeResourcesBalancedAllocation
            weight: 1
          - name: NodeAffinity
            weight: 10
```

**è°ƒåº¦å™¨æ’ä»¶åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šè‡ªå®šä¹‰èµ„æºè°ƒåº¦**:

- **éœ€æ±‚**ï¼šæ ¹æ®è‡ªå®šä¹‰èµ„æºï¼ˆå¦‚ GPUï¼‰è¿›è¡Œè°ƒåº¦
- **æ–¹æ¡ˆ**ï¼šå¼€å‘è‡ªå®šä¹‰ Filter å’Œ Score æ’ä»¶
- **ä¼˜ç‚¹**ï¼šçµæ´»ã€å¯æ‰©å±•
- **ç¼ºç‚¹**ï¼šéœ€è¦å¼€å‘ç»´æŠ¤

**åœºæ™¯ 2ï¼šè´Ÿè½½å‡è¡¡è°ƒåº¦**:

- **éœ€æ±‚**ï¼šä¼˜åŒ–èµ„æºåˆ†é…ï¼Œå®ç°è´Ÿè½½å‡è¡¡
- **æ–¹æ¡ˆ**ï¼šé…ç½® NodeResourcesBalancedAllocation æ’ä»¶
- **ä¼˜ç‚¹**ï¼šèµ„æºåˆ©ç”¨ä¼˜åŒ–
- **ç¼ºç‚¹**ï¼šå¯èƒ½å½±å“è°ƒåº¦æ€§èƒ½

**åœºæ™¯ 3ï¼šå¤šè°ƒåº¦å™¨å¹¶å­˜**:

- **éœ€æ±‚**ï¼šä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥
- **æ–¹æ¡ˆ**ï¼šé…ç½®å¤šä¸ªè°ƒåº¦å™¨ Profile
- **ä¼˜ç‚¹**ï¼šçµæ´»ã€ç²¾ç»†åŒ–æ§åˆ¶
- **ç¼ºç‚¹**ï¼šç®¡ç†å¤æ‚

### 01.11.2 è‡ªå®šä¹‰è°ƒåº¦å™¨å¼€å‘

**è‡ªå®šä¹‰è°ƒåº¦å™¨å®šä¹‰**ï¼š

å¼€å‘ç‹¬ç«‹çš„è°ƒåº¦å™¨ç¨‹åºï¼Œå®ç°ç‰¹å®šçš„è°ƒåº¦é€»è¾‘ã€‚

**è‡ªå®šä¹‰è°ƒåº¦å™¨æ¶æ„**ï¼š

```mermaid
graph TB
    A[è‡ªå®šä¹‰è°ƒåº¦å™¨] --> B[ç›‘å¬ Pod]
    B --> C[è¿‡æ»¤èŠ‚ç‚¹]
    C --> D[è¯„åˆ†èŠ‚ç‚¹]
    D --> E[ç»‘å®š Pod]
    E --> F[æ›´æ–° API Server]

    style A fill:#e1f5ff
    style F fill:#fff4e1
```

**è‡ªå®šä¹‰è°ƒåº¦å™¨å¼€å‘æ­¥éª¤**ï¼š

1. **åˆ›å»ºè°ƒåº¦å™¨ç¨‹åº**ï¼šå®ç°è°ƒåº¦é€»è¾‘
2. **é…ç½® RBAC**ï¼šæˆäºˆè°ƒåº¦å™¨æƒé™
3. **éƒ¨ç½²è°ƒåº¦å™¨**ï¼šåœ¨é›†ç¾¤ä¸­è¿è¡Œ
4. **ä½¿ç”¨è°ƒåº¦å™¨**ï¼šåœ¨ Pod ä¸­æŒ‡å®š schedulerName

**è‡ªå®šä¹‰è°ƒåº¦å™¨ç¤ºä¾‹**ï¼š

```go
package main

import (
    "context"
    "k8s.io/client-go/kubernetes"
    "k8s.io/client-go/tools/clientcmd"
)

func main() {
    // 1. åˆ›å»º Kubernetes å®¢æˆ·ç«¯
    config, _ := clientcmd.BuildConfigFromFlags("", "")
    clientset, _ := kubernetes.NewForConfig(config)

    // 2. ç›‘å¬å¾…è°ƒåº¦çš„ Pod
    // 3. å®ç°è°ƒåº¦é€»è¾‘
    // 4. ç»‘å®š Pod åˆ°èŠ‚ç‚¹
}
```

**è‡ªå®šä¹‰è°ƒåº¦å™¨åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šGPU è°ƒåº¦å™¨**:

- **éœ€æ±‚**ï¼šæ ¹æ® GPU èµ„æºè¿›è¡Œè°ƒåº¦
- **æ–¹æ¡ˆ**ï¼šå¼€å‘ GPU æ„ŸçŸ¥çš„è°ƒåº¦å™¨
- **ä¼˜ç‚¹**ï¼šGPU èµ„æºé«˜æ•ˆåˆ©ç”¨
- **ç¼ºç‚¹**ï¼šéœ€è¦ç»´æŠ¤è°ƒåº¦å™¨

**åœºæ™¯ 2ï¼šè¾¹ç¼˜è°ƒåº¦å™¨**:

- **éœ€æ±‚**ï¼šè€ƒè™‘åœ°ç†ä½ç½®å’Œå»¶è¿Ÿçš„è°ƒåº¦
- **æ–¹æ¡ˆ**ï¼šå¼€å‘è¾¹ç¼˜æ„ŸçŸ¥çš„è°ƒåº¦å™¨
- **ä¼˜ç‚¹**ï¼šä½å»¶è¿Ÿã€è¾¹ç¼˜ä¼˜åŒ–
- **ç¼ºç‚¹**ï¼šè°ƒåº¦é€»è¾‘å¤æ‚

**åœºæ™¯ 3ï¼šæˆæœ¬ä¼˜åŒ–è°ƒåº¦å™¨**:

- **éœ€æ±‚**ï¼šä¼˜å…ˆè°ƒåº¦åˆ°æˆæœ¬ä½çš„èŠ‚ç‚¹
- **æ–¹æ¡ˆ**ï¼šå¼€å‘æˆæœ¬æ„ŸçŸ¥çš„è°ƒåº¦å™¨
- **ä¼˜ç‚¹**ï¼šæˆæœ¬ä¼˜åŒ–
- **ç¼ºç‚¹**ï¼šå¯èƒ½å½±å“æ€§èƒ½

### 01.11.3 è°ƒåº¦ç­–ç•¥æ‰©å±•

**è°ƒåº¦ç­–ç•¥æ‰©å±•æ–¹å¼**ï¼š

1. **è°ƒåº¦å™¨æ’ä»¶**ï¼šé€šè¿‡é…ç½®è°ƒåº¦å™¨æ’ä»¶æ‰©å±•åŠŸèƒ½
2. **è‡ªå®šä¹‰è°ƒåº¦å™¨**ï¼šå¼€å‘ç‹¬ç«‹çš„è°ƒåº¦å™¨ç¨‹åº
3. **è°ƒåº¦å™¨æ‰©å±•å™¨**ï¼šä½¿ç”¨è°ƒåº¦å™¨æ‰©å±•å™¨ï¼ˆScheduler Extenderï¼‰

**è°ƒåº¦å™¨æ‰©å±•å™¨ï¼ˆScheduler Extenderï¼‰**ï¼š

è°ƒåº¦å™¨æ‰©å±•å™¨é€šè¿‡ HTTP æ¥å£æ‰©å±•è°ƒåº¦åŠŸèƒ½ï¼Œæ— éœ€ä¿®æ”¹è°ƒåº¦å™¨ä»£ç ã€‚

**è°ƒåº¦å™¨æ‰©å±•å™¨é…ç½®ç¤ºä¾‹**ï¼š

```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
extenders:
  - urlPrefix: "http://scheduler-extender:80"
    filterVerb: "filter"
    prioritizeVerb: "prioritize"
    weight: 1
    enableHttps: false
    managedResources:
      - name: "example.com/foo"
        ignoredByScheduler: false
```

**è°ƒåº¦ç­–ç•¥æ‰©å±•åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šæ··åˆäº‘è°ƒåº¦**:

- **éœ€æ±‚**ï¼šåœ¨æ··åˆäº‘ç¯å¢ƒä¸­è¿›è¡Œè°ƒåº¦
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨è°ƒåº¦å™¨æ‰©å±•å™¨å®ç°è·¨äº‘è°ƒåº¦
- **ä¼˜ç‚¹**ï¼šçµæ´»ã€å¯æ‰©å±•
- **ç¼ºç‚¹**ï¼šéœ€è¦ç»´æŠ¤æ‰©å±•å™¨

**åœºæ™¯ 2ï¼šæ™ºèƒ½è°ƒåº¦**:

- **éœ€æ±‚**ï¼šåŸºäºå†å²æ•°æ®å’Œæœºå™¨å­¦ä¹ è¿›è¡Œè°ƒåº¦
- **æ–¹æ¡ˆ**ï¼šå¼€å‘æ™ºèƒ½è°ƒåº¦å™¨
- **ä¼˜ç‚¹**ï¼šè°ƒåº¦ä¼˜åŒ–ã€è‡ªé€‚åº”
- **ç¼ºç‚¹**ï¼šå¤æ‚åº¦é«˜

### 01.11.4 è¾¹ç¼˜åœºæ™¯è°ƒåº¦ä¼˜åŒ–

**è¾¹ç¼˜åœºæ™¯è°ƒåº¦ç‰¹ç‚¹**ï¼š

- **åœ°ç†ä½ç½®åˆ†æ•£**ï¼šèŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒåœ°ç†ä½ç½®
- **ç½‘ç»œå»¶è¿Ÿå·®å¼‚**ï¼šä¸åŒèŠ‚ç‚¹é—´ç½‘ç»œå»¶è¿Ÿä¸åŒ
- **èµ„æºå¼‚æ„**ï¼šèŠ‚ç‚¹èµ„æºç±»å‹ä¸åŒ
- **ç¦»çº¿èƒ½åŠ›**ï¼šéƒ¨åˆ†èŠ‚ç‚¹å¯èƒ½ç¦»çº¿

**è¾¹ç¼˜åœºæ™¯è°ƒåº¦ç­–ç•¥**ï¼š

| ç­–ç•¥         | è¯´æ˜                 | é€‚ç”¨åœºæ™¯     |
| ------------ | -------------------- | ------------ |
| **æ‹“æ‰‘æ„ŸçŸ¥** | è€ƒè™‘èŠ‚ç‚¹æ‹“æ‰‘ç»“æ„     | åœ°ç†ä½ç½®åˆ†æ•£ |
| **å»¶è¿Ÿä¼˜åŒ–** | ä¼˜å…ˆè°ƒåº¦åˆ°ä½å»¶è¿ŸèŠ‚ç‚¹ | å®æ—¶åº”ç”¨     |
| **èµ„æºæ„ŸçŸ¥** | è€ƒè™‘èŠ‚ç‚¹èµ„æºç±»å‹     | å¼‚æ„èµ„æº     |
| **å®¹é”™è°ƒåº¦** | è€ƒè™‘èŠ‚ç‚¹å¯ç”¨æ€§       | ç¦»çº¿åœºæ™¯     |

**è¾¹ç¼˜åœºæ™¯è°ƒåº¦ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ 1ï¼šTopologySpreadConstraints**:

- **é…ç½®**ï¼šä½¿ç”¨ Pod çš„ topologySpreadConstraints
- **ä¼˜ç‚¹**ï¼šKubernetes åŸç”Ÿæ”¯æŒ
- **ç¼ºç‚¹**ï¼šé…ç½®å¯èƒ½å¤æ‚

**æ–¹æ¡ˆ 2ï¼šè‡ªå®šä¹‰è°ƒåº¦å™¨**:

- **é…ç½®**ï¼šå¼€å‘è¾¹ç¼˜æ„ŸçŸ¥çš„è°ƒåº¦å™¨
- **ä¼˜ç‚¹**ï¼šçµæ´»ã€å¯å®šåˆ¶
- **ç¼ºç‚¹**ï¼šéœ€è¦å¼€å‘ç»´æŠ¤

**æ–¹æ¡ˆ 3ï¼šè°ƒåº¦å™¨æ’ä»¶ + æ‰©å±•å™¨**:

- **é…ç½®**ï¼šç»“åˆè°ƒåº¦å™¨æ’ä»¶å’Œæ‰©å±•å™¨
- **ä¼˜ç‚¹**ï¼šå¹³è¡¡çµæ´»æ€§å’Œå¤æ‚åº¦
- **ç¼ºç‚¹**ï¼šé…ç½®è¾ƒå¤æ‚

## 01.12 å†³ç­–ä¾æ®ä¸æ€è·¯

### 01.12.1 ä½•æ—¶é€‰æ‹© Kubernetesï¼Ÿ

**å†³ç­–ä¾æ®**ï¼š

- âœ… èŠ‚ç‚¹æ•° > 1000
- âœ… éœ€è¦å¤šç§Ÿæˆ·
- âœ… éœ€è¦ Alpha API
- âœ… éœ€è¦å®Œæ•´ Kubernetes ç”Ÿæ€

**å†³ç­–æ€è·¯**ï¼š

```yaml
é€‰æ‹© Kubernetes çš„æ¡ä»¶:
  if èŠ‚ç‚¹æ•° > 1000: é€‰æ‹© Kubernetes
  elif éœ€è¦å¤šç§Ÿæˆ·: é€‰æ‹© Kubernetes
  elif éœ€è¦ Alpha API: é€‰æ‹© Kubernetes
  else: è€ƒè™‘ K3s æˆ–å…¶ä»–è½»é‡æ–¹æ¡ˆ
```

### 01.12.2 ç½‘ç»œæ’ä»¶é€‰æ‹©

**å†³ç­–ä¾æ®**ï¼š

- âœ… é›†ç¾¤è§„æ¨¡
- âœ… æ€§èƒ½è¦æ±‚
- âœ… ç½‘ç»œç­–ç•¥éœ€æ±‚

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ’ä»¶é€‰æ‹©:
  if é›†ç¾¤è§„æ¨¡ < 100: é€‰æ‹© Flannel
  elif éœ€è¦ç½‘ç»œç­–ç•¥: é€‰æ‹© Calico æˆ– Cilium
  elif æ€§èƒ½è¦æ±‚é«˜: é€‰æ‹© Cilium
  else: é€‰æ‹© Flannel
```

### 01.12.3 å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©

**å†³ç­–ä¾æ®**ï¼š

- âœ… éƒ¨ç½²ç¯å¢ƒï¼ˆäº‘/æœ¬åœ°ï¼‰
- âœ… æ€§èƒ½è¦æ±‚
- âœ… é«˜å¯ç”¨è¦æ±‚

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©:
  if äº‘å¹³å°éƒ¨ç½²: ä½¿ç”¨äº‘å­˜å‚¨ï¼ˆEBS/Azure Diskï¼‰
  elif é«˜æ€§èƒ½éœ€æ±‚: ä½¿ç”¨æœ¬åœ°å­˜å‚¨ + å‰¯æœ¬
  elif å…±äº«å­˜å‚¨éœ€æ±‚: ä½¿ç”¨ NFS/Ceph
  else: ä½¿ç”¨æœ¬åœ°å­˜å‚¨
```

## 01.13 å½¢å¼åŒ–æ€»ç»“

### 01.13.1 å¯¹è±¡æ¨¡å‹å½¢å¼åŒ–

è®¾å¯¹è±¡ä¸º $O = \{M, S, T\}$ï¼Œå…¶ä¸­ï¼š

- $M$ = Metadataï¼ˆå…ƒæ•°æ®ï¼‰
- $S$ = Specï¼ˆæœŸæœ›çŠ¶æ€ï¼‰
- $T$ = Statusï¼ˆå®é™…çŠ¶æ€ï¼‰

**å¯¹è±¡çŠ¶æ€è½¬æ¢**ï¼š $$O_{t+1} = \text{Reconcile}(S, T_t)$$

å…¶ä¸­ Reconcile å‡½æ•°æ ¹æ®æœŸæœ›çŠ¶æ€ $S$ å’Œå½“å‰å®é™…çŠ¶æ€ $T_t$ è®¡ç®—ä¸‹ä¸€çŠ¶æ€
$T_{t+1}$ã€‚

### 01.13.2 è°ƒåº¦å†³ç­–å‡½æ•°

**è°ƒåº¦å‡½æ•°**ï¼š $$S(P, N) = \arg\max_{n \in N'} \text{Score}(P, n)$$

å…¶ä¸­ï¼š

- $P$ = Pod
- $N$ = èŠ‚ç‚¹é›†åˆ
- $N' = \text{Predicate}(P, N)$ = è¿‡æ»¤åçš„å€™é€‰èŠ‚ç‚¹
- $\text{Score}(P, n)$ = èŠ‚ç‚¹ $n$ å¯¹ Pod $P$ çš„åˆ†æ•°

### 01.13.3 æ§åˆ¶å¾ªç¯æ”¶æ•›å®šç†

**å®šç† 5.1**ï¼ˆæ§åˆ¶å¾ªç¯æ”¶æ•›ï¼‰ï¼šåœ¨æœ‰é™æ—¶é—´å†…ï¼Œå®é™…çŠ¶æ€ä¼šæ”¶æ•›åˆ°æœŸæœ›çŠ¶æ€ã€‚

$$\lim_{t \to \infty} |T_t - S| = 0$$

**è¯æ˜**ï¼šå‚è€ƒ
[2.5.2 æ§åˆ¶å¾ªç¯æ”¶æ•›å®šç†](../COGNITIVE/02-principles/principles.md#252-æ§åˆ¶å¾ªç¯æ”¶æ•›å®šç†)

## 01.14 å®é™…éƒ¨ç½²æ¡ˆä¾‹

### 01.14.1 æ¡ˆä¾‹ 1ï¼šä½¿ç”¨ kubeadm éƒ¨ç½² Kubernetes é›†ç¾¤

**åœºæ™¯**ï¼šä½¿ç”¨ kubeadm éƒ¨ç½²ç”Ÿäº§çº§ Kubernetes é›†ç¾¤

**éƒ¨ç½²æ­¥éª¤**ï¼š

```bash
# 1. åˆå§‹åŒ–ä¸»èŠ‚ç‚¹
kubeadm init \
  --pod-network-cidr=10.244.0.0/16 \
  --apiserver-advertise-address=192.168.1.100

# 2. é…ç½® kubectl
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# 3. å®‰è£…ç½‘ç»œæ’ä»¶ï¼ˆFlannelï¼‰
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# 4. åŠ å…¥å·¥ä½œèŠ‚ç‚¹
kubeadm join 192.168.1.100:6443 \
  --token <token> \
  --discovery-token-ca-cert-hash sha256:<hash>
```

### 01.14.2 æ¡ˆä¾‹ 2ï¼šéƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡

**åœºæ™¯**ï¼šéƒ¨ç½²å®Œæ•´çš„åº”ç”¨æ ˆï¼ˆDeployment + Service + Ingressï¼‰

**éƒ¨ç½²é…ç½®**ï¼š

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
        - name: app
          image: nginx:alpine
          ports:
            - containerPort: 80
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"
---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
  ports:
    - port: 80
      targetPort: 80
  type: ClusterIP
---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
spec:
  ingressClassName: nginx
  rules:
    - host: myapp.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: myapp
                port:
                  number: 80
```

### 01.14.3 æ¡ˆä¾‹ 3ï¼šé…ç½® ConfigMap å’Œ Secret

**åœºæ™¯**ï¼šä½¿ç”¨ ConfigMap å’Œ Secret ç®¡ç†é…ç½®å’Œæ•æ„Ÿä¿¡æ¯

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  app.properties: |
    server.port=8080
    app.name=myapp
    app.env=production
---
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  username: YWRtaW4= # base64 encoded
  password: cGFzc3dvcmQ= # base64 encoded
---
# pod-with-config.yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-pod
spec:
  containers:
    - name: app
      image: myapp:latest
      env:
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: app-secret
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secret
              key: password
      volumeMounts:
        - name: config
          mountPath: /etc/config
  volumes:
    - name: config
      configMap:
        name: app-config
```

## 01.15 Kubernetes æ•…éšœæ’æŸ¥

### 01.15.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šPod å¤„äº Pending çŠ¶æ€**:

```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods
kubectl describe pod <pod-name>

# æ£€æŸ¥èŠ‚ç‚¹èµ„æº
kubectl describe nodes
kubectl top nodes

# æ£€æŸ¥è°ƒåº¦å™¨æ—¥å¿—
kubectl logs -n kube-system -l component=kube-scheduler
```

**é—®é¢˜ 2ï¼šPod æ— æ³•è®¿é—® Service**:

```bash
# æ£€æŸ¥ Service å’Œ Endpoints
kubectl get svc <service-name>
kubectl get endpoints <service-name>

# æ£€æŸ¥ Pod æ ‡ç­¾
kubectl get pods --show-labels

# æ£€æŸ¥ DNS è§£æ
kubectl run test-pod --image=busybox --rm -it -- nslookup <service-name>
```

**é—®é¢˜ 3ï¼šèŠ‚ç‚¹ NotReady**:

```bash
# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
kubectl describe node <node-name>

# æ£€æŸ¥ kubelet çŠ¶æ€
systemctl status kubelet
journalctl -u kubelet -f

# æ£€æŸ¥å®¹å™¨è¿è¡Œæ—¶
systemctl status containerd
# æˆ–
systemctl status docker
```

## 01.16 å‚è€ƒ

**å…³è”æ–‡æ¡£**ï¼š

- **[10. æŠ€æœ¯å†³ç­–æ¨¡å‹](../../COGNITIVE/10-decision-models/decision-models.md)** -
  æŠ€æœ¯é€‰å‹å†³ç­–æ¡†æ¶
- **[10. å¿«é€Ÿå‚è€ƒæŒ‡å—](../../COGNITIVE/10-decision-models/QUICK-REFERENCE.md)** -
  è®¾å¤‡è®¿é—®ï¼ˆUSB/PCI/GPUï¼‰å’Œå†…æ ¸ç‰¹æ€§å†³ç­–å¿«é€Ÿå‚è€ƒ
- **[10. ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š](../../COGNITIVE/10-decision-models/CONSISTENCY-REPORT.md)** -
  æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥ä¸ Wikipedia æ ‡å‡†å¯¹é½
- **[28. æ¶æ„æ¡†æ¶](../28-architecture-framework/architecture-framework.md)** -
  å¤šç»´åº¦æ¶æ„ä½“ç³»ä¸æŠ€æœ¯è§„èŒƒï¼ˆæŠ€æœ¯æ¶æ„ã€è½¯ä»¶æ¶æ„ã€åº”ç”¨æ¶æ„ç­‰ï¼‰
- **[03. æ¶æ„ä¸å¯¹è±¡æ¨¡å‹](../../COGNITIVE/03-architecture/architecture.md)** -
  Kubernetes å¯¹è±¡æ¨¡å‹å’Œæ§åˆ¶é—­ç¯
- **[03. æ‰§è¡Œæµä¸è°ƒåº¦è§†è§’](../../COGNITIVE/03-architecture/execution-flow-scheduling.md)** -
  æ‰§è¡Œæµä¸è°ƒåº¦è§†è§’åˆ†æ
- **[09. çŸ©é˜µè§†è§’](../../COGNITIVE/09-matrix-perspective/README.md)** -
  Kubernetes æŠ€æœ¯é“¾çŸ©é˜µåˆ†æ
- **[00. Docker](../00-docker/docker.md)** - Docker æŠ€æœ¯è§„èŒƒ
- **[02. K3s](../02-k3s/k3s.md)** - K3s è½»é‡çº§æ¶æ„

**å¤–éƒ¨å‚è€ƒ**ï¼š

[k8s-architecture]:
[Kubernetes æ¶æ„](https://kubernetes.io/docs/concepts/architecture/)

[k8s-objects]:
[Kubernetes å¯¹è±¡](https://kubernetes.io/docs/concepts/overview/working-with-objects/)

[k8s-network]:
[Kubernetes ç½‘ç»œ](https://kubernetes.io/docs/concepts/cluster-administration/networking/)

[k8s-storage]: [Kubernetes å­˜å‚¨](https://kubernetes.io/docs/concepts/storage/)
[k8s-scheduling]:
[Kubernetes è°ƒåº¦](https://kubernetes.io/docs/concepts/scheduling-eviction/)

> å®Œæ•´å‚è€ƒåˆ—è¡¨è§ [REFERENCES.md](../REFERENCES.md)

---

**æœ€åæ›´æ–°**ï¼š2025-11-06 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
