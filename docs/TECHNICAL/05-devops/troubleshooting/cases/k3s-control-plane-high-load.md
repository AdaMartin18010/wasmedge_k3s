# æ¡ˆä¾‹ K-005ï¼šK3s æ§åˆ¶å¹³é¢é«˜è´Ÿè½½

> **æ¡ˆä¾‹ç¼–å·**ï¼šK-005
> **æ•…éšœç±»å‹**ï¼šæ€§èƒ½é—®é¢˜
> **ä¸¥é‡ç¨‹åº¦**ï¼šä¸­ç­‰
> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-15
> **æœ€åæ›´æ–°**ï¼š2025-11-15

---

## ğŸ“‘ ç›®å½•

- [æ¡ˆä¾‹ K-005ï¼šK3s æ§åˆ¶å¹³é¢é«˜è´Ÿè½½](#æ¡ˆä¾‹-k-005k3s-æ§åˆ¶å¹³é¢é«˜è´Ÿè½½)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. é—®é¢˜æè¿°](#1-é—®é¢˜æè¿°)
    - [1.1 æ•…éšœç°è±¡](#11-æ•…éšœç°è±¡)
    - [1.2 ç¯å¢ƒä¿¡æ¯](#12-ç¯å¢ƒä¿¡æ¯)
    - [1.3 å½±å“èŒƒå›´](#13-å½±å“èŒƒå›´)
  - [2. æ•…éšœæ’æŸ¥è¿‡ç¨‹](#2-æ•…éšœæ’æŸ¥è¿‡ç¨‹)
    - [2.1 åˆæ­¥è¯Šæ–­](#21-åˆæ­¥è¯Šæ–­)
    - [2.2 æ·±å…¥æ’æŸ¥](#22-æ·±å…¥æ’æŸ¥)
    - [2.3 æ ¹å› åˆ†æ](#23-æ ¹å› åˆ†æ)
  - [3. è§£å†³æ–¹æ¡ˆ](#3-è§£å†³æ–¹æ¡ˆ)
    - [3.1 ä¸´æ—¶è§£å†³æ–¹æ¡ˆ](#31-ä¸´æ—¶è§£å†³æ–¹æ¡ˆ)
    - [3.2 æ°¸ä¹…è§£å†³æ–¹æ¡ˆ](#32-æ°¸ä¹…è§£å†³æ–¹æ¡ˆ)
    - [3.3 é¢„é˜²æªæ–½](#33-é¢„é˜²æªæ–½)
  - [4. éªŒè¯ä¸æ¢å¤](#4-éªŒè¯ä¸æ¢å¤)
    - [4.1 éªŒè¯æ­¥éª¤](#41-éªŒè¯æ­¥éª¤)
    - [4.2 æ¢å¤ç¡®è®¤](#42-æ¢å¤ç¡®è®¤)
  - [5. ç»éªŒæ€»ç»“](#5-ç»éªŒæ€»ç»“)
    - [5.1 å…³é”®å‘ç°](#51-å…³é”®å‘ç°)
    - [5.2 æœ€ä½³å®è·µ](#52-æœ€ä½³å®è·µ)
    - [5.3 ç›¸å…³æ–‡æ¡£](#53-ç›¸å…³æ–‡æ¡£)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)

---

## 1. é—®é¢˜æè¿°

### 1.1 æ•…éšœç°è±¡

**ä¸»è¦ç—‡çŠ¶**ï¼š

- K3s æ§åˆ¶å¹³é¢ CPU ä½¿ç”¨ç‡æŒç»­ >80%
- API Server å“åº”å»¶è¿Ÿå¢åŠ ï¼Œ>1s
- etcd å†™å…¥å»¶è¿Ÿå¢åŠ ï¼Œ>100ms
- Pod è°ƒåº¦å»¶è¿Ÿå¢åŠ ï¼Œ>5s
- èŠ‚ç‚¹å¿ƒè·³è¶…æ—¶ï¼ŒèŠ‚ç‚¹çŠ¶æ€é¢‘ç¹å˜åŒ–

**é”™è¯¯æ—¥å¿—**ï¼š

```text
2025-11-15T21:00:00.123Z WARN [k3s] API Server CPU usage: 85%
2025-11-15T21:00:05.456Z WARN [k3s] etcd write latency: 150ms
2025-11-15T21:00:10.789Z ERROR [k3s] Pod scheduling timeout: 8s
2025-11-15T21:00:15.012Z ERROR [k3s] Node heartbeat timeout
```

**æ—¶é—´çº¿**ï¼š

- **21:00:00** - æ§åˆ¶å¹³é¢ CPU ä½¿ç”¨ç‡å¼€å§‹ä¸Šå‡
- **21:00:05** - etcd å»¶è¿Ÿå¢åŠ 
- **21:00:10** - Pod è°ƒåº¦å¼€å§‹å»¶è¿Ÿ
- **21:00:15** - èŠ‚ç‚¹å¿ƒè·³è¶…æ—¶

### 1.2 ç¯å¢ƒä¿¡æ¯

**é›†ç¾¤ä¿¡æ¯**ï¼š

- **K3s ç‰ˆæœ¬**ï¼šv1.30.4+k3s1
- **èŠ‚ç‚¹æ•°**ï¼š50 ä¸ªèŠ‚ç‚¹
- **Pod æ•°**ï¼š500+ Pod
- **æ§åˆ¶å¹³é¢**ï¼šå•èŠ‚ç‚¹ï¼ˆServer èŠ‚ç‚¹ï¼‰

**èµ„æºé…ç½®**ï¼š

- **Server èŠ‚ç‚¹**ï¼š4C8G
- **etcd**ï¼šä½¿ç”¨ SQLiteï¼ˆK3s é»˜è®¤ï¼‰
- **API Server**ï¼šé»˜è®¤é…ç½®

### 1.3 å½±å“èŒƒå›´

- **å—å½±å“ç»„ä»¶**ï¼šAPI Serverã€etcdã€Scheduler
- **å—å½±å“æœåŠ¡**ï¼šæ‰€æœ‰éœ€è¦ API Server çš„æœåŠ¡
- **ä¸šåŠ¡å½±å“**ï¼šPod è°ƒåº¦å»¶è¿Ÿï¼ŒæœåŠ¡éƒ¨ç½²å˜æ…¢
- **ç”¨æˆ·å½±å“**ï¼šåº”ç”¨éƒ¨ç½²å’Œæ›´æ–°å˜æ…¢

---

## 2. æ•…éšœæ’æŸ¥è¿‡ç¨‹

### 2.1 åˆæ­¥è¯Šæ–­

**æ­¥éª¤ 1ï¼šæ£€æŸ¥æ§åˆ¶å¹³é¢èµ„æºä½¿ç”¨**ï¼š

```bash
# æ£€æŸ¥ CPU å’Œå†…å­˜ä½¿ç”¨
top
htop

# è¾“å‡ºæ˜¾ç¤º CPU ä½¿ç”¨ç‡ 85%ï¼Œå†…å­˜ä½¿ç”¨ç‡ 70%
```

**æ­¥éª¤ 2ï¼šæ£€æŸ¥ API Server å»¶è¿Ÿ**ï¼š

```bash
# æµ‹è¯• API Server å“åº”æ—¶é—´
time kubectl get nodes

# è¾“å‡ºæ˜¾ç¤ºå“åº”æ—¶é—´ >1s
```

**æ­¥éª¤ 3ï¼šæ£€æŸ¥ etcd å»¶è¿Ÿ**ï¼š

```bash
# æ£€æŸ¥ etcd å»¶è¿Ÿ
kubectl get --raw /metrics | grep etcd

# è¾“å‡ºæ˜¾ç¤ºå†™å…¥å»¶è¿Ÿ >100ms
```

**åˆæ­¥ç»“è®º**ï¼š

- æ§åˆ¶å¹³é¢èµ„æºä½¿ç”¨ç‡é«˜
- API Server å“åº”å»¶è¿Ÿ
- etcd å†™å…¥å»¶è¿Ÿ

### 2.2 æ·±å…¥æ’æŸ¥

**æ­¥éª¤ 4ï¼šæ£€æŸ¥ API Server è¯·æ±‚é‡**ï¼š

```bash
# æ£€æŸ¥ API Server è¯·æ±‚é€Ÿç‡
kubectl get --raw /metrics | grep apiserver_request_total

# è¾“å‡ºæ˜¾ç¤ºè¯·æ±‚é€Ÿç‡å¾ˆé«˜
```

**æ­¥éª¤ 5ï¼šæ£€æŸ¥ etcd æ“ä½œ**ï¼š

```bash
# æ£€æŸ¥ etcd æ“ä½œé¢‘ç‡
kubectl get --raw /metrics | grep etcd_request_duration

# è¾“å‡ºæ˜¾ç¤ºæ“ä½œé¢‘ç‡å¾ˆé«˜
```

**æ­¥éª¤ 6ï¼šæ£€æŸ¥ Pod è°ƒåº¦**ï¼š

```bash
# æ£€æŸ¥å¾…è°ƒåº¦çš„ Pod
kubectl get pods --all-namespaces --field-selector=status.phase=Pending

# è¾“å‡ºæ˜¾ç¤ºå¤§é‡å¾…è°ƒåº¦çš„ Pod
```

**æ­¥éª¤ 7ï¼šæ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€**ï¼š

```bash
# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes

# è¾“å‡ºæ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€é¢‘ç¹å˜åŒ–
```

**æ·±å…¥æ’æŸ¥ç»“è®º**ï¼š

- API Server è¯·æ±‚é‡è¿‡å¤§
- etcd æ“ä½œé¢‘ç‡è¿‡é«˜
- Pod è°ƒåº¦é˜Ÿåˆ—ç§¯å‹
- èŠ‚ç‚¹çŠ¶æ€é¢‘ç¹å˜åŒ–å¯¼è‡´é¢å¤–è´Ÿè½½

### 2.3 æ ¹å› åˆ†æ

**æ ¹å›  1ï¼šå•èŠ‚ç‚¹æ§åˆ¶å¹³é¢**ï¼š

- K3s ä½¿ç”¨å•èŠ‚ç‚¹æ§åˆ¶å¹³é¢
- æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹
- èŠ‚ç‚¹èµ„æºä¸è¶³

**æ ¹å›  2ï¼šetcd ä½¿ç”¨ SQLite**ï¼š

- K3s é»˜è®¤ä½¿ç”¨ SQLite ä½œä¸º etcd
- SQLite åœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½è¾ƒå·®
- å†™å…¥å»¶è¿Ÿé«˜

**æ ¹å›  3ï¼šå¤§é‡ Pod è°ƒåº¦è¯·æ±‚**ï¼š

- 500+ Pod éœ€è¦è°ƒåº¦
- è°ƒåº¦å™¨å¤„ç†ä¸è¿‡æ¥
- è°ƒåº¦é˜Ÿåˆ—ç§¯å‹

**æ ¹å›  4ï¼šèŠ‚ç‚¹çŠ¶æ€é¢‘ç¹å˜åŒ–**ï¼š

- èŠ‚ç‚¹å¿ƒè·³è¶…æ—¶
- å¯¼è‡´èŠ‚ç‚¹çŠ¶æ€é¢‘ç¹æ›´æ–°
- å¢åŠ  etcd å†™å…¥å‹åŠ›

**æ ¹æœ¬åŸå› **ï¼š

**å•èŠ‚ç‚¹æ§åˆ¶å¹³é¢èµ„æºä¸è¶³å’Œ etcd æ€§èƒ½ç“¶é¢ˆ**ï¼šK3s å•èŠ‚ç‚¹æ§åˆ¶å¹³é¢åœ¨é«˜è´Ÿè½½ä¸‹èµ„æºä¸è¶³ï¼Œä¸”ä½¿ç”¨ SQLite ä½œä¸º etcd åœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½è¾ƒå·®ï¼Œå¯¼è‡´æ§åˆ¶å¹³é¢é«˜è´Ÿè½½ã€‚

---

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå¢åŠ æ§åˆ¶å¹³é¢èµ„æº**ï¼š

```bash
# å¢åŠ  Server èŠ‚ç‚¹èµ„æº
# ä» 4C8G å‡çº§åˆ° 8C16G
```

**æ–¹æ¡ˆ 2ï¼šé™åˆ¶ API Server è¯·æ±‚**ï¼š

```bash
# é…ç½® API Server é™æµ
# ç¼–è¾‘ /etc/rancher/k3s/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
data:
  config.yaml: |
    kube-apiserver-arg:
      - "max-requests-inflight=400"
      - "max-mutating-requests-inflight=200"
```

**æ–¹æ¡ˆ 3ï¼šå‡å°‘ Pod è°ƒåº¦é¢‘ç‡**ï¼š

```bash
# æš‚åœéƒ¨åˆ† Pod åˆ›å»º
kubectl scale deployment app --replicas=0
```

**ä¸´æ—¶æ–¹æ¡ˆæ•ˆæœ**ï¼š

- âœ… å¯ä»¥å¿«é€Ÿç¼“è§£è´Ÿè½½
- âš ï¸ ä½†æœªè§£å†³æ ¹æœ¬é—®é¢˜
- âš ï¸ å¯èƒ½å½±å“æœåŠ¡å¯ç”¨æ€§

### 3.2 æ°¸ä¹…è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå‡çº§åˆ°å¤šèŠ‚ç‚¹æ§åˆ¶å¹³é¢**ï¼š

```bash
# æ·»åŠ é¢å¤–çš„ Server èŠ‚ç‚¹
curl -sfL https://get.k3s.io | K3S_TOKEN=xxx K3S_URL=https://server1:6443 sh -s - server

# é…ç½®è´Ÿè½½å‡è¡¡
# ä½¿ç”¨å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨åˆ†å‘è¯·æ±‚
```

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨å¤–éƒ¨ etcd**ï¼š

```bash
# é…ç½® K3s ä½¿ç”¨å¤–éƒ¨ etcd
curl -sfL https://get.k3s.io | \
  INSTALL_K3S_EXEC="--datastore-endpoint=etcd://etcd-server:2379" sh -
```

**æ–¹æ¡ˆ 3ï¼šä¼˜åŒ– etcd é…ç½®**ï¼š

```bash
# å¦‚æœä½¿ç”¨ SQLiteï¼Œä¼˜åŒ– SQLite é…ç½®
# ç¼–è¾‘ /etc/rancher/k3s/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
data:
  config.yaml: |
    etcd-arg:
      - "max-request-bytes=1572864"
      - "quota-backend-bytes=8589934592"
```

**æ–¹æ¡ˆ 4ï¼šä¼˜åŒ–è°ƒåº¦å™¨é…ç½®**ï¼š

```bash
# é…ç½®è°ƒåº¦å™¨å‚æ•°
# ç¼–è¾‘ /etc/rancher/k3s/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
data:
  config.yaml: |
    kube-scheduler-arg:
      - "bind-address=0.0.0.0"
      - "leader-elect=true"
      - "profiling=false"
```

**æ–¹æ¡ˆ 5ï¼šä¼˜åŒ–èŠ‚ç‚¹å¿ƒè·³**ï¼š

```bash
# å¢åŠ èŠ‚ç‚¹å¿ƒè·³é—´éš”
# ç¼–è¾‘ /etc/rancher/k3s/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
data:
  config.yaml: |
    kubelet-arg:
      - "node-status-update-frequency=10s"
      - "node-status-report-frequency=1m"
```

### 3.3 é¢„é˜²æªæ–½

1. **èµ„æºè§„åˆ’**ï¼š
   - åˆç†è§„åˆ’æ§åˆ¶å¹³é¢èµ„æº
   - æ ¹æ®é›†ç¾¤è§„æ¨¡é€‰æ‹©é…ç½®
   - é¢„ç•™è¶³å¤Ÿçš„èµ„æºä½™é‡

2. **ç›‘æ§å‘Šè­¦**ï¼š
   - ç›‘æ§æ§åˆ¶å¹³é¢èµ„æºä½¿ç”¨
   - é…ç½® CPU/å†…å­˜å‘Šè­¦
   - ç›‘æ§ API Server å»¶è¿Ÿ

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨å¤–éƒ¨ etcdï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   - é…ç½® API Server é™æµ
   - ä¼˜åŒ–è°ƒåº¦å™¨é…ç½®

4. **å®¹é‡è§„åˆ’**ï¼š
   - æ ¹æ® Pod æ•°é‡è§„åˆ’èµ„æº
   - è€ƒè™‘èŠ‚ç‚¹æ•°é‡å½±å“
   - å®šæœŸè¯„ä¼°é›†ç¾¤å®¹é‡

---

## 4. éªŒè¯ä¸æ¢å¤

### 4.1 éªŒè¯æ­¥éª¤

**æ­¥éª¤ 1ï¼šéªŒè¯èµ„æºä½¿ç”¨**ï¼š

```bash
# æ£€æŸ¥ CPU å’Œå†…å­˜ä½¿ç”¨
top
htop

# åº”è¯¥çœ‹åˆ° CPU ä½¿ç”¨ç‡ <60%ï¼Œå†…å­˜ä½¿ç”¨ç‡ <70%
```

**æ­¥éª¤ 2ï¼šéªŒè¯ API Server å»¶è¿Ÿ**ï¼š

```bash
# æµ‹è¯• API Server å“åº”æ—¶é—´
time kubectl get nodes

# åº”è¯¥çœ‹åˆ°å“åº”æ—¶é—´ <500ms
```

**æ­¥éª¤ 3ï¼šéªŒè¯ etcd å»¶è¿Ÿ**ï¼š

```bash
# æ£€æŸ¥ etcd å»¶è¿Ÿ
kubectl get --raw /metrics | grep etcd

# åº”è¯¥çœ‹åˆ°å†™å…¥å»¶è¿Ÿ <50ms
```

**æ­¥éª¤ 4ï¼šéªŒè¯ Pod è°ƒåº¦**ï¼š

```bash
# æ£€æŸ¥ Pod è°ƒåº¦æ—¶é—´
kubectl get pods --all-namespaces

# åº”è¯¥çœ‹åˆ° Pod å¿«é€Ÿè°ƒåº¦
```

### 4.2 æ¢å¤ç¡®è®¤

**æ¢å¤æ—¶é—´çº¿**ï¼š

- **æ•…éšœå‘ç°**ï¼š21:00:00
- **å¼€å§‹æ’æŸ¥**ï¼š21:00:05
- **æ ¹å› ç¡®è®¤**ï¼š21:15:00
- **é—®é¢˜è§£å†³**ï¼š21:30:00
- **æœåŠ¡æ¢å¤**ï¼š21:35:00
- **æ€»è€—æ—¶**ï¼š35 åˆ†é’Ÿ

**æ¢å¤éªŒè¯**ï¼š

- âœ… æ§åˆ¶å¹³é¢èµ„æºä½¿ç”¨æ­£å¸¸
- âœ… API Server å“åº”æ—¶é—´æ­£å¸¸
- âœ… etcd å»¶è¿Ÿæ­£å¸¸
- âœ… Pod è°ƒåº¦æ­£å¸¸

---

## 5. ç»éªŒæ€»ç»“

### 5.1 å…³é”®å‘ç°

1. **å•èŠ‚ç‚¹æ§åˆ¶å¹³é¢é™åˆ¶**ï¼š
   - å•èŠ‚ç‚¹æ§åˆ¶å¹³é¢æœ‰æ€§èƒ½ä¸Šé™
   - é«˜è´Ÿè½½ä¸‹éœ€è¦å¤šèŠ‚ç‚¹
   - æˆ–ä½¿ç”¨å¤–éƒ¨ etcd

2. **SQLite æ€§èƒ½é™åˆ¶**ï¼š
   - SQLite é€‚åˆå°è§„æ¨¡é›†ç¾¤
   - å¤§è§„æ¨¡é›†ç¾¤éœ€è¦å¤–éƒ¨ etcd
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å¤–éƒ¨ etcd

3. **èµ„æºè§„åˆ’é‡è¦**ï¼š
   - éœ€è¦æ ¹æ®é›†ç¾¤è§„æ¨¡è§„åˆ’èµ„æº
   - é¢„ç•™è¶³å¤Ÿçš„èµ„æºä½™é‡
   - å®šæœŸè¯„ä¼°å’Œè°ƒæ•´

### 5.2 æœ€ä½³å®è·µ

1. **èµ„æºè§„åˆ’**ï¼š
   - æ ¹æ®é›†ç¾¤è§„æ¨¡é€‰æ‹©é…ç½®
   - é¢„ç•™ 30-40% èµ„æºä½™é‡
   - å®šæœŸè¯„ä¼°èµ„æºä½¿ç”¨

2. **etcd é€‰æ‹©**ï¼š
   - å°è§„æ¨¡é›†ç¾¤å¯ä»¥ä½¿ç”¨ SQLite
   - å¤§è§„æ¨¡é›†ç¾¤ä½¿ç”¨å¤–éƒ¨ etcd
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¤–éƒ¨ etcd

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - é…ç½® API Server é™æµ
   - ä¼˜åŒ–è°ƒåº¦å™¨é…ç½®
   - ä¼˜åŒ–èŠ‚ç‚¹å¿ƒè·³é—´éš”

4. **ç›‘æ§å‘Šè­¦**ï¼š
   - ç›‘æ§æ§åˆ¶å¹³é¢èµ„æº
   - é…ç½®å‘Šè­¦è§„åˆ™
   - å®šæœŸæ£€æŸ¥æ€§èƒ½æŒ‡æ ‡

### 5.3 ç›¸å…³æ–‡æ¡£

- [`../../TECHNICAL/02-k3s/k3s.md`](../../TECHNICAL/02-k3s/k3s.md) - K3s æ–‡æ¡£
- [`../troubleshooting.md`](../troubleshooting.md) - æ•…éšœæ’æŸ¥æŒ‡å—
- [K3s é«˜å¯ç”¨æ–‡æ¡£](https://docs.k3s.io/installation/high-availability) - K3s é«˜å¯ç”¨é…ç½®

---

## 6. ç›¸å…³æ–‡æ¡£

- [`../README.md`](README.md) - æ•…éšœæ’æŸ¥æ¡ˆä¾‹é›†ç›®å½•
- [`../../TECHNICAL/02-k3s/k3s.md`](../../TECHNICAL/02-k3s/k3s.md) - K3s æ–‡æ¡£
- [`../troubleshooting.md`](../troubleshooting.md) - æ•…éšœæ’æŸ¥æŒ‡å—

---

**æœ€åæ›´æ–°**ï¼š2025-11-15
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
**ç‰ˆæœ¬**ï¼šv1.0
