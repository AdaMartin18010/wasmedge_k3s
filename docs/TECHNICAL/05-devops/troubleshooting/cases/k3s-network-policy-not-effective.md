# æ¡ˆä¾‹ K-004ï¼šK3s ç½‘ç»œç­–ç•¥ä¸ç”Ÿæ•ˆ

> **æ¡ˆä¾‹ç¼–å·**ï¼šK-004
> **æ•…éšœç±»å‹**ï¼šç½‘ç»œç­–ç•¥æ•…éšœ
> **ä¸¥é‡ç¨‹åº¦**ï¼šä¸­ç­‰
> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-15
> **æœ€åæ›´æ–°**ï¼š2025-11-15

---

## ğŸ“‘ ç›®å½•

- [æ¡ˆä¾‹ K-004ï¼šK3s ç½‘ç»œç­–ç•¥ä¸ç”Ÿæ•ˆ](#æ¡ˆä¾‹-k-004k3s-ç½‘ç»œç­–ç•¥ä¸ç”Ÿæ•ˆ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. é—®é¢˜æè¿°](#1-é—®é¢˜æè¿°)
    - [1.1 æ•…éšœç°è±¡](#11-æ•…éšœç°è±¡)
    - [1.2 ç¯å¢ƒä¿¡æ¯](#12-ç¯å¢ƒä¿¡æ¯)
    - [1.3 å½±å“èŒƒå›´](#13-å½±å“èŒƒå›´)
  - [2. æ•…éšœæ’æŸ¥è¿‡ç¨‹](#2-æ•…éšœæ’æŸ¥è¿‡ç¨‹)
    - [2.1 åˆæ­¥è¯Šæ–­](#21-åˆæ­¥è¯Šæ–­)
    - [2.2 æ·±å…¥æ’æŸ¥](#22-æ·±å…¥æ’æŸ¥)
    - [2.3 æ ¹å› åˆ†æ](#23-æ ¹å› åˆ†æ)
  - [3. è§£å†³æ–¹æ¡ˆ](#3-è§£å†³æ–¹æ¡ˆ)
    - [3.1 ä¸´æ—¶è§£å†³æ–¹æ¡ˆ](#31-ä¸´æ—¶è§£å†³æ–¹æ¡ˆ)
    - [3.2 æ°¸ä¹…è§£å†³æ–¹æ¡ˆ](#32-æ°¸ä¹…è§£å†³æ–¹æ¡ˆ)
    - [3.3 é¢„é˜²æªæ–½](#33-é¢„é˜²æªæ–½)
  - [4. éªŒè¯ä¸æ¢å¤](#4-éªŒè¯ä¸æ¢å¤)
    - [4.1 éªŒè¯æ­¥éª¤](#41-éªŒè¯æ­¥éª¤)
    - [4.2 æ¢å¤ç¡®è®¤](#42-æ¢å¤ç¡®è®¤)
  - [5. ç»éªŒæ€»ç»“](#5-ç»éªŒæ€»ç»“)
    - [5.1 å…³é”®å‘ç°](#51-å…³é”®å‘ç°)
    - [5.2 æœ€ä½³å®è·µ](#52-æœ€ä½³å®è·µ)
    - [5.3 ç›¸å…³æ–‡æ¡£](#53-ç›¸å…³æ–‡æ¡£)
  - [6. ç›¸å…³æ–‡æ¡£](#6-ç›¸å…³æ–‡æ¡£)

---

## 1. é—®é¢˜æè¿°

### 1.1 æ•…éšœç°è±¡

**ä¸»è¦ç—‡çŠ¶**ï¼š

- K3s ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰é…ç½®åä¸ç”Ÿæ•ˆ
- Pod ä¹‹é—´ä»ç„¶å¯ä»¥äº’ç›¸è®¿é—®ï¼Œç­–ç•¥è§„åˆ™è¢«å¿½ç•¥
- æ—¥å¿—æ˜¾ç¤ºç½‘ç»œç­–ç•¥å·²åˆ›å»ºï¼Œä½†æœªåº”ç”¨
- ç½‘ç»œç­–ç•¥çŠ¶æ€ä¸º `Active`ï¼Œä½†å®é™…æœªç”Ÿæ•ˆ

**é”™è¯¯æ—¥å¿—**ï¼š

```text
2025-11-15T20:00:00.123Z INFO [k3s] NetworkPolicy default/deny-all created
2025-11-15T20:00:05.456Z WARN [k3s] NetworkPolicy not applied to pods
2025-11-15T20:00:10.789Z ERROR [k3s] Pod communication not blocked by policy
```

**æ—¶é—´çº¿**ï¼š

- **20:00:00** - åˆ›å»ºç½‘ç»œç­–ç•¥
- **20:00:05** - ç­–ç•¥æœªç”Ÿæ•ˆï¼ŒPod ä»å¯é€šä¿¡
- **20:00:10** - ç¡®è®¤ç­–ç•¥é…ç½®æ­£ç¡®ä½†æœªåº”ç”¨

### 1.2 ç¯å¢ƒä¿¡æ¯

**é›†ç¾¤ä¿¡æ¯**ï¼š

- **K3s ç‰ˆæœ¬**ï¼šv1.30.4+k3s1
- **CNI æ’ä»¶**ï¼šflannel
- **ç½‘ç»œæ¨¡å¼**ï¼šVXLAN

**ç½‘ç»œç­–ç•¥é…ç½®**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: default
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
```

### 1.3 å½±å“èŒƒå›´

- **å—å½±å“ Pod**ï¼šæ‰€æœ‰ default å‘½åç©ºé—´çš„ Pod
- **å—å½±å“æœåŠ¡**ï¼šæ‰€æœ‰ç½‘ç»œé€šä¿¡æœåŠ¡
- **ä¸šåŠ¡å½±å“**ï¼šç½‘ç»œç­–ç•¥æ— æ³•ç”Ÿæ•ˆï¼Œå®‰å…¨ç­–ç•¥å¤±æ•ˆ
- **ç”¨æˆ·å½±å“**ï¼šæ— æ³•å®ç°é¢„æœŸçš„ç½‘ç»œéš”ç¦»

---

## 2. æ•…éšœæ’æŸ¥è¿‡ç¨‹

### 2.1 åˆæ­¥è¯Šæ–­

**æ­¥éª¤ 1ï¼šæ£€æŸ¥ç½‘ç»œç­–ç•¥çŠ¶æ€**ï¼š

```bash
# æŸ¥çœ‹ç½‘ç»œç­–ç•¥
kubectl get networkpolicy -n default

# è¾“å‡ºæ˜¾ç¤ºç­–ç•¥å­˜åœ¨
NAME        POD-SELECTOR   AGE
deny-all    <none>         5m
```

**æ­¥éª¤ 2ï¼šæ£€æŸ¥ CNI æ’ä»¶**ï¼š

```bash
# æ£€æŸ¥ flannel çŠ¶æ€
kubectl get pods -n kube-system | grep flannel

# æ£€æŸ¥ CNI é…ç½®
cat /etc/cni/net.d/*.conf
```

**æ­¥éª¤ 3ï¼šæµ‹è¯•ç½‘ç»œç­–ç•¥**ï¼š

```bash
# æµ‹è¯• Pod é—´é€šä¿¡
kubectl exec -it pod-a -- ping pod-b

# ä»ç„¶å¯ä»¥é€šä¿¡ï¼Œç­–ç•¥æœªç”Ÿæ•ˆ
```

**åˆæ­¥ç»“è®º**ï¼š

- ç½‘ç»œç­–ç•¥å·²åˆ›å»º
- CNI æ’ä»¶è¿è¡Œæ­£å¸¸
- ä½†ç­–ç•¥æœªç”Ÿæ•ˆ

### 2.2 æ·±å…¥æ’æŸ¥

**æ­¥éª¤ 4ï¼šæ£€æŸ¥ CNI æ’ä»¶æ”¯æŒ**ï¼š

```bash
# æ£€æŸ¥ flannel æ˜¯å¦æ”¯æŒç½‘ç»œç­–ç•¥
kubectl describe daemonset kube-flannel-ds -n kube-system

# å‘ç° flannel é»˜è®¤ä¸æ”¯æŒç½‘ç»œç­–ç•¥
```

**æ­¥éª¤ 5ï¼šæ£€æŸ¥ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨**ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨
kubectl get pods -n kube-system | grep network-policy

# æœªæ‰¾åˆ°ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨
```

**æ­¥éª¤ 6ï¼šæ£€æŸ¥ CNI é…ç½®**ï¼š

```bash
# æ£€æŸ¥ CNI é…ç½®
cat /var/lib/rancher/k3s/agent/etc/cni/net.d/10-flannel.conflist

# å‘ç°æœªé…ç½®ç½‘ç»œç­–ç•¥æ”¯æŒ
```

**æ·±å…¥æ’æŸ¥ç»“è®º**ï¼š

- flannel é»˜è®¤ä¸æ”¯æŒç½‘ç»œç­–ç•¥
- éœ€è¦å®‰è£…ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨ï¼ˆå¦‚ Calico æˆ– Ciliumï¼‰
- æˆ–è€…åˆ‡æ¢åˆ°æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI æ’ä»¶

### 2.3 æ ¹å› åˆ†æ

**æ ¹å›  1ï¼šCNI æ’ä»¶ä¸æ”¯æŒç½‘ç»œç­–ç•¥**ï¼š

- flannel æ˜¯ç®€å•çš„è¦†ç›–ç½‘ç»œï¼Œä¸æ”¯æŒç½‘ç»œç­–ç•¥
- éœ€è¦æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI æ’ä»¶ï¼ˆå¦‚ Calicoã€Ciliumï¼‰

**æ ¹å›  2ï¼šç¼ºå°‘ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨**ï¼š

- K3s é»˜è®¤ä½¿ç”¨ flannelï¼Œä¸åŒ…å«ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨
- éœ€è¦å•ç‹¬å®‰è£…ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨

**æ ¹å›  3ï¼šCNI é…ç½®æœªå¯ç”¨ç½‘ç»œç­–ç•¥**ï¼š

- CNI é…ç½®ä¸­æœªå¯ç”¨ç½‘ç»œç­–ç•¥åŠŸèƒ½
- éœ€è¦é…ç½®æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI

**æ ¹æœ¬åŸå› **ï¼š

**flannel CNI æ’ä»¶ä¸æ”¯æŒç½‘ç»œç­–ç•¥**ï¼šK3s é»˜è®¤ä½¿ç”¨ flannelï¼Œä½† flannel ä¸æ”¯æŒ Kubernetes ç½‘ç»œç­–ç•¥ï¼Œéœ€è¦åˆ‡æ¢åˆ°æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI æ’ä»¶æˆ–å®‰è£…ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨ã€‚

---

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ iptables è§„åˆ™**ï¼š

```bash
# æ‰‹åŠ¨æ·»åŠ  iptables è§„åˆ™å®ç°ç½‘ç»œéš”ç¦»
iptables -A FORWARD -s 10.42.0.0/16 -d 10.42.1.0/24 -j DROP
```

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Pod å®‰å…¨ç­–ç•¥**ï¼š

```yaml
# ä½¿ç”¨ Pod å®‰å…¨ç­–ç•¥é™åˆ¶ç½‘ç»œè®¿é—®
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  hostNetwork: false
  hostIPC: false
  hostPID: false
```

**ä¸´æ—¶æ–¹æ¡ˆæ•ˆæœ**ï¼š

- âœ… å¯ä»¥å¿«é€Ÿå®ç°ç½‘ç»œéš”ç¦»
- âš ï¸ ä½†ç®¡ç†å¤æ‚ï¼Œä¸æ˜“ç»´æŠ¤
- âš ï¸ ä¸ç¬¦åˆ Kubernetes æœ€ä½³å®è·µ

### 3.2 æ°¸ä¹…è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šåˆ‡æ¢åˆ° Calico CNI**ï¼š

```bash
# å¸è½½ flannel
kubectl delete -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# å®‰è£… Calico
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

# éªŒè¯ Calico å®‰è£…
kubectl get pods -n kube-system | grep calico
```

**æ–¹æ¡ˆ 2ï¼šåˆ‡æ¢åˆ° Cilium CNI**ï¼š

```bash
# å¸è½½ flannel
kubectl delete -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# å®‰è£… Cilium
helm repo add cilium https://helm.cilium.io/
helm install cilium cilium/cilium --namespace kube-system

# éªŒè¯ Cilium å®‰è£…
kubectl get pods -n kube-system | grep cilium
```

**æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ K3s å†…ç½® Calico**ï¼š

```bash
# é‡æ–°å®‰è£… K3sï¼Œä½¿ç”¨ Calico CNI
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--flannel-backend=none --cluster-cidr=10.42.0.0/16" sh -

# å®‰è£… Calico
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
```

**æ–¹æ¡ˆ 4ï¼šå®‰è£…ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨**ï¼š

```bash
# å®‰è£… Calico ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨ï¼ˆä¸æ›¿æ¢ CNIï¼‰
kubectl apply -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
kubectl apply -f https://docs.projectcalico.org/manifests/custom-resources.yaml
```

### 3.3 é¢„é˜²æªæ–½

1. **CNI é€‰å‹**ï¼š
   - é€‰æ‹©æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI æ’ä»¶
   - åœ¨éƒ¨ç½²å‰éªŒè¯ CNI åŠŸèƒ½
   - ä½¿ç”¨ Calico æˆ– Cilium ç­‰æˆç†Ÿæ–¹æ¡ˆ

2. **ç½‘ç»œç­–ç•¥æµ‹è¯•**ï¼š
   - éƒ¨ç½²åç«‹å³æµ‹è¯•ç½‘ç»œç­–ç•¥
   - éªŒè¯ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ
   - å®šæœŸæ£€æŸ¥ç­–ç•¥çŠ¶æ€

3. **æ–‡æ¡£è®°å½•**ï¼š
   - è®°å½• CNI æ’ä»¶é…ç½®
   - è®°å½•ç½‘ç»œç­–ç•¥é…ç½®
   - ç»´æŠ¤ç½‘ç»œç­–ç•¥æ–‡æ¡£

4. **ç›‘æ§å‘Šè­¦**ï¼š
   - ç›‘æ§ç½‘ç»œç­–ç•¥çŠ¶æ€
   - é…ç½®ç­–ç•¥å¤±æ•ˆå‘Šè­¦
   - å®šæœŸæ£€æŸ¥ç­–ç•¥æœ‰æ•ˆæ€§

---

## 4. éªŒè¯ä¸æ¢å¤

### 4.1 éªŒè¯æ­¥éª¤

**æ­¥éª¤ 1ï¼šéªŒè¯ CNI æ’ä»¶**ï¼š

```bash
# æ£€æŸ¥ Calico çŠ¶æ€
kubectl get pods -n kube-system | grep calico

# åº”è¯¥çœ‹åˆ° Calico ç»„ä»¶è¿è¡Œæ­£å¸¸
```

**æ­¥éª¤ 2ï¼šéªŒè¯ç½‘ç»œç­–ç•¥**ï¼š

```bash
# åˆ›å»ºæµ‹è¯•ç½‘ç»œç­–ç•¥
kubectl apply -f network-policy.yaml

# æµ‹è¯•ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ
kubectl exec -it pod-a -- ping pod-b

# åº”è¯¥æ— æ³•é€šä¿¡
```

**æ­¥éª¤ 3ï¼šéªŒè¯ç­–ç•¥åº”ç”¨**ï¼š

```bash
# æ£€æŸ¥ç½‘ç»œç­–ç•¥çŠ¶æ€
kubectl describe networkpolicy deny-all -n default

# åº”è¯¥çœ‹åˆ°ç­–ç•¥å·²åº”ç”¨
```

### 4.2 æ¢å¤ç¡®è®¤

**æ¢å¤æ—¶é—´çº¿**ï¼š

- **æ•…éšœå‘ç°**ï¼š20:00:00
- **å¼€å§‹æ’æŸ¥**ï¼š20:00:05
- **æ ¹å› ç¡®è®¤**ï¼š20:10:00
- **é—®é¢˜è§£å†³**ï¼š20:20:00
- **æœåŠ¡æ¢å¤**ï¼š20:25:00
- **æ€»è€—æ—¶**ï¼š25 åˆ†é’Ÿ

**æ¢å¤éªŒè¯**ï¼š

- âœ… CNI æ’ä»¶åˆ‡æ¢æˆåŠŸ
- âœ… ç½‘ç»œç­–ç•¥ç”Ÿæ•ˆ
- âœ… Pod é—´é€šä¿¡è¢«æ­£ç¡®é™åˆ¶
- âœ… æœåŠ¡å¯ç”¨æ€§æ¢å¤

---

## 5. ç»éªŒæ€»ç»“

### 5.1 å…³é”®å‘ç°

1. **CNI æ’ä»¶é€‰æ‹©å¾ˆé‡è¦**ï¼š
   - flannel ä¸æ”¯æŒç½‘ç»œç­–ç•¥
   - éœ€è¦é€‰æ‹©æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI
   - Calico å’Œ Cilium æ˜¯å¥½çš„é€‰æ‹©

2. **ç½‘ç»œç­–ç•¥éœ€è¦ CNI æ”¯æŒ**ï¼š
   - ç½‘ç»œç­–ç•¥æ˜¯ Kubernetes åŠŸèƒ½
   - ä½†éœ€è¦ CNI æ’ä»¶å®ç°
   - ä¸æ˜¯æ‰€æœ‰ CNI éƒ½æ”¯æŒ

3. **K3s é»˜è®¤é…ç½®é™åˆ¶**ï¼š
   - K3s é»˜è®¤ä½¿ç”¨ flannel
   - flannel ä¸æ”¯æŒç½‘ç»œç­–ç•¥
   - éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ CNI

### 5.2 æœ€ä½³å®è·µ

1. **CNI é€‰å‹**ï¼š
   - é€‰æ‹©æ”¯æŒç½‘ç»œç­–ç•¥çš„ CNI
   - åœ¨éƒ¨ç½²å‰éªŒè¯åŠŸèƒ½
   - ä½¿ç”¨æˆç†Ÿç¨³å®šçš„æ–¹æ¡ˆ

2. **ç½‘ç»œç­–ç•¥è®¾è®¡**ï¼š
   - ä½¿ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥
   - æ˜ç¡®å…è®¸çš„æµé‡
   - å®šæœŸå®¡æŸ¥ç­–ç•¥è§„åˆ™

3. **æµ‹è¯•éªŒè¯**ï¼š
   - éƒ¨ç½²åç«‹å³æµ‹è¯•
   - éªŒè¯ç­–ç•¥ç”Ÿæ•ˆ
   - å®šæœŸæ£€æŸ¥ç­–ç•¥çŠ¶æ€

4. **æ–‡æ¡£ç»´æŠ¤**ï¼š
   - è®°å½• CNI é…ç½®
   - è®°å½•ç½‘ç»œç­–ç•¥
   - ç»´æŠ¤ç½‘ç»œæ¶æ„æ–‡æ¡£

### 5.3 ç›¸å…³æ–‡æ¡£

- [`../../TECHNICAL/02-k3s/k3s.md`](../../TECHNICAL/02-k3s/k3s.md) - K3s æ–‡æ¡£
- [`../troubleshooting.md`](../troubleshooting.md) - æ•…éšœæ’æŸ¥æŒ‡å—
- [Kubernetes ç½‘ç»œç­–ç•¥æ–‡æ¡£](https://kubernetes.io/docs/concepts/services-networking/network-policies/) - K8s ç½‘ç»œç­–ç•¥

---

## 6. ç›¸å…³æ–‡æ¡£

- [`../README.md`](README.md) - æ•…éšœæ’æŸ¥æ¡ˆä¾‹é›†ç›®å½•
- [`../../TECHNICAL/02-k3s/k3s.md`](../../TECHNICAL/02-k3s/k3s.md) - K3s æ–‡æ¡£
- [`../troubleshooting.md`](../troubleshooting.md) - æ•…éšœæ’æŸ¥æŒ‡å—

---

**æœ€åæ›´æ–°**ï¼š2025-11-15
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
**ç‰ˆæœ¬**ï¼šv1.0
