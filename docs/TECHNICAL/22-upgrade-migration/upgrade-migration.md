# 22. å‡çº§å’Œè¿ç§»ï¼šå…¨é¢æ¢³ç†

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [22.1 æ–‡æ¡£å®šä½](#221-æ–‡æ¡£å®šä½)
- [22.2 å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆå…¨æ™¯](#222-å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆå…¨æ™¯)
  - [22.2.1 å‡çº§å’Œè¿ç§»åˆ†ç±»](#2221-å‡çº§å’Œè¿ç§»åˆ†ç±»)
  - [22.2.2 æŠ€æœ¯ç»„ä»¶çŸ©é˜µ](#2222-æŠ€æœ¯ç»„ä»¶çŸ©é˜µ)
  - [22.2.3 æŠ€æœ¯æ ˆç»„åˆ](#2223-æŠ€æœ¯æ ˆç»„åˆ)
- [22.3 Kubernetes ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼](#223-kubernetes-ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼)
  - [22.3.1 å‡çº§ç­–ç•¥](#2231-å‡çº§ç­–ç•¥)
  - [22.3.2 æ»šåŠ¨å‡çº§è§„æ ¼](#2232-æ»šåŠ¨å‡çº§è§„æ ¼)
  - [22.3.3 å‡çº§å‰å‡†å¤‡](#2233-å‡çº§å‰å‡†å¤‡)
  - [22.3.4 å‡çº§æµç¨‹](#2234-å‡çº§æµç¨‹)
  - [22.3.5 å‡çº§åéªŒè¯](#2235-å‡çº§åéªŒè¯)
  - [22.3.6 å‡çº§å›æ»š](#2236-å‡çº§å›æ»š)
- [22.4 K3s ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼](#224-k3s-ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼)
  - [22.4.1 å‡çº§ç­–ç•¥](#2241-å‡çº§ç­–ç•¥)
  - [22.4.2 å‡çº§æµç¨‹](#2242-å‡çº§æµç¨‹)
  - [22.4.3 å‡çº§å‰å‡†å¤‡](#2243-å‡çº§å‰å‡†å¤‡)
  - [22.4.4 å‡çº§åéªŒè¯](#2244-å‡çº§åéªŒè¯)
- [22.5 è¿è¡Œæ—¶è¿ç§»æŠ€æœ¯è§„æ ¼](#225-è¿è¡Œæ—¶è¿ç§»æŠ€æœ¯è§„æ ¼)
  - [22.5.1 Docker åˆ° containerd è¿ç§»](#2251-docker-åˆ°-containerd-è¿ç§»)
  - [22.5.2 runc åˆ° crun è¿ç§»](#2252-runc-åˆ°-crun-è¿ç§»)
  - [22.5.3 ä¼ ç»Ÿå®¹å™¨åˆ° Wasm è¿ç§»](#2253-ä¼ ç»Ÿå®¹å™¨åˆ°-wasm-è¿ç§»)
  - [22.5.4 è¿è¡Œæ—¶è¿ç§»ç­–ç•¥](#2254-è¿è¡Œæ—¶è¿ç§»ç­–ç•¥)
- [22.6 ç¼–æ’ç³»ç»Ÿè¿ç§»æŠ€æœ¯è§„æ ¼](#226-ç¼–æ’ç³»ç»Ÿè¿ç§»æŠ€æœ¯è§„æ ¼)
  - [22.6.1 Kubernetes åˆ° K3s è¿ç§»](#2261-kubernetes-åˆ°-k3s-è¿ç§»)
  - [22.6.2 å•é›†ç¾¤åˆ°å¤šé›†ç¾¤è¿ç§»](#2262-å•é›†ç¾¤åˆ°å¤šé›†ç¾¤è¿ç§»)
  - [22.6.3 å¤šé›†ç¾¤åˆ°è”é‚¦è¿ç§»](#2263-å¤šé›†ç¾¤åˆ°è”é‚¦è¿ç§»)
  - [22.6.4 ç¼–æ’ç³»ç»Ÿè¿ç§»ç­–ç•¥](#2264-ç¼–æ’ç³»ç»Ÿè¿ç§»ç­–ç•¥)
- [22.7 åº”ç”¨è¿ç§»æŠ€æœ¯è§„æ ¼](#227-åº”ç”¨è¿ç§»æŠ€æœ¯è§„æ ¼)
  - [22.7.1 åº”ç”¨è¿ç§»ç­–ç•¥](#2271-åº”ç”¨è¿ç§»ç­–ç•¥)
  - [22.7.2 æ•°æ®è¿ç§»](#2272-æ•°æ®è¿ç§»)
  - [22.7.3 é…ç½®è¿ç§»](#2273-é…ç½®è¿ç§»)
  - [22.7.4 ç½‘ç»œè¿ç§»](#2274-ç½‘ç»œè¿ç§»)
  - [22.7.5 å­˜å‚¨è¿ç§»](#2275-å­˜å‚¨è¿ç§»)
- [22.8 è¿ç§»å·¥å…·æŠ€æœ¯è§„æ ¼](#228-è¿ç§»å·¥å…·æŠ€æœ¯è§„æ ¼)
  - [22.8.1 Velero è§„æ ¼](#2281-velero-è§„æ ¼)
  - [22.8.2 Kompose è§„æ ¼](#2282-kompose-è§„æ ¼)
  - [22.8.3 Crane è§„æ ¼](#2283-crane-è§„æ ¼)
  - [22.8.4 è¿ç§»å·¥å…·å¯¹æ¯”](#2284-è¿ç§»å·¥å…·å¯¹æ¯”)
- [22.9 å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆ](#229-å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆ)
  - [22.9.1 å°è§„æ¨¡é›†ç¾¤ç»„åˆ](#2291-å°è§„æ¨¡é›†ç¾¤ç»„åˆ)
  - [22.9.2 å¤§è§„æ¨¡é›†ç¾¤ç»„åˆ](#2292-å¤§è§„æ¨¡é›†ç¾¤ç»„åˆ)
  - [22.9.3 å¤šé›†ç¾¤ç»„åˆ](#2293-å¤šé›†ç¾¤ç»„åˆ)
  - [22.9.4 è¾¹ç¼˜è®¡ç®—ç»„åˆ](#2294-è¾¹ç¼˜è®¡ç®—ç»„åˆ)
- [22.10 å¤‡ä»½å’Œæ¢å¤æŠ€æœ¯è§„æ ¼](#2210-å¤‡ä»½å’Œæ¢å¤æŠ€æœ¯è§„æ ¼)
  - [22.10.1 etcd å¤‡ä»½å’Œæ¢å¤](#22101-etcd-å¤‡ä»½å’Œæ¢å¤)
  - [22.10.2 åº”ç”¨æ•°æ®å¤‡ä»½å’Œæ¢å¤](#22102-åº”ç”¨æ•°æ®å¤‡ä»½å’Œæ¢å¤)
  - [22.10.3 ç¾éš¾æ¢å¤è®¡åˆ’](#22103-ç¾éš¾æ¢å¤è®¡åˆ’)
  - [22.10.4 å¤‡ä»½å·¥å…·å’Œæœ€ä½³å®è·µ](#22104-å¤‡ä»½å·¥å…·å’Œæœ€ä½³å®è·µ)
- [22.11 å‡çº§å’Œè¿ç§»æœ€ä½³å®è·µ](#2211-å‡çº§å’Œè¿ç§»æœ€ä½³å®è·µ)
  - [22.11.1 å‡çº§å‰æ£€æŸ¥æ¸…å•](#22111-å‡çº§å‰æ£€æŸ¥æ¸…å•)
  - [22.11.2 è¿ç§»å‰è§„åˆ’](#22112-è¿ç§»å‰è§„åˆ’)
  - [22.11.3 å‡çº§å’Œè¿ç§»æµç¨‹](#22113-å‡çº§å’Œè¿ç§»æµç¨‹)
  - [22.11.4 é£é™©æ§åˆ¶å’Œå›æ»š](#22114-é£é™©æ§åˆ¶å’Œå›æ»š)
- [22.12 å®é™…è¿ç§»æ¡ˆä¾‹](#2212-å®é™…è¿ç§»æ¡ˆä¾‹)
  - [22.12.1 æ¡ˆä¾‹ 1ï¼šK3s ä» 1.28 å‡çº§åˆ° 1.30ï¼ˆé›¶åœæœºï¼‰](#22121-æ¡ˆä¾‹-1k3s-ä»-128-å‡çº§åˆ°-130é›¶åœæœº)
  - [22.12.2 æ¡ˆä¾‹ 2ï¼šä» Docker è¿ç§»åˆ° containerd](#22122-æ¡ˆä¾‹-2ä»-docker-è¿ç§»åˆ°-containerd)
  - [22.12.3 æ¡ˆä¾‹ 3ï¼šä¼ ç»Ÿå®¹å™¨è¿ç§»åˆ° Wasmï¼ˆæ¸è¿›å¼ï¼‰](#22123-æ¡ˆä¾‹-3ä¼ ç»Ÿå®¹å™¨è¿ç§»åˆ°-wasmæ¸è¿›å¼)
  - [22.12.4 æ¡ˆä¾‹ 4ï¼šVelero å¤‡ä»½å’Œæ¢å¤](#22124-æ¡ˆä¾‹-4velero-å¤‡ä»½å’Œæ¢å¤)
  - [22.12.5 æ¡ˆä¾‹ 5ï¼šå•é›†ç¾¤è¿ç§»åˆ°å¤šé›†ç¾¤ï¼ˆKarmadaï¼‰](#22125-æ¡ˆä¾‹-5å•é›†ç¾¤è¿ç§»åˆ°å¤šé›†ç¾¤karmada)
- [22.13 å‡çº§å’Œè¿ç§»æ•…éšœæ’æŸ¥](#2213-å‡çº§å’Œè¿ç§»æ•…éšœæ’æŸ¥)
  - [22.13.1 å‡çº§å¸¸è§é—®é¢˜](#22131-å‡çº§å¸¸è§é—®é¢˜)
  - [22.13.2 è¿ç§»å¸¸è§é—®é¢˜](#22132-è¿ç§»å¸¸è§é—®é¢˜)
- [22.14 å‚è€ƒ](#2214-å‚è€ƒ)

---

## 22.1 æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£å…¨é¢æ¢³ç†äº‘åŸç”Ÿå®¹å™¨æŠ€æœ¯æ ˆä¸­çš„å‡çº§å’Œè¿ç§»æŠ€æœ¯ã€è§„æ ¼å’Œæœ€ä½³å®è·µï¼ŒåŒ…æ‹¬
Kubernetes ç‰ˆæœ¬å‡çº§ã€K3s ç‰ˆæœ¬å‡çº§ã€è¿è¡Œæ—¶è¿ç§»ã€ç¼–æ’ç³»ç»Ÿè¿ç§»ã€åº”ç”¨è¿ç§»ç­‰æŠ€æœ¯ã€‚

**æ–‡æ¡£ç»“æ„**ï¼š

- **å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆå…¨æ™¯**ï¼šå‡çº§å’Œè¿ç§»åˆ†ç±»ã€æŠ€æœ¯ç»„ä»¶çŸ©é˜µã€æŠ€æœ¯æ ˆç»„åˆ
- **Kubernetes ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼**ï¼šå‡çº§ç­–ç•¥ã€æ»šåŠ¨å‡çº§ã€å‡çº§æµç¨‹ã€å‡çº§åéªŒè¯ã€å›
  æ»š
- **K3s ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼**ï¼šå‡çº§ç­–ç•¥ã€å‡çº§æµç¨‹ã€å‡çº§å‰å‡†å¤‡ã€å‡çº§åéªŒè¯
- **è¿è¡Œæ—¶è¿ç§»æŠ€æœ¯è§„æ ¼**ï¼šDocker åˆ° containerdã€runc åˆ° crunã€ä¼ ç»Ÿå®¹å™¨åˆ° Wasm
- **ç¼–æ’ç³»ç»Ÿè¿ç§»æŠ€æœ¯è§„æ ¼**ï¼šKubernetes åˆ° K3sã€å•é›†ç¾¤åˆ°å¤šé›†ç¾¤ã€å¤šé›†ç¾¤åˆ°è”é‚¦
- **åº”ç”¨è¿ç§»æŠ€æœ¯è§„æ ¼**ï¼šåº”ç”¨è¿ç§»ç­–ç•¥ã€æ•°æ®è¿ç§»ã€é…ç½®è¿ç§»ã€ç½‘ç»œè¿ç§»ã€å­˜å‚¨è¿ç§»
- **è¿ç§»å·¥å…·æŠ€æœ¯è§„æ ¼**ï¼šVeleroã€Komposeã€Crane ç­‰è¿ç§»å·¥å…·
- **å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆ**ï¼šä¸åŒåœºæ™¯çš„å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆ
- **å‡çº§å’Œè¿ç§»æœ€ä½³å®è·µ**ï¼šå‡çº§å‰æ£€æŸ¥æ¸…å•ã€è¿ç§»å‰è§„åˆ’ã€å‡çº§å’Œè¿ç§»æµç¨‹ã€é£é™©æ§åˆ¶

## 22.2 å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆå…¨æ™¯

### 22.2.1 å‡çº§å’Œè¿ç§»åˆ†ç±»

**å‡çº§å’Œè¿ç§»åˆ†ç±»**ï¼š

```mermaid
graph TB
    A[å‡çº§å’Œè¿ç§»] --> B[ç‰ˆæœ¬å‡çº§<br/>Version Upgrade]
    A --> C[è¿è¡Œæ—¶è¿ç§»<br/>Runtime Migration]
    A --> D[ç¼–æ’ç³»ç»Ÿè¿ç§»<br/>Orchestration Migration]
    A --> E[åº”ç”¨è¿ç§»<br/>Application Migration]

    B --> B1[Kubernetes å‡çº§<br/>K8s Upgrade]
    B --> B2[K3s å‡çº§<br/>K3s Upgrade]
    B --> B3[ç»„ä»¶å‡çº§<br/>Component Upgrade]

    C --> C1[Docker â†’ containerd<br/>è¿è¡Œæ—¶è¿ç§»]
    C --> C2[runc â†’ crun<br/>è¿è¡Œæ—¶è¿ç§»]
    C --> C3[å®¹å™¨ â†’ Wasm<br/>è¿è¡Œæ—¶è¿ç§»]

    D --> D1[K8s â†’ K3s<br/>ç¼–æ’è¿ç§»]
    D --> D2[å•é›†ç¾¤ â†’ å¤šé›†ç¾¤<br/>æ¶æ„è¿ç§»]
    D --> D3[å¤šé›†ç¾¤ â†’ è”é‚¦<br/>æ¶æ„è¿ç§»]

    E --> E1[æ•°æ®è¿ç§»<br/>Data Migration]
    E --> E2[é…ç½®è¿ç§»<br/>Config Migration]
    E --> E3[ç½‘ç»œè¿ç§»<br/>Network Migration]
    E --> E4[å­˜å‚¨è¿ç§»<br/>Storage Migration]

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#e6ffe6
    style D fill:#ffe6e6
    style E fill:#f0e1ff
```

**å‡çº§å’Œè¿ç§»å®šä¹‰**ï¼š

| ç±»å‹             | å®šä¹‰                     | å…¸å‹åœºæ™¯               | éš¾åº¦       |
| ---------------- | ------------------------ | ---------------------- | ---------- |
| **ç‰ˆæœ¬å‡çº§**     | åŒç±»å‹ç»„ä»¶çš„ç‰ˆæœ¬æ›´æ–°     | Kubernetes 1.29 â†’ 1.30 | â­â­â­     |
| **è¿è¡Œæ—¶è¿ç§»**   | å®¹å™¨è¿è¡Œæ—¶çš„åˆ‡æ¢         | Docker â†’ containerd    | â­â­â­â­   |
| **ç¼–æ’ç³»ç»Ÿè¿ç§»** | ç¼–æ’ç³»ç»Ÿçš„åˆ‡æ¢           | Kubernetes â†’ K3s       | â­â­â­â­â­ |
| **åº”ç”¨è¿ç§»**     | åº”ç”¨çš„è·¨é›†ç¾¤æˆ–è·¨ç¯å¢ƒè¿ç§» | é›†ç¾¤é—´è¿ç§»ã€äº‘è¿ç§»     | â­â­â­â­â­ |

### 22.2.2 æŠ€æœ¯ç»„ä»¶çŸ©é˜µ

**å‡çº§å’Œè¿ç§»æŠ€æœ¯ç»„ä»¶çŸ©é˜µ**ï¼š

| ç»„ä»¶ç±»åˆ«     | æŠ€æœ¯      | å®šä½                  | æˆç†Ÿåº¦     | ç”Ÿäº§éªŒè¯   |
| ------------ | --------- | --------------------- | ---------- | ---------- |
| **å‡çº§å·¥å…·** | kubeadm   | Kubernetes å‡çº§å·¥å…·   | â­â­â­â­â­ | â­â­â­â­â­ |
|              | K3s å‡çº§  | K3s å†…ç½®å‡çº§          | â­â­â­â­â­ | â­â­â­â­â­ |
| **è¿ç§»å·¥å…·** | Velero    | Kubernetes å¤‡ä»½æ¢å¤   | â­â­â­â­â­ | â­â­â­â­â­ |
|              | Kompose   | Docker Compose è¿ç§»   | â­â­â­â­   | â­â­â­â­   |
|              | Crane     | Google è¿ç§»å·¥å…·       | â­â­â­     | â­â­â­     |
| **å¤‡ä»½å·¥å…·** | etcd å¤‡ä»½ | etcd æ•°æ®å¤‡ä»½         | â­â­â­â­â­ | â­â­â­â­â­ |
|              | Velero    | Kubernetes èµ„æºå¤‡ä»½   | â­â­â­â­â­ | â­â­â­â­â­ |
| **éªŒè¯å·¥å…·** | Sonobuoy  | Kubernetes ä¸€è‡´æ€§æµ‹è¯• | â­â­â­â­   | â­â­â­â­   |
|              | kubectl   | Kubernetes ç®¡ç†å·¥å…·   | â­â­â­â­â­ | â­â­â­â­â­ |

### 22.2.3 æŠ€æœ¯æ ˆç»„åˆ

**å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆ**ï¼š

| åœºæ™¯           | å‡çº§å·¥å…· | è¿ç§»å·¥å…· | å¤‡ä»½å·¥å…· | éªŒè¯å·¥å…· | ç‰¹ç‚¹               |
| -------------- | -------- | -------- | -------- | -------- | ------------------ |
| **å°è§„æ¨¡é›†ç¾¤** | kubeadm  | Velero   | Velero   | kubectl  | ç®€å•æ˜“ç”¨ã€æ‰‹åŠ¨æ“ä½œ |
| **å¤§è§„æ¨¡é›†ç¾¤** | kubeadm  | Velero   | Velero   | Sonobuoy | è‡ªåŠ¨åŒ–ã€å¯æ‰©å±•     |
| **K3s é›†ç¾¤**   | K3s å†…ç½® | Velero   | K3s å¤‡ä»½ | kubectl  | è½»é‡çº§ã€å¿«é€Ÿå‡çº§   |
| **å¤šé›†ç¾¤**     | kubeadm  | Velero   | Velero   | Sonobuoy | æ‰¹é‡æ“ä½œã€ç»Ÿä¸€ç®¡ç† |

## 22.3 Kubernetes ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼

### 22.3.1 å‡çº§ç­–ç•¥

**Kubernetes ç‰ˆæœ¬å‡çº§ç­–ç•¥**ï¼š

**å‡çº§è·¯å¾„**ï¼š

- âœ… **åªèƒ½å‡çº§ç›¸é‚»ç‰ˆæœ¬**ï¼š1.29 â†’ 1.30ï¼ˆä¸èƒ½è·³ç‰ˆæœ¬ï¼‰
- âœ… **æ”¯æŒå‘ä¸‹å…¼å®¹**ï¼šAPI å‘ä¸‹å…¼å®¹
- âœ… **ä¸æ”¯æŒé™çº§**ï¼šå‡çº§åä¸èƒ½é™çº§ï¼ˆéœ€è¦é‡æ–°å®‰è£…ï¼‰

**å‡çº§æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜             | é€‚ç”¨åœºæ™¯         | ç‰¹ç‚¹             |
| ------------ | ---------------- | ---------------- | ---------------- |
| **æ»šåŠ¨å‡çº§** | é€ä¸ªèŠ‚ç‚¹å‡çº§     | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | é›¶åœæœºã€é£é™©åˆ†æ•£ |
| **å°±åœ°å‡çº§** | åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šå‡çº§ | æµ‹è¯•ç¯å¢ƒã€å•èŠ‚ç‚¹ | å¿«é€Ÿä½†åœæœº       |
| **é›†ç¾¤æ›¿æ¢** | åˆ›å»ºæ–°é›†ç¾¤è¿ç§»   | å¤§è§„æ¨¡å‡çº§       | é£é™©éš”ç¦»ä½†æˆæœ¬é«˜ |

**å‡çº§é¡ºåº**ï¼š

1. **etcd å‡çº§**ï¼šå…ˆå‡çº§ etcd
2. **æ§åˆ¶å¹³é¢å‡çº§**ï¼šAPI Serverã€Controller Managerã€Scheduler
3. **èŠ‚ç‚¹å‡çº§**ï¼škubeletã€kube-proxy
4. **ç»„ä»¶å‡çº§**ï¼šCNIã€CSIã€CRI æ’ä»¶

### 22.3.2 æ»šåŠ¨å‡çº§è§„æ ¼

**æ»šåŠ¨å‡çº§è§„æ ¼**ï¼š

**å‡çº§æµç¨‹**ï¼š

```mermaid
graph TB
    A[å‡çº§å‡†å¤‡] --> B[å¤‡ä»½ etcd]
    B --> C[å‡çº§æ§åˆ¶å¹³é¢èŠ‚ç‚¹ 1]
    C --> D[éªŒè¯æ§åˆ¶å¹³é¢èŠ‚ç‚¹ 1]
    D --> E[å‡çº§æ§åˆ¶å¹³é¢èŠ‚ç‚¹ 2]
    E --> F[éªŒè¯æ§åˆ¶å¹³é¢èŠ‚ç‚¹ 2]
    F --> G[å‡çº§å·¥ä½œèŠ‚ç‚¹ 1]
    G --> H[éªŒè¯å·¥ä½œèŠ‚ç‚¹ 1]
    H --> I[å‡çº§å·¥ä½œèŠ‚ç‚¹ N]
    I --> J[éªŒè¯é›†ç¾¤çŠ¶æ€]
    J --> K[å‡çº§å®Œæˆ]

    style A fill:#e1f5ff
    style K fill:#fff4e1
```

**å‡çº§æ­¥éª¤**ï¼š

1. **å¤‡ä»½ etcd**ï¼šå¤‡ä»½é›†ç¾¤çŠ¶æ€
2. **å‡çº§æ§åˆ¶å¹³é¢**ï¼šé€ä¸ªå‡çº§æ§åˆ¶å¹³é¢èŠ‚ç‚¹
3. **éªŒè¯æ§åˆ¶å¹³é¢**ï¼šç¡®ä¿æ§åˆ¶å¹³é¢æ­£å¸¸
4. **å‡çº§å·¥ä½œèŠ‚ç‚¹**ï¼šé€ä¸ªå‡çº§å·¥ä½œèŠ‚ç‚¹ï¼ˆå¯æ‰¹é‡ï¼‰
5. **éªŒè¯é›†ç¾¤**ï¼šéªŒè¯é›†ç¾¤åŠŸèƒ½æ­£å¸¸

### 22.3.3 å‡çº§å‰å‡†å¤‡

**å‡çº§å‰å‡†å¤‡æ£€æŸ¥æ¸…å•**ï¼š

**é›†ç¾¤çŠ¶æ€æ£€æŸ¥**ï¼š

- âœ… é›†ç¾¤å¥åº·çŠ¶æ€
- âœ… æ‰€æœ‰ Pod æ­£å¸¸è¿è¡Œ
- âœ… å­˜å‚¨å’Œç½‘ç»œæ­£å¸¸
- âœ… å¤‡ä»½å®Œæ•´æ€§

**ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**ï¼š

- âœ… Kubernetes ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… API ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… CRD ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… æ’ä»¶ç‰ˆæœ¬å…¼å®¹æ€§

**èµ„æºæ£€æŸ¥**ï¼š

- âœ… æ§åˆ¶å¹³é¢èµ„æºå……è¶³
- âœ… å·¥ä½œèŠ‚ç‚¹èµ„æºå……è¶³
- âœ… å­˜å‚¨ç©ºé—´å……è¶³
- âœ… ç½‘ç»œå¸¦å®½å……è¶³

**å¤‡ä»½æ£€æŸ¥**ï¼š

- âœ… etcd å¤‡ä»½
- âœ… åº”ç”¨æ•°æ®å¤‡ä»½
- âœ… é…ç½®æ–‡ä»¶å¤‡ä»½
- âœ… æ¢å¤è®¡åˆ’å‡†å¤‡

**å‡çº§å‰æ£€æŸ¥å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl get nodes
kubectl get pods --all-namespaces

# æ£€æŸ¥ç‰ˆæœ¬
kubectl version

# æ£€æŸ¥ API èµ„æº
kubectl api-resources

# æ£€æŸ¥ CRD
kubectl get crd

# å¤‡ä»½ etcd
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot.db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/etcd/ca.crt \
  --cert=/etc/etcd/etcd.crt \
  --key=/etc/etcd/etcd.key
```

### 22.3.4 å‡çº§æµç¨‹

**Kubernetes å‡çº§æµç¨‹**ï¼š

**ä½¿ç”¨ kubeadm å‡çº§**ï¼š

**æ§åˆ¶å¹³é¢èŠ‚ç‚¹å‡çº§**ï¼š

```bash
# 1. å‡çº§ kubeadm
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.x-*
apt-mark hold kubeadm

# 2. æ£€æŸ¥å‡çº§è®¡åˆ’
kubeadm upgrade plan

# 3. å‡çº§æ§åˆ¶å¹³é¢
kubeadm upgrade apply v1.30.x

# 4. å‡çº§ kubelet å’Œ kubectl
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.x-* kubectl=1.30.x-*
apt-mark hold kubelet kubectl

# 5. é‡å¯ kubelet
systemctl daemon-reload
systemctl restart kubelet

# 6. éªŒè¯èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
```

**å·¥ä½œèŠ‚ç‚¹å‡çº§**ï¼š

```bash
# 1. é©±é€èŠ‚ç‚¹ä¸Šçš„ Podï¼ˆå¯é€‰ï¼‰
kubectl drain <node-name> --ignore-daemonsets

# 2. å‡çº§ kubeadm
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.x-*
apt-mark hold kubeadm

# 3. å‡çº§èŠ‚ç‚¹é…ç½®
kubeadm upgrade node

# 4. å‡çº§ kubelet å’Œ kubectl
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.x-* kubectl=1.30.x-*
apt-mark hold kubelet kubectl

# 5. é‡å¯ kubelet
systemctl daemon-reload
systemctl restart kubelet

# 6. æ¢å¤èŠ‚ç‚¹
kubectl uncordon <node-name>

# 7. éªŒè¯èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
```

### 22.3.5 å‡çº§åéªŒè¯

**å‡çº§åéªŒè¯æ£€æŸ¥æ¸…å•**ï¼š

**é›†ç¾¤åŠŸèƒ½éªŒè¯**ï¼š

- âœ… æ‰€æœ‰èŠ‚ç‚¹ Ready
- âœ… æ‰€æœ‰ç³»ç»Ÿ Pod è¿è¡Œæ­£å¸¸
- âœ… API Server å“åº”æ­£å¸¸
- âœ… è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œ
- âœ… Controller Manager æ­£å¸¸å·¥ä½œ

**åº”ç”¨åŠŸèƒ½éªŒè¯**ï¼š

- âœ… åº”ç”¨ Pod è¿è¡Œæ­£å¸¸
- âœ… Service æ­£å¸¸è®¿é—®
- âœ… Ingress æ­£å¸¸è·¯ç”±
- âœ… å­˜å‚¨æ­£å¸¸æŒ‚è½½
- âœ… ç½‘ç»œç­–ç•¥æ­£å¸¸

**éªŒè¯å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes

# æ£€æŸ¥ç³»ç»Ÿ Pod
kubectl get pods --all-namespaces

# æ£€æŸ¥ API ç‰ˆæœ¬
kubectl version

# æ£€æŸ¥ API èµ„æº
kubectl api-resources

# æ£€æŸ¥ CRD
kubectl get crd

# è¿è¡Œä¸€è‡´æ€§æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
sonobuoy run --wait
```

### 22.3.6 å‡çº§å›æ»š

**å‡çº§å›æ»šç­–ç•¥**ï¼š

**å›æ»šæ–¹å¼**ï¼š

- âš ï¸ **Kubernetes ä¸æ”¯æŒç›´æ¥é™çº§**ï¼šä¸èƒ½ç›´æ¥é™çº§åˆ°æ—§ç‰ˆæœ¬
- âœ… **å›æ»šåˆ°å¤‡ä»½**ï¼šä½¿ç”¨ etcd å¤‡ä»½æ¢å¤
- âœ… **é‡å»ºé›†ç¾¤**ï¼šé‡æ–°å®‰è£…æ—§ç‰ˆæœ¬å¹¶æ¢å¤æ•°æ®
- âœ… **åº”ç”¨å›æ»š**ï¼šåªå›æ»šåº”ç”¨ç‰ˆæœ¬ï¼ˆä¸é™çº§ K8sï¼‰

**etcd æ¢å¤æµç¨‹**ï¼š

```bash
# 1. åœæ­¢ API Server
systemctl stop kube-apiserver

# 2. æ¢å¤ etcd å¤‡ä»½
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \
  --data-dir /var/lib/etcd-restored

# 3. æ›´æ–° etcd é…ç½®
# 4. é‡å¯ etcd
# 5. é‡å¯ API Server
# 6. éªŒè¯é›†ç¾¤çŠ¶æ€
```

## 22.4 K3s ç‰ˆæœ¬å‡çº§æŠ€æœ¯è§„æ ¼

### 22.4.1 å‡çº§ç­–ç•¥

**K3s ç‰ˆæœ¬å‡çº§ç­–ç•¥**ï¼š

**å‡çº§ç‰¹ç‚¹**ï¼š

- âœ… **å•äºŒè¿›åˆ¶å‡çº§**ï¼šå‡çº§ç®€å•å¿«é€Ÿ
- âœ… **é›¶åœæœºå‡çº§**ï¼šæ”¯æŒæ»šåŠ¨å‡çº§
- âœ… **è‡ªåŠ¨ manifest åº”ç”¨**ï¼šè‡ªåŠ¨åº”ç”¨æ›´æ–°

**å‡çº§æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜             | é€‚ç”¨åœºæ™¯           | ç‰¹ç‚¹               |
| ------------ | ---------------- | ------------------ | ------------------ |
| **è„šæœ¬å‡çº§** | ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ | å¤§å¤šæ•°åœºæ™¯ï¼ˆæ¨èï¼‰ | ç®€å•å¿«é€Ÿã€è‡ªåŠ¨å¤„ç† |
| **æ‰‹åŠ¨å‡çº§** | æ‰‹åŠ¨æ›¿æ¢äºŒè¿›åˆ¶   | ç¦»çº¿ç¯å¢ƒ           | çµæ´»ä½†éœ€è¦æ‰‹åŠ¨æ“ä½œ |
| **è‡ªåŠ¨å‡çº§** | ä½¿ç”¨ç³»ç»ŸæœåŠ¡å‡çº§ | è‡ªåŠ¨åŒ–ç¯å¢ƒ         | è‡ªåŠ¨åŒ–ä½†éœ€è¦é…ç½®   |

### 22.4.2 å‡çº§æµç¨‹

**K3s å‡çº§æµç¨‹**ï¼š

**Server èŠ‚ç‚¹å‡çº§**ï¼š

```bash
# 1. å¤‡ä»½æ•°æ®ï¼ˆå¯é€‰ï¼‰
# K3s æ•°æ®å­˜å‚¨åœ¨ /var/lib/rancher/k3s

# 2. ä¸‹è½½æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.30.4+k3s1 sh -

# 3. å‡çº§ï¼ˆä½¿ç”¨å®‰è£…è„šæœ¬ï¼‰
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.30.4+k3s1 sh -

# æˆ–è€…é‡å¯æœåŠ¡ï¼ˆå¦‚æœå·²å®‰è£…æ–°ç‰ˆæœ¬ï¼‰
systemctl restart k3s

# 4. éªŒè¯å‡çº§
k3s --version
kubectl version
```

**Agent èŠ‚ç‚¹å‡çº§**ï¼š

```bash
# 1. å‡çº§ Agent
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.30.4+k3s1 K3S_URL=https://server:6443 K3S_TOKEN=xxx sh -

# æˆ–è€…é‡å¯æœåŠ¡
systemctl restart k3s-agent

# 2. éªŒè¯å‡çº§
k3s --version
```

### 22.4.3 å‡çº§å‰å‡†å¤‡

**K3s å‡çº§å‰å‡†å¤‡**ï¼š

**æ£€æŸ¥æ¸…å•**ï¼š

- âœ… é›†ç¾¤å¥åº·çŠ¶æ€
- âœ… æ‰€æœ‰ Pod æ­£å¸¸è¿è¡Œ
- âœ… å¤‡ä»½æ•°æ®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
- âœ… æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§

**å‡†å¤‡å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl get nodes
kubectl get pods --all-namespaces

# æ£€æŸ¥ç‰ˆæœ¬
k3s --version

# å¤‡ä»½æ•°æ®ï¼ˆå¯é€‰ï¼‰
sudo tar -czf /backup/k3s-$(date +%Y%m%d).tar.gz /var/lib/rancher/k3s
```

### 22.4.4 å‡çº§åéªŒè¯

**K3s å‡çº§åéªŒè¯**ï¼š

**éªŒè¯æ£€æŸ¥æ¸…å•**ï¼š

- âœ… èŠ‚ç‚¹çŠ¶æ€æ­£å¸¸
- âœ… ç³»ç»Ÿ Pod è¿è¡Œæ­£å¸¸
- âœ… åº”ç”¨ Pod è¿è¡Œæ­£å¸¸
- âœ… ç½‘ç»œå’Œå­˜å‚¨æ­£å¸¸

**éªŒè¯å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥ç‰ˆæœ¬
k3s --version
kubectl version

# æ£€æŸ¥èŠ‚ç‚¹
kubectl get nodes

# æ£€æŸ¥ Pod
kubectl get pods --all-namespaces
```

## 22.5 è¿è¡Œæ—¶è¿ç§»æŠ€æœ¯è§„æ ¼

### 22.5.1 Docker åˆ° containerd è¿ç§»

**Docker åˆ° containerd è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… Kubernetes 1.24+ ç§»é™¤ docker-shim æ”¯æŒ
- âœ… containerd æ˜¯ Kubernetes æ¨èçš„è¿è¡Œæ—¶
- âœ… æ€§èƒ½æ›´å¥½ã€èµ„æºå ç”¨æ›´å°‘

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **å®‰è£… containerd**ï¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£… containerd
2. **é…ç½® containerd**ï¼šé…ç½® containerd ä½œä¸º CRI
3. **è¿ç§»é•œåƒ**ï¼šå°† Docker é•œåƒå¯¼å…¥ containerd
4. **åˆ‡æ¢è¿è¡Œæ—¶**ï¼šæ›´æ–° kubelet é…ç½®
5. **éªŒè¯è¿ç§»**ï¼šéªŒè¯ Pod æ­£å¸¸è¿è¡Œ
6. **æ¸…ç† Docker**ï¼šå¸è½½ Dockerï¼ˆå¯é€‰ï¼‰

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… containerd
apt-get update && apt-get install -y containerd.io

# 2. é…ç½® containerd
containerd config default | sudo tee /etc/containerd/config.toml
systemctl restart containerd

# 3. å¯¼å‡º Docker é•œåƒ
docker save <image> | ctr -n k8s.io images import -

# æˆ–è€…ä½¿ç”¨è„šæœ¬æ‰¹é‡è¿ç§»
for image in $(docker images --format "{{.Repository}}:{{.Tag}}"); do
  docker save $image | ctr -n k8s.io images import -
done

# 4. æ›´æ–° kubelet é…ç½®
# /var/lib/kubelet/config.yaml
runtimeRequestTimeout: 15m
containerRuntimeEndpoint: unix:///run/containerd/containerd.sock

# 5. é‡å¯ kubelet
systemctl restart kubelet

# 6. éªŒè¯è¿ç§»
kubectl get nodes
kubectl describe node <node-name>
```

### 22.5.2 runc åˆ° crun è¿ç§»

**runc åˆ° crun è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… crun æ”¯æŒ Wasm
- âœ… crun æ€§èƒ½æ›´å¥½
- âœ… crun è‡ªåŠ¨è¯†åˆ«å®¹å™¨ç±»å‹

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **å®‰è£… crun**ï¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£… crun
2. **é…ç½® containerd**ï¼šé…ç½® containerd ä½¿ç”¨ crun
3. **éªŒè¯è¿ç§»**ï¼šéªŒè¯å®¹å™¨æ­£å¸¸è¿è¡Œ

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… crun
apt-get update && apt-get install -y crun

# 2. é…ç½® containerd
# /etc/containerd/config.toml
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  runtime_type = "io.containerd.runc.v2"
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
    SystemdCgroup = true

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.crun]
  runtime_type = "io.containerd.runc.v2"
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.crun.options]
    BinaryName = "crun"
    SystemdCgroup = true

# 3. é‡å¯ containerd
systemctl restart containerd

# 4. ä½¿ç”¨ RuntimeClass æŒ‡å®š crun
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun
handler: crun
```

### 22.5.3 ä¼ ç»Ÿå®¹å™¨åˆ° Wasm è¿ç§»

**ä¼ ç»Ÿå®¹å™¨åˆ° Wasm è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… Wasm å¯åŠ¨æ›´å¿«
- âœ… Wasm èµ„æºå ç”¨æ›´å°‘
- âœ… Wasm å¯†åº¦æ›´é«˜

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **ç¼–è¯‘åˆ° Wasm**ï¼šå°†åº”ç”¨ç¼–è¯‘åˆ° WebAssembly
2. **é…ç½® RuntimeClass**ï¼šé…ç½® Wasm RuntimeClass
3. **æ›´æ–° Deployment**ï¼šæ›´æ–° Pod ä½¿ç”¨ Wasm è¿è¡Œæ—¶
4. **éªŒè¯è¿ç§»**ï¼šéªŒè¯åº”ç”¨æ­£å¸¸è¿è¡Œ

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. ç¼–è¯‘åˆ° Wasmï¼ˆç¤ºä¾‹ï¼šRustï¼‰
cargo build --target wasm32-wasi --release

# 2. åˆ›å»º Wasm é•œåƒ
# ä½¿ç”¨ wasm-to-oci æˆ–å…¶ä»–å·¥å…·

# 3. é…ç½® RuntimeClass
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: wasmedge
handler: wasmedge

# 4. æ›´æ–° Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  template:
    spec:
      runtimeClassName: wasmedge
      containers:
      - name: app
        image: myapp:wasm
```

### 22.5.4 è¿è¡Œæ—¶è¿ç§»ç­–ç•¥

**è¿è¡Œæ—¶è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜           | é€‚ç”¨åœºæ™¯         | ç‰¹ç‚¹             |
| ------------ | -------------- | ---------------- | ---------------- |
| **æ»šåŠ¨è¿ç§»** | é€ä¸ªèŠ‚ç‚¹è¿ç§»   | ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ | é›¶åœæœºã€é£é™©åˆ†æ•£ |
| **æ‰¹é‡è¿ç§»** | æ‰¹é‡èŠ‚ç‚¹è¿ç§»   | æµ‹è¯•ç¯å¢ƒ         | å¿«é€Ÿä½†å¯èƒ½åœæœº   |
| **è“ç»¿è¿ç§»** | åˆ›å»ºæ–°ç¯å¢ƒè¿ç§» | å¤§è§„æ¨¡è¿ç§»       | é£é™©éš”ç¦»ä½†æˆæœ¬é«˜ |

## 22.6 ç¼–æ’ç³»ç»Ÿè¿ç§»æŠ€æœ¯è§„æ ¼

### 22.6.1 Kubernetes åˆ° K3s è¿ç§»

**Kubernetes åˆ° K3s è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… K3s èµ„æºå ç”¨æ›´å°‘
- âœ… K3s éƒ¨ç½²æ›´ç®€å•
- âœ… K3s é€‚åˆè¾¹ç¼˜åœºæ™¯

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **è¯„ä¼°å…¼å®¹æ€§**ï¼šæ£€æŸ¥ K3s æ˜¯å¦æ”¯æŒæ‰€éœ€åŠŸèƒ½
2. **å‡†å¤‡ K3s é›†ç¾¤**ï¼šå®‰è£…å’Œé…ç½® K3s
3. **å¯¼å‡ºèµ„æº**ï¼šä» K8s å¯¼å‡ºèµ„æºå®šä¹‰
4. **å¯¼å…¥èµ„æº**ï¼šå¯¼å…¥åˆ° K3s é›†ç¾¤
5. **è¿ç§»æ•°æ®**ï¼šè¿ç§»æŒä¹…åŒ–æ•°æ®
6. **åˆ‡æ¢æµé‡**ï¼šåˆ‡æ¢åˆ° K3s é›†ç¾¤
7. **éªŒè¯è¿ç§»**ï¼šéªŒè¯åº”ç”¨æ­£å¸¸è¿è¡Œ

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å¯¼å‡º Kubernetes èµ„æº
kubectl get all --all-namespaces -o yaml > k8s-resources.yaml

# 2. å¯¼å‡ºé…ç½®
kubectl get configmap,secret --all-namespaces -o yaml > k8s-configs.yaml

# 3. å¯¼å‡ºå­˜å‚¨
# ä½¿ç”¨ Velero æˆ–æ‰‹åŠ¨å¯¼å‡º PVC

# 4. åœ¨ K3s ä¸­å¯¼å…¥èµ„æº
kubectl apply -f k8s-resources.yaml
kubectl apply -f k8s-configs.yaml

# 5. è¿ç§»å­˜å‚¨
# ä½¿ç”¨ Velero æˆ–æ‰‹åŠ¨è¿ç§»
```

### 22.6.2 å•é›†ç¾¤åˆ°å¤šé›†ç¾¤è¿ç§»

**å•é›†ç¾¤åˆ°å¤šé›†ç¾¤è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… é«˜å¯ç”¨éœ€æ±‚
- âœ… åœ°ç†åˆ†å¸ƒéœ€æ±‚
- âœ… èµ„æºéš”ç¦»éœ€æ±‚

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **è§„åˆ’å¤šé›†ç¾¤æ¶æ„**ï¼šè®¾è®¡å¤šé›†ç¾¤æ¶æ„
2. **åˆ›å»ºæ–°é›†ç¾¤**ï¼šåˆ›å»ºæ–°çš„é›†ç¾¤
3. **åº”ç”¨è¿ç§»**ï¼šè¿ç§»åº”ç”¨åˆ°æ–°é›†ç¾¤
4. **æ•°æ®åŒæ­¥**ï¼šåŒæ­¥æ•°æ®åˆ°æ–°é›†ç¾¤
5. **æµé‡åˆ‡æ¢**ï¼šé€æ­¥åˆ‡æ¢æµé‡
6. **éªŒè¯è¿ç§»**ï¼šéªŒè¯å¤šé›†ç¾¤è¿è¡Œæ­£å¸¸

### 22.6.3 å¤šé›†ç¾¤åˆ°è”é‚¦è¿ç§»

**å¤šé›†ç¾¤åˆ°è”é‚¦è¿ç§»è§„æ ¼**ï¼š

**è¿ç§»èƒŒæ™¯**ï¼š

- âœ… ç»Ÿä¸€ç®¡ç†å¤šé›†ç¾¤
- âœ… è·¨é›†ç¾¤æœåŠ¡å‘ç°
- âœ… è·¨é›†ç¾¤è°ƒåº¦

**è¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æµç¨‹**ï¼š

1. **å®‰è£…é›†ç¾¤è”é‚¦**ï¼šå®‰è£… Karmada æˆ– ClusterFederation
2. **æ³¨å†Œé›†ç¾¤**ï¼šå°†ç°æœ‰é›†ç¾¤æ³¨å†Œåˆ°è”é‚¦
3. **è¿ç§»åº”ç”¨**ï¼šè¿ç§»åº”ç”¨åˆ°è”é‚¦ç®¡ç†
4. **éªŒè¯è”é‚¦**ï¼šéªŒè¯è”é‚¦åŠŸèƒ½æ­£å¸¸

### 22.6.4 ç¼–æ’ç³»ç»Ÿè¿ç§»ç­–ç•¥

**ç¼–æ’ç³»ç»Ÿè¿ç§»ç­–ç•¥**ï¼š

**è¿ç§»æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜             | é€‚ç”¨åœºæ™¯           | ç‰¹ç‚¹               |
| ------------ | ---------------- | ------------------ | ------------------ |
| **è“ç»¿è¿ç§»** | åˆ›å»ºæ–°ç¯å¢ƒè¿ç§»   | å¤§è§„æ¨¡è¿ç§»ï¼ˆæ¨èï¼‰ | é£é™©éš”ç¦»ã€å¿«é€Ÿå›æ»š |
| **æ»šåŠ¨è¿ç§»** | é€æ­¥è¿ç§»åº”ç”¨     | å°è§„æ¨¡è¿ç§»         | æˆæœ¬ä½ä½†å‘¨æœŸé•¿     |
| **æ··åˆè¿è¡Œ** | æ–°æ—§ç³»ç»Ÿå¹¶è¡Œè¿è¡Œ | è¿‡æ¸¡æœŸ             | é£é™©æœ€å°ä½†æˆæœ¬é«˜   |

## 22.7 åº”ç”¨è¿ç§»æŠ€æœ¯è§„æ ¼

### 22.7.1 åº”ç”¨è¿ç§»ç­–ç•¥

**åº”ç”¨è¿ç§»ç­–ç•¥è§„æ ¼**ï¼š

**è¿ç§»æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜           | é€‚ç”¨åœºæ™¯         | ç‰¹ç‚¹             |
| ------------ | -------------- | ---------------- | ---------------- |
| **å¯¼å‡ºå¯¼å…¥** | å¯¼å‡º YAML å¯¼å…¥ | ç®€å•åº”ç”¨ï¼ˆæ¨èï¼‰ | ç®€å•å¿«é€Ÿ         |
| **å·¥å…·è¿ç§»** | ä½¿ç”¨è¿ç§»å·¥å…·   | å¤æ‚åº”ç”¨         | è‡ªåŠ¨åŒ–ä½†éœ€è¦é…ç½® |
| **é‡å»ºåº”ç”¨** | é‡æ–°éƒ¨ç½²åº”ç”¨   | å¯é‡æ„åº”ç”¨       | çµæ´»ä½†å·¥ä½œé‡å¤§   |

### 22.7.2 æ•°æ®è¿ç§»

**æ•°æ®è¿ç§»è§„æ ¼**ï¼š

**æ•°æ®è¿ç§»ç­–ç•¥**ï¼š

- âœ… **Volume è¿ç§»**ï¼šä½¿ç”¨ Velero è¿ç§» PV
- âœ… **æ•°æ®åº“è¿ç§»**ï¼šä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·
- âœ… **å¯¹è±¡å­˜å‚¨è¿ç§»**ï¼šä½¿ç”¨å¯¹è±¡å­˜å‚¨åŒæ­¥å·¥å…·
- âœ… **å¤‡ä»½æ¢å¤**ï¼šå¤‡ä»½åæ¢å¤åˆ°æ–°ç¯å¢ƒ

**Velero æ•°æ®è¿ç§»**ï¼š

```bash
# 1. å¤‡ä»½ PVC
velero backup create backup-name --include-resources pvc

# 2. æ¢å¤ PVC
velero restore create restore-name --from-backup backup-name
```

### 22.7.3 é…ç½®è¿ç§»

**é…ç½®è¿ç§»è§„æ ¼**ï¼š

**é…ç½®è¿ç§»ç­–ç•¥**ï¼š

- âœ… **ConfigMap è¿ç§»**ï¼šå¯¼å‡ºå¯¼å…¥ ConfigMap
- âœ… **Secret è¿ç§»**ï¼šå¯¼å‡ºå¯¼å…¥ Secret
- âœ… **RBAC è¿ç§»**ï¼šå¯¼å‡ºå¯¼å…¥ RBAC èµ„æº
- âœ… **ç½‘ç»œç­–ç•¥è¿ç§»**ï¼šå¯¼å‡ºå¯¼å…¥ NetworkPolicy

**é…ç½®è¿ç§»å‘½ä»¤**ï¼š

```bash
# å¯¼å‡ºé…ç½®
kubectl get configmap,secret --all-namespaces -o yaml > configs.yaml

# å¯¼å…¥é…ç½®
kubectl apply -f configs.yaml
```

### 22.7.4 ç½‘ç»œè¿ç§»

**ç½‘ç»œè¿ç§»è§„æ ¼**ï¼š

**ç½‘ç»œè¿ç§»ç­–ç•¥**ï¼š

- âœ… **Service è¿ç§»**ï¼šé‡æ–°åˆ›å»º Service
- âœ… **Ingress è¿ç§»**ï¼šé‡æ–°åˆ›å»º Ingress
- âœ… **NetworkPolicy è¿ç§»**ï¼šå¯¼å‡ºå¯¼å…¥ NetworkPolicy
- âœ… **CNI è¿ç§»**ï¼šæ›´æ¢ CNI æ’ä»¶ï¼ˆéœ€è¦é‡æ–°éƒ¨ç½²ï¼‰

### 22.7.5 å­˜å‚¨è¿ç§»

**å­˜å‚¨è¿ç§»è§„æ ¼**ï¼š

**å­˜å‚¨è¿ç§»ç­–ç•¥**ï¼š

- âœ… **PV è¿ç§»**ï¼šä½¿ç”¨ Velero è¿ç§» PV
- âœ… **StorageClass è¿ç§»**ï¼šé‡æ–°åˆ›å»º StorageClass
- âœ… **æ•°æ®åŒæ­¥**ï¼šä½¿ç”¨å­˜å‚¨åŒæ­¥å·¥å…·
- âœ… **å¤‡ä»½æ¢å¤**ï¼šå¤‡ä»½åæ¢å¤

## 22.8 è¿ç§»å·¥å…·æŠ€æœ¯è§„æ ¼

### 22.8.1 Velero è§„æ ¼

**Velero è§„æ ¼**ï¼š

**å®šä¹‰**ï¼šVelero æ˜¯ Kubernetes çš„å¤‡ä»½å’Œæ¢å¤å·¥å…·ï¼Œæ”¯æŒé›†ç¾¤è¿ç§»ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š

- âœ… é›†ç¾¤å¤‡ä»½å’Œæ¢å¤
- âœ… è·¨é›†ç¾¤è¿ç§»
- âœ… PV å¤‡ä»½å’Œæ¢å¤
- âœ… å®šæ—¶å¤‡ä»½
- âœ… æ’ä»¶ç³»ç»Ÿ

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š

- **æœ€æ–°ç‰ˆæœ¬**ï¼šv1.12.0+ï¼ˆ2024ï¼‰
- **GitHub Stars**ï¼š8K+
- **ç”Ÿäº§éªŒè¯**ï¼šâœ… å¤§è§„æ¨¡ä½¿ç”¨

**å¤‡ä»½ç¤ºä¾‹**ï¼š

```bash
# å¤‡ä»½æ•´ä¸ªå‘½åç©ºé—´
velero backup create backup-name --include-namespaces my-namespace

# å¤‡ä»½ç‰¹å®šèµ„æº
velero backup create backup-name --include-resources deployments,services

# æ¢å¤å¤‡ä»½
velero restore create restore-name --from-backup backup-name
```

### 22.8.2 Kompose è§„æ ¼

**Kompose è§„æ ¼**ï¼š

**å®šä¹‰**ï¼šKompose æ˜¯å°† Docker Compose è½¬æ¢ä¸º Kubernetes èµ„æºçš„å·¥å…·ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š

- âœ… Docker Compose åˆ° Kubernetes è½¬æ¢
- âœ… æ”¯æŒå¤šç§ Kubernetes èµ„æº
- âœ… é…ç½®è½¬æ¢
- âœ… ç®€å•æ˜“ç”¨

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š

- **æœ€æ–°ç‰ˆæœ¬**ï¼šv1.32.0+ï¼ˆ2024ï¼‰
- **GitHub Stars**ï¼š4K+
- **ç”Ÿäº§éªŒè¯**ï¼šâœ… ä¸­ç­‰è§„æ¨¡ä½¿ç”¨

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# è½¬æ¢ Docker Compose
kompose convert

# è½¬æ¢ä¸ºç‰¹å®šèµ„æºç±»å‹
kompose convert --deployment
kompose convert --daemonset

# åº”ç”¨åˆ° Kubernetes
kompose up
```

### 22.8.3 Crane è§„æ ¼

**Crane è§„æ ¼**ï¼š

**å®šä¹‰**ï¼šCrane æ˜¯ Google çš„å®¹å™¨é•œåƒå’Œé›†ç¾¤è¿ç§»å·¥å…·ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š

- âœ… é•œåƒè¿ç§»
- âœ… é›†ç¾¤è¿ç§»
- âœ… å¤šä»“åº“æ”¯æŒ
- âœ… æ‰¹é‡æ“ä½œ

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š

- **æœ€æ–°ç‰ˆæœ¬**ï¼šv2.6.0+ï¼ˆ2024ï¼‰
- **GitHub Stars**ï¼š1K+
- **ç”Ÿäº§éªŒè¯**ï¼šâœ… ä¸­ç­‰è§„æ¨¡ä½¿ç”¨

### 22.8.4 è¿ç§»å·¥å…·å¯¹æ¯”

**è¿ç§»å·¥å…·å¯¹æ¯”çŸ©é˜µ**ï¼š

| å·¥å…·        | å®šä½                | åŠŸèƒ½       | æ˜“ç”¨æ€§     | æˆç†Ÿåº¦     | æ¨èåœºæ™¯            |
| ----------- | ------------------- | ---------- | ---------- | ---------- | ------------------- |
| **Velero**  | å¤‡ä»½æ¢å¤å’Œè¿ç§»      | â­â­â­â­â­ | â­â­â­â­   | â­â­â­â­â­ | å¤§å¤šæ•°åœºæ™¯          |
| **Kompose** | Docker Compose è½¬æ¢ | â­â­â­â­   | â­â­â­â­â­ | â­â­â­â­   | Docker Compose è¿ç§» |
| **Crane**   | é•œåƒå’Œé›†ç¾¤è¿ç§»      | â­â­â­â­   | â­â­â­     | â­â­â­     | Google ç¯å¢ƒ         |

## 22.9 å‡çº§å’Œè¿ç§»æŠ€æœ¯æ ˆç»„åˆæ–¹æ¡ˆ

### 22.9.1 å°è§„æ¨¡é›†ç¾¤ç»„åˆ

**å°è§„æ¨¡é›†ç¾¤å‡çº§å’Œè¿ç§»ç»„åˆ**ï¼š

**æŠ€æœ¯æ ˆ**ï¼š

- **å‡çº§å·¥å…·**ï¼škubeadmï¼ˆK8sï¼‰æˆ– K3s å†…ç½®ï¼ˆK3sï¼‰
- **è¿ç§»å·¥å…·**ï¼šVelero
- **å¤‡ä»½å·¥å…·**ï¼šVelero + etcd å¤‡ä»½
- **éªŒè¯å·¥å…·**ï¼škubectl

**ç‰¹ç‚¹**ï¼š

- âœ… ç®€å•æ˜“ç”¨
- âœ… æ‰‹åŠ¨æ“ä½œ
- âœ… æˆæœ¬ä½

### 22.9.2 å¤§è§„æ¨¡é›†ç¾¤ç»„åˆ

**å¤§è§„æ¨¡é›†ç¾¤å‡çº§å’Œè¿ç§»ç»„åˆ**ï¼š

**æŠ€æœ¯æ ˆ**ï¼š

- **å‡çº§å·¥å…·**ï¼škubeadm + è‡ªåŠ¨åŒ–è„šæœ¬
- **è¿ç§»å·¥å…·**ï¼šVelero
- **å¤‡ä»½å·¥å…·**ï¼šVelero + etcd å¤‡ä»½
- **éªŒè¯å·¥å…·**ï¼šSonobuoy + kubectl

**ç‰¹ç‚¹**ï¼š

- âœ… è‡ªåŠ¨åŒ–æ“ä½œ
- âœ… å¯æ‰©å±•æ€§å¼º
- âœ… å®Œæ•´éªŒè¯

### 22.9.3 å¤šé›†ç¾¤ç»„åˆ

**å¤šé›†ç¾¤å‡çº§å’Œè¿ç§»ç»„åˆ**ï¼š

**æŠ€æœ¯æ ˆ**ï¼š

- **å‡çº§å·¥å…·**ï¼škubeadm + æ‰¹é‡æ“ä½œå·¥å…·
- **è¿ç§»å·¥å…·**ï¼šVelero + å¤šé›†ç¾¤ç®¡ç†å·¥å…·
- **å¤‡ä»½å·¥å…·**ï¼šVeleroï¼ˆå¤šé›†ç¾¤ï¼‰
- **éªŒè¯å·¥å…·**ï¼šSonobuoy + å¤šé›†ç¾¤éªŒè¯å·¥å…·

**ç‰¹ç‚¹**ï¼š

- âœ… æ‰¹é‡æ“ä½œ
- âœ… ç»Ÿä¸€ç®¡ç†
- âœ… å®Œæ•´éªŒè¯

### 22.9.4 è¾¹ç¼˜è®¡ç®—ç»„åˆ

**è¾¹ç¼˜è®¡ç®—å‡çº§å’Œè¿ç§»ç»„åˆ**ï¼š

**æŠ€æœ¯æ ˆ**ï¼š

- **å‡çº§å·¥å…·**ï¼šK3s å†…ç½®å‡çº§
- **è¿ç§»å·¥å…·**ï¼šVeleroï¼ˆç®€åŒ–ç‰ˆï¼‰
- **å¤‡ä»½å·¥å…·**ï¼šK3s å¤‡ä»½ + è¾¹ç¼˜å­˜å‚¨
- **éªŒè¯å·¥å…·**ï¼škubectl

**ç‰¹ç‚¹**ï¼š

- âœ… è½»é‡çº§
- âœ… ç¦»çº¿æ”¯æŒ
- âœ… è¾¹ç¼˜ä¼˜åŒ–

## 22.10 å¤‡ä»½å’Œæ¢å¤æŠ€æœ¯è§„æ ¼

### 22.10.1 etcd å¤‡ä»½å’Œæ¢å¤

**etcd å¤‡ä»½å®šä¹‰**ï¼š

etcd æ˜¯ Kubernetes çš„æ•°æ®å­˜å‚¨ï¼Œå¤‡ä»½ etcd å¯ä»¥æ¢å¤æ•´ä¸ªé›†ç¾¤çŠ¶æ€ã€‚

**etcd å¤‡ä»½æ–¹å¼**ï¼š

| æ–¹å¼         | è¯´æ˜             | é€‚ç”¨åœºæ™¯         | ç‰¹ç‚¹           |
| ------------ | ---------------- | ---------------- | -------------- |
| **å¿«ç…§å¤‡ä»½** | etcdctl snapshot | å®šæœŸå¤‡ä»½ï¼ˆæ¨èï¼‰ | å¿«é€Ÿã€å®Œæ•´     |
| **å®Œæ•´å¤‡ä»½** | etcdctl backup   | è¿ç§»å¤‡ä»½         | å®Œæ•´ä½†è¾ƒæ…¢     |
| **è‡ªåŠ¨å¤‡ä»½** | Velero + etcd    | ç”Ÿäº§ç¯å¢ƒ         | è‡ªåŠ¨åŒ–ã€å¯æ¢å¤ |

**etcd å¿«ç…§å¤‡ä»½é…ç½®ç¤ºä¾‹**ï¼š

```bash
# 1. å¤‡ä»½ etcdï¼ˆåœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹æ‰§è¡Œï¼‰
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d).db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# 2. éªŒè¯å¤‡ä»½
etcdctl snapshot status /backup/etcd-snapshot-20240101.db

# 3. æ¢å¤ etcdï¼ˆåœ¨åœæ­¢ kube-apiserver åæ‰§è¡Œï¼‰
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot-20240101.db \
  --data-dir /var/lib/etcd-restored \
  --initial-cluster-token etcd-cluster-1 \
  --initial-advertise-peer-urls https://<control-plane-ip>:2380 \
  --initial-cluster <node1>=https://<control-plane-ip>:2380
```

**etcd å¤‡ä»½åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šå®šæœŸå¤‡ä»½**:

- **éœ€æ±‚**ï¼šå®šæœŸå¤‡ä»½é›†ç¾¤çŠ¶æ€
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ cron ä»»åŠ¡å®šæœŸæ‰§è¡Œ etcd å¿«ç…§å¤‡ä»½
- **é¢‘ç‡**ï¼šæ¯å¤©æˆ–æ¯å‘¨å¤‡ä»½
- **ä¿ç•™**ï¼šä¿ç•™æœ€è¿‘ 7-30 å¤©çš„å¤‡ä»½

**åœºæ™¯ 2ï¼šå‡çº§å‰å¤‡ä»½**:

- **éœ€æ±‚**ï¼šå‡çº§å‰å¤‡ä»½é›†ç¾¤çŠ¶æ€
- **æ–¹æ¡ˆ**ï¼šå‡çº§å‰æ‰‹åŠ¨æ‰§è¡Œ etcd å¿«ç…§å¤‡ä»½
- **ä¼˜ç‚¹**ï¼šå¯å¿«é€Ÿå›æ»šå‡çº§
- **ç¼ºç‚¹**ï¼šéœ€è¦æ‰‹åŠ¨æ“ä½œ

**åœºæ™¯ 3ï¼šç¾éš¾æ¢å¤å¤‡ä»½**:

- **éœ€æ±‚**ï¼šåº”å¯¹é›†ç¾¤ç¾éš¾æ€§æ•…éšœ
- **æ–¹æ¡ˆ**ï¼šç»“åˆ etcd å¤‡ä»½å’Œ Velero åº”ç”¨å¤‡ä»½
- **ä¼˜ç‚¹**ï¼šå®Œæ•´æ¢å¤èƒ½åŠ›
- **ç¼ºç‚¹**ï¼šéœ€è¦å®šæœŸæµ‹è¯•æ¢å¤

**etcd å¤‡ä»½æœ€ä½³å®è·µ**ï¼š

1. **å®šæœŸå¤‡ä»½**ï¼šæ¯å¤©æˆ–æ¯å‘¨å¤‡ä»½ä¸€æ¬¡
2. **å¼‚åœ°å­˜å‚¨**ï¼šå¤‡ä»½å­˜å‚¨åˆ°å¼‚åœ°ä½ç½®
3. **å¤‡ä»½éªŒè¯**ï¼šå®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§
4. **æ¢å¤æµ‹è¯•**ï¼šå®šæœŸæµ‹è¯•æ¢å¤æµç¨‹
5. **åŠ å¯†å­˜å‚¨**ï¼šæ•æ„Ÿæ•°æ®å¤‡ä»½åŠ å¯†å­˜å‚¨

### 22.10.2 åº”ç”¨æ•°æ®å¤‡ä»½å’Œæ¢å¤

**åº”ç”¨æ•°æ®å¤‡ä»½å®šä¹‰**ï¼š

å¤‡ä»½åº”ç”¨çš„æ•°æ®å·ï¼ˆPVï¼‰å’Œåº”ç”¨é…ç½®ï¼Œç”¨äºåº”ç”¨è¿ç§»æˆ–æ¢å¤ã€‚

**åº”ç”¨æ•°æ®å¤‡ä»½æ–¹å¼**ï¼š

| æ–¹å¼           | å·¥å…·       | é€‚ç”¨åœºæ™¯            | ç‰¹ç‚¹                 |
| -------------- | ---------- | ------------------- | -------------------- |
| **Velero**     | Velero     | Kubernetes èµ„æºå¤‡ä»½ | å®Œæ•´ã€è‡ªåŠ¨åŒ–         |
| **å­˜å‚¨å¿«ç…§**   | CSI å¿«ç…§   | å­˜å‚¨çº§å¤‡ä»½          | å¿«é€Ÿã€å­˜å‚¨æä¾›å•†æ”¯æŒ |
| **æ•°æ®å¯¼å‡º**   | kubectl cp | å°è§„æ¨¡æ•°æ®å¤‡ä»½      | ç®€å•ä½†æ‰‹åŠ¨           |
| **åº”ç”¨çº§å¤‡ä»½** | åº”ç”¨å·¥å…·   | æ•°æ®åº“ç­‰åº”ç”¨å¤‡ä»½    | åº”ç”¨æ„ŸçŸ¥ã€ä¸€è‡´æ€§ä¿è¯ |

**Velero å¤‡ä»½é…ç½®ç¤ºä¾‹**ï¼š

```bash
# 1. å®‰è£… Velero
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.0.0 \
  --bucket my-backup-bucket \
  --secret-file ./credentials-velero

# 2. å¤‡ä»½å‘½åç©ºé—´
velero backup create my-backup --include-namespaces production

# 3. å¤‡ä»½ç‰¹å®šèµ„æº
velero backup create my-backup \
  --include-resources deployments,services,pvc

# 4. å®šæ—¶å¤‡ä»½
velero schedule create daily-backup \
  --schedule="0 2 * * *" \
  --include-namespaces production

# 5. æ¢å¤å¤‡ä»½
velero restore create my-restore --from-backup my-backup
```

**åº”ç”¨æ•°æ®å¤‡ä»½åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ 1ï¼šå®šæœŸåº”ç”¨å¤‡ä»½**:

- **éœ€æ±‚**ï¼šå®šæœŸå¤‡ä»½ç”Ÿäº§ç¯å¢ƒåº”ç”¨
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Velero å®šæ—¶å¤‡ä»½
- **é¢‘ç‡**ï¼šæ¯å¤©å‡Œæ™¨å¤‡ä»½
- **ä¿ç•™**ï¼šä¿ç•™æœ€è¿‘ 30 å¤©å¤‡ä»½

**åœºæ™¯ 2ï¼šè¿ç§»å‰å¤‡ä»½**:

- **éœ€æ±‚**ï¼šè¿ç§»åº”ç”¨å‰å¤‡ä»½æ•°æ®
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Velero æˆ– CSI å¿«ç…§
- **ä¼˜ç‚¹**ï¼šå¯å¿«é€Ÿæ¢å¤
- **ç¼ºç‚¹**ï¼šå¯èƒ½éœ€è¦åœæœº

**åœºæ™¯ 3ï¼šæ•°æ®åº“å¤‡ä»½**:

- **éœ€æ±‚**ï¼šæ•°æ®åº“ä¸€è‡´æ€§å¤‡ä»½
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ•°æ®åº“å·¥å…·ï¼ˆmysqldumpã€pg_dumpï¼‰æˆ– Velero
- **ä¼˜ç‚¹**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- **ç¼ºç‚¹**ï¼šå¯èƒ½éœ€è¦åº”ç”¨æš‚åœ

**åº”ç”¨æ•°æ®å¤‡ä»½æœ€ä½³å®è·µ**ï¼š

1. **å®šæœŸå¤‡ä»½**ï¼šæ ¹æ® RPOï¼ˆæ¢å¤ç‚¹ç›®æ ‡ï¼‰è®¾ç½®å¤‡ä»½é¢‘ç‡
2. **å¢é‡å¤‡ä»½**ï¼šç»“åˆå…¨é‡å’Œå¢é‡å¤‡ä»½å‡å°‘å¤‡ä»½æ—¶é—´
3. **å¼‚åœ°å­˜å‚¨**ï¼šå¤‡ä»½å­˜å‚¨åˆ°å¼‚åœ°ä½ç½®
4. **åŠ å¯†å­˜å‚¨**ï¼šæ•æ„Ÿæ•°æ®å¤‡ä»½åŠ å¯†
5. **æ¢å¤æµ‹è¯•**ï¼šå®šæœŸæµ‹è¯•æ¢å¤æµç¨‹

### 22.10.3 ç¾éš¾æ¢å¤è®¡åˆ’

**ç¾éš¾æ¢å¤è®¡åˆ’å®šä¹‰**ï¼š

åˆ¶å®šå®Œæ•´çš„ç¾éš¾æ¢å¤æµç¨‹ï¼ŒåŒ…æ‹¬å¤‡ä»½ç­–ç•¥ã€æ¢å¤æµç¨‹ã€æ¢å¤æ—¶é—´ç›®æ ‡ï¼ˆRTOï¼‰å’Œæ¢å¤ç‚¹ç›®æ ‡
ï¼ˆRPOï¼‰ã€‚

**ç¾éš¾æ¢å¤è®¡åˆ’è¦ç´ **ï¼š

| è¦ç´          | è¯´æ˜               | ç›®æ ‡å€¼               |
| ------------ | ------------------ | -------------------- |
| **RTO**      | æ¢å¤æ—¶é—´ç›®æ ‡       | < 4 å°æ—¶ï¼ˆå…³é”®ä¸šåŠ¡ï¼‰ |
| **RPO**      | æ¢å¤ç‚¹ç›®æ ‡         | < 1 å°æ—¶ï¼ˆå…³é”®ä¸šåŠ¡ï¼‰ |
| **å¤‡ä»½ç­–ç•¥** | å¤‡ä»½é¢‘ç‡å’Œä¿ç•™ç­–ç•¥ | æ¯å¤©å¤‡ä»½ï¼Œä¿ç•™ 30 å¤© |
| **æ¢å¤æµç¨‹** | è¯¦ç»†çš„æ¢å¤æ­¥éª¤     | æ–‡æ¡£åŒ–ã€å¯æ‰§è¡Œ       |
| **æ¢å¤æµ‹è¯•** | å®šæœŸæ¢å¤æµ‹è¯•       | æ¯å­£åº¦æµ‹è¯•ä¸€æ¬¡       |

**ç¾éš¾æ¢å¤åœºæ™¯**ï¼š

**åœºæ™¯ 1ï¼šetcd æ•°æ®æŸå**:

- **å½±å“**ï¼šé›†ç¾¤æ— æ³•æ­£å¸¸å·¥ä½œ
- **æ¢å¤æµç¨‹**ï¼š
  1. åœæ­¢ kube-apiserver
  2. æ¢å¤ etcd å¿«ç…§
  3. é‡å¯ kube-apiserver
  4. éªŒè¯é›†ç¾¤çŠ¶æ€
- **RTO**ï¼š< 2 å°æ—¶

**åœºæ™¯ 2ï¼šèŠ‚ç‚¹æ•…éšœ**:

- **å½±å“**ï¼šåº”ç”¨ä¸å¯ç”¨
- **æ¢å¤æµç¨‹**ï¼š
  1. ä¿®å¤æˆ–æ›¿æ¢æ•…éšœèŠ‚ç‚¹
  2. é‡æ–°åŠ å…¥é›†ç¾¤
  3. åº”ç”¨è‡ªåŠ¨é‡æ–°è°ƒåº¦
- **RTO**ï¼š< 1 å°æ—¶

**åœºæ™¯ 3ï¼šåº”ç”¨æ•°æ®ä¸¢å¤±**:

- **å½±å“**ï¼šåº”ç”¨æ•°æ®ä¸å¯ç”¨
- **æ¢å¤æµç¨‹**ï¼š
  1. ä» Velero å¤‡ä»½æ¢å¤
  2. éªŒè¯åº”ç”¨çŠ¶æ€
  3. æ¢å¤æœåŠ¡æµé‡
- **RTO**ï¼š< 4 å°æ—¶

**ç¾éš¾æ¢å¤è®¡åˆ’æœ€ä½³å®è·µ**ï¼š

1. **æ–‡æ¡£åŒ–**ï¼šè¯¦ç»†çš„æ¢å¤æµç¨‹æ–‡æ¡£
2. **è‡ªåŠ¨åŒ–**ï¼šå°½å¯èƒ½è‡ªåŠ¨åŒ–æ¢å¤æµç¨‹
3. **å®šæœŸæµ‹è¯•**ï¼šæ¯å­£åº¦æµ‹è¯•ä¸€æ¬¡æ¢å¤æµç¨‹
4. **å¼‚åœ°å¤‡ä»½**ï¼šå¤‡ä»½å­˜å‚¨åˆ°å¼‚åœ°ä½ç½®
5. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å¤‡ä»½å’Œæ¢å¤çŠ¶æ€

### 22.10.4 å¤‡ä»½å·¥å…·å’Œæœ€ä½³å®è·µ

**å¤‡ä»½å·¥å…·å¯¹æ¯”**ï¼š

| å·¥å…·           | å®šä½            | åŠŸèƒ½       | æ˜“ç”¨æ€§     | æˆç†Ÿåº¦     | æ¨èåœºæ™¯           |
| -------------- | --------------- | ---------- | ---------- | ---------- | ------------------ |
| **Velero**     | Kubernetes å¤‡ä»½ | â­â­â­â­â­ | â­â­â­â­   | â­â­â­â­â­ | å¤§å¤šæ•°åœºæ™¯ï¼ˆæ¨èï¼‰ |
| **etcdctl**    | etcd å¤‡ä»½       | â­â­â­â­   | â­â­â­     | â­â­â­â­â­ | etcd ä¸“ç”¨å¤‡ä»½      |
| **CSI å¿«ç…§**   | å­˜å‚¨çº§å¤‡ä»½      | â­â­â­â­   | â­â­â­â­â­ | â­â­â­â­   | å­˜å‚¨æä¾›å•†æ”¯æŒ     |
| **kubectl cp** | æ‰‹åŠ¨å¤‡ä»½        | â­â­â­     | â­â­â­â­â­ | â­â­â­â­â­ | å°è§„æ¨¡ä¸´æ—¶å¤‡ä»½     |

**å¤‡ä»½æœ€ä½³å®è·µ**ï¼š

1. **3-2-1 å¤‡ä»½ç­–ç•¥**ï¼š

   - 3 ä»½å¤‡ä»½
   - 2 ç§ä¸åŒä»‹è´¨
   - 1 ä»½å¼‚åœ°å­˜å‚¨

2. **å¤‡ä»½éªŒè¯**ï¼š

   - å®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§
   - å®šæœŸæµ‹è¯•æ¢å¤æµç¨‹

3. **å¤‡ä»½åŠ å¯†**ï¼š

   - æ•æ„Ÿæ•°æ®å¤‡ä»½åŠ å¯†
   - ä½¿ç”¨åŠ å¯†å­˜å‚¨

4. **å¤‡ä»½ç›‘æ§**ï¼š

   - ç›‘æ§å¤‡ä»½ä»»åŠ¡çŠ¶æ€
   - å‘Šè­¦å¤‡ä»½å¤±è´¥

5. **å¤‡ä»½ä¿ç•™ç­–ç•¥**ï¼š
   - æ ¹æ®åˆè§„è¦æ±‚è®¾ç½®ä¿ç•™æ—¶é—´
   - å®šæœŸæ¸…ç†è¿‡æœŸå¤‡ä»½

**æ¢å¤æœ€ä½³å®è·µ**ï¼š

1. **æ¢å¤å‰éªŒè¯**ï¼šéªŒè¯å¤‡ä»½å®Œæ•´æ€§å’Œå¯ç”¨æ€§
2. **æ¢å¤æµç¨‹æ–‡æ¡£**ï¼šè¯¦ç»†çš„æ¢å¤æ­¥éª¤æ–‡æ¡£
3. **æ¢å¤æµ‹è¯•ç¯å¢ƒ**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå…ˆæµ‹è¯•æ¢å¤
4. **æ¢å¤åéªŒè¯**ï¼šæ¢å¤åéªŒè¯åº”ç”¨åŠŸèƒ½
5. **æ¢å¤æ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œç¾éš¾æ¢å¤æ¼”ç»ƒ

## 22.11 å‡çº§å’Œè¿ç§»æœ€ä½³å®è·µ

### 22.11.1 å‡çº§å‰æ£€æŸ¥æ¸…å•

**å‡çº§å‰æ£€æŸ¥æ¸…å•**ï¼š

**é›†ç¾¤å¥åº·æ£€æŸ¥**ï¼š

- âœ… æ‰€æœ‰èŠ‚ç‚¹ Ready
- âœ… æ‰€æœ‰ç³»ç»Ÿ Pod è¿è¡Œæ­£å¸¸
- âœ… æ‰€æœ‰åº”ç”¨ Pod è¿è¡Œæ­£å¸¸
- âœ… å­˜å‚¨å’Œç½‘ç»œæ­£å¸¸
- âœ… æ— å‘Šè­¦å’Œé”™è¯¯

**ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**ï¼š

- âœ… Kubernetes ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… API ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… CRD ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… æ’ä»¶ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… åº”ç”¨ç‰ˆæœ¬å…¼å®¹æ€§

**èµ„æºæ£€æŸ¥**ï¼š

- âœ… æ§åˆ¶å¹³é¢èµ„æºå……è¶³ï¼ˆCPUã€å†…å­˜ã€å­˜å‚¨ï¼‰
- âœ… å·¥ä½œèŠ‚ç‚¹èµ„æºå……è¶³
- âœ… å­˜å‚¨ç©ºé—´å……è¶³ï¼ˆè‡³å°‘ 2 å€ç©ºé—´ï¼‰
- âœ… ç½‘ç»œå¸¦å®½å……è¶³

**å¤‡ä»½æ£€æŸ¥**ï¼š

- âœ… etcd å¤‡ä»½ï¼ˆæœ€è¿‘å¤‡ä»½ï¼‰
- âœ… åº”ç”¨æ•°æ®å¤‡ä»½
- âœ… é…ç½®æ–‡ä»¶å¤‡ä»½
- âœ… æ¢å¤è®¡åˆ’å‡†å¤‡
- âœ… æ¢å¤æµ‹è¯•é€šè¿‡

**å‡çº§è®¡åˆ’**ï¼š

- âœ… å‡çº§æ—¶é—´çª—å£ç¡®å®š
- âœ… å‡çº§æµç¨‹æ–‡æ¡£åŒ–
- âœ… å›æ»šè®¡åˆ’å‡†å¤‡
- âœ… åº”æ€¥è”ç³»äººç¡®è®¤
- âœ… å‡çº§é€šçŸ¥å‘é€

### 22.11.2 è¿ç§»å‰è§„åˆ’

**è¿ç§»å‰è§„åˆ’**ï¼š

**è¿ç§»è§„åˆ’**ï¼š

- âœ… **è¿ç§»èŒƒå›´**ï¼šç¡®å®šè¿ç§»çš„åº”ç”¨å’Œèµ„æº
- âœ… **è¿ç§»é¡ºåº**ï¼šç¡®å®šè¿ç§»ä¼˜å…ˆçº§å’Œé¡ºåº
- âœ… **è¿ç§»æ—¶é—´**ï¼šç¡®å®šè¿ç§»æ—¶é—´çª—å£
- âœ… **è¿ç§»æ–¹å¼**ï¼šç¡®å®šè¿ç§»æ–¹å¼ï¼ˆè“ç»¿ã€æ»šåŠ¨ç­‰ï¼‰
- âœ… **éªŒè¯æ ‡å‡†**ï¼šç¡®å®šéªŒè¯æ ‡å‡†

**é£é™©è¯„ä¼°**ï¼š

- âœ… è¯†åˆ«æ½œåœ¨é£é™©
- âœ… è¯„ä¼°é£é™©å½±å“
- âœ… åˆ¶å®šé£é™©ç¼“è§£æªæ–½
- âœ… å‡†å¤‡åº”æ€¥è®¡åˆ’

### 22.11.3 å‡çº§å’Œè¿ç§»æµç¨‹

**å‡çº§å’Œè¿ç§»æ ‡å‡†æµç¨‹**ï¼š

**æ ‡å‡†æµç¨‹**ï¼š

1. **è§„åˆ’é˜¶æ®µ**ï¼šåˆ¶å®šå‡çº§/è¿ç§»è®¡åˆ’
2. **å‡†å¤‡é˜¶æ®µ**ï¼šå‡†å¤‡ç¯å¢ƒã€å¤‡ä»½ã€å·¥å…·
3. **æ‰§è¡Œé˜¶æ®µ**ï¼šæ‰§è¡Œå‡çº§/è¿ç§»æ“ä½œ
4. **éªŒè¯é˜¶æ®µ**ï¼šéªŒè¯åŠŸèƒ½æ­£å¸¸
5. **æ¸…ç†é˜¶æ®µ**ï¼šæ¸…ç†ä¸´æ—¶èµ„æº
6. **æ€»ç»“é˜¶æ®µ**ï¼šæ€»ç»“ç»éªŒå’Œé—®é¢˜

**æµç¨‹æ¨¡æ¿**ï¼š

```yaml
å‡çº§/è¿ç§»æµç¨‹:
  é˜¶æ®µ: è§„åˆ’
    ä»»åŠ¡:
      - åˆ¶å®šè®¡åˆ’
      - è¯„ä¼°é£é™©
      - å‡†å¤‡èµ„æº
  é˜¶æ®µ: å‡†å¤‡
    ä»»åŠ¡:
      - ç¯å¢ƒæ£€æŸ¥
      - å¤‡ä»½æ•°æ®
      - å‡†å¤‡å·¥å…·
  é˜¶æ®µ: æ‰§è¡Œ
    ä»»åŠ¡:
      - æ‰§è¡Œæ“ä½œ
      - ç›‘æ§çŠ¶æ€
      - è®°å½•æ—¥å¿—
  é˜¶æ®µ: éªŒè¯
    ä»»åŠ¡:
      - åŠŸèƒ½éªŒè¯
      - æ€§èƒ½éªŒè¯
      - ç¨³å®šæ€§éªŒè¯
  é˜¶æ®µ: æ¸…ç†
    ä»»åŠ¡:
      - æ¸…ç†ä¸´æ—¶èµ„æº
      - å½’æ¡£æ•°æ®
  é˜¶æ®µ: æ€»ç»“
    ä»»åŠ¡:
      - æ€»ç»“ç»éªŒ
      - è®°å½•é—®é¢˜
      - æ›´æ–°æ–‡æ¡£
```

### 22.11.4 é£é™©æ§åˆ¶å’Œå›æ»š

**é£é™©æ§åˆ¶å’Œå›æ»šç­–ç•¥**ï¼š

**é£é™©æ§åˆ¶**ï¼š

- âœ… **åˆ†é˜¶æ®µæ‰§è¡Œ**ï¼šåˆ†é˜¶æ®µå‡çº§/è¿ç§»ï¼Œé™ä½é£é™©
- âœ… **ç°åº¦éªŒè¯**ï¼šå…ˆåœ¨å°èŒƒå›´éªŒè¯
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å’Œå‘Šè­¦
- âœ… **å¿«é€Ÿå›æ»š**ï¼šå‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

**å›æ»šç­–ç•¥**ï¼š

- âœ… **æ•°æ®å›æ»š**ï¼šä½¿ç”¨å¤‡ä»½æ¢å¤æ•°æ®
- âœ… **é…ç½®å›æ»š**ï¼šæ¢å¤åˆ°æ—§ç‰ˆæœ¬é…ç½®
- âœ… **åº”ç”¨å›æ»š**ï¼šå›æ»šåº”ç”¨ç‰ˆæœ¬
- âœ… **é›†ç¾¤å›æ»š**ï¼šé‡å»ºé›†ç¾¤å¹¶æ¢å¤æ•°æ®

**å›æ»šæ£€æŸ¥æ¸…å•**ï¼š

- âœ… å›æ»šè®¡åˆ’æ–‡æ¡£åŒ–
- âœ… å›æ»šå·¥å…·å‡†å¤‡
- âœ… å›æ»šæ•°æ®å®Œæ•´
- âœ… å›æ»šæµç¨‹æµ‹è¯•
- âœ… å›æ»šæ—¶é—´ä¼°ç®—

## 22.12 å®é™…è¿ç§»æ¡ˆä¾‹

### 22.12.1 æ¡ˆä¾‹ 1ï¼šK3s ä» 1.28 å‡çº§åˆ° 1.30ï¼ˆé›¶åœæœºï¼‰

**åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒ K3s é›†ç¾¤éœ€è¦ä» 1.28 å‡çº§åˆ° 1.30ï¼ŒåŒ…å« 100+ ä¸ª Pod

**å‡çº§æ­¥éª¤**ï¼š

```bash
# 1. å‡çº§å‰æ£€æŸ¥
kubectl get nodes
kubectl get pods -A
kubectl top nodes

# 2. å¤‡ä»½ etcd
sudo k3s etcd-snapshot --name=pre-upgrade-backup

# 3. å‡çº§ä¸»èŠ‚ç‚¹
# åœ¨ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹æ‰§è¡Œ
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.30.4+k3s1 sh -

# ç­‰å¾…ä¸»èŠ‚ç‚¹å°±ç»ª
kubectl wait --for=condition=ready node <master-node> --timeout=300s

# 4. å‡çº§å…¶ä»–ä¸»èŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯å¤šä¸»ï¼‰
curl -sfL https://get.k3s.io | \
  K3S_URL=https://<master-ip>:6443 \
  K3S_TOKEN=<token> \
  INSTALL_K3S_VERSION=v1.30.4+k3s1 sh -

# 5. å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼ˆé€ä¸ªå‡çº§ï¼‰
# é©±é€èŠ‚ç‚¹ä¸Šçš„ Pod
kubectl drain <worker-node> --ignore-daemonsets --delete-emptydir-data

# å‡çº§èŠ‚ç‚¹
curl -sfL https://get.k3s.io | \
  K3S_URL=https://<master-ip>:6443 \
  K3S_TOKEN=<token> \
  INSTALL_K3S_VERSION=v1.30.4+k3s1 sh -

# å–æ¶ˆé©±é€
kubectl uncordon <worker-node>

# 6. éªŒè¯å‡çº§
kubectl get nodes
kubectl version
k3s --version
```

**å‡çº§åéªŒè¯**ï¼š

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl get nodes -o wide
kubectl get pods -A | grep -v Running

# æ£€æŸ¥åº”ç”¨åŠŸèƒ½
kubectl get svc -A
curl http://<service-ip>:<port>

# æ£€æŸ¥å­˜å‚¨
kubectl get pv,pvc -A

# æ£€æŸ¥ç½‘ç»œ
kubectl get networkpolicies -A
```

### 22.12.2 æ¡ˆä¾‹ 2ï¼šä» Docker è¿ç§»åˆ° containerd

**åœºæ™¯**ï¼šK3s é›†ç¾¤éœ€è¦ä» Docker è¿è¡Œæ—¶è¿ç§»åˆ° containerd

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
sudo cp /etc/k3s/config.yaml /etc/k3s/config.yaml.backup

# 2. åœæ­¢ K3s
sudo systemctl stop k3s

# 3. å¸è½½ Dockerï¼ˆä¿ç•™é•œåƒæ•°æ®ï¼‰
sudo systemctl stop docker
sudo systemctl disable docker

# 4. ä¿®æ”¹ K3s é…ç½®ä½¿ç”¨ containerd
sudo mkdir -p /etc/rancher/k3s
sudo cat > /etc/rancher/k3s/config.yaml <<EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF

# 5. å¯åŠ¨ K3sï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ containerdï¼‰
sudo systemctl start k3s

# 6. éªŒè¯è¿è¡Œæ—¶
kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.containerRuntimeVersion}'
# åº”è¯¥æ˜¾ç¤ºï¼šcontainerd://<version>

# 7. éªŒè¯ Pod è¿è¡Œ
kubectl get pods -A
```

**è¿ç§»åæ¸…ç†**ï¼š

```bash
# æ¸…ç† Docker æ®‹ç•™ï¼ˆå¯é€‰ï¼‰
sudo apt-get remove docker-ce docker-ce-cli containerd.io
sudo rm -rf /var/lib/docker
```

### 22.12.3 æ¡ˆä¾‹ 3ï¼šä¼ ç»Ÿå®¹å™¨è¿ç§»åˆ° Wasmï¼ˆæ¸è¿›å¼ï¼‰

**åœºæ™¯**ï¼šå°†éƒ¨åˆ†è½»é‡åº”ç”¨ä»ä¼ ç»Ÿå®¹å™¨è¿ç§»åˆ° Wasmï¼Œé™ä½èµ„æºå ç”¨

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å‡†å¤‡ Wasm è¿è¡Œæ—¶
# å®‰è£… WasmEdge å’Œ crunï¼ˆå‚è€ƒå®‰è£…æ–‡æ¡£ï¼‰

# 2. åˆ›å»º RuntimeClass
kubectl apply -f - <<EOF
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun-wasm
handler: crun
EOF

# 3. æ„å»º Wasm é•œåƒ
# å°†åº”ç”¨ç¼–è¯‘ä¸º Wasm æ ¼å¼ï¼ˆå¦‚ä½¿ç”¨ Rustã€Go ç­‰ï¼‰
wasmedgec myapp.wasm myapp.so

# 4. åˆ›å»º OCI é•œåƒ
cat > Dockerfile <<EOF
FROM scratch
COPY myapp.wasm /myapp.wasm
ENTRYPOINT ["/myapp.wasm"]
EOF

docker build -t myregistry.com/myapp-wasm:v1.0.0 .
docker push myregistry.com/myapp-wasm:v1.0.0

# 5. éƒ¨ç½² Wasm Podï¼ˆä¸åŸå®¹å™¨å¹¶è¡Œï¼‰
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-wasm
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp-wasm
  template:
    metadata:
      labels:
        app: myapp-wasm
      annotations:
        module.wasm.image/variant: compat-smart
    spec:
      runtimeClassName: crun-wasm
      containers:
      - name: app
        image: myregistry.com/myapp-wasm:v1.0.0
        command: ["/myapp.wasm"]
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
          limits:
            cpu: 100m
            memory: 50Mi
---
apiVersion: v1
kind: Service
metadata:
  name: myapp-wasm
spec:
  selector:
    app: myapp-wasm
  ports:
  - port: 8080
    targetPort: 8080
EOF

# 6. æµé‡åˆ‡æ¢ï¼ˆä½¿ç”¨ Service Mesh æˆ– Ingressï¼‰
# é€æ­¥å°†æµé‡ä»ä¼ ç»Ÿå®¹å™¨åˆ‡æ¢åˆ° Wasm Pod

# 7. éªŒè¯æ€§èƒ½
kubectl top pods -l app=myapp-wasm
kubectl logs -l app=myapp-wasm

# 8. é€æ­¥å…³é—­ä¼ ç»Ÿå®¹å™¨
kubectl scale deployment myapp --replicas=0
```

### 22.12.4 æ¡ˆä¾‹ 4ï¼šVelero å¤‡ä»½å’Œæ¢å¤

**åœºæ™¯**ï¼šä½¿ç”¨ Velero å¤‡ä»½æ•´ä¸ªå‘½åç©ºé—´å¹¶æ¢å¤åˆ°æ–°é›†ç¾¤

**å¤‡ä»½æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… Velero
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket my-backup-bucket \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=false

# 2. å¤‡ä»½å‘½åç©ºé—´
velero backup create myapp-backup-$(date +%Y%m%d) \
  --include-namespaces production \
  --wait

# 3. éªŒè¯å¤‡ä»½
velero backup describe myapp-backup-$(date +%Y%m%d)
velero backup logs myapp-backup-$(date +%Y%m%d)
```

**æ¢å¤æ­¥éª¤**ï¼š

```bash
# 1. åœ¨æ–°é›†ç¾¤å®‰è£… Veleroï¼ˆç›¸åŒé…ç½®ï¼‰
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket my-backup-bucket \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=false

# 2. æŸ¥çœ‹å¯ç”¨å¤‡ä»½
velero backup get

# 3. æ¢å¤å¤‡ä»½
velero restore create myapp-restore-$(date +%Y%m%d) \
  --from-backup myapp-backup-20250101 \
  --wait

# 4. éªŒè¯æ¢å¤
velero restore describe myapp-restore-$(date +%Y%m%d)
kubectl get pods -n production
kubectl get svc -n production
```

### 22.12.5 æ¡ˆä¾‹ 5ï¼šå•é›†ç¾¤è¿ç§»åˆ°å¤šé›†ç¾¤ï¼ˆKarmadaï¼‰

**åœºæ™¯**ï¼šå°†å•é›†ç¾¤åº”ç”¨è¿ç§»åˆ° Karmada å¤šé›†ç¾¤è”é‚¦

**è¿ç§»æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… Karmada
# åœ¨ä¸»é›†ç¾¤å®‰è£… Karmadaï¼ˆå‚è€ƒ Karmada æ–‡æ¡£ï¼‰

# 2. æ³¨å†Œæˆå‘˜é›†ç¾¤
karmadactl join member-cluster \
  --karmada-context=karmada-apiserver \
  --cluster-kubeconfig=/path/to/member-cluster-kubeconfig

# 3. åˆ›å»º PropagationPolicy
kubectl apply -f - <<EOF
apiVersion: policy.karmada.io/v1alpha1
kind: PropagationPolicy
metadata:
  name: myapp-propagation
spec:
  resourceSelectors:
    - apiVersion: apps/v1
      kind: Deployment
      name: myapp
  placement:
    clusterAffinity:
      clusterNames:
        - member-cluster-1
        - member-cluster-2
    replicaScheduling:
      replicaDivisionPreference: Weighted
      replicaSchedulingType: Divided
      weightPreference:
        staticWeightList:
          - targetCluster:
              clusterNames:
                - member-cluster-1
            weight: 1
          - targetCluster:
              clusterNames:
                - member-cluster-2
            weight: 1
EOF

# 4. åˆ›å»ºåº”ç”¨ï¼ˆä¼šè‡ªåŠ¨åˆ†å‘åˆ°æˆå‘˜é›†ç¾¤ï¼‰
kubectl apply -f myapp-deployment.yaml

# 5. éªŒè¯åˆ†å‘
karmadactl get deployment myapp --karmada-context=karmada-apiserver
kubectl get deployment myapp -n <namespace> --context=member-cluster-1
kubectl get deployment myapp -n <namespace> --context=member-cluster-2
```

## 22.13 å‡çº§å’Œè¿ç§»æ•…éšœæ’æŸ¥

### 22.13.1 å‡çº§å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šå‡çº§å Pod æ— æ³•å¯åŠ¨**:

```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl describe pod <pod-name>

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl describe node <node-name>

# æ£€æŸ¥è¿è¡Œæ—¶
kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.containerRuntimeVersion}'

# æ£€æŸ¥æ—¥å¿—
journalctl -u k3s -f
```

**é—®é¢˜ 2ï¼šAPI ç‰ˆæœ¬ä¸å…¼å®¹**:

```bash
# æ£€æŸ¥ API ç‰ˆæœ¬
kubectl api-versions

# æ£€æŸ¥èµ„æºç‰ˆæœ¬
kubectl get <resource> -o yaml | grep apiVersion

# ä½¿ç”¨ kubectl convertï¼ˆå·²åºŸå¼ƒï¼‰æˆ–æ‰‹åŠ¨æ›´æ–° YAML
```

**é—®é¢˜ 3ï¼šCRD ç‰ˆæœ¬ä¸å…¼å®¹**:

```bash
# æ£€æŸ¥ CRD ç‰ˆæœ¬
kubectl get crd

# æ›´æ–° CRD
kubectl apply -f <crd-definition.yaml>

# éªŒè¯ CRD
kubectl get crd <crd-name> -o yaml
```

### 22.13.2 è¿ç§»å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šæ•°æ®è¿ç§»å¤±è´¥**:

```bash
# æ£€æŸ¥ PVC çŠ¶æ€
kubectl get pvc -A

# æ£€æŸ¥ PV çŠ¶æ€
kubectl get pv

# æ£€æŸ¥å­˜å‚¨ç±»
kubectl get storageclass

# æ‰‹åŠ¨è¿ç§»æ•°æ®
kubectl run data-migration --image=busybox --rm -it -- sh
# åœ¨ Pod ä¸­æ‰§è¡Œæ•°æ®è¿ç§»å‘½ä»¤
```

**é—®é¢˜ 2ï¼šç½‘ç»œé…ç½®è¿ç§»å¤±è´¥**:

```bash
# æ£€æŸ¥ Service
kubectl get svc -A

# æ£€æŸ¥ Ingress
kubectl get ingress -A

# æ£€æŸ¥ NetworkPolicy
kubectl get networkpolicies -A

# æ£€æŸ¥ DNS
kubectl run test-dns --image=busybox --rm -it -- nslookup <service-name>
```

**é—®é¢˜ 3ï¼šåº”ç”¨é…ç½®è¿ç§»å¤±è´¥**:

```bash
# æ£€æŸ¥ ConfigMap
kubectl get configmap -A

# æ£€æŸ¥ Secret
kubectl get secret -A

# æ£€æŸ¥ç¯å¢ƒå˜é‡
kubectl exec <pod-name> -- env

# å¯¹æ¯”é…ç½®
kubectl get configmap <name> -o yaml > old-config.yaml
kubectl get configmap <name> -n <new-namespace> -o yaml > new-config.yaml
diff old-config.yaml new-config.yaml
```

## 22.14 å‚è€ƒ

- [Kubernetes å‡çº§æ–‡æ¡£](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)
- [K3s å‡çº§æ–‡æ¡£](https://docs.k3s.io/upgrades)
- [Velero å®˜æ–¹æ–‡æ¡£](https://velero.io/docs/)
- [Kompose å®˜æ–¹æ–‡æ¡£](https://kompose.io/)
- [etcd å¤‡ä»½æ¢å¤æ–‡æ¡£](https://etcd.io/docs/)

---

**æœ€åæ›´æ–°**ï¼š2025-11-06 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
