# 03. WasmEdgeï¼šWebAssembly è¿è¡Œæ—¶é›†æˆæŒ‡å—

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [03.1 æ–‡æ¡£å®šä½](#031-æ–‡æ¡£å®šä½)
- [03.2 æ ¸å¿ƒå®šä½](#032-æ ¸å¿ƒå®šä½)
  - [03.2.1 WasmEdge æ˜¯ä»€ä¹ˆï¼Ÿ](#0321-wasmedge-æ˜¯ä»€ä¹ˆ)
  - [03.2.2 å®šä½è®ºè¯](#0322-å®šä½è®ºè¯)
- [03.3 ä¸‰ç§é›†æˆè·¯çº¿](#033-ä¸‰ç§é›†æˆè·¯çº¿)
  - [03.3.1 è·¯çº¿å¯¹æ¯”](#0331-è·¯çº¿å¯¹æ¯”)
  - [03.3.2 è·¯çº¿é€‰æ‹©è®ºè¯](#0332-è·¯çº¿é€‰æ‹©è®ºè¯)
- [03.4 è·¯çº¿ 1ï¼šDocker + WasmEdgeï¼ˆå¿«é€ŸéªŒè¯ï¼‰](#034-è·¯çº¿-1docker--wasmedgeå¿«é€ŸéªŒè¯)
  - [03.4.1 æ¶æ„](#0341-æ¶æ„)
  - [03.4.2 å®ç°ç¤ºä¾‹](#0342-å®ç°ç¤ºä¾‹)
  - [03.4.3 ä¼˜ç¼ºç‚¹](#0343-ä¼˜ç¼ºç‚¹)
  - [03.4.4 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–](#0344-æŠ€æœ¯åœºæ™¯ä¸å†³ç­–)
- [03.5 è·¯çº¿ 2ï¼šcrun è‡ªåŠ¨è¯†åˆ«ï¼ˆç”Ÿäº§æ¨èï¼‰](#035-è·¯çº¿-2crun-è‡ªåŠ¨è¯†åˆ«ç”Ÿäº§æ¨è)
  - [03.5.1 æ¶æ„](#0351-æ¶æ„)
  - [03.5.2 OCI æ³¨é‡Š](#0352-oci-æ³¨é‡Š)
  - [03.5.3 crun é…ç½®](#0353-crun-é…ç½®)
  - [03.5.4 é•œåƒæ„å»º](#0354-é•œåƒæ„å»º)
  - [03.5.5 ä¼˜ç¼ºç‚¹](#0355-ä¼˜ç¼ºç‚¹)
  - [03.5.6 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–](#0356-æŠ€æœ¯åœºæ™¯ä¸å†³ç­–)
- [03.6 è·¯çº¿ 3ï¼šcontainerd-shim-runwasiï¼ˆæœ€æ–°ï¼‰](#036-è·¯çº¿-3containerd-shim-runwasiæœ€æ–°)
  - [03.6.1 æ¶æ„](#0361-æ¶æ„)
  - [03.6.2 å®‰è£…é…ç½®](#0362-å®‰è£…é…ç½®)
  - [03.6.3 RuntimeClass é…ç½®](#0363-runtimeclass-é…ç½®)
  - [03.6.4 ä¼˜ç¼ºç‚¹](#0364-ä¼˜ç¼ºç‚¹)
  - [03.6.5 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–](#0365-æŠ€æœ¯åœºæ™¯ä¸å†³ç­–)
- [03.7 CRI é›†æˆåŸç†](#037-cri-é›†æˆåŸç†)
  - [03.7.1 è¿è¡Œæ—¶è¯†åˆ«æµç¨‹](#0371-è¿è¡Œæ—¶è¯†åˆ«æµç¨‹)
  - [03.7.2 CRI æ’ä»¶æ¶æ„](#0372-cri-æ’ä»¶æ¶æ„)
  - [03.7.3 é›†æˆè®ºè¯](#0373-é›†æˆè®ºè¯)
- [03.8 æ€§èƒ½ä¼˜åŠ¿](#038-æ€§èƒ½ä¼˜åŠ¿)
  - [03.8.1 å¯¹æ¯”æ•°æ®](#0381-å¯¹æ¯”æ•°æ®)
  - [03.8.2 æ€§èƒ½ä¼˜åŠ¿åŸç†](#0382-æ€§èƒ½ä¼˜åŠ¿åŸç†)
  - [03.8.3 æ€§èƒ½è®ºè¯](#0383-æ€§èƒ½è®ºè¯)
  - [03.8.4 æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–](#0384-æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–)
- [03.9 å®æˆ˜ç¤ºä¾‹](#039-å®æˆ˜ç¤ºä¾‹)
  - [03.9.1 å‡†å¤‡ Wasm å­—èŠ‚ç ï¼ˆRustï¼‰](#0391-å‡†å¤‡-wasm-å­—èŠ‚ç rust)
  - [03.9.2 æ‰“åŒ… OCI é•œåƒ](#0392-æ‰“åŒ…-oci-é•œåƒ)
  - [03.9.3 éƒ¨ç½²åˆ° K3s](#0393-éƒ¨ç½²åˆ°-k3s)
- [03.10 å¸¸è§é—®é¢˜](#0310-å¸¸è§é—®é¢˜)
  - [03.10.1 æ•…éšœæ’æŸ¥](#03101-æ•…éšœæ’æŸ¥)
  - [03.10.2 æ•…éšœåœºæ™¯ä¸å†³ç­–](#03102-æ•…éšœåœºæ™¯ä¸å†³ç­–)
- [03.11 æœ€ä½³å®è·µ](#0311-æœ€ä½³å®è·µ)
  - [03.11.1 é•œåƒæ„å»º](#03111-é•œåƒæ„å»º)
  - [03.11.2 ç½‘ç»œé…ç½®](#03112-ç½‘ç»œé…ç½®)
  - [03.11.3 èµ„æºé™åˆ¶](#03113-èµ„æºé™åˆ¶)
- [03.12 æŠ€æœ¯åœºæ™¯åˆ†æ](#0312-æŠ€æœ¯åœºæ™¯åˆ†æ)
  - [03.12.1 å¼€å‘ç¯å¢ƒåœºæ™¯](#03121-å¼€å‘ç¯å¢ƒåœºæ™¯)
  - [03.12.2 ç”Ÿäº§ç¯å¢ƒåœºæ™¯](#03122-ç”Ÿäº§ç¯å¢ƒåœºæ™¯)
  - [03.12.3 CI/CD åœºæ™¯](#03123-cicd-åœºæ™¯)
  - [03.12.4 è¾¹ç¼˜åœºæ™¯](#03124-è¾¹ç¼˜åœºæ™¯)
  - [03.12.5 Serverless åœºæ™¯](#03125-serverless-åœºæ™¯)
- [03.13 å†³ç­–ä¾æ®ä¸æ€è·¯](#0313-å†³ç­–ä¾æ®ä¸æ€è·¯)
  - [03.13.1 è·¯çº¿é€‰æ‹©å†³ç­–æ ‘](#03131-è·¯çº¿é€‰æ‹©å†³ç­–æ ‘)
  - [03.13.2 æŠ€æœ¯åœºæ™¯é€‰æ‹©å†³ç­–æ ‘](#03132-æŠ€æœ¯åœºæ™¯é€‰æ‹©å†³ç­–æ ‘)
  - [03.13.3 æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘](#03133-æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘)
- [03.14 å½¢å¼åŒ–æ€»ç»“](#0314-å½¢å¼åŒ–æ€»ç»“)
  - [03.14.1 è·¯çº¿æ¨¡å‹å½¢å¼åŒ–](#03141-è·¯çº¿æ¨¡å‹å½¢å¼åŒ–)
  - [03.14.2 æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–](#03142-æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–)
  - [03.14.3 è·¯çº¿æ€§èƒ½å¯¹æ¯”æ¨¡å‹](#03143-è·¯çº¿æ€§èƒ½å¯¹æ¯”æ¨¡å‹)
- [03.15 å®é™…éƒ¨ç½²æ¡ˆä¾‹](#0315-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
  - [03.15.1 æ¡ˆä¾‹ 1ï¼šä½¿ç”¨ crun éƒ¨ç½² Wasm åº”ç”¨ï¼ˆç”Ÿäº§æ¨èï¼‰](#03151-æ¡ˆä¾‹-1ä½¿ç”¨-crun-éƒ¨ç½²-wasm-åº”ç”¨ç”Ÿäº§æ¨è)
  - [03.15.2 æ¡ˆä¾‹ 2ï¼šä½¿ç”¨ runwasi éƒ¨ç½² Wasm åº”ç”¨ï¼ˆK8s 1.30+ï¼‰](#03152-æ¡ˆä¾‹-2ä½¿ç”¨-runwasi-éƒ¨ç½²-wasm-åº”ç”¨k8s-130)
  - [03.15.3 æ¡ˆä¾‹ 3ï¼šRust åº”ç”¨ç¼–è¯‘ä¸º Wasm å¹¶éƒ¨ç½²](#03153-æ¡ˆä¾‹-3rust-åº”ç”¨ç¼–è¯‘ä¸º-wasm-å¹¶éƒ¨ç½²)
- [03.16 WasmEdge æ•…éšœæ’æŸ¥](#0316-wasmedge-æ•…éšœæ’æŸ¥)
  - [03.16.1 å¸¸è§é—®é¢˜](#03161-å¸¸è§é—®é¢˜)
- [03.17 å‚è€ƒ](#0317-å‚è€ƒ)

---

## 03.1 æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£æ·±å…¥è§£æ WasmEdge ä¸ Docker/K8s/K3s çš„é›†æˆæ–¹å¼ã€æŠ€æœ¯åŸç†å’Œæœ€ä½³å®è·µï¼Œä»¥åŠä¸
åŒæŠ€æœ¯åœºæ™¯ä¸‹çš„å†³ç­–ä¾æ®å’Œå†³ç­–æ€è·¯ã€‚

**å½“å‰ç‰ˆæœ¬ï¼ˆ2025-11-06ï¼‰**ï¼š

- **WasmEdge ç‰ˆæœ¬**ï¼š0.14.0ï¼ˆ2024-12 å‘å¸ƒï¼Œ2025-11-06 ç¨³å®šç‰ˆï¼‰
- **å…³é”®ç‰¹æ€§**ï¼šå†…ç½® Llama2/7B æ’ä»¶ï¼ŒGPU åŠ é€Ÿæ¨ç†ï¼Œæ¨ç†å»¶è¿Ÿæ¯” PyTorch å®¹å™¨ â†“60%
- **é›†æˆæ”¯æŒ**ï¼šK8s 1.30 RuntimeClass=wasm åŸç”Ÿæ”¯æŒï¼ŒK3s 1.30 --wasm flag
- **ç”Ÿäº§éªŒè¯**ï¼šæµªæ½®äº‘ 10 ä¸‡å°è¾¹ç¼˜èŠ‚ç‚¹ï¼Œå†·å¯åŠ¨ â‰¤6 msï¼ˆ2025-11-06ï¼‰

**æ–‡æ¡£ç»“æ„**ï¼š

- **é›†æˆè·¯çº¿**ï¼šä¸‰ç§é›†æˆè·¯çº¿ï¼ˆDocker/crun/runwasiï¼‰çš„æŠ€æœ¯åŸç†å’Œå®ç°
- **æ€§èƒ½ä¼˜åŠ¿**ï¼šWasmEdge çš„æ€§èƒ½ä¼˜åŠ¿å’ŒåŸç†
- **AI æ¨ç†**ï¼šWasmEdge 0.14 + Llama2 æ’ä»¶ã€æ¨¡å‹ Wasm-åŒ–æ–¹æ¡ˆ
- **æŠ€æœ¯åœºæ™¯**ï¼šå¼€å‘ã€ç”Ÿäº§ã€CI/CDã€è¾¹ç¼˜ã€Serverless
- **å†³ç­–åˆ†æ**ï¼šè·¯çº¿é€‰æ‹©ã€åœºæ™¯é€‚é…ã€æ€§èƒ½ä¼˜åŒ–

## 03.2 æ ¸å¿ƒå®šä½

### 03.2.1 WasmEdge æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸æ˜¯**ï¼šåœ¨ Linux å®¹å™¨å†…è¿è¡Œ WasmEdge **è€Œæ˜¯**ï¼šè®© Wasm å­—èŠ‚ç æˆä¸º"ä¸€ç­‰å…¬æ°‘"ï¼Œ
é•œåƒé‡Œåªæœ‰ `.wasm` æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ç›´æ¥è°ƒç”¨ WasmEdge å¼•æ“ã€‚

```mermaid
graph TD
    A[ä¼ ç»Ÿå®¹å™¨] --> B[rootfs + åº”ç”¨]
    B --> C[runc]
    C --> D[Linux è¿›ç¨‹]

    E[Wasm å®¹å™¨] --> F[.wasm æ–‡ä»¶]
    F --> G[WasmEdge å¼•æ“]
    G --> H[å­—èŠ‚ç æ‰§è¡Œ]

    style A fill:#ffe6e6
    style E fill:#e6ffe6
```

**æ ¸å¿ƒå®šä½è®ºè¯**ï¼š

- **ä¼ ç»Ÿå®¹å™¨**ï¼šéœ€è¦ rootfs + åº”ç”¨ï¼Œé€šè¿‡ runc åˆ›å»º Linux è¿›ç¨‹
- **Wasm å®¹å™¨**ï¼šåªæœ‰ `.wasm` æ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡ WasmEdge å¼•æ“æ‰§è¡Œ
- **ä¼˜åŠ¿**ï¼šæ— éœ€ rootfsï¼Œå¯åŠ¨å¿«ï¼Œä½“ç§¯å°

### 03.2.2 å®šä½è®ºè¯

**ä¸ºä»€ä¹ˆè®© Wasm æˆä¸ºä¸€ç­‰å…¬æ°‘ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¯åŠ¨é€Ÿåº¦ï¼šWasm å¯åŠ¨æ—¶é—´ < 10msï¼Œå®¹å™¨å¯åŠ¨æ—¶é—´ > 1s [^wasmedge-performance]
- âœ… é•œåƒä½“ç§¯ï¼šWasm é•œåƒ < 1MBï¼Œå®¹å™¨é•œåƒ > 10MB
- âœ… èµ„æºå ç”¨ï¼šWasm å†…å­˜å ç”¨ ~2MBï¼Œå®¹å™¨å†…å­˜å ç”¨ > 18MB

**å†³ç­–æ€è·¯**ï¼š

```yaml
Wasm ä¸€ç­‰å…¬æ°‘è®¾è®¡:
  ä¼˜åŠ¿:
    - å¯åŠ¨é€Ÿåº¦å¿«ï¼ˆ< 10msï¼‰
    - é•œåƒä½“ç§¯å°ï¼ˆ< 1MBï¼‰
    - èµ„æºå ç”¨ä½ï¼ˆ~2MBï¼‰
  æƒè¡¡:
    - ä¸æ”¯æŒæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
    - éœ€è¦ WASI æ”¯æŒ
```

## 03.3 ä¸‰ç§é›†æˆè·¯çº¿

### 03.3.1 è·¯çº¿å¯¹æ¯”

```mermaid
graph TB
    A[WasmEdge é›†æˆ] --> B[è·¯çº¿ 1<br/>Docker + å…¥å£è„šæœ¬]
    A --> C[è·¯çº¿ 2<br/>crun è‡ªåŠ¨è¯†åˆ«]
    A --> D[è·¯çº¿ 3<br/>containerd-shim-runwasi]

    B --> E[æœ¬åœ°éªŒè¯/CI]
    C --> F[ç”Ÿäº§ K8s/K3s]
    D --> G[æœ€æ–° K8s/è¾¹ç¼˜]

    style B fill:#ffe6e6
    style C fill:#fff4e1
    style D fill:#e6ffe6
```

| è·¯çº¿                          | å¯åŠ¨æ–¹å¼                              | æ˜¯å¦éœ€ rootfs                 | YAML æ”¹é€  | é€‚ç”¨åœºæ™¯       | æˆç†Ÿåº¦     |
| ----------------------------- | ------------------------------------- | ----------------------------- | --------- | -------------- | ---------- |
| **â‘  Docker + WasmEdge**       | å…¥å£è„šæœ¬ `wasmedge app.wasm`          | âœ… éœ€è¦ï¼ˆå« WasmEdge äºŒè¿›åˆ¶ï¼‰ | âŒ ä¸éœ€è¦ | å¿«é€ŸéªŒè¯ã€CI   | â­â­â­     |
| **â‘¡ crun è‡ªåŠ¨è¯†åˆ«**           | crun æ ¹æ® OCI æ³¨é‡Š `module.wasm` è°ƒç”¨ | âŒ ä¸éœ€è¦                     | âŒ ä¸éœ€è¦ | ç”Ÿäº§ K8s/K3s   | â­â­â­â­â­ |
| **â‘¢ containerd-shim-runwasi** | shim ç›´æ¥å¯åŠ¨ WasmEdge                | âŒ ä¸éœ€è¦                     | âŒ ä¸éœ€è¦ | æœ€æ–° K8sã€è¾¹ç¼˜ | â­â­â­â­   |

> **æ¨èé¡ºåº**ï¼šæœ¬åœ°è·¯çº¿ â‘  â†’ æµ‹è¯•è·¯çº¿ â‘¡ â†’ è¾¹ç¼˜/Serverless è·¯çº¿ â‘¢

### 03.3.2 è·¯çº¿é€‰æ‹©è®ºè¯

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ç§è·¯çº¿ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… ä¸åŒåœºæ™¯éœ€æ±‚ï¼šå¼€å‘ã€ç”Ÿäº§ã€è¾¹ç¼˜å„æœ‰ä¸åŒéœ€æ±‚
- âœ… æˆç†Ÿåº¦ä¸åŒï¼šè·¯çº¿æˆç†Ÿåº¦ä¸åŒï¼Œéœ€è¦æ¸è¿›å¼é‡‡ç”¨
- âœ… æŠ€æœ¯å¤æ‚åº¦ï¼šè·¯çº¿å¤æ‚åº¦ä¸åŒï¼Œéœ€è¦å¹³è¡¡

**å†³ç­–æ€è·¯**ï¼š

```yaml
è·¯çº¿é€‰æ‹©ç­–ç•¥:
  å¼€å‘é˜¶æ®µ: è·¯çº¿ 1ï¼ˆç®€å•ã€å¿«é€ŸéªŒè¯ï¼‰
  ç”Ÿäº§é˜¶æ®µ: è·¯çº¿ 2ï¼ˆæˆç†Ÿã€æ¨èï¼‰
  è¾¹ç¼˜é˜¶æ®µ: è·¯çº¿ 3ï¼ˆæœ€æ–°ã€é€‚åˆè¾¹ç¼˜ï¼‰
```

## 03.4 è·¯çº¿ 1ï¼šDocker + WasmEdgeï¼ˆå¿«é€ŸéªŒè¯ï¼‰

### 03.4.1 æ¶æ„

```mermaid
graph LR
    A[Dockerfile] --> B[é•œåƒåŒ…å«<br/>WasmEdge äºŒè¿›åˆ¶]
    B --> C[å…¥å£è„šæœ¬]
    C --> D[wasmedge app.wasm]

    style B fill:#ffe6e6
```

**æ¶æ„åˆ†æ**ï¼š

- **é•œåƒåŒ…å« WasmEdge**ï¼šé•œåƒéœ€è¦åŒ…å« WasmEdge äºŒè¿›åˆ¶ï¼Œä½“ç§¯å¤§
- **å…¥å£è„šæœ¬**ï¼šé€šè¿‡å…¥å£è„šæœ¬è°ƒç”¨ WasmEdge
- **éœ€è¦ rootfs**ï¼šéœ€è¦å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½“ç§¯å¤§

### 03.4.2 å®ç°ç¤ºä¾‹

```dockerfile
FROM ubuntu:22.04

# å®‰è£… WasmEdge
RUN curl -sSf https://raw.githubusercontent.com/WasmEdge/WasmEdge/master/utils/install.sh | bash

# å¤åˆ¶ wasm æ–‡ä»¶
COPY app.wasm /app.wasm

# å…¥å£è„šæœ¬
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
```

```bash
#!/bin/bash
# entrypoint.sh
wasmedge /app.wasm
```

### 03.4.3 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹            | ç¼ºç‚¹                           |
| --------------- | ------------------------------ |
| âœ… å®ç°ç®€å•     | âŒ é•œåƒä½“ç§¯å¤§ï¼ˆåŒ…å« WasmEdgeï¼‰ |
| âœ… æ— éœ€ä¿®æ”¹ K8s | âŒ éœ€è¦ rootfs                 |
| âœ… å…¼å®¹æ€§å¥½     | âŒ å¯åŠ¨æ—¶é—´ç›¸å¯¹æ…¢              |

**ä¼˜ç¼ºç‚¹è®ºè¯**ï¼š

- **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œæ— éœ€ä¿®æ”¹ K8sï¼Œå…¼å®¹æ€§å¥½
- **ç¼ºç‚¹**ï¼šé•œåƒä½“ç§¯å¤§ï¼ˆåŒ…å« WasmEdgeï¼‰ï¼Œéœ€è¦ rootfsï¼Œå¯åŠ¨æ—¶é—´ç›¸å¯¹æ…¢

### 03.4.4 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæœ¬åœ°å¼€å‘éªŒè¯**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦å¿«é€ŸéªŒè¯
- âœ… ä¸éœ€è¦ç”Ÿäº§çº§æ€§èƒ½
- âœ… ç®€å•å®ç°ä¼˜å…ˆ

**å†³ç­–æ€è·¯**ï¼š

```yaml
æœ¬åœ°å¼€å‘éªŒè¯:
  è·¯çº¿: è·¯çº¿ 1ï¼ˆDocker + WasmEdgeï¼‰
  åŸå› : ç®€å•ã€å¿«é€Ÿã€æ— éœ€é…ç½®
  æƒè¡¡: é•œåƒä½“ç§¯å¤§ã€å¯åŠ¨æ…¢
```

**åœºæ™¯ 2ï¼šCI/CD æµ‹è¯•**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦å¿«é€ŸéªŒè¯
- âœ… ä¸éœ€è¦ç”Ÿäº§çº§æ€§èƒ½
- âœ… å…¼å®¹æ€§å¥½

**å†³ç­–æ€è·¯**ï¼š

```yaml
CI/CD æµ‹è¯•:
  è·¯çº¿: è·¯çº¿ 1ï¼ˆDocker + WasmEdgeï¼‰
  åŸå› : ç®€å•ã€å…¼å®¹æ€§å¥½
  æƒè¡¡: é•œåƒä½“ç§¯å¤§ã€å¯åŠ¨æ…¢
```

## 03.5 è·¯çº¿ 2ï¼šcrun è‡ªåŠ¨è¯†åˆ«ï¼ˆç”Ÿäº§æ¨èï¼‰

### 03.5.1 æ¶æ„

```mermaid
graph LR
    A[OCI é•œåƒ] --> B[é•œåƒæ³¨é‡Š<br/>module.wasm.image/variant]
    B --> C[crun è¯†åˆ«]
    C --> D[è°ƒç”¨ WasmEdge]
    D --> E[æ‰§è¡Œ .wasm]

    style C fill:#fff4e1
    style E fill:#e6ffe6
```

**æ¶æ„åˆ†æ**ï¼š

- **OCI é•œåƒ**ï¼šæ ‡å‡† OCI é•œåƒæ ¼å¼
- **é•œåƒæ³¨é‡Š**ï¼šé€šè¿‡ OCI æ³¨é‡Šæ ‡è¯† wasm æ¨¡å—
- **crun è¯†åˆ«**ï¼šcrun æ ¹æ®æ³¨é‡Šè‡ªåŠ¨è¯†åˆ«å¹¶è°ƒç”¨ WasmEdge

### 03.5.2 OCI æ³¨é‡Š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: wasm-app
  annotations:
    module.wasm.image/variant: compat-smart # å…³é”®æ³¨é‡Š
spec:
  runtimeClassName: crun-wasm
  containers:
    - name: app
      image: yourhub/app-wasm:v1
      command: ["app.wasm"] # å¯é€‰ï¼Œcrun ä¼šè‡ªåŠ¨æå–
```

**OCI æ³¨é‡Šè®ºè¯**ï¼š

- **module.wasm.image/variant**ï¼šæ ‡è¯†é•œåƒåŒ…å« wasm æ¨¡å—
- **crun è‡ªåŠ¨è¯†åˆ«**ï¼šcrun â‰¥ 1.8.5 æ”¯æŒè‡ªåŠ¨è¯†åˆ« wasm æ¨¡å—
- **é›¶ YAML æ”¹é€ **ï¼šåªéœ€æ·»åŠ æ³¨é‡Šï¼Œæ— éœ€ä¿®æ”¹ YAML ç»“æ„

### 03.5.3 crun é…ç½®

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun-wasm
handler: crun
```

**RuntimeClass è®ºè¯**ï¼š

- **handler: crun**ï¼šæŒ‡å®šä½¿ç”¨ crun è¿è¡Œæ—¶
- **è‡ªåŠ¨è¯†åˆ«**ï¼šcrun æ ¹æ® OCI æ³¨é‡Šè‡ªåŠ¨è¯†åˆ« wasm æ¨¡å—
- **é›¶æ”¹é€ **ï¼šæ— éœ€ä¿®æ”¹ Pod YAML ç»“æ„

### 03.5.4 é•œåƒæ„å»º

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ wasm-to-oci
wasm-to-oci push app.wasm docker.io/yourhub/app-wasm:v1

# æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ„å»º
cat > Dockerfile <<EOF
FROM scratch
COPY app.wasm /app.wasm
EOF
docker build -t yourhub/app-wasm:v1 .
```

**é•œåƒæ„å»ºè®ºè¯**ï¼š

- **wasm-to-oci**ï¼šä¸“é—¨ç”¨äºæ¨é€ wasm æ¨¡å—åˆ° OCI ä»“åº“
- **FROM scratch**ï¼šæœ€å°åŒ–é•œåƒï¼Œæ— éœ€ rootfs
- **ä½“ç§¯ä¼˜åŒ–**ï¼šæœ€ç»ˆé•œåƒä½“ç§¯ < 1MB

### 03.5.5 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹                    | ç¼ºç‚¹                     |
| ----------------------- | ------------------------ |
| âœ… é›¶ rootfs            | âš ï¸ éœ€è¦ crun â‰¥ 1.8.5     |
| âœ… é•œåƒä½“ç§¯å°ï¼ˆ< 1MBï¼‰  | âš ï¸ éœ€è¦ RuntimeClass     |
| âœ… å¯åŠ¨é€Ÿåº¦å¿«ï¼ˆ< 10msï¼‰ | âš ï¸ éœ€è¦èŠ‚ç‚¹å®‰è£… WasmEdge |
| âœ… é›¶ YAML æ”¹é€          |                          |

**ä¼˜ç¼ºç‚¹è®ºè¯**ï¼š

- **ä¼˜ç‚¹**ï¼šé›¶ rootfsã€é•œåƒä½“ç§¯å°ã€å¯åŠ¨é€Ÿåº¦å¿«ã€é›¶ YAML æ”¹é€ 
- **ç¼ºç‚¹**ï¼šéœ€è¦ crun â‰¥ 1.8.5ã€éœ€è¦ RuntimeClassã€éœ€è¦èŠ‚ç‚¹å®‰è£… WasmEdge

### 03.5.6 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆK8s/K3sï¼‰**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦ç”Ÿäº§çº§æ€§èƒ½
- âœ… éœ€è¦æœ€å°é•œåƒä½“ç§¯
- âœ… éœ€è¦å¿«é€Ÿå¯åŠ¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç”Ÿäº§ç¯å¢ƒ:
  è·¯çº¿: è·¯çº¿ 2ï¼ˆcrun è‡ªåŠ¨è¯†åˆ«ï¼‰
  åŸå› : é›¶ rootfsã€ä½“ç§¯å°ã€å¯åŠ¨å¿«
  æƒè¡¡: éœ€è¦ crun â‰¥ 1.8.5
```

**åœºæ™¯ 2ï¼šå¤§è§„æ¨¡éƒ¨ç½²**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦é«˜å¯†åº¦éƒ¨ç½²
- âœ… éœ€è¦å¿«é€Ÿå¯åŠ¨
- âœ… éœ€è¦èµ„æºä¼˜åŒ–

**å†³ç­–æ€è·¯**ï¼š

```yaml
å¤§è§„æ¨¡éƒ¨ç½²:
  è·¯çº¿: è·¯çº¿ 2ï¼ˆcrun è‡ªåŠ¨è¯†åˆ«ï¼‰
  åŸå› : é•œåƒä½“ç§¯å°ã€å¯åŠ¨å¿«ã€èµ„æºå ç”¨ä½
  ä¼˜åŠ¿: å•èŠ‚ç‚¹å¯éƒ¨ç½² 3000 Pod
```

## 03.6 è·¯çº¿ 3ï¼šcontainerd-shim-runwasiï¼ˆæœ€æ–°ï¼‰

### 03.6.1 æ¶æ„

```mermaid
graph LR
    A[containerd] --> B[containerd-shim-runwasi]
    B --> C[WasmEdge å¼•æ“]
    C --> D[æ‰§è¡Œ .wasm]

    style B fill:#e6ffe6
```

**æ¶æ„åˆ†æ**ï¼š

- **containerd**ï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£
- **containerd-shim-runwasi**ï¼šä¸“é—¨çš„ wasm shim
- **WasmEdge å¼•æ“**ï¼šç›´æ¥è°ƒç”¨ WasmEdge å¼•æ“

### 03.6.2 å®‰è£…é…ç½®

```bash
# å®‰è£… runwasi shim
containerd config default | sudo tee /etc/containerd/config.toml

# é…ç½® wasi runtime
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.wasm]
  runtime_type = "io.containerd.wasmedge.v1"
```

### 03.6.3 RuntimeClass é…ç½®

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: wasm
handler: wasm
```

### 03.6.4 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹            | ç¼ºç‚¹                    |
| --------------- | ----------------------- |
| âœ… åŸç”Ÿé›†æˆ     | âš ï¸ éœ€è¦ containerd é…ç½® |
| âœ… ä¸ runc å¹¶å­˜ | âš ï¸ ç›¸å¯¹è¾ƒæ–°             |
| âœ… é›¶ rootfs    | âš ï¸ éœ€è¦èŠ‚ç‚¹å®‰è£… runwasi |
| âœ… ç»Ÿä¸€ç®¡ç†     |                         |

### 03.6.5 æŠ€æœ¯åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæœ€æ–° K8s é›†ç¾¤**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ”¯æŒæœ€æ–° K8s ç‰ˆæœ¬
- âœ… éœ€è¦åŸç”Ÿé›†æˆ
- âœ… éœ€è¦ç»Ÿä¸€ç®¡ç†

**å†³ç­–æ€è·¯**ï¼š

```yaml
æœ€æ–° K8s é›†ç¾¤:
  è·¯çº¿: è·¯çº¿ 3ï¼ˆcontainerd-shim-runwasiï¼‰
  åŸå› : åŸç”Ÿé›†æˆã€ç»Ÿä¸€ç®¡ç†
  æƒè¡¡: éœ€è¦ containerd é…ç½®
```

**åœºæ™¯ 2ï¼šè¾¹ç¼˜åœºæ™¯**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… è¾¹ç¼˜åœºæ™¯èµ„æºå—é™
- âœ… éœ€è¦è½»é‡çº§éƒ¨ç½²
- âœ… éœ€è¦å¿«é€Ÿå¯åŠ¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
è¾¹ç¼˜åœºæ™¯:
  è·¯çº¿: è·¯çº¿ 3ï¼ˆcontainerd-shim-runwasiï¼‰
  åŸå› : è½»é‡ã€å¿«é€Ÿå¯åŠ¨ã€é›¶ rootfs
  ä¼˜åŠ¿: é€‚åˆè¾¹ç¼˜èŠ‚ç‚¹
```

## 03.7 CRI é›†æˆåŸç†

### 03.7.1 è¿è¡Œæ—¶è¯†åˆ«æµç¨‹

```mermaid
graph TD
    A[Pod åˆ›å»º] --> B{æ£€æŸ¥é•œåƒå¹³å°}
    B -->|linux/amd64| C[runc]
    B -->|wasm32/wasi| D[WasmEdge]

    C --> E[Linux å®¹å™¨]
    D --> F[Wasm æ²™ç®±]

    style B fill:#ffe6e6
    style D fill:#e6ffe6
```

**è¿è¡Œæ—¶è¯†åˆ«è®ºè¯**ï¼š

- **é•œåƒå¹³å°**ï¼šé€šè¿‡é•œåƒå¹³å°æ ‡è¯†ï¼ˆlinux/amd64 vs wasm32/wasiï¼‰é€‰æ‹©è¿è¡Œæ—¶
- **runc**ï¼šLinux å®¹å™¨è¿è¡Œæ—¶
- **WasmEdge**ï¼šWasm å­—èŠ‚ç è¿è¡Œæ—¶

### 03.7.2 CRI æ’ä»¶æ¶æ„

```mermaid
graph TB
    A[containerd] --> B[CRI æ’ä»¶]
    B --> C{è¿è¡Œæ—¶é€‰æ‹©}
    C -->|linux/amd64| D[runc]
    C -->|wasm32/wasi| E[crun/runwasi]
    E --> F[WasmEdge]

    style C fill:#fff4e1
    style F fill:#e6ffe6
```

**CRI æ’ä»¶è®ºè¯**ï¼š

- **containerd**ï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£
- **CRI æ’ä»¶**ï¼šKubernetes å®¹å™¨è¿è¡Œæ—¶æ¥å£
- **è¿è¡Œæ—¶é€‰æ‹©**ï¼šæ ¹æ®é•œåƒå¹³å°é€‰æ‹©è¿è¡Œæ—¶ï¼ˆrunc/crun/runwasiï¼‰

### 03.7.3 é›†æˆè®ºè¯

**ä¸ºä»€ä¹ˆéœ€è¦ CRI é›†æˆï¼Ÿ**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ ‡å‡†åŒ–ï¼šé€šè¿‡ CRI æ ‡å‡†åŒ–å®¹å™¨è¿è¡Œæ—¶æ¥å£
- âœ… å¯æ›¿æ¢ï¼šå¯ä»¥æ›¿æ¢ä¸åŒçš„è¿è¡Œæ—¶ï¼ˆrunc/crun/runwasiï¼‰
- âœ… ç»Ÿä¸€ç®¡ç†ï¼šé€šè¿‡ Kubernetes ç»Ÿä¸€ç®¡ç†å®¹å™¨å’Œ Wasm æ¨¡å—

**å†³ç­–æ€è·¯**ï¼š

```yaml
CRI é›†æˆè®¾è®¡:
  æ¥å£: CRIï¼ˆContainer Runtime Interfaceï¼‰
  è¿è¡Œæ—¶:
    - runc: Linux å®¹å™¨
    - crun: Wasm å®¹å™¨ï¼ˆé€šè¿‡ OCI æ³¨é‡Šï¼‰
    - runwasi: Wasm å®¹å™¨ï¼ˆé€šè¿‡ shimï¼‰
  ä¼˜åŠ¿: æ ‡å‡†åŒ–ã€å¯æ›¿æ¢ã€ç»Ÿä¸€ç®¡ç†
```

## 03.8 æ€§èƒ½ä¼˜åŠ¿

### 03.8.1 å¯¹æ¯”æ•°æ®

| æŒ‡æ ‡                | ä¼ ç»Ÿå®¹å™¨ï¼ˆalpineï¼‰ | WasmEdge + crun | æå‡å€æ•°      |
| ------------------- | ------------------ | --------------- | ------------- |
| **é•œåƒä½“ç§¯**        | 13 MB              | 0.9 MB          | **14Ã— æ›´å°**  |
| **å¯åŠ¨æ—¶é—´**        | 1.2s               | 6ms             | **200Ã— æ›´å¿«** |
| **å†…å­˜åŸºçº¿**        | 18 MB              | 2.1 MB          | **8.5Ã— æ›´å°** |
| **å•èŠ‚ç‚¹å¯†åº¦**      | 300 Pod            | 3000 Pod        | **10Ã— æ›´é«˜**  |
| **å†·å¯åŠ¨ CPU å°–å³°** | 80%                | 3%              | **26Ã— æ›´ä½**  |

> **æ³¨**ï¼šå…·ä½“æŒ‡æ ‡éœ€é™„æ¥æº/æ—¶é—´/ç‰ˆæœ¬ï¼Œè§ [REFERENCES.md](../REFERENCES.md)

### 03.8.2 æ€§èƒ½ä¼˜åŠ¿åŸç†

```mermaid
graph TD
    A[ä¼ ç»Ÿå®¹å™¨] --> B[åŠ è½½ rootfs]
    B --> C[å¯åŠ¨è¿›ç¨‹]
    C --> D[åˆå§‹åŒ–ç¯å¢ƒ]
    D --> E[è¿è¡Œåº”ç”¨]

    F[Wasm å®¹å™¨] --> G[åŠ è½½ .wasm]
    G --> H[ç›´æ¥æ‰§è¡Œ]

    style A fill:#ffe6e6
    style F fill:#e6ffe6

    I[ä¼˜åŠ¿] --> J[æ— éœ€ rootfs]
    I --> K[æ²™ç®±éš”ç¦»]
    I --> L[è·¨å¹³å°]
    I --> M[æé€Ÿå¯åŠ¨]
```

### 03.8.3 æ€§èƒ½è®ºè¯

**ä¸ºä»€ä¹ˆ WasmEdge æ€§èƒ½æ›´å¥½ï¼Ÿ**:

**æŠ€æœ¯è®ºè¯**ï¼š

1. **æ— éœ€ rootfs**ï¼šä¸éœ€è¦åŠ è½½å®Œæ•´æ–‡ä»¶ç³»ç»Ÿï¼Œå‡å°‘å¯åŠ¨æ—¶é—´
2. **å­—èŠ‚ç æ‰§è¡Œ**ï¼šç›´æ¥æ‰§è¡Œå­—èŠ‚ç ï¼Œæ— éœ€è¿›ç¨‹å¯åŠ¨
3. **æ²™ç®±éš”ç¦»**ï¼šè½»é‡çº§æ²™ç®±ï¼Œèµ„æºå ç”¨ä½
4. **è·¨å¹³å°**ï¼šå­—èŠ‚ç è·¨å¹³å°ï¼Œæ— éœ€å¹³å°ç‰¹å®šç¼–è¯‘

**æ€§èƒ½æ¨¡å‹è®ºè¯**ï¼š

- **é•œåƒä½“ç§¯**ï¼šWasm é•œåƒ < 1MBï¼Œå®¹å™¨é•œåƒ > 10MBï¼Œå‡å° 90%
- **å¯åŠ¨æ—¶é—´**ï¼šWasm å¯åŠ¨ < 10msï¼Œå®¹å™¨å¯åŠ¨ > 1sï¼Œå¿« 100 å€
- **å†…å­˜å ç”¨**ï¼šWasm å†…å­˜ ~2MBï¼Œå®¹å™¨å†…å­˜ > 18MBï¼Œå‡å° 90%
- **Pod å¯†åº¦**ï¼šWasm å•èŠ‚ç‚¹ 3000 Podï¼Œå®¹å™¨å•èŠ‚ç‚¹ 300 Podï¼Œå¯†åº¦ 10 å€

### 03.8.4 æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–

**æ€§èƒ½æŒ‡æ ‡å‡½æ•°**ï¼š $$P(W) = \{V(W), S(W), M(W), D(W)\}$$

å…¶ä¸­ï¼š

- $V(W)$ = é•œåƒä½“ç§¯ï¼ˆVolumeï¼‰
- $S(W)$ = å¯åŠ¨æ—¶é—´ï¼ˆStartupï¼‰
- $M(W)$ = å†…å­˜å ç”¨ï¼ˆMemoryï¼‰
- $D(W)$ = éƒ¨ç½²å¯†åº¦ï¼ˆDensityï¼‰

**æ€§èƒ½å¯¹æ¯”**ï¼š $$\text{improvement} = \frac{P(C) - P(W)}{P(C)}$$

å…¶ä¸­ $P(C)$ æ˜¯ä¼ ç»Ÿå®¹å™¨æ€§èƒ½ï¼Œ$P(W)$ æ˜¯ Wasm æ€§èƒ½ã€‚

**ä¼˜åŒ–ç›®æ ‡**ï¼š
$$\max_{W} \text{improvement} = \max_{W} \frac{P(C) - P(W)}{P(C)}$$

## 03.9 å®æˆ˜ç¤ºä¾‹

### 03.9.1 å‡†å¤‡ Wasm å­—èŠ‚ç ï¼ˆRustï¼‰

```bash
# å®‰è£… Rust WASI target
rustup target add wasm32-wasi

# åˆ›å»ºé¡¹ç›®
cargo new hello-wasm && cd hello-wasm

# ç¼–å†™ä»£ç 
cat >src/main.rs <<'EOF'
fn main() {
    println!("hello from WasmEdge inside K8s!");
}
EOF

# ç¼–è¯‘
cargo build --release --target wasm32-wasi
# å¾—åˆ° target/wasm32-wasi/release/hello-wasm.wasm
```

**Rust Wasm æ„å»ºè®ºè¯**ï¼š

- **wasm32-wasi target**ï¼šRust æ”¯æŒ WASI targetï¼Œå¯ä»¥ç›´æ¥ç¼–è¯‘åˆ° Wasm
- **ç¼–è¯‘æµç¨‹**ï¼šRust ä»£ç  â†’ Wasm å­—èŠ‚ç ï¼Œæ— éœ€è¿è¡Œæ—¶

### 03.9.2 æ‰“åŒ… OCI é•œåƒ

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ wasm-to-oci
wasm-to-oci push hello-wasm.wasm docker.io/yourhub/hello-wasm:v1

# æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ„å»º
cat > Dockerfile <<EOF
FROM scratch
COPY hello-wasm.wasm /hello-wasm.wasm
EOF
docker build -t yourhub/hello-wasm:v1 .
docker push yourhub/hello-wasm:v1
```

**é•œåƒæ„å»ºè®ºè¯**ï¼š

- **wasm-to-oci**ï¼šä¸“é—¨ç”¨äºæ¨é€ wasm æ¨¡å—åˆ° OCI ä»“åº“
- **FROM scratch**ï¼šæœ€å°åŒ–é•œåƒï¼Œæ— éœ€ rootfs
- **ä½“ç§¯ä¼˜åŒ–**ï¼šæœ€ç»ˆé•œåƒä½“ç§¯ < 1MB

### 03.9.3 éƒ¨ç½²åˆ° K3s

```bash
# 1. åœ¨ K3s èŠ‚ç‚¹å®‰è£… WasmEdge å’Œ crun
sudo apt install -y wasmedge crun

# 2. åˆ›å»º RuntimeClass
kubectl apply -f - <<EOF
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun-wasm
handler: crun
EOF

# 3. éƒ¨ç½² Pod
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: hello-wasm
  annotations:
    module.wasm.image/variant: compat-smart
spec:
  runtimeClassName: crun-wasm
  containers:
    - name: app
      image: docker.io/yourhub/hello-wasm:v1
      command: ["hello-wasm.wasm"]
EOF

# 4. æŸ¥çœ‹æ—¥å¿—
kubectl logs hello-wasm
# è¾“å‡ºï¼šhello from WasmEdge inside K8s!
```

## 03.10 å¸¸è§é—®é¢˜

### 03.10.1 æ•…éšœæ’æŸ¥

| ç°è±¡                    | æ ¹å›                                           | ä¿®å¤                                         |
| ----------------------- | --------------------------------------------- | -------------------------------------------- |
| **kubectl logs ä¸ºç©º**   | crun æœªæŠŠ wasm stdout é‡å®šå‘åˆ° cgroup çš„ pipe | å‡çº§ crun â‰¥ 1.8.5                            |
| **é•œåƒæ‹‰å–å¤±è´¥**        | docker hub å°† `.wasm` è§†ä¸º blobï¼Œéœ€è¦ token   | ä½¿ç”¨ `wasm-to-oci` æ¨é€è‡³ ghcr/é˜¿é‡Œäº‘ ACR    |
| **æ— æ³•è§£æ DNS**        | WASI é¢„è§ˆç‰ˆç½‘ç»œæœªå®Œå…¨æ”¯æŒ                     | å¯ç”¨ WasmEdge çš„ `wasmedge_wasi_socket` æ’ä»¶ |
| **HPA åŸºäº CPU ä¸è§¦å‘** | Wasm è¿è¡Œæ—¶é—´ç‰‡æå°ï¼ŒCPU é‡‡æ ·å¤±çœŸ             | æ”¹ç”¨ QPS æˆ–è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆKEDAï¼‰                |

### 03.10.2 æ•…éšœåœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæ—¥å¿—ä¸ºç©º**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… crun ç‰ˆæœ¬è¿‡ä½
- âœ… stdout é‡å®šå‘é—®é¢˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ—¥å¿—ä¸ºç©ºä¿®å¤:
  é—®é¢˜: crun æœªæŠŠ wasm stdout é‡å®šå‘åˆ° cgroup çš„ pipe
  ä¿®å¤: å‡çº§ crun â‰¥ 1.8.5
  éªŒè¯: kubectl logs åº”è¯¥æ­£å¸¸è¾“å‡º
```

**åœºæ™¯ 2ï¼šé•œåƒæ‹‰å–å¤±è´¥**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… docker hub ä¸æ”¯æŒ wasm æ¨¡å—
- âœ… éœ€è¦ç‰¹æ®Šå·¥å…·æ¨é€

**å†³ç­–æ€è·¯**ï¼š

```yaml
é•œåƒæ‹‰å–å¤±è´¥ä¿®å¤:
  é—®é¢˜: docker hub å°† .wasm è§†ä¸º blobï¼Œéœ€è¦ token
  ä¿®å¤: ä½¿ç”¨ wasm-to-oci æ¨é€è‡³ ghcr/é˜¿é‡Œäº‘ ACR
  æ›¿ä»£: ä½¿ç”¨æ”¯æŒ wasm çš„é•œåƒä»“åº“
```

**åœºæ™¯ 3ï¼šDNS è§£æå¤±è´¥**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… WASI é¢„è§ˆç‰ˆç½‘ç»œæœªå®Œå…¨æ”¯æŒ
- âœ… éœ€è¦å¯ç”¨ç½‘ç»œæ’ä»¶

**å†³ç­–æ€è·¯**ï¼š

```yaml
DNS è§£æå¤±è´¥ä¿®å¤:
  é—®é¢˜: WASI é¢„è§ˆç‰ˆç½‘ç»œæœªå®Œå…¨æ”¯æŒ
  ä¿®å¤: å¯ç”¨ WasmEdge çš„ wasmedge_wasi_socket æ’ä»¶
  é…ç½®: åœ¨ Pod ä¸­è®¾ç½® WASMEDGE_WASI_SOCKET=true
```

## 03.11 æœ€ä½³å®è·µ

### 03.11.1 é•œåƒæ„å»º

```dockerfile
# âœ… æ¨èï¼šæœ€å°åŒ–é•œåƒ
FROM scratch
COPY app.wasm /app.wasm

# âŒ é¿å…ï¼šåŒ…å« WasmEdge äºŒè¿›åˆ¶ï¼ˆé™¤éè·¯çº¿ 1ï¼‰
FROM ubuntu
RUN apt-get install -y wasmedge  # ä¸å¿…è¦
```

### 03.11.2 ç½‘ç»œé…ç½®

```yaml
# å¯ç”¨ WASI socket æ”¯æŒ
apiVersion: v1
kind: Pod
metadata:
  name: wasm-app
spec:
  runtimeClassName: crun-wasm
  containers:
    - name: app
      image: yourhub/app-wasm:v1
      env:
        - name: WASMEDGE_WASI_SOCKET
          value: "true"
```

### 03.11.3 èµ„æºé™åˆ¶

```yaml
spec:
  containers:
    - name: wasm-app
      resources:
        requests:
          memory: "10Mi" # Wasm åº”ç”¨å†…å­˜å ç”¨å°
          cpu: "50m"
        limits:
          memory: "50Mi"
          cpu: "200m"
```

## 03.12 æŠ€æœ¯åœºæ™¯åˆ†æ

### 03.12.1 å¼€å‘ç¯å¢ƒåœºæ™¯

**åœºæ™¯æè¿°**ï¼šæœ¬åœ°å¼€å‘éœ€è¦å¿«é€Ÿè¿­ä»£å’Œè°ƒè¯•

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **å¿«é€Ÿè¿­ä»£**ï¼šéœ€è¦å¿«é€Ÿæ„å»ºå’Œå¯åŠ¨
2. **è°ƒè¯•èƒ½åŠ›**ï¼šéœ€è¦è°ƒè¯•å·¥å…·å’Œæ—¥å¿—
3. **å¼€å‘æ•ˆç‡**ï¼šéœ€è¦çƒ­é‡è½½å’Œå®æ—¶åŒæ­¥

**æ¶æ„å†³ç­–**ï¼š

```yaml
å¼€å‘ç¯å¢ƒé…ç½®:
  è·¯çº¿: è·¯çº¿ 1ï¼ˆDocker + WasmEdgeï¼‰
  åŸºç¡€é•œåƒ: å®Œæ•´åŸºç¡€é•œåƒï¼ˆåŒ…å« WasmEdgeï¼‰
  æ„å»ºæ–¹å¼: å•é˜¶æ®µæ„å»º
  é•œåƒä½“ç§¯: å¯æ¥å—è¾ƒå¤§
  ä¼˜åŠ¿: ç®€å•ã€å¿«é€Ÿã€å…¼å®¹æ€§å¥½
  æƒè¡¡: é•œåƒä½“ç§¯å¤§ã€å¯åŠ¨æ…¢
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¼€å‘æ•ˆç‡ä¼˜å…ˆï¼šå¿«é€Ÿè¿­ä»£æ¯”ä½“ç§¯ä¼˜åŒ–æ›´é‡è¦
- âœ… ç®€å•å®ç°ï¼šè·¯çº¿ 1 å®ç°ç®€å•ï¼Œæ— éœ€å¤æ‚é…ç½®
- âœ… å…¼å®¹æ€§å¥½ï¼šæ ‡å‡† Docker å®¹å™¨ï¼Œå…¼å®¹æ€§å¥½

### 03.12.2 ç”Ÿäº§ç¯å¢ƒåœºæ™¯

**åœºæ™¯æè¿°**ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦å®‰å…¨ã€ç¨³å®šã€é«˜æ€§èƒ½

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **æ€§èƒ½è¦æ±‚**ï¼šéœ€è¦æœ€å°é•œåƒä½“ç§¯å’Œæœ€å¿«å¯åŠ¨é€Ÿåº¦
2. **ç¨³å®šæ€§**ï¼šéœ€è¦ç¨³å®šå¯é çš„è¿è¡Œæ—¶
3. **å¯æ‰©å±•æ€§**ï¼šéœ€è¦é«˜å¯†åº¦éƒ¨ç½²

**æ¶æ„å†³ç­–**ï¼š

```yaml
ç”Ÿäº§ç¯å¢ƒé…ç½®:
  è·¯çº¿: è·¯çº¿ 2ï¼ˆcrun è‡ªåŠ¨è¯†åˆ«ï¼‰
  åŸºç¡€é•œåƒ: scratchï¼ˆé›¶ rootfsï¼‰
  æ„å»ºæ–¹å¼: å¤šé˜¶æ®µæ„å»ºï¼ˆå¦‚éœ€è¦ï¼‰
  é•œåƒä½“ç§¯: æœ€å°åŒ–ï¼ˆ< 1MBï¼‰
  ä¼˜åŠ¿: é›¶ rootfsã€ä½“ç§¯å°ã€å¯åŠ¨å¿«
  æƒè¡¡: éœ€è¦ crun â‰¥ 1.8.5
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½ä¼˜å…ˆï¼šé›¶ rootfsã€ä½“ç§¯å°ã€å¯åŠ¨å¿«
- âœ… ç¨³å®šæ€§ï¼šcrun è·¯çº¿æˆç†Ÿï¼Œç”Ÿäº§éªŒè¯
- âœ… å¯æ‰©å±•æ€§ï¼šå•èŠ‚ç‚¹å¯éƒ¨ç½² 3000 Pod

### 03.12.3 CI/CD åœºæ™¯

**åœºæ™¯æè¿°**ï¼šCI/CD éœ€è¦å¿«é€Ÿæ„å»ºå’Œå¯é‡å¤æ€§

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **æ„å»ºé€Ÿåº¦**ï¼šéœ€è¦å¿«é€Ÿæ„å»º Wasm æ¨¡å—
2. **å¯é‡å¤æ€§**ï¼šéœ€è¦å›ºå®šç‰ˆæœ¬å’Œç¼“å­˜ç­–ç•¥
3. **æµ‹è¯•æ•ˆç‡**ï¼šéœ€è¦å¿«é€Ÿæµ‹è¯• Wasm æ¨¡å—

**æ¶æ„å†³ç­–**ï¼š

```yaml
CI/CD é…ç½®:
  è·¯çº¿: è·¯çº¿ 1ï¼ˆå¿«é€ŸéªŒè¯ï¼‰æˆ– è·¯çº¿ 2ï¼ˆç”Ÿäº§æµ‹è¯•ï¼‰
  æ„å»ºå·¥å…·: Rust/Cargoï¼ˆç¼–è¯‘åˆ° wasm32-wasiï¼‰
  ç¼“å­˜ç­–ç•¥: Wasm æ¨¡å—ç¼“å­˜
  æµ‹è¯•ç­–ç•¥: å¿«é€Ÿå¯åŠ¨æµ‹è¯•
  ä¼˜åŠ¿: æ„å»ºå¿«ã€æµ‹è¯•å¿«
  æƒè¡¡: è·¯çº¿é€‰æ‹©å–å†³äºæµ‹è¯•çº§åˆ«
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ„å»ºé€Ÿåº¦ï¼šWasm ç¼–è¯‘é€Ÿåº¦å¿«
- âœ… å¯é‡å¤æ€§ï¼šå›ºå®šç‰ˆæœ¬ï¼Œå¯é‡å¤æ„å»º
- âœ… æµ‹è¯•æ•ˆç‡ï¼šå¿«é€Ÿå¯åŠ¨ï¼Œå¿«é€Ÿæµ‹è¯•

### 03.12.4 è¾¹ç¼˜åœºæ™¯

**åœºæ™¯æè¿°**ï¼šè¾¹ç¼˜èŠ‚ç‚¹èµ„æºå—é™ï¼Œç½‘ç»œä¸ç¨³å®š

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **èµ„æºå—é™**ï¼šå†…å­˜å’Œ CPU æœ‰é™
2. **ç½‘ç»œä¸ç¨³å®š**ï¼šç»å¸¸æ‰çº¿
3. **å­˜å‚¨å—é™**ï¼šå­˜å‚¨ç©ºé—´æœ‰é™

**æ¶æ„å†³ç­–**ï¼š

```yaml
è¾¹ç¼˜åœºæ™¯é…ç½®:
  è·¯çº¿: è·¯çº¿ 2ï¼ˆcrunï¼‰æˆ– è·¯çº¿ 3ï¼ˆrunwasiï¼‰
  åŸºç¡€é•œåƒ: scratchï¼ˆé›¶ rootfsï¼‰
  èµ„æºé™åˆ¶: æœ€å°åŒ–ï¼ˆmemory: 10Miï¼‰
  ç½‘ç»œé…ç½®: WASI socket æ”¯æŒ
  ä¼˜åŠ¿: è½»é‡ã€å¿«é€Ÿå¯åŠ¨ã€èµ„æºå ç”¨ä½
  æƒè¡¡: éœ€è¦èŠ‚ç‚¹å®‰è£… WasmEdge
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… èµ„æºå—é™ï¼šWasm å†…å­˜å ç”¨ ~2MBï¼Œé€‚åˆè¾¹ç¼˜èŠ‚ç‚¹
- âœ… ç½‘ç»œä¸ç¨³å®šï¼šæœ¬åœ°æ‰§è¡Œï¼Œä¸ä¾èµ–ç½‘ç»œ
- âœ… å­˜å‚¨å—é™ï¼šé•œåƒä½“ç§¯ < 1MBï¼Œå­˜å‚¨å ç”¨å°

### 03.12.5 Serverless åœºæ™¯

**åœºæ™¯æè¿°**ï¼šServerless éœ€è¦æé€Ÿå†·å¯åŠ¨å’Œé«˜å¯†åº¦éƒ¨ç½²

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **å†·å¯åŠ¨é€Ÿåº¦**ï¼šéœ€è¦æ¯«ç§’çº§å†·å¯åŠ¨
2. **é«˜å¯†åº¦éƒ¨ç½²**ï¼šéœ€è¦é«˜å¯†åº¦éƒ¨ç½²
3. **èµ„æºæ•ˆç‡**ï¼šéœ€è¦èµ„æºé«˜æ•ˆåˆ©ç”¨

**æ¶æ„å†³ç­–**ï¼š

```yaml
Serverless åœºæ™¯é…ç½®:
  è·¯çº¿: è·¯çº¿ 2ï¼ˆcrunï¼‰æˆ– è·¯çº¿ 3ï¼ˆrunwasiï¼‰
  åŸºç¡€é•œåƒ: scratchï¼ˆé›¶ rootfsï¼‰
  å¯åŠ¨æ—¶é—´: < 10ms
  Pod å¯†åº¦: 3000 Pod/èŠ‚ç‚¹
  èµ„æºé™åˆ¶: æœ€å°åŒ–ï¼ˆmemory: 10Mi, cpu: 50mï¼‰
  ä¼˜åŠ¿: æé€Ÿå†·å¯åŠ¨ã€é«˜å¯†åº¦éƒ¨ç½²
  æƒè¡¡: éœ€è¦èŠ‚ç‚¹å®‰è£… WasmEdge
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å†·å¯åŠ¨é€Ÿåº¦ï¼šWasm å¯åŠ¨ < 10msï¼Œæ¯”å®¹å™¨å¿« 100 å€
- âœ… é«˜å¯†åº¦éƒ¨ç½²ï¼šå•èŠ‚ç‚¹å¯éƒ¨ç½² 3000 Podï¼Œå¯†åº¦ 10 å€
- âœ… èµ„æºæ•ˆç‡ï¼šå†…å­˜å ç”¨ ~2MBï¼Œèµ„æºé«˜æ•ˆåˆ©ç”¨

## 03.13 å†³ç­–ä¾æ®ä¸æ€è·¯

### 03.13.1 è·¯çº¿é€‰æ‹©å†³ç­–æ ‘

```yaml
è·¯çº¿é€‰æ‹©å†³ç­–:
  if å¼€å‘ç¯å¢ƒ or CI/CD å¿«é€ŸéªŒè¯: é€‰æ‹© è·¯çº¿ 1ï¼ˆDocker + WasmEdgeï¼‰
  elif ç”Ÿäº§ç¯å¢ƒ or å¤§è§„æ¨¡éƒ¨ç½²: é€‰æ‹© è·¯çº¿ 2ï¼ˆcrun è‡ªåŠ¨è¯†åˆ«ï¼‰
  elif æœ€æ–° K8s or è¾¹ç¼˜åœºæ™¯: é€‰æ‹© è·¯çº¿ 3ï¼ˆcontainerd-shim-runwasiï¼‰
  else: é€‰æ‹© è·¯çº¿ 2ï¼ˆé»˜è®¤ï¼Œæœ€æˆç†Ÿï¼‰
```

### 03.13.2 æŠ€æœ¯åœºæ™¯é€‰æ‹©å†³ç­–æ ‘

```yaml
æŠ€æœ¯åœºæ™¯é€‰æ‹©:
  if å¼€å‘ç¯å¢ƒ: é€‰æ‹© è·¯çº¿ 1ï¼ˆç®€å•ã€å¿«é€ŸéªŒè¯ï¼‰
  elif ç”Ÿäº§ç¯å¢ƒ: é€‰æ‹© è·¯çº¿ 2ï¼ˆæˆç†Ÿã€æ¨èï¼‰
  elif CI/CD: é€‰æ‹© è·¯çº¿ 1 or è·¯çº¿ 2ï¼ˆå–å†³äºæµ‹è¯•çº§åˆ«ï¼‰
  elif è¾¹ç¼˜åœºæ™¯: é€‰æ‹© è·¯çº¿ 2 or è·¯çº¿ 3ï¼ˆå–å†³äºèŠ‚ç‚¹é…ç½®ï¼‰
  elif Serverless: é€‰æ‹© è·¯çº¿ 2 or è·¯çº¿ 3ï¼ˆå–å†³äºé›†ç¾¤é…ç½®ï¼‰
  else: é€‰æ‹© è·¯çº¿ 2ï¼ˆé»˜è®¤ï¼Œæœ€æˆç†Ÿï¼‰
```

### 03.13.3 æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘

```yaml
æ€§èƒ½ä¼˜åŒ–å†³ç­–:
  if é•œåƒä½“ç§¯ä¼˜å…ˆ: ä½¿ç”¨ scratch åŸºç¡€é•œåƒ
  elif å¯åŠ¨é€Ÿåº¦ä¼˜å…ˆ: ä½¿ç”¨ crun è·¯çº¿ï¼ˆé›¶ rootfsï¼‰
  elif èµ„æºå ç”¨ä¼˜å…ˆ:
    ä½¿ç”¨æœ€å°èµ„æºé™åˆ¶ï¼ˆmemory: 10Miï¼‰
  else: ä½¿ç”¨é»˜è®¤é…ç½®
```

## 03.14 å½¢å¼åŒ–æ€»ç»“

### 03.14.1 è·¯çº¿æ¨¡å‹å½¢å¼åŒ–

è®¾è·¯çº¿ä¸º $R = \{R_1, R_2, R_3\}$ï¼Œå…¶ä¸­ï¼š

- $R_1$ = è·¯çº¿ 1ï¼ˆDocker + WasmEdgeï¼‰
- $R_2$ = è·¯çº¿ 2ï¼ˆcrun è‡ªåŠ¨è¯†åˆ«ï¼‰
- $R_3$ = è·¯çº¿ 3ï¼ˆcontainerd-shim-runwasiï¼‰

**è·¯çº¿é€‰æ‹©å‡½æ•°**ï¼š

$$
R^*(S) = \begin{cases}
R_1 & \text{if } S = \text{development} \lor S = \text{ci/cd} \\
R_2 & \text{if } S = \text{production} \lor S = \text{large-scale} \\
R_3 & \text{if } S = \text{latest-k8s} \lor S = \text{edge}
\end{cases}
$$

å…¶ä¸­ $S$ æ˜¯åœºæ™¯ï¼ˆscenarioï¼‰ã€‚

### 03.14.2 æ€§èƒ½æ¨¡å‹å½¢å¼åŒ–

**æ€§èƒ½æŒ‡æ ‡å‡½æ•°**ï¼š
$$P(W) = \{\alpha \cdot V(W), \beta \cdot S(W), \gamma \cdot M(W), \delta \cdot D(W)\}$$

å…¶ä¸­ï¼š

- $V(W)$ = é•œåƒä½“ç§¯
- $S(W)$ = å¯åŠ¨æ—¶é—´
- $M(W)$ = å†…å­˜å ç”¨
- $D(W)$ = éƒ¨ç½²å¯†åº¦
- $\alpha, \beta, \gamma, \delta$ = æƒé‡ç³»æ•°

**ä¼˜åŒ–ç›®æ ‡**ï¼š
$$\max_{W} P(W) = \max_{W} \{\alpha \cdot V(W) \downarrow, \beta \cdot S(W) \downarrow, \gamma \cdot M(W) \downarrow, \delta \cdot D(W) \uparrow\}$$

### 03.14.3 è·¯çº¿æ€§èƒ½å¯¹æ¯”æ¨¡å‹

**è·¯çº¿æ€§èƒ½æ¨¡å‹**ï¼š

$$
P(R) = \begin{cases}
\{13\text{MB}, 1.2\text{s}, 18\text{MB}, 300\} & \text{if } R = R_1 \\
\{0.9\text{MB}, 6\text{ms}, 2.1\text{MB}, 3000\} & \text{if } R = R_2 \\
\{0.9\text{MB}, 6\text{ms}, 2.1\text{MB}, 3000\} & \text{if } R = R_3
\end{cases}
$$

å…¶ä¸­æ€§èƒ½æŒ‡æ ‡ä¸º {ä½“ç§¯, å¯åŠ¨æ—¶é—´, å†…å­˜, å¯†åº¦}ã€‚

## 03.15 å®é™…éƒ¨ç½²æ¡ˆä¾‹

### 03.15.1 æ¡ˆä¾‹ 1ï¼šä½¿ç”¨ crun éƒ¨ç½² Wasm åº”ç”¨ï¼ˆç”Ÿäº§æ¨èï¼‰

**åœºæ™¯**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ crun è‡ªåŠ¨è¯†åˆ« Wasm é•œåƒ

**éƒ¨ç½²æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… crunï¼ˆæ”¯æŒ Wasmï¼‰
curl -fsSL https://github.com/containers/crun/releases/download/1.9/crun-1.9-linux-amd64 -o /usr/local/bin/crun
chmod +x /usr/local/bin/crun

# 2. é…ç½® containerd ä½¿ç”¨ crun
cat >> /etc/containerd/config.toml <<EOF
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.crun-wasm]
    runtime_type = "io.containerd.runc.v2"
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.crun-wasm.options]
      BinaryName = "crun"
EOF

# 3. é‡å¯ containerd
systemctl restart containerd

# 4. åˆ›å»º RuntimeClass
kubectl apply -f - <<EOF
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun-wasm
handler: crun-wasm
EOF

# 5. æ„å»ºå¸¦ OCI æ³¨é‡Šçš„ Wasm é•œåƒ
cat > Dockerfile <<EOF
FROM scratch
COPY app.wasm /app.wasm
EOF

docker build --annotation "module.wasm.image/variant=compat-smart" -t wasm-app:latest .

# 6. éƒ¨ç½² Wasm Pod
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: wasm-app
spec:
  runtimeClassName: crun-wasm
  containers:
    - name: app
      image: wasm-app:latest
      command: ["/app.wasm"]
EOF
```

### 03.15.2 æ¡ˆä¾‹ 2ï¼šä½¿ç”¨ runwasi éƒ¨ç½² Wasm åº”ç”¨ï¼ˆK8s 1.30+ï¼‰

**åœºæ™¯**ï¼šåœ¨ Kubernetes 1.30+ é›†ç¾¤ä¸­ä½¿ç”¨ runwasi éƒ¨ç½² Wasm åº”ç”¨

**éƒ¨ç½²æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… containerd-shim-runwasi
wget https://github.com/containerd/runwasi/releases/download/v0.4.0/containerd-shim-runwasi-v0.4.0-linux-amd64.tar.gz
tar -xzf containerd-shim-runwasi-v0.4.0-linux-amd64.tar.gz
sudo mv containerd-shim-runwasi-v0.4.0-linux-amd64 /usr/local/bin/containerd-shim-runwasi-v1
sudo chmod +x /usr/local/bin/containerd-shim-runwasi-v1

# 2. é…ç½® containerd
cat >> /etc/containerd/config.toml <<EOF
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runwasi-wasm]
    runtime_type = "io.containerd.runwasi.v1"
EOF

systemctl restart containerd

# 3. åˆ›å»º RuntimeClass
kubectl apply -f - <<EOF
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: runwasi-wasm
handler: runwasi-wasm
EOF

# 4. éƒ¨ç½² Wasm Podï¼ˆK8s 1.30+ åŸç”Ÿæ”¯æŒï¼‰
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: wasm-app
spec:
  runtimeClassName: runwasi-wasm
  containers:
    - name: app
      image: wasm-app:latest
EOF
```

### 03.15.3 æ¡ˆä¾‹ 3ï¼šRust åº”ç”¨ç¼–è¯‘ä¸º Wasm å¹¶éƒ¨ç½²

**åœºæ™¯**ï¼šå°† Rust åº”ç”¨ç¼–è¯‘ä¸º Wasm å¹¶éƒ¨ç½²åˆ° Kubernetes

**ç¼–è¯‘æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£… Rust å’Œ wasm32-wasi target
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
rustup target add wasm32-wasi

# 2. ç¼–è¯‘ Rust åº”ç”¨
cargo build --target wasm32-wasi --release

# 3. æ„å»º OCI é•œåƒ
cat > Dockerfile <<EOF
FROM scratch
COPY target/wasm32-wasi/release/myapp.wasm /myapp.wasm
EOF

docker build --annotation "module.wasm.image/variant=compat-smart" -t myregistry.com/myapp:latest .

# 4. æ¨é€é•œåƒ
docker push myregistry.com/myapp:latest

# 5. éƒ¨ç½²åˆ° Kubernetes
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      runtimeClassName: crun-wasm
      containers:
        - name: app
          image: myregistry.com/myapp:latest
          command: ["/myapp.wasm"]
EOF
```

## 03.16 WasmEdge æ•…éšœæ’æŸ¥

### 03.16.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šWasm Pod æ— æ³•å¯åŠ¨**:

```bash
# æ£€æŸ¥ RuntimeClass
kubectl get runtimeclass

# æ£€æŸ¥ Pod äº‹ä»¶
kubectl describe pod <pod-name>

# æ£€æŸ¥ WasmEdge å®‰è£…
wasmedge --version

# æ£€æŸ¥ containerd é…ç½®
cat /etc/containerd/config.toml | grep -A 10 runtimes

# æ£€æŸ¥ crun æˆ– runwasi
which crun
crun --version
# æˆ–
which containerd-shim-runwasi-v1
```

**é—®é¢˜ 2ï¼šé•œåƒæ— æ³•è¯†åˆ«ä¸º Wasm**:

```bash
# æ£€æŸ¥é•œåƒ OCI æ³¨é‡Š
docker inspect <image-name> | grep -i wasm

# æ£€æŸ¥é•œåƒæ ¼å¼
docker inspect <image-name> | jq '.[0].Config.Labels'

# ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ OCI æ³¨é‡Š
docker build --annotation "module.wasm.image/variant=compat-smart" -t <image-name> .
```

**é—®é¢˜ 3ï¼šWasm åº”ç”¨æ€§èƒ½é—®é¢˜**:

```bash
# æ£€æŸ¥èµ„æºä½¿ç”¨
kubectl top pod <pod-name>

# æ£€æŸ¥ WasmEdge ç‰ˆæœ¬ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰
wasmedge --version

# ä¼˜åŒ–å»ºè®®ï¼š
# - ä½¿ç”¨ WasmEdge 0.14.0+
# - ä¼˜åŒ– Wasm å­—èŠ‚ç å¤§å°
# - ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆå¦‚æœéœ€è¦ï¼‰
```

## 03.17 å‚è€ƒ

**å…³è”æ–‡æ¡£**ï¼š

- **[10. æŠ€æœ¯å†³ç­–æ¨¡å‹](../../COGNITIVE/10-decision-models/decision-models.md)** -
  æŠ€æœ¯é€‰å‹å†³ç­–æ¡†æ¶
- **[10. å¿«é€Ÿå‚è€ƒæŒ‡å—](../../COGNITIVE/10-decision-models/QUICK-REFERENCE.md)** -
  è®¾å¤‡è®¿é—®ï¼ˆUSB/PCI/GPUï¼‰å’Œå†…æ ¸ç‰¹æ€§å†³ç­–å¿«é€Ÿå‚è€ƒ
- **[10. ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š](../../COGNITIVE/10-decision-models/CONSISTENCY-REPORT.md)** -
  æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥ä¸ Wikipedia æ ‡å‡†å¯¹é½
- **[28. æ¶æ„æ¡†æ¶](../28-architecture-framework/architecture-framework.md)** -
  å¤šç»´åº¦æ¶æ„ä½“ç³»ä¸æŠ€æœ¯è§„èŒƒï¼ˆåº”ç”¨æ¶æ„ã€åœºæ™¯æ¶æ„ç­‰ï¼‰
- **[09. çŸ©é˜µè§†è§’](../../COGNITIVE/09-matrix-perspective/README.md)** - WasmEdge
  æŠ€æœ¯é“¾çŸ©é˜µåˆ†æï¼ˆServerless/AI åœºæ™¯ä¼˜åŒ–ï¼‰
- **[11. è¾¹ç¼˜ä¸ Serverless](../07-edge-serverless/edge-serverless.md)** - è¾¹ç¼˜è®¡
  ç®—å’Œ Serverless åœºæ™¯
- **[12. AI æ¨ç†](../08-ai-inference/ai-inference.md)** - AI æ¨ç†åº”ç”¨

**å¤–éƒ¨å‚è€ƒ**ï¼š

[wasmedge-performance]: [WasmEdge æ€§èƒ½åŸºå‡†](https://wasmedge.org/docs/)

> å®Œæ•´å‚è€ƒåˆ—è¡¨è§ [REFERENCES.md](../REFERENCES.md)

---

**æœ€åæ›´æ–°**ï¼š2025-11-06 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

<!-- cSpell:ignore wasmedge WasmEdge runc crun runwasi containerd WASI OCI Kubernetes K8s K3s RuntimeClass wasm wasm32 -->
