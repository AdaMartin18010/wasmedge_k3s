# ç­–ç•¥å¼•æ“é€‰å‹å†³ç­–

## ğŸ“‘ ç›®å½•

- [ç­–ç•¥å¼•æ“é€‰å‹å†³ç­–](#ç­–ç•¥å¼•æ“é€‰å‹å†³ç­–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [å†³ç­–æ ‘](#å†³ç­–æ ‘)
  - [å†³ç­–çŸ©é˜µ](#å†³ç­–çŸ©é˜µ)
  - [é€‰å‹æŒ‡å—](#é€‰å‹æŒ‡å—)
    - [Gatekeeper é€‚ç”¨åœºæ™¯](#gatekeeper-é€‚ç”¨åœºæ™¯)
    - [OPA-Wasm é€‚ç”¨åœºæ™¯](#opa-wasm-é€‚ç”¨åœºæ™¯)
    - [OPA åŸç”Ÿé€‚ç”¨åœºæ™¯](#opa-åŸç”Ÿé€‚ç”¨åœºæ™¯)
  - [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
  - [éƒ¨ç½²ç¤ºä¾‹](#éƒ¨ç½²ç¤ºä¾‹)
    - [Gatekeeper éƒ¨ç½²ç¤ºä¾‹](#gatekeeper-éƒ¨ç½²ç¤ºä¾‹)
    - [OPA-Wasm éƒ¨ç½²ç¤ºä¾‹](#opa-wasm-éƒ¨ç½²ç¤ºä¾‹)
    - [OPA åŸç”Ÿéƒ¨ç½²ç¤ºä¾‹](#opa-åŸç”Ÿéƒ¨ç½²ç¤ºä¾‹)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
    - [Gatekeeper æœ€ä½³å®è·µ](#gatekeeper-æœ€ä½³å®è·µ)
    - [OPA-Wasm æœ€ä½³å®è·µ](#opa-wasm-æœ€ä½³å®è·µ)
    - [OPA åŸç”Ÿæœ€ä½³å®è·µ](#opa-åŸç”Ÿæœ€ä½³å®è·µ)

---

**æœ€åæ›´æ–°**: 2025-11-06 **ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ

> ğŸ“‹ **ä¸»æ–‡æ¡£é“¾
> æ¥**ï¼š[30.14.3 ç­–ç•¥å¼•æ“é€‰å‹å†³ç­–](../concept-relations-matrix.md#30143-ç­–ç•¥å¼•æ“é€‰å‹å†³ç­–)

## å†³ç­–æ ‘

```mermaid
graph TD
    A[ç­–ç•¥å¼•æ“é€‰å‹] --> B{K8sç¯å¢ƒ?}
    B -->|æ˜¯| C{éœ€è¦å®æ—¶éªŒè¯?}
    B -->|å¦| D[OPAç‹¬ç«‹éƒ¨ç½²]

    C -->|æ˜¯| E[Gatekeeper<br/>Z=3 åº”ç”¨ç­–ç•¥]
    C -->|å¦| F[OPA<br/>Z=2 è¿è¡Œæ—¶ç­–ç•¥]

    E --> G[K8sç­–ç•¥æ²»ç†]
    F --> H[åº”ç”¨ç­–ç•¥å†³ç­–]
    D --> I[å¤–éƒ¨ç­–ç•¥æœåŠ¡]
```

## å†³ç­–çŸ©é˜µ

| åœºæ™¯             | K8s ç¯å¢ƒ | å®æ—¶éªŒè¯ | é«˜æ€§èƒ½ | Wasm æ”¯æŒ | æ¨èç­–ç•¥å¼•æ“ |
| ---------------- | -------- | -------- | ------ | --------- | ------------ |
| **K8s ç­–ç•¥æ²»ç†** | âœ…       | âœ…       | âš ï¸     | âœ…        | Gatekeeper   |
| **åº”ç”¨ç­–ç•¥**     | âš ï¸       | âŒ       | âœ…     | âœ…        | OPA-Wasm     |
| **è¿è¡Œæ—¶ç­–ç•¥**   | âŒ       | âŒ       | âœ…     | âŒ        | OPA          |
| **å¤–éƒ¨ç­–ç•¥**     | âŒ       | âŒ       | âš ï¸     | âŒ        | OPA ç‹¬ç«‹éƒ¨ç½² |

## é€‰å‹æŒ‡å—

### Gatekeeper é€‚ç”¨åœºæ™¯

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- âœ… **K8s ç¯å¢ƒ**ï¼šéœ€è¦ Kubernetes é›†æˆï¼ŒåŸç”Ÿæ”¯æŒ
- âœ… **å®æ—¶éªŒè¯**ï¼šéœ€è¦ Admission Controllerï¼Œå®æ—¶ç­–ç•¥éªŒè¯
- âœ… **ç­–ç•¥æ²»ç†**ï¼šéœ€è¦ç»Ÿä¸€ç­–ç•¥ç®¡ç†ï¼ŒCRD æ–¹å¼ç®¡ç†ç­–ç•¥
- âœ… **ç­–ç•¥å³ä»£ç **ï¼šä½¿ç”¨ Rego è¯­è¨€ç¼–å†™ç­–ç•¥

**å…¸å‹åº”ç”¨**ï¼š

- Kubernetes å‡†å…¥æ§åˆ¶
- èµ„æºè§„èŒƒéªŒè¯
- å®‰å…¨ç­–ç•¥æ‰§è¡Œ
- åˆè§„æ€§æ£€æŸ¥

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š

- åŸç”Ÿ K8s é›†æˆ
- å®æ—¶ç­–ç•¥éªŒè¯
- ç­–ç•¥å³ä»£ç 
- æ”¯æŒ Wasm ç¼–è¯‘

### OPA-Wasm é€‚ç”¨åœºæ™¯

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- âœ… **é«˜æ€§èƒ½**ï¼šéœ€è¦ <1ms ç­–ç•¥æ‰§è¡Œï¼Œæ¯”åŸç”Ÿ OPA å¿« 10-50 å€
- âœ… **Wasm æ”¯æŒ**ï¼šéœ€è¦ Wasm ç¼–è¯‘ç­–ç•¥ï¼Œè½»é‡çº§éƒ¨ç½²
- âœ… **è¾¹ç¼˜åœºæ™¯**ï¼šèµ„æºå—é™ç¯å¢ƒï¼Œä½èµ„æºå ç”¨
- âœ… **ä½å»¶è¿Ÿ**ï¼šæ¯«ç§’çº§ç­–ç•¥æ‰§è¡Œï¼Œé€‚åˆå®æ—¶åœºæ™¯

**å…¸å‹åº”ç”¨**ï¼š

- è¾¹ç¼˜è®¡ç®—ç­–ç•¥æ‰§è¡Œ
- å®æ—¶ç­–ç•¥éªŒè¯
- ä½å»¶è¿Ÿç­–ç•¥å†³ç­–
- èµ„æºå—é™ç¯å¢ƒ

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š

- æä½æ‰§è¡Œå»¶è¿Ÿï¼ˆ<1msï¼‰
- ä½èµ„æºå ç”¨ï¼ˆ<5MBï¼‰
- Wasm æ ¼å¼ï¼Œå¿«é€Ÿåˆ†å‘
- æ”¯æŒçƒ­æ›´æ–°

### OPA åŸç”Ÿé€‚ç”¨åœºæ™¯

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- âœ… **ç‹¬ç«‹éƒ¨ç½²**ï¼šé K8s ç¯å¢ƒï¼Œç‹¬ç«‹ç­–ç•¥æœåŠ¡
- âœ… **é€šç”¨ç­–ç•¥**ï¼šéœ€è¦é€šç”¨ç­–ç•¥å¼•æ“ï¼Œæ”¯æŒå¤šç§åœºæ™¯
- âœ… **çµæ´»éƒ¨ç½²**ï¼šæ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼
- âœ… **ä¸°å¯ŒåŠŸèƒ½**ï¼šå®Œæ•´çš„ç­–ç•¥è¯­è¨€å’Œå·¥å…·é“¾

**å…¸å‹åº”ç”¨**ï¼š

- å¾®æœåŠ¡ç­–ç•¥å†³ç­–
- API æˆæƒç­–ç•¥
- æ•°æ®è®¿é—®ç­–ç•¥
- é€šç”¨ç­–ç•¥æœåŠ¡

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š

- é€šç”¨ç­–ç•¥å¼•æ“
- çµæ´»éƒ¨ç½²æ–¹å¼
- ä¸°å¯ŒåŠŸèƒ½ç‰¹æ€§
- æˆç†Ÿç¨³å®š

## æ€§èƒ½å¯¹æ¯”

**è¯¦ç»†æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼š

| ç­–ç•¥å¼•æ“       | æ‰§è¡Œå»¶è¿Ÿ | Wasm æ”¯æŒ | K8s é›†æˆ | èµ„æºå ç”¨ | ç­–ç•¥æ ¼å¼ |
| -------------- | -------- | --------- | -------- | -------- | -------- |
| **Gatekeeper** | 10-50ms  | âœ…        | âœ…       | 50-100MB | Rego     |
| **OPA-Wasm**   | <1ms     | âœ…        | âš ï¸       | <5MB     | Regoâ†’Wasm|
| **OPA**        | 10-50ms  | âŒ        | âŒ       | 50-100MB | Rego     |
| **Kyverno**    | 5-20ms   | âŒ        | âœ…       | 30-50MB  | YAML     |

**åŠŸèƒ½å¯¹æ¯”**ï¼š

| åŠŸèƒ½ç‰¹æ€§         | Gatekeeper | OPA-Wasm | OPA   | Kyverno |
| ---------------- | ---------- | -------- | ----- | ------- |
| **K8s é›†æˆ**     | âœ…         | âš ï¸       | âŒ    | âœ…      |
| **å®æ—¶éªŒè¯**     | âœ…         | âš ï¸       | âŒ    | âœ…      |
| **é«˜æ€§èƒ½**       | âš ï¸         | âœ…       | âš ï¸    | âš ï¸      |
| **Wasm æ”¯æŒ**    | âœ…         | âœ…       | âŒ    | âŒ      |
| **ç­–ç•¥å³ä»£ç **   | âœ…         | âœ…       | âœ…    | âš ï¸      |
| **ç­–ç•¥çƒ­æ›´æ–°**   | âš ï¸         | âœ…       | âš ï¸    | âœ…      |

## éƒ¨ç½²ç¤ºä¾‹

### Gatekeeper éƒ¨ç½²ç¤ºä¾‹

```bash
# å®‰è£… Gatekeeper
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.15/deploy/gatekeeper.yaml

# åˆ›å»ºç­–ç•¥æ¨¡æ¿
kubectl apply -f - <<EOF
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels
        violation[{"msg": msg}] {
          required := input.parameters.labels
          provided := input.review.object.metadata.labels
          missing := required - provided
          count(missing) > 0
          msg := sprintf("Missing required labels: %v", [missing])
        }
EOF
```

### OPA-Wasm éƒ¨ç½²ç¤ºä¾‹

```bash
# ç¼–è¯‘ç­–ç•¥ä¸º Wasm
opa build -t wasm -e data.example.allow policy.rego

# éƒ¨ç½² OPA-Wasm
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: opa-wasm
spec:
  runtimeClassName: wasm
  containers:
    - name: opa
      image: openpolicyagent/opa:latest-envoy
      command: ["opa", "run", "--server", "--set", "plugins.envoy_ext_authz_grpc.enable_wasm=true"]
EOF
```

### OPA åŸç”Ÿéƒ¨ç½²ç¤ºä¾‹

```bash
# éƒ¨ç½² OPA æœåŠ¡
docker run -d --name opa -p 8181:8181 openpolicyagent/opa run --server

# åŠ è½½ç­–ç•¥
curl -X PUT http://localhost:8181/v1/policies/example -d @policy.rego

# æŸ¥è¯¢ç­–ç•¥
curl -X POST http://localhost:8181/v1/data/example/allow -d @input.json
```

## æœ€ä½³å®è·µ

### Gatekeeper æœ€ä½³å®è·µ

1. **ç­–ç•¥è®¾è®¡**ï¼šä½¿ç”¨ ConstraintTemplate å®šä¹‰ç­–ç•¥æ¨¡æ¿
2. **ç­–ç•¥æµ‹è¯•**ï¼šä½¿ç”¨ gator å·¥å…·æµ‹è¯•ç­–ç•¥
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ– Rego ç­–ç•¥æ€§èƒ½
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§ç­–ç•¥æ‰§è¡Œæƒ…å†µ

### OPA-Wasm æœ€ä½³å®è·µ

1. **ç­–ç•¥ç¼–è¯‘**ï¼šå°†ç­–ç•¥ç¼–è¯‘ä¸º Wasm æ ¼å¼
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–ç­–ç•¥é€»è¾‘ï¼Œå‡å°‘æ‰§è¡Œæ—¶é—´
3. **çƒ­æ›´æ–°**ï¼šæ”¯æŒç­–ç•¥çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯
4. **èµ„æºç®¡ç†**ï¼šåˆç†é…ç½®èµ„æºé™åˆ¶

### OPA åŸç”Ÿæœ€ä½³å®è·µ

1. **ç­–ç•¥ç»„ç»‡**ï¼šåˆç†ç»„ç»‡ç­–ç•¥æ–‡ä»¶
2. **ç­–ç•¥æµ‹è¯•**ï¼šä½¿ç”¨ OPA test å·¥å…·æµ‹è¯•ç­–ç•¥
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ– Rego ç­–ç•¥æ€§èƒ½
4. **å®‰å…¨åŠ å›º**ï¼šé…ç½®è®¤è¯å’Œæˆæƒ

---

**æœ€åæ›´æ–°**ï¼š2025-11-06 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
