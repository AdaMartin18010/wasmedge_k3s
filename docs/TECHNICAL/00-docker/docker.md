# 00. Dockerï¼šå®¹å™¨åŒ–å¼•æ“æŠ€æœ¯è§„èŒƒ

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [00.1 æ–‡æ¡£å®šä½](#001-æ–‡æ¡£å®šä½)
- [00.2 æ ¸å¿ƒç»„ä»¶](#002-æ ¸å¿ƒç»„ä»¶)
  - [00.2.1 æŠ€æœ¯æ ˆæ¶æ„](#0021-æŠ€æœ¯æ ˆæ¶æ„)
  - [00.2.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜](#0022-æ ¸å¿ƒç»„ä»¶è¯´æ˜)
  - [00.2.3 æ¶æ„è®¾è®¡è®ºè¯](#0023-æ¶æ„è®¾è®¡è®ºè¯)
- [00.3 OCI Image Spec](#003-oci-image-spec)
  - [00.3.1 é•œåƒç»“æ„](#0031-é•œåƒç»“æ„)
  - [00.3.2 é•œåƒå¯»å€](#0032-é•œåƒå¯»å€)
  - [00.3.3 é•œåƒå±‚å­˜å‚¨](#0033-é•œåƒå±‚å­˜å‚¨)
  - [00.3.4 é•œåƒæ¨¡å‹è®ºè¯](#0034-é•œåƒæ¨¡å‹è®ºè¯)
- [00.4 æ§åˆ¶è·¯å¾„è¯¦è§£](#004-æ§åˆ¶è·¯å¾„è¯¦è§£)
  - [00.4.1 å®¹å™¨å¯åŠ¨æµç¨‹](#0041-å®¹å™¨å¯åŠ¨æµç¨‹)
  - [00.4.2 Shim çš„å¿…è¦æ€§](#0042-shim-çš„å¿…è¦æ€§)
  - [00.4.3 æ§åˆ¶è·¯å¾„è®ºè¯](#0043-æ§åˆ¶è·¯å¾„è®ºè¯)
- [00.5 å­˜å‚¨é©±åŠ¨ï¼šoverlay2](#005-å­˜å‚¨é©±åŠ¨overlay2)
  - [00.5.1 OverlayFS åŸç†](#0051-overlayfs-åŸç†)
  - [00.5.2 å­˜å‚¨é©±åŠ¨å¯¹æ¯”](#0052-å­˜å‚¨é©±åŠ¨å¯¹æ¯”)
  - [00.5.3 å­˜å‚¨åœºæ™¯ä¸å†³ç­–](#0053-å­˜å‚¨åœºæ™¯ä¸å†³ç­–)
- [00.6 ç½‘ç»œæ¨¡å‹ï¼šCNM](#006-ç½‘ç»œæ¨¡å‹cnm)
  - [00.6.1 ç½‘ç»œæ¶æ„](#0061-ç½‘ç»œæ¶æ„)
  - [00.6.2 ç½‘ç»œé©±åŠ¨å¯¹æ¯”](#0062-ç½‘ç»œé©±åŠ¨å¯¹æ¯”)
  - [00.6.3 ç½‘ç»œåœºæ™¯ä¸å†³ç­–](#0063-ç½‘ç»œåœºæ™¯ä¸å†³ç­–)
- [00.7 é•œåƒæ„å»ºæœ€ä½³å®è·µ](#007-é•œåƒæ„å»ºæœ€ä½³å®è·µ)
  - [00.7.1 å¤šé˜¶æ®µæ„å»º](#0071-å¤šé˜¶æ®µæ„å»º)
  - [00.7.2 é•œåƒä¼˜åŒ–ç­–ç•¥](#0072-é•œåƒä¼˜åŒ–ç­–ç•¥)
  - [00.7.3 åˆ†å±‚è§„èŒƒ](#0073-åˆ†å±‚è§„èŒƒ)
  - [00.7.4 æ„å»ºåœºæ™¯ä¸å†³ç­–](#0074-æ„å»ºåœºæ™¯ä¸å†³ç­–)
- [00.8 æ•°æ®ç®¡ç†](#008-æ•°æ®ç®¡ç†)
  - [00.8.1 Volume vs Bind Mount](#0081-volume-vs-bind-mount)
  - [00.8.2 Volume ç®¡ç†](#0082-volume-ç®¡ç†)
  - [00.8.3 æ•°æ®åœºæ™¯ä¸å†³ç­–](#0083-æ•°æ®åœºæ™¯ä¸å†³ç­–)
- [00.9 å®‰å…¨æœ€ä½³å®è·µ](#009-å®‰å…¨æœ€ä½³å®è·µ)
  - [00.9.1 é•œåƒå®‰å…¨](#0091-é•œåƒå®‰å…¨)
  - [00.9.2 è¿è¡Œæ—¶å®‰å…¨](#0092-è¿è¡Œæ—¶å®‰å…¨)
  - [00.9.3 å®‰å…¨åœºæ™¯ä¸å†³ç­–](#0093-å®‰å…¨åœºæ™¯ä¸å†³ç­–)
- [00.10 æ€§èƒ½ä¼˜åŒ–](#0010-æ€§èƒ½ä¼˜åŒ–)
  - [00.10.1 æ„å»ºä¼˜åŒ–](#00101-æ„å»ºä¼˜åŒ–)
  - [00.10.2 è¿è¡Œæ—¶ä¼˜åŒ–](#00102-è¿è¡Œæ—¶ä¼˜åŒ–)
  - [00.10.3 æ€§èƒ½åœºæ™¯ä¸å†³ç­–](#00103-æ€§èƒ½åœºæ™¯ä¸å†³ç­–)
- [00.11 æŠ€æœ¯åœºæ™¯åˆ†æ](#0011-æŠ€æœ¯åœºæ™¯åˆ†æ)
  - [00.11.1 å¼€å‘ç¯å¢ƒåœºæ™¯](#00111-å¼€å‘ç¯å¢ƒåœºæ™¯)
  - [00.11.2 ç”Ÿäº§ç¯å¢ƒåœºæ™¯](#00112-ç”Ÿäº§ç¯å¢ƒåœºæ™¯)
  - [00.11.3 CI/CD åœºæ™¯](#00113-cicd-åœºæ™¯)
- [00.12 å†³ç­–ä¾æ®ä¸æ€è·¯](#0012-å†³ç­–ä¾æ®ä¸æ€è·¯)
  - [00.12.1 å­˜å‚¨é©±åŠ¨é€‰æ‹©å†³ç­–æ ‘](#00121-å­˜å‚¨é©±åŠ¨é€‰æ‹©å†³ç­–æ ‘)
  - [00.12.2 ç½‘ç»œé©±åŠ¨é€‰æ‹©å†³ç­–æ ‘](#00122-ç½‘ç»œé©±åŠ¨é€‰æ‹©å†³ç­–æ ‘)
  - [00.12.3 æ•°æ®ç®¡ç†é€‰æ‹©å†³ç­–æ ‘](#00123-æ•°æ®ç®¡ç†é€‰æ‹©å†³ç­–æ ‘)
  - [00.12.4 æ„å»ºç­–ç•¥é€‰æ‹©å†³ç­–æ ‘](#00124-æ„å»ºç­–ç•¥é€‰æ‹©å†³ç­–æ ‘)
- [00.13 å½¢å¼åŒ–æ€»ç»“](#0013-å½¢å¼åŒ–æ€»ç»“)
  - [00.13.1 Docker æ¶æ„æ¨¡å‹å½¢å¼åŒ–](#00131-docker-æ¶æ„æ¨¡å‹å½¢å¼åŒ–)
  - [00.13.2 é•œåƒä½“ç§¯æ¨¡å‹](#00132-é•œåƒä½“ç§¯æ¨¡å‹)
  - [00.13.3 æ„å»ºæ€§èƒ½æ¨¡å‹](#00133-æ„å»ºæ€§èƒ½æ¨¡å‹)
  - [00.13.4 ç¼“å­˜å‘½ä¸­ç‡æ¨¡å‹](#00134-ç¼“å­˜å‘½ä¸­ç‡æ¨¡å‹)
- [00.14 å®é™…éƒ¨ç½²æ¡ˆä¾‹](#0014-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
  - [00.14.1 æ¡ˆä¾‹ 1ï¼šå¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒ](#00141-æ¡ˆä¾‹-1å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒ)
  - [00.14.2 æ¡ˆä¾‹ 2ï¼šDocker Compose å¤šå®¹å™¨åº”ç”¨](#00142-æ¡ˆä¾‹-2docker-compose-å¤šå®¹å™¨åº”ç”¨)
  - [00.14.3 æ¡ˆä¾‹ 3ï¼šDocker ç½‘ç»œé…ç½®](#00143-æ¡ˆä¾‹-3docker-ç½‘ç»œé…ç½®)
- [00.15 Docker ç»¼åˆæœ€ä½³å®è·µ](#0015-docker-ç»¼åˆæœ€ä½³å®è·µ)
  - [00.15.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ](#00151-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ)
  - [00.15.2 Docker æ£€æŸ¥æ¸…å•](#00152-docker-æ£€æŸ¥æ¸…å•)
- [00.16 Docker æ•…éšœæ’æŸ¥](#0016-docker-æ•…éšœæ’æŸ¥)
  - [00.16.1 å¸¸è§é—®é¢˜](#00161-å¸¸è§é—®é¢˜)
- [00.17 å‚è€ƒ](#0017-å‚è€ƒ)
  - [00.17.1 éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£](#00171-éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£)
  - [00.17.2 Docker ç›¸å…³æ–‡æ¡£](#00172-docker-ç›¸å…³æ–‡æ¡£)
  - [00.17.3 å…¶ä»–ç›¸å…³æ–‡æ¡£](#00173-å…¶ä»–ç›¸å…³æ–‡æ¡£)
  - [00.17.4 å¤–éƒ¨å‚è€ƒ](#00174-å¤–éƒ¨å‚è€ƒ)

---

## 00.1 æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£æ·±å…¥è§£æ Docker çš„æ ¸å¿ƒæŠ€æœ¯ã€æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µï¼Œä»¥åŠä¸åŒæŠ€æœ¯åœºæ™¯ä¸‹çš„å†³ç­–ä¾
æ®å’Œå†³ç­–æ€è·¯ã€‚

**æ–‡æ¡£ç»“æ„**ï¼š

- **æ¶æ„è®¾è®¡**ï¼šDocker æŠ€æœ¯æ ˆæ¶æ„å’Œæ§åˆ¶è·¯å¾„
- **é•œåƒæ¨¡å‹**ï¼šOCI Image Specã€é•œåƒå±‚å­˜å‚¨ã€é•œåƒå¯»å€
- **å­˜å‚¨ç½‘ç»œ**ï¼šoverlay2 å­˜å‚¨é©±åŠ¨ã€CNM ç½‘ç»œæ¨¡å‹
- **æœ€ä½³å®è·µ**ï¼šé•œåƒæ„å»ºã€æ•°æ®ç®¡ç†ã€å®‰å…¨é…ç½®ã€æ€§èƒ½ä¼˜åŒ–
- **æŠ€æœ¯åœºæ™¯**ï¼šå¼€å‘ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒã€CI/CD
- **å†³ç­–åˆ†æ**ï¼šæ¶æ„é€‰æ‹©ã€å­˜å‚¨ç½‘ç»œé€‰æ‹©ã€æ„å»ºç­–ç•¥é€‰æ‹©

## 00.2 æ ¸å¿ƒç»„ä»¶

> **ğŸ’¡ éš”ç¦»å±‚æ¬¡å…³è”**ï¼šDocker ä½¿ç”¨ runc ä½œä¸º OCI è¿è¡Œæ—¶ï¼Œå±äº L-3 å®¹å™¨åŒ–å±‚ï¼Œæä¾›
> è¿›ç¨‹çº§éš”ç¦»ã€‚è¯¦ç»†çš„æŠ€æœ¯è§£æè¯·å‚è€ƒï¼š
>
> - **[29. éš”ç¦»æ ˆ](../29-isolation-stack/isolation-stack.md)** - å®Œæ•´çš„éš”ç¦»æ ˆæŠ€
>   æœ¯è§£æ
> - **[L-3 å®¹å™¨åŒ–å±‚](../29-isolation-stack/layers/L-3-containerization.md)** -
>   runcã€containerdã€Docker è¯¦ç»†æ–‡æ¡£
> - **[éš”ç¦»å±‚æ¬¡å¯¹æ¯”æ–‡æ¡£](../29-isolation-stack/layers/isolation-comparison.md)** -
>   å®¹å™¨åŒ–å±‚æ€§èƒ½å¯¹æ¯”å’ŒæŠ€æœ¯é€‰å‹

### 00.2.1 æŠ€æœ¯æ ˆæ¶æ„

```mermaid
graph TB
    A[docker-cli] --> B[dockerd]
    B --> C[containerd]
    C --> D[containerd-shim]
    D --> E[runc]
    E --> F[å®¹å™¨è¿›ç¨‹]

    G[é•œåƒå­˜å‚¨] --> C
    H[ç½‘ç»œé©±åŠ¨] --> B
    I[å­˜å‚¨é©±åŠ¨] --> C

    style A fill:#e1f5ff
    style F fill:#fff4e1
```

**æ¶æ„å±‚æ¬¡åˆ†æ**ï¼š

1. **ç”¨æˆ·æ¥å£å±‚**ï¼ˆdocker-cliï¼‰ï¼šå‘½ä»¤è¡Œå·¥å…·ï¼ŒREST API å®¢æˆ·ç«¯
2. **å®ˆæŠ¤è¿›ç¨‹å±‚**ï¼ˆdockerdï¼‰ï¼šDocker å®ˆæŠ¤è¿›ç¨‹ï¼Œé•œåƒç®¡ç†ã€ç½‘ç»œç®¡ç†
3. **è¿è¡Œæ—¶æ¥å£å±‚**ï¼ˆcontainerdï¼‰ï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼Œç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
4. **è¿è¡Œæ—¶å±‚**ï¼ˆruncï¼‰ï¼šOCI è¿è¡Œæ—¶ï¼Œåˆ›å»ºå®¹å™¨è¿›ç¨‹
5. **å®¹å™¨å±‚**ï¼ˆå®¹å™¨è¿›ç¨‹ï¼‰ï¼šå®é™…è¿è¡Œçš„å®¹å™¨è¿›ç¨‹

### 00.2.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶                | èŒè´£            | æŠ€æœ¯è§„èŒƒ                               |
| ------------------- | --------------- | -------------------------------------- |
| **docker-cli**      | ç”¨æˆ·å‘½ä»¤è¡Œæ¥å£  | REST API å®¢æˆ·ç«¯                        |
| **dockerd**         | Docker å®ˆæŠ¤è¿›ç¨‹ | é•œåƒç®¡ç†ã€ç½‘ç»œç®¡ç†ã€API æœåŠ¡           |
| **containerd**      | å®¹å™¨è¿è¡Œæ—¶æ¥å£  | CRIï¼ˆContainer Runtime Interfaceï¼‰å®ç° |
| **containerd-shim** | è¿è¡Œæ—¶ shim     | éš”ç¦» containerd ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸ         |
| **runc**            | OCI è¿è¡Œæ—¶      | OCI Runtime Spec å®ç°                  |
| **overlay2**        | å­˜å‚¨é©±åŠ¨        | è”åˆæ–‡ä»¶ç³»ç»Ÿ                           |

### 00.2.3 æ¶æ„è®¾è®¡è®ºè¯

**ä¸ºä»€ä¹ˆé‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… èŒè´£åˆ†ç¦»ï¼šæ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤ [^docker-architecture]
- âœ… è§£è€¦è®¾è®¡ï¼šç»„ä»¶é—´é€šè¿‡æ¥å£äº¤äº’ï¼Œé™ä½è€¦åˆ
- âœ… å¯æ‰©å±•æ€§ï¼šæ’ä»¶åŒ–è®¾è®¡æ”¯æŒæ‰©å±•

**å†³ç­–æ€è·¯**ï¼š

```yaml
Docker æ¶æ„é€‰æ‹©:
  æ¨¡å¼: åˆ†å±‚æ¶æ„
  ç»„ä»¶:
    - docker-cli: ç”¨æˆ·æ¥å£å±‚
    - dockerd: å®ˆæŠ¤è¿›ç¨‹å±‚
    - containerd: è¿è¡Œæ—¶æ¥å£å±‚
    - runc: è¿è¡Œæ—¶å±‚
  ä¼˜åŠ¿: èŒè´£åˆ†ç¦»ã€è§£è€¦è®¾è®¡ã€å¯æ‰©å±•
  æƒè¡¡: è°ƒç”¨é“¾è·¯è¾ƒé•¿ï¼Œæ€§èƒ½ç•¥ä½
```

**ä¸ºä»€ä¹ˆåˆ†ç¦» containerd å’Œ runcï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ ‡å‡†åŒ–ï¼šcontainerd å®ç° CRIï¼Œrunc å®ç° OCI
- âœ… è§£è€¦ï¼šcontainerd ä¸å…·ä½“è¿è¡Œæ—¶è§£è€¦
- âœ… å¯æ›¿æ¢ï¼šå¯ä»¥æ›¿æ¢ä¸åŒçš„ OCI è¿è¡Œæ—¶ï¼ˆrunc/crun/runwasiï¼‰

**å†³ç­–æ€è·¯**ï¼š

```yaml
è¿è¡Œæ—¶åˆ†ç¦»:
  containerd: CRI å®ç°ï¼Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
  runc: OCI å®ç°ï¼Œå®¹å™¨è¿›ç¨‹åˆ›å»º
  ä¼˜åŠ¿: æ ‡å‡†åŒ–ã€è§£è€¦ã€å¯æ›¿æ¢
  åº”ç”¨: K8s é€šè¿‡ containerd è°ƒç”¨ runc
```

## 00.3 OCI Image Spec

### 00.3.1 é•œåƒç»“æ„

```mermaid
graph TD
    A[é•œåƒ Manifest] --> B[Config å±‚]
    A --> C[Layer 1]
    A --> D[Layer 2]
    A --> E[Layer N]

    B --> F[é•œåƒå…ƒæ•°æ®<br/>JSON]
    C --> G[æ–‡ä»¶ç³»ç»Ÿå˜æ›´<br/>tar]
    D --> G
    E --> G

    style A fill:#e1f5ff
    style G fill:#fff4e1
```

**é•œåƒç»“æ„åˆ†æ**ï¼š

- **Manifest**ï¼šé•œåƒæ¸…å•ï¼ŒåŒ…å«æ‰€æœ‰å±‚çš„ä¿¡æ¯
- **Config**ï¼šé•œåƒé…ç½®ï¼ŒåŒ…å«é•œåƒå…ƒæ•°æ®ï¼ˆCMDã€ENVã€EXPOSE ç­‰ï¼‰
- **Layer**ï¼šæ–‡ä»¶ç³»ç»Ÿå±‚ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿå˜æ›´ï¼ˆtar æ ¼å¼ï¼‰

### 00.3.2 é•œåƒå¯»å€

**Content-addressable å¯»å€**ï¼š

```bash
é•œåƒ ID = SHA256(Manifest)

ç¤ºä¾‹ï¼š
sha256:abc123...def456
```

**æ ‡ç­¾å¯»å€**ï¼š

```bash
ä»“åº“:æ ‡ç­¾ = namespace/repository:tag

ç¤ºä¾‹ï¼š
docker.io/library/nginx:latest
```

**å¯»å€æ–¹å¼è®ºè¯**ï¼š

- **Content-addressable**ï¼šåŸºäºå†…å®¹å“ˆå¸Œï¼Œä¿è¯é•œåƒå®Œæ•´æ€§
- **æ ‡ç­¾å¯»å€**ï¼šä¾¿äºç”¨æˆ·ä½¿ç”¨ï¼Œå¯æŒ‡å‘ä¸åŒç‰ˆæœ¬çš„é•œåƒ
- **æ ‡ç­¾å¯å˜æ€§**ï¼šæ ‡ç­¾å¯ä»¥æŒ‡å‘ä¸åŒçš„é•œåƒ IDï¼ˆtag å¯æ›´æ–°ï¼‰

### 00.3.3 é•œåƒå±‚å­˜å‚¨

```mermaid
graph LR
    A[åªè¯»å±‚ 1<br/>Base Image] --> B[åªè¯»å±‚ 2<br/>è½¯ä»¶å®‰è£…]
    B --> C[åªè¯»å±‚ 3<br/>é…ç½®æ–‡ä»¶]
    C --> D[è¯»å†™å±‚<br/>Container]

    E[overlay2 é©±åŠ¨] --> F[åˆå¹¶è§†å›¾]
    A --> F
    B --> F
    C --> F
    D --> F

    style D fill:#ffe6e6
    style F fill:#e6ffe6
```

**é•œåƒå±‚å­˜å‚¨è®ºè¯**ï¼š

- **åªè¯»å±‚**ï¼šåŸºç¡€é•œåƒå’Œè½¯ä»¶å®‰è£…å±‚ï¼Œå¯å…±äº«
- **è¯»å†™å±‚**ï¼šå®¹å™¨è¿è¡Œæ—¶å†™å…¥å±‚ï¼Œæ¯ä¸ªå®¹å™¨ç‹¬ç«‹
- **overlay2 åˆå¹¶**ï¼šç”¨æˆ·çœ‹åˆ°åˆå¹¶åçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾

### 00.3.4 é•œåƒæ¨¡å‹è®ºè¯

**ä¸ºä»€ä¹ˆé‡‡ç”¨åˆ†å±‚å­˜å‚¨ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… é•œåƒå¤ç”¨ï¼šå¤šä¸ªé•œåƒå¯ä»¥å…±äº«åŸºç¡€å±‚
- âœ… ä½“ç§¯ä¼˜åŒ–ï¼šåªå­˜å‚¨å±‚å·®å¼‚ï¼Œä¸å­˜å‚¨å®Œæ•´é•œåƒ
- âœ… æ„å»ºæ•ˆç‡ï¼šåªé‡å»ºå˜æ›´çš„å±‚ï¼Œå…¶ä»–å±‚å¤ç”¨

**å†³ç­–æ€è·¯**ï¼š

```yaml
åˆ†å±‚å­˜å‚¨ç­–ç•¥:
  åŸºç¡€å±‚: å¯å…±äº«ï¼ˆå¦‚ alpineã€ubuntuï¼‰
  åº”ç”¨å±‚: ç‹¬ç«‹ï¼ˆå¦‚åº”ç”¨ä»£ç ï¼‰
  ä¼˜åŠ¿: é•œåƒå¤ç”¨ã€ä½“ç§¯ä¼˜åŒ–ã€æ„å»ºæ•ˆç‡
  æ•ˆæœ: é•œåƒä½“ç§¯å‡å°‘ 50-70%
```

**ä¸ºä»€ä¹ˆé‡‡ç”¨ Content-addressable å¯»å€ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… å†…å®¹å®Œæ•´æ€§ï¼šåŸºäºå†…å®¹å“ˆå¸Œï¼Œä¿è¯é•œåƒå®Œæ•´æ€§
- âœ… å»é‡å­˜å‚¨ï¼šç›¸åŒå†…å®¹çš„å±‚åªå­˜å‚¨ä¸€æ¬¡
- âœ… å®‰å…¨éªŒè¯ï¼šå¯ä»¥é€šè¿‡å“ˆå¸ŒéªŒè¯é•œåƒæ˜¯å¦è¢«ç¯¡æ”¹

**å†³ç­–æ€è·¯**ï¼š

```yaml
Content-addressable ç­–ç•¥:
  å¯»å€: SHA256(Manifest)
  ä¼˜åŠ¿: å†…å®¹å®Œæ•´æ€§ã€å»é‡å­˜å‚¨ã€å®‰å…¨éªŒè¯
  åº”ç”¨: é•œåƒæ‹‰å–ã€é•œåƒæ¨é€ã€é•œåƒéªŒè¯
```

## 00.4 æ§åˆ¶è·¯å¾„è¯¦è§£

### 00.4.1 å®¹å™¨å¯åŠ¨æµç¨‹

```mermaid
sequenceDiagram
    participant C as docker-cli
    participant D as dockerd
    participant CT as containerd
    participant SH as shim
    participant R as runc
    participant P as å®¹å™¨è¿›ç¨‹

    C->>D: docker run image
    D->>CT: Create Container
    CT->>CT: æ£€æŸ¥é•œåƒ
    CT->>SH: å¯åŠ¨ shim
    SH->>R: åˆ›å»ºå®¹å™¨
    R->>P: å¯åŠ¨è¿›ç¨‹
    P-->>SH: è¿è¡Œä¸­
    SH-->>CT: çŠ¶æ€åŒæ­¥
    CT-->>D: çŠ¶æ€åŒæ­¥
    D-->>C: å®¹å™¨è¿è¡Œ
```

**å¯åŠ¨æµç¨‹åˆ†æ**ï¼š

1. **docker-cli â†’ dockerd**ï¼šç”¨æˆ·å‘½ä»¤é€šè¿‡ REST API å‘é€åˆ° dockerd
2. **dockerd â†’ containerd**ï¼šdockerd è°ƒç”¨ containerd API åˆ›å»ºå®¹å™¨
3. **containerd â†’ shim**ï¼šcontainerd å¯åŠ¨ shim è¿›ç¨‹
4. **shim â†’ runc**ï¼šshim è°ƒç”¨ runc åˆ›å»ºå®¹å™¨è¿›ç¨‹
5. **runc â†’ å®¹å™¨è¿›ç¨‹**ï¼šrunc åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨è¿›ç¨‹
6. **çŠ¶æ€åŒæ­¥**ï¼šå®¹å™¨è¿›ç¨‹çŠ¶æ€é€šè¿‡ shim â†’ containerd â†’ dockerd â†’ docker-cli åŒæ­¥

### 00.4.2 Shim çš„å¿…è¦æ€§

**é—®é¢˜**ï¼šrunc åˆ›å»ºå®¹å™¨åç«‹å³é€€å‡ºï¼Œå®¹å™¨è¿›ç¨‹ï¼ˆinit è¿›ç¨‹ï¼‰ä¼šå¤±å»çˆ¶è¿›ç¨‹ï¼Œå˜æˆå­¤å„¿è¿›
ç¨‹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šshim ä½œä¸º"è½»é‡çº§ init"æŒæœ‰ STDIO å’Œ fifoï¼Œä½¿ dockerd å¯ä»¥é‡å¯è€Œä¸
ä¸¢å¤±å®¹å™¨ã€‚

```mermaid
graph TD
    A[dockerd å´©æºƒ] --> B{shim æ˜¯å¦å­˜åœ¨?}
    B -->|æ˜¯| C[å®¹å™¨ç»§ç»­è¿è¡Œ]
    B -->|å¦| D[å®¹å™¨è¿›ç¨‹æˆä¸ºå­¤å„¿]

    C --> E[dockerd é‡å¯]
    E --> F[é‡æ–°è¿æ¥ shim]
    F --> G[æ¢å¤æ§åˆ¶]

    D --> H[å®¹å™¨å¤±å»ç®¡ç†]

    style C fill:#ccffcc
    style D fill:#ffcccc
```

**shim å¿…è¦æ€§è®ºè¯**ï¼š

- **å­¤å„¿è¿›ç¨‹é—®é¢˜**ï¼šrunc åˆ›å»ºå®¹å™¨åç«‹å³é€€å‡ºï¼Œå®¹å™¨è¿›ç¨‹å¤±å»çˆ¶è¿›ç¨‹
- **shim ä½œç”¨**ï¼šshim æŒæœ‰å®¹å™¨è¿›ç¨‹ï¼Œé¿å…æˆä¸ºå­¤å„¿
- **å¯æ¢å¤æ€§**ï¼šdockerd é‡å¯åå¯ä»¥é‡æ–°è¿æ¥ shimï¼Œæ¢å¤å®¹å™¨æ§åˆ¶

### 00.4.3 æ§åˆ¶è·¯å¾„è®ºè¯

**ä¸ºä»€ä¹ˆé‡‡ç”¨åˆ†å±‚æ§åˆ¶è·¯å¾„ï¼Ÿ**

**å†³ç­–ä¾æ®**ï¼š

- âœ… èŒè´£åˆ†ç¦»ï¼šæ¯å±‚èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
- âœ… æ ‡å‡†åŒ–ï¼šcontainerd å®ç° CRIï¼Œrunc å®ç° OCI
- âœ… å¯æ‰©å±•ï¼šå¯ä»¥æ›¿æ¢ä¸åŒç»„ä»¶ï¼ˆå¦‚ runc â†’ crunï¼‰

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ§åˆ¶è·¯å¾„è®¾è®¡:
  å±‚æ¬¡: docker-cli â†’ dockerd â†’ containerd â†’ shim â†’ runc
  ä¼˜åŠ¿: èŒè´£åˆ†ç¦»ã€æ ‡å‡†åŒ–ã€å¯æ‰©å±•
  æƒè¡¡: è°ƒç”¨é“¾è·¯è¾ƒé•¿ï¼Œæ€§èƒ½ç•¥ä½
```

## 00.5 å­˜å‚¨é©±åŠ¨ï¼šoverlay2

### 00.5.1 OverlayFS åŸç†

```mermaid
graph TB
    A[Lower Layer<br/>åªè¯»] --> C[Overlay<br/>åˆå¹¶è§†å›¾]
    B[Upper Layer<br/>è¯»å†™] --> C

    D[å®¹å™¨è¯»å†™] --> B
    C --> E[ç”¨æˆ·çœ‹åˆ°<br/>åˆå¹¶æ–‡ä»¶ç³»ç»Ÿ]

    style A fill:#e6f3ff
    style B fill:#ffe6e6
    style E fill:#e6ffe6
```

**OverlayFS åŸç†è®ºè¯**ï¼š

- **Lower Layer**ï¼šåªè¯»å±‚ï¼Œå¤šä¸ªé•œåƒå±‚å åŠ 
- **Upper Layer**ï¼šè¯»å†™å±‚ï¼Œå®¹å™¨è¿è¡Œæ—¶å†™å…¥
- **åˆå¹¶è§†å›¾**ï¼šç”¨æˆ·çœ‹åˆ°æ‰€æœ‰å±‚çš„åˆå¹¶ç»“æœ
- **Copy-on-Write**ï¼šä¿®æ”¹æ—¶ä» Lower å¤åˆ¶åˆ° Upper

### 00.5.2 å­˜å‚¨é©±åŠ¨å¯¹æ¯”

| é©±åŠ¨             | æ€§èƒ½       | åŠŸèƒ½               | é€‚ç”¨åœºæ™¯           |
| ---------------- | ---------- | ------------------ | ------------------ |
| **overlay2**     | â­â­â­â­â­ | æ”¯æŒ CoWã€åŸå­æ“ä½œ | æ¨èä½¿ç”¨ï¼ˆé»˜è®¤ï¼‰   |
| **aufs**         | â­â­â­     | ä¸æ”¯æŒ             | æ—§ç‰ˆæœ¬             |
| **devicemapper** | â­â­       | éœ€è¦é¢å¤–è®¾å¤‡       | ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€é…ç½®ï¼‰ |
| **btrfs**        | â­â­â­     | å¿«ç…§æ”¯æŒ           | ç‰¹å®šåœºæ™¯           |

**å­˜å‚¨é©±åŠ¨è®ºè¯**ï¼š

- **overlay2**ï¼šæ€§èƒ½æœ€å¥½ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œæ¨èä½¿ç”¨ [^docker-overlay2]
- **aufs**ï¼šæ—§ç‰ˆæœ¬ï¼Œæ€§èƒ½ä¸€èˆ¬ï¼Œä¸æ¨è
- **devicemapper**ï¼šéœ€è¦é¢å¤–è®¾å¤‡ï¼Œé…ç½®å¤æ‚
- **btrfs**ï¼šæ”¯æŒå¿«ç…§ï¼Œä½†æ€§èƒ½ä¸€èˆ¬

### 00.5.3 å­˜å‚¨åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šå¼€å‘ç¯å¢ƒ**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½è¦æ±‚ä¸é«˜
- âœ… ç®€å•æ˜“ç”¨ä¼˜å…ˆ

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨é©±åŠ¨é€‰æ‹©:
  åœºæ™¯: å¼€å‘ç¯å¢ƒ
  é©±åŠ¨: overlay2ï¼ˆé»˜è®¤ï¼‰
  åŸå› : æ€§èƒ½å¥½ã€ç®€å•æ˜“ç”¨
  æƒè¡¡: æ— ç‰¹æ®Šè¦æ±‚
```

**åœºæ™¯ 2ï¼šç”Ÿäº§ç¯å¢ƒ**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ€§èƒ½è¦æ±‚é«˜
- âœ… ç¨³å®šæ€§è¦æ±‚é«˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨é©±åŠ¨é€‰æ‹©:
  åœºæ™¯: ç”Ÿäº§ç¯å¢ƒ
  é©±åŠ¨: overlay2ï¼ˆæ¨èï¼‰
  åŸå› : æ€§èƒ½æœ€å¥½ã€ç¨³å®šæ€§é«˜
  æƒè¡¡: éœ€è¦å†…æ ¸æ”¯æŒ
```

**åœºæ™¯ 3ï¼šéœ€è¦å¿«ç…§**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦æ–‡ä»¶ç³»ç»Ÿå¿«ç…§
- âœ… å¿«ç…§æ€§èƒ½è¦æ±‚

**å†³ç­–æ€è·¯**ï¼š

```yaml
å­˜å‚¨é©±åŠ¨é€‰æ‹©:
  åœºæ™¯: éœ€è¦å¿«ç…§
  é©±åŠ¨: btrfs
  åŸå› : æ”¯æŒæ–‡ä»¶ç³»ç»Ÿå¿«ç…§
  æƒè¡¡: æ€§èƒ½ç›¸å¯¹è¾ƒä½
```

## 00.6 ç½‘ç»œæ¨¡å‹ï¼šCNM

### 00.6.1 ç½‘ç»œæ¶æ„

```mermaid
graph TB
    A[Docker Network] --> B[Bridge Driver]
    A --> C[Host Driver]
    A --> D[None Driver]
    A --> E[Overlay Driver]

    B --> F[å®¹å™¨è¿æ¥åˆ° Bridge]
    F --> G[NAT åˆ°ä¸»æœºç½‘ç»œ]

    E --> H[è·¨ä¸»æœºç½‘ç»œ<br/>Swarm]

    style B fill:#e1f5ff
    style E fill:#fff4e1
```

**ç½‘ç»œæ¶æ„åˆ†æ**ï¼š

- **Bridge**ï¼šé»˜è®¤ç½‘ç»œé©±åŠ¨ï¼Œå®¹å™¨é€šè¿‡ NAT è®¿é—®ä¸»æœºç½‘ç»œ
- **Host**ï¼šå®¹å™¨å…±äº«ä¸»æœºç½‘ç»œï¼Œæ€§èƒ½æœ€å¥½
- **None**ï¼šæ— ç½‘ç»œï¼Œç”¨äºè‡ªå®šä¹‰ç½‘ç»œ
- **Overlay**ï¼šè·¨ä¸»æœºç½‘ç»œï¼Œç”¨äº Swarm æ¨¡å¼

### 00.6.2 ç½‘ç»œé©±åŠ¨å¯¹æ¯”

| é©±åŠ¨        | ç‰¹ç‚¹         | é€‚ç”¨åœºæ™¯     |
| ----------- | ------------ | ------------ |
| **Bridge**  | é»˜è®¤ã€NAT    | å•æœºå®¹å™¨é€šä¿¡ |
| **Host**    | å…±äº«ä¸»æœºç½‘ç»œ | æ€§èƒ½æ•æ„Ÿ     |
| **None**    | æ— ç½‘ç»œ       | è‡ªå®šä¹‰ç½‘ç»œ   |
| **Overlay** | è·¨ä¸»æœºç½‘ç»œ   | Swarm æ¨¡å¼   |

**ç½‘ç»œé©±åŠ¨è®ºè¯**ï¼š

- **Bridge**ï¼šé»˜è®¤é€‰æ‹©ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ [^docker-network]
- **Host**ï¼šæ€§èƒ½æœ€å¥½ï¼Œä½†ç½‘ç»œéš”ç¦»æ€§å·®
- **None**ï¼šæ— ç½‘ç»œï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ç½‘ç»œ
- **Overlay**ï¼šè·¨ä¸»æœºç½‘ç»œï¼Œé€‚åˆ Swarm é›†ç¾¤

### 00.6.3 ç½‘ç»œåœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šå•æœºå®¹å™¨é€šä¿¡**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å®¹å™¨é—´éœ€è¦é€šä¿¡
- âœ… ä¸éœ€è¦å¤–éƒ¨è®¿é—®

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  åœºæ™¯: å•æœºå®¹å™¨é€šä¿¡
  é©±åŠ¨: Bridgeï¼ˆé»˜è®¤ï¼‰
  åŸå› : ç®€å•æ˜“ç”¨ï¼Œè‡ªåŠ¨ NAT
  æƒè¡¡: æ€§èƒ½ç•¥ä½ï¼ˆNAT å¼€é”€ï¼‰
```

**åœºæ™¯ 2ï¼šæ€§èƒ½æ•æ„Ÿåº”ç”¨**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… ç½‘ç»œå»¶è¿Ÿè¦æ±‚ä½
- âœ… ä¸éœ€è¦ç½‘ç»œéš”ç¦»

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  åœºæ™¯: æ€§èƒ½æ•æ„Ÿåº”ç”¨
  é©±åŠ¨: Host
  åŸå› : é›¶ NAT å¼€é”€ï¼Œæ€§èƒ½æœ€å¥½
  æƒè¡¡: ç½‘ç»œéš”ç¦»æ€§å·®
```

**åœºæ™¯ 3ï¼šSwarm é›†ç¾¤**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… è·¨ä¸»æœºå®¹å™¨é€šä¿¡
- âœ… éœ€è¦æœåŠ¡å‘ç°

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©:
  åœºæ™¯: Swarm é›†ç¾¤
  é©±åŠ¨: Overlay
  åŸå› : æ”¯æŒè·¨ä¸»æœºç½‘ç»œå’ŒæœåŠ¡å‘ç°
  æƒè¡¡: é…ç½®ç›¸å¯¹å¤æ‚
```

## 00.7 é•œåƒæ„å»ºæœ€ä½³å®è·µ

### 00.7.1 å¤šé˜¶æ®µæ„å»º

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM golang:1.21-alpine AS builder
WORKDIR /build
COPY . .
RUN go build -o app .

# è¿è¡Œé˜¶æ®µ
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /build/app .
CMD ["./app"]
```

**å¤šé˜¶æ®µæ„å»ºè®ºè¯**ï¼š

- **åˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ**ï¼šæ„å»ºé˜¶æ®µåŒ…å«ç¼–è¯‘å·¥å…·ï¼Œè¿è¡Œé˜¶æ®µåªåŒ…å«è¿è¡Œæ—¶
- **ä½“ç§¯ä¼˜åŒ–**ï¼šæœ€ç»ˆé•œåƒä¸åŒ…å«æ„å»ºå·¥å…·ï¼Œä½“ç§¯å‡å°‘ 50-70%
- **å®‰å…¨ä¼˜åŒ–**ï¼šè¿è¡Œé˜¶æ®µå·¥å…·é“¾å°‘ï¼Œæ”»å‡»é¢å°

### 00.7.2 é•œåƒä¼˜åŒ–ç­–ç•¥

| ç­–ç•¥                   | æ–¹æ³•               | æ•ˆæœ            |
| ---------------------- | ------------------ | --------------- |
| **å¤šé˜¶æ®µæ„å»º**         | åˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ | å‡å°ä½“ç§¯ 50-70% |
| **Distroless/Scratch** | æœ€å°åŒ–åŸºç¡€é•œåƒ     | å‡å°ä½“ç§¯ 80-90% |
| **å±‚åˆå¹¶**             | åˆå¹¶ RUN æŒ‡ä»¤      | å‡å°‘å±‚æ•°        |
| **.dockerignore**      | æ’é™¤æ— å…³æ–‡ä»¶       | å‡å°æ„å»ºä¸Šä¸‹æ–‡  |

**ä¼˜åŒ–ç­–ç•¥è®ºè¯**ï¼š

- **å¤šé˜¶æ®µæ„å»º**ï¼šåˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒï¼Œå‡å°æœ€ç»ˆé•œåƒä½“ç§¯
- **Distroless/Scratch**ï¼šæœ€å°åŒ–åŸºç¡€é•œåƒï¼Œå‡å°æ”»å‡»é¢
- **å±‚åˆå¹¶**ï¼šå‡å°‘é•œåƒå±‚æ•°ï¼Œæé«˜æ‹‰å–é€Ÿåº¦
- **.dockerignore**ï¼šæ’é™¤æ— å…³æ–‡ä»¶ï¼Œå‡å°æ„å»ºä¸Šä¸‹æ–‡

### 00.7.3 åˆ†å±‚è§„èŒƒ

```dockerfile
# âŒ é”™è¯¯ï¼šé¢‘ç¹å˜åŒ–çš„å±‚åœ¨åº•å±‚
FROM alpine
COPY app.py /app/app.py    # æ¯æ¬¡ä»£ç å˜æ›´éƒ½é‡å»ºè¿™ä¸€å±‚
RUN pip install -r requirements.txt

# âœ… æ­£ç¡®ï¼šç¨³å®šå±‚åœ¨åº•å±‚ï¼Œå˜åŒ–å±‚åœ¨é¡¶å±‚
FROM alpine
RUN pip install -r requirements.txt  # ä¾èµ–ç¨³å®š
COPY app.py /app/app.py              # ä»£ç å˜åŒ–åªå½±å“è¿™ä¸€å±‚
```

**åˆ†å±‚è§„èŒƒè®ºè¯**ï¼š

- **ç¨³å®šå±‚åœ¨åº•å±‚**ï¼šåŸºç¡€é•œåƒå’Œä¾èµ–å®‰è£…å±‚ï¼Œå˜åŒ–å°‘
- **å˜åŒ–å±‚åœ¨é¡¶å±‚**ï¼šåº”ç”¨ä»£ç å±‚ï¼Œå˜åŒ–é¢‘ç¹
- **ç¼“å­˜åˆ©ç”¨**ï¼šåªæœ‰é¡¶å±‚å˜åŒ–æ—¶ï¼Œåº•å±‚å¯ä»¥å¤ç”¨ç¼“å­˜

### 00.7.4 æ„å»ºåœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šå¼€å‘ç¯å¢ƒæ„å»º**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ„å»ºé€Ÿåº¦ä¼˜å…ˆ
- âœ… é•œåƒä½“ç§¯ä¸é‡è¦

**å†³ç­–æ€è·¯**ï¼š

```yaml
å¼€å‘ç¯å¢ƒæ„å»ºç­–ç•¥:
  åŸºç¡€é•œåƒ: å®Œæ•´åŸºç¡€é•œåƒï¼ˆå¦‚ alpine/nodeï¼‰
  æ„å»ºæ–¹å¼: å•é˜¶æ®µæ„å»º
  å±‚é¡ºåº: ä¼˜åŒ–ç¼“å­˜åˆ©ç”¨
  é•œåƒä½“ç§¯: å¯æ¥å—è¾ƒå¤§
```

**åœºæ™¯ 2ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… é•œåƒä½“ç§¯ä¼˜å…ˆ
- âœ… å®‰å…¨è¦æ±‚é«˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç”Ÿäº§ç¯å¢ƒæ„å»ºç­–ç•¥:
  åŸºç¡€é•œåƒ: Distroless æˆ– Scratch
  æ„å»ºæ–¹å¼: å¤šé˜¶æ®µæ„å»º
  å±‚é¡ºåº: ç¨³å®šå±‚åœ¨åº•å±‚
  é•œåƒä½“ç§¯: æœ€å°åŒ–
```

**åœºæ™¯ 3ï¼šCI/CD æ„å»º**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ„å»ºé€Ÿåº¦å…³é”®
- âœ… å¯é‡å¤æ€§é‡è¦

**å†³ç­–æ€è·¯**ï¼š

```yaml
CI/CD æ„å»ºç­–ç•¥:
  æ„å»ºå·¥å…·: BuildKitï¼ˆå¹¶è¡Œæ„å»ºï¼‰
  ç¼“å­˜ç­–ç•¥: åˆ†å±‚ç¼“å­˜
  å¤šé˜¶æ®µæ„å»º: å¿…é¡»ä½¿ç”¨
  æ„å»ºä¸Šä¸‹æ–‡: .dockerignore ä¼˜åŒ–
```

## 00.8 æ•°æ®ç®¡ç†

### 00.8.1 Volume vs Bind Mount

| æ–¹å¼           | ç‰¹ç‚¹                | é€‚ç”¨åœºæ™¯             |
| -------------- | ------------------- | -------------------- |
| **Volume**     | Docker ç®¡ç†ã€å¯å¤‡ä»½ | æŒä¹…åŒ–æ•°æ®ã€æ•°æ®å…±äº« |
| **Bind Mount** | ç›´æ¥æ˜ å°„ä¸»æœºè·¯å¾„    | å¼€å‘ç¯å¢ƒã€é…ç½®æ–‡ä»¶   |
| **tmpfs**      | å†…å­˜æ–‡ä»¶ç³»ç»Ÿ        | ä¸´æ—¶æ•°æ®ã€æ•æ„Ÿæ•°æ®   |

**æ•°æ®ç®¡ç†è®ºè¯**ï¼š

- **Volume**ï¼šDocker ç®¡ç†ï¼Œå¯å¤‡ä»½ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ
- **Bind Mount**ï¼šç›´æ¥æ˜ å°„ä¸»æœºè·¯å¾„ï¼Œé€‚åˆå¼€å‘ç¯å¢ƒ
- **tmpfs**ï¼šå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œé€Ÿåº¦å¿«ä½†ä¸æŒä¹…åŒ–

### 00.8.2 Volume ç®¡ç†

```bash
# åˆ›å»ºå‘½åå·
docker volume create my-volume

# ä½¿ç”¨å·
docker run -v my-volume:/data nginx

# å¤‡ä»½å·
docker run --rm -v my-volume:/data -v $(pwd):/backup \
  alpine tar czf /backup/backup.tar.gz /data
```

### 00.8.3 æ•°æ®åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæŒä¹…åŒ–æ•°æ®**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ•°æ®éœ€è¦æŒä¹…åŒ–
- âœ… æ•°æ®éœ€è¦å¤‡ä»½

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ•°æ®æ–¹æ¡ˆé€‰æ‹©:
  æ–¹å¼: Volume
  åŸå› : Docker ç®¡ç†ï¼Œå¯å¤‡ä»½
  é€‚ç”¨: æ•°æ®åº“ã€æ—¥å¿—ã€é…ç½®æ–‡ä»¶
```

**åœºæ™¯ 2ï¼šå¼€å‘ç¯å¢ƒæ•°æ®**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… éœ€è¦ç›´æ¥è®¿é—®ä¸»æœºæ–‡ä»¶
- âœ… éœ€è¦å®æ—¶åŒæ­¥

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ•°æ®æ–¹æ¡ˆé€‰æ‹©:
  æ–¹å¼: Bind Mount
  åŸå› : ç›´æ¥æ˜ å°„ä¸»æœºè·¯å¾„ï¼Œå®æ—¶åŒæ­¥
  é€‚ç”¨: å¼€å‘ç¯å¢ƒã€é…ç½®æ–‡ä»¶
```

**åœºæ™¯ 3ï¼šä¸´æ—¶æ•°æ®**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ•°æ®ä¸éœ€è¦æŒä¹…åŒ–
- âœ… æ€§èƒ½è¦æ±‚é«˜

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ•°æ®æ–¹æ¡ˆé€‰æ‹©:
  æ–¹å¼: tmpfs
  åŸå› : å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œæ€§èƒ½æœ€å¥½
  é€‚ç”¨: ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜
```

## 00.9 å®‰å…¨æœ€ä½³å®è·µ

### 00.9.1 é•œåƒå®‰å…¨

| æªæ–½         | æ–¹æ³•                 | è¯´æ˜           |
| ------------ | -------------------- | -------------- |
| **é•œåƒç­¾å** | Docker Content Trust | éªŒè¯é•œåƒå®Œæ•´æ€§ |
| **æ¼æ´æ‰«æ** | Trivy/Clair          | æ£€æµ‹å·²çŸ¥ CVE   |
| **æœ€å°æƒé™** | é root ç”¨æˆ·è¿è¡Œ     | å‡å°‘æ”»å‡»é¢     |
| **æœ€å°é•œåƒ** | Distroless/Scratch   | å‡å°‘æ”»å‡»é¢     |

**é•œåƒå®‰å…¨è®ºè¯**ï¼š

- **é•œåƒç­¾å**ï¼šéªŒè¯é•œåƒå®Œæ•´æ€§å’Œæ¥æºï¼Œé˜²æ­¢é•œåƒè¢«ç¯¡æ”¹
- **æ¼æ´æ‰«æ**ï¼šæ£€æµ‹é•œåƒä¸­çš„å·²çŸ¥æ¼æ´ï¼ŒåŠæ—¶ä¿®å¤
- **æœ€å°æƒé™**ï¼šä»¥é root ç”¨æˆ·è¿è¡Œå®¹å™¨ï¼Œå‡å°‘æ”»å‡»é¢
- **æœ€å°é•œåƒ**ï¼šä½¿ç”¨ Distroless/Scratchï¼Œå‡å°‘æ”»å‡»é¢

### 00.9.2 è¿è¡Œæ—¶å®‰å…¨

```yaml
# Docker Compose å®‰å…¨é…ç½®ç¤ºä¾‹
services:
  app:
    image: myapp:latest
    user: "1000:1000" # é root
    read_only: true # åªè¯»æ–‡ä»¶ç³»ç»Ÿ
    tmpfs:
      - /tmp
      - /run
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
```

**è¿è¡Œæ—¶å®‰å…¨è®ºè¯**ï¼š

- **é root ç”¨æˆ·**ï¼šå‡å°‘æ”»å‡»é¢ï¼Œé™åˆ¶å®¹å™¨æƒé™
- **åªè¯»æ–‡ä»¶ç³»ç»Ÿ**ï¼šé˜²æ­¢å®¹å™¨ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶
- **Capability é™åˆ¶**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- **no-new-privileges**ï¼šé˜²æ­¢æƒé™æå‡

### 00.9.3 å®‰å…¨åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šå¼€å‘ç¯å¢ƒ**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å®‰å…¨è¦æ±‚ç›¸å¯¹è¾ƒä½
- âœ… è°ƒè¯•ä¾¿åˆ©æ€§ä¼˜å…ˆ

**å†³ç­–æ€è·¯**ï¼š

```yaml
å¼€å‘ç¯å¢ƒå®‰å…¨é…ç½®:
  ç”¨æˆ·: rootï¼ˆé»˜è®¤ï¼‰
  æ–‡ä»¶ç³»ç»Ÿ: å¯è¯»å†™
  Capability: é»˜è®¤æƒé™
  åŸå› : è°ƒè¯•ä¾¿åˆ©æ€§ä¼˜å…ˆ
```

**åœºæ™¯ 2ï¼šç”Ÿäº§ç¯å¢ƒ**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… å®‰å…¨è¦æ±‚é«˜
- âœ… æœ€å°æƒé™åŸåˆ™

**å†³ç­–æ€è·¯**ï¼š

```yaml
ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®:
  ç”¨æˆ·: é rootï¼ˆå¿…é¡»ï¼‰
  æ–‡ä»¶ç³»ç»Ÿ: åªè¯»ï¼ˆread_only: trueï¼‰
  Capability: æœ€å°æƒé™ï¼ˆcap_drop: ALLï¼‰
  åŸå› : æœ€å°æƒé™åŸåˆ™
```

**åœºæ™¯ 3ï¼šé«˜å®‰å…¨è¦æ±‚**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æœ€é«˜å®‰å…¨è¦æ±‚
- âœ… åˆè§„è¦æ±‚

**å†³ç­–æ€è·¯**ï¼š

```yaml
é«˜å®‰å…¨é…ç½®:
  ç”¨æˆ·: é root + æœ€å° UID
  æ–‡ä»¶ç³»ç»Ÿ: åªè¯» + tmpfs
  Capability: åªæˆäºˆå¿…è¦æƒé™
  é•œåƒ: Distroless + é•œåƒç­¾å
  æ‰«æ: å®šæœŸæ¼æ´æ‰«æ
```

## 00.10 æ€§èƒ½ä¼˜åŒ–

### 00.10.1 æ„å»ºä¼˜åŒ–

| ä¼˜åŒ–ç‚¹         | æ–¹æ³•                  | æ•ˆæœ         |
| -------------- | --------------------- | ------------ |
| **æ„å»ºç¼“å­˜**   | åˆç†é¡ºåºçš„ Dockerfile | åŠ é€Ÿæ„å»º     |
| **å¹¶è¡Œæ„å»º**   | BuildKit å¹¶è¡Œé˜¶æ®µ     | å‡å°‘æ„å»ºæ—¶é—´ |
| **æ„å»ºä¸Šä¸‹æ–‡** | .dockerignore         | å‡å°ä¸Šä¼ å¤§å° |
| **å¤šé˜¶æ®µæ„å»º** | åªå¤åˆ¶å¿…è¦æ–‡ä»¶        | å‡å°æœ€ç»ˆé•œåƒ |

**æ„å»ºä¼˜åŒ–è®ºè¯**ï¼š

- **æ„å»ºç¼“å­˜**ï¼šåˆç†é¡ºåºçš„ Dockerfile å¯ä»¥æœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­ç‡
- **å¹¶è¡Œæ„å»º**ï¼šBuildKit æ”¯æŒå¹¶è¡Œæ„å»ºå¤šä¸ªé˜¶æ®µ
- **æ„å»ºä¸Šä¸‹æ–‡**ï¼š.dockerignore æ’é™¤æ— å…³æ–‡ä»¶ï¼Œå‡å°ä¸Šä¼ å¤§å°
- **å¤šé˜¶æ®µæ„å»º**ï¼šåªå¤åˆ¶å¿…è¦æ–‡ä»¶ï¼Œå‡å°æœ€ç»ˆé•œåƒä½“ç§¯

### 00.10.2 è¿è¡Œæ—¶ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹       | æ–¹æ³•             | æ•ˆæœ         |
| ------------ | ---------------- | ------------ |
| **èµ„æºé™åˆ¶** | --memory, --cpus | é¿å…èµ„æºç«äº‰ |
| **å­˜å‚¨é©±åŠ¨** | overlay2         | æœ€ä½³æ€§èƒ½     |
| **ç½‘ç»œæ¨¡å¼** | hostï¼ˆå¦‚é€‚ç”¨ï¼‰   | å‡å°‘å»¶è¿Ÿ     |

**è¿è¡Œæ—¶ä¼˜åŒ–è®ºè¯**ï¼š

- **èµ„æºé™åˆ¶**ï¼šé™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨ï¼Œé¿å…èµ„æºç«äº‰
- **å­˜å‚¨é©±åŠ¨**ï¼šoverlay2 æ€§èƒ½æœ€å¥½ï¼Œæ¨èä½¿ç”¨
- **ç½‘ç»œæ¨¡å¼**ï¼šhost æ¨¡å¼å‡å°‘ NAT å¼€é”€ï¼Œæ€§èƒ½æœ€å¥½

### 00.10.3 æ€§èƒ½åœºæ™¯ä¸å†³ç­–

**åœºæ™¯ 1ï¼šæ„å»ºæ€§èƒ½ä¼˜åŒ–**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ„å»ºé€Ÿåº¦å…³é”®
- âœ… ç¼“å­˜åˆ©ç”¨é‡è¦

**å†³ç­–æ€è·¯**ï¼š

```yaml
æ„å»ºæ€§èƒ½ä¼˜åŒ–:
  å·¥å…·: BuildKit
  ç­–ç•¥: åˆ†å±‚ç¼“å­˜ + å¹¶è¡Œæ„å»º
  Dockerfile: ä¼˜åŒ–å±‚é¡ºåº
  æ•ˆæœ: æ„å»ºæ—¶é—´å‡å°‘ 50-70%
```

**åœºæ™¯ 2ï¼šè¿è¡Œæ€§èƒ½ä¼˜åŒ–**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… è¿è¡Œæ€§èƒ½è¦æ±‚é«˜
- âœ… èµ„æºå—é™

**å†³ç­–æ€è·¯**ï¼š

```yaml
è¿è¡Œæ€§èƒ½ä¼˜åŒ–:
  å­˜å‚¨é©±åŠ¨: overlay2
  ç½‘ç»œæ¨¡å¼: hostï¼ˆå¦‚é€‚ç”¨ï¼‰
  èµ„æºé™åˆ¶: ç²¾ç¡®è®¾ç½®
  æ•ˆæœ: æ€§èƒ½æå‡ 20-30%
```

**åœºæ™¯ 3ï¼šé•œåƒä½“ç§¯ä¼˜åŒ–**:

**å†³ç­–ä¾æ®**ï¼š

- âœ… é•œåƒä½“ç§¯å…³é”®
- âœ… æ‹‰å–é€Ÿåº¦é‡è¦

**å†³ç­–æ€è·¯**ï¼š

```yaml
é•œåƒä½“ç§¯ä¼˜åŒ–:
  åŸºç¡€é•œåƒ: Distroless/Scratch
  æ„å»ºæ–¹å¼: å¤šé˜¶æ®µæ„å»º
  å±‚ä¼˜åŒ–: åˆå¹¶å±‚ã€å‡å°‘å±‚æ•°
  æ•ˆæœ: é•œåƒä½“ç§¯å‡å°‘ 80-90%
```

## 00.11 æŠ€æœ¯åœºæ™¯åˆ†æ

### 00.11.1 å¼€å‘ç¯å¢ƒåœºæ™¯

**åœºæ™¯æè¿°**ï¼šæœ¬åœ°å¼€å‘éœ€è¦å¿«é€Ÿè¿­ä»£å’Œè°ƒè¯•

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **æ„å»ºé€Ÿåº¦**ï¼šéœ€è¦å¿«é€Ÿæ„å»ºå’Œå¯åŠ¨
2. **è°ƒè¯•èƒ½åŠ›**ï¼šéœ€è¦è°ƒè¯•å·¥å…·å’Œæ—¥å¿—
3. **å¼€å‘æ•ˆç‡**ï¼šéœ€è¦çƒ­é‡è½½å’Œå®æ—¶åŒæ­¥

**æ¶æ„å†³ç­–**ï¼š

```yaml
å¼€å‘ç¯å¢ƒé…ç½®:
  åŸºç¡€é•œåƒ: å®Œæ•´åŸºç¡€é•œåƒï¼ˆalpine/nodeï¼‰
  æ„å»ºæ–¹å¼: å•é˜¶æ®µæ„å»º
  æ•°æ®ç®¡ç†: Bind Mountï¼ˆä»£ç å®æ—¶åŒæ­¥ï¼‰
  å®‰å…¨é…ç½®: é»˜è®¤é…ç½®ï¼ˆroot ç”¨æˆ·ï¼‰
  ç½‘ç»œæ¨¡å¼: Bridgeï¼ˆé»˜è®¤ï¼‰
  ä¼˜åŒ–ç›®æ ‡: å¼€å‘æ•ˆç‡ > ä½“ç§¯ > æ€§èƒ½
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å¼€å‘æ•ˆç‡ä¼˜å…ˆï¼šå¿«é€Ÿè¿­ä»£æ¯”ä½“ç§¯ä¼˜åŒ–æ›´é‡è¦
- âœ… è°ƒè¯•èƒ½åŠ›ï¼šéœ€è¦å®Œæ•´çš„å·¥å…·é“¾
- âœ… å®æ—¶åŒæ­¥ï¼šBind Mount å®ç°ä»£ç å®æ—¶åŒæ­¥

### 00.11.2 ç”Ÿäº§ç¯å¢ƒåœºæ™¯

**åœºæ™¯æè¿°**ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦å®‰å…¨ã€ç¨³å®šã€é«˜æ€§èƒ½

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **å®‰å…¨æ€§**ï¼šæœ€å°æ”»å‡»é¢ã€é•œåƒç­¾åã€æ¼æ´æ‰«æ
2. **ç¨³å®šæ€§**ï¼šèµ„æºé™åˆ¶ã€å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨é‡å¯
3. **æ€§èƒ½**ï¼šå­˜å‚¨é©±åŠ¨ã€ç½‘ç»œæ¨¡å¼ã€èµ„æºä¼˜åŒ–

**æ¶æ„å†³ç­–**ï¼š

```yaml
ç”Ÿäº§ç¯å¢ƒé…ç½®:
  åŸºç¡€é•œåƒ: Distroless/Scratch
  æ„å»ºæ–¹å¼: å¤šé˜¶æ®µæ„å»º
  æ•°æ®ç®¡ç†: Volumeï¼ˆæŒä¹…åŒ–ï¼‰
  å®‰å…¨é…ç½®: æœ€å°æƒé™ï¼ˆé root + åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼‰
  ç½‘ç»œæ¨¡å¼: Bridgeï¼ˆé»˜è®¤ï¼‰æˆ– Hostï¼ˆæ€§èƒ½æ•æ„Ÿï¼‰
  é•œåƒç­¾å: å¿…é¡»ç­¾å
  æ¼æ´æ‰«æ: å®šæœŸæ‰«æ
  ä¼˜åŒ–ç›®æ ‡: å®‰å…¨ > æ€§èƒ½ > ä½“ç§¯
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… å®‰å…¨ä¼˜å…ˆï¼šæœ€å°æƒé™ã€é•œåƒç­¾åã€æ¼æ´æ‰«æ
- âœ… ç¨³å®šæ€§ï¼šèµ„æºé™åˆ¶ã€å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨é‡å¯
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šoverlay2ã€host ç½‘ç»œï¼ˆå¦‚é€‚ç”¨ï¼‰

### 00.11.3 CI/CD åœºæ™¯

**åœºæ™¯æè¿°**ï¼šCI/CD éœ€è¦å¿«é€Ÿæ„å»ºå’Œå¯é‡å¤æ€§

**æ¶æ„æŒ‘æˆ˜**ï¼š

1. **æ„å»ºé€Ÿåº¦**ï¼šå¹¶è¡Œæ„å»ºã€ç¼“å­˜åˆ©ç”¨
2. **å¯é‡å¤æ€§**ï¼šå›ºå®šç‰ˆæœ¬ã€ç¼“å­˜ç­–ç•¥
3. **èµ„æºæ•ˆç‡**ï¼šæ„å»ºèµ„æºä¼˜åŒ–

**æ¶æ„å†³ç­–**ï¼š

```yaml
CI/CD é…ç½®:
  æ„å»ºå·¥å…·: BuildKitï¼ˆå¹¶è¡Œæ„å»ºï¼‰
  ç¼“å­˜ç­–ç•¥: åˆ†å±‚ç¼“å­˜ + æ„å»ºç¼“å­˜
  å¤šé˜¶æ®µæ„å»º: å¿…é¡»ä½¿ç”¨
  æ„å»ºä¸Šä¸‹æ–‡: .dockerignore ä¼˜åŒ–
  ç‰ˆæœ¬å›ºå®š: åŸºç¡€é•œåƒç‰ˆæœ¬å›ºå®š
  ä¼˜åŒ–ç›®æ ‡: æ„å»ºé€Ÿåº¦ > å¯é‡å¤æ€§ > ä½“ç§¯
```

**å†³ç­–ä¾æ®**ï¼š

- âœ… æ„å»ºé€Ÿåº¦ï¼šå¹¶è¡Œæ„å»ºã€ç¼“å­˜åˆ©ç”¨
- âœ… å¯é‡å¤æ€§ï¼šå›ºå®šç‰ˆæœ¬ã€ç¼“å­˜ç­–ç•¥
- âœ… èµ„æºæ•ˆç‡ï¼šæ„å»ºèµ„æºä¼˜åŒ–

## 00.12 å†³ç­–ä¾æ®ä¸æ€è·¯

### 00.12.1 å­˜å‚¨é©±åŠ¨é€‰æ‹©å†³ç­–æ ‘

```yaml
å­˜å‚¨é©±åŠ¨é€‰æ‹©:
  if å†…æ ¸æ”¯æŒ overlay2: é€‰æ‹© overlay2ï¼ˆæ¨èï¼‰
  elif éœ€è¦å¿«ç…§: é€‰æ‹© btrfs
  elif ç”Ÿäº§ç¯å¢ƒ: é€‰æ‹© devicemapperï¼ˆéœ€é…ç½®ï¼‰
  else: é€‰æ‹© overlay2ï¼ˆé»˜è®¤ï¼‰
```

### 00.12.2 ç½‘ç»œé©±åŠ¨é€‰æ‹©å†³ç­–æ ‘

```yaml
ç½‘ç»œé©±åŠ¨é€‰æ‹©:
  if æ€§èƒ½æ•æ„Ÿ and ä¸éœ€è¦ç½‘ç»œéš”ç¦»: é€‰æ‹© Host
  elif Swarm é›†ç¾¤: é€‰æ‹© Overlay
  elif è‡ªå®šä¹‰ç½‘ç»œ: é€‰æ‹© None
  else: é€‰æ‹© Bridgeï¼ˆé»˜è®¤ï¼‰
```

### 00.12.3 æ•°æ®ç®¡ç†é€‰æ‹©å†³ç­–æ ‘

```yaml
æ•°æ®ç®¡ç†é€‰æ‹©:
  if éœ€è¦æŒä¹…åŒ– and ç”Ÿäº§ç¯å¢ƒ: é€‰æ‹© Volume
  elif å¼€å‘ç¯å¢ƒ and éœ€è¦å®æ—¶åŒæ­¥: é€‰æ‹© Bind Mount
  elif ä¸´æ—¶æ•°æ® and æ€§èƒ½è¦æ±‚é«˜: é€‰æ‹© tmpfs
  else: é€‰æ‹© Volumeï¼ˆé»˜è®¤ï¼‰
```

### 00.12.4 æ„å»ºç­–ç•¥é€‰æ‹©å†³ç­–æ ‘

```yaml
æ„å»ºç­–ç•¥é€‰æ‹©:
  if ç”Ÿäº§ç¯å¢ƒ: å¤šé˜¶æ®µæ„å»º + Distroless
  elif CI/CD: BuildKit + å¤šé˜¶æ®µæ„å»º + ç¼“å­˜
  elif å¼€å‘ç¯å¢ƒ: å•é˜¶æ®µæ„å»º + å®Œæ•´åŸºç¡€é•œåƒ
  else: å¤šé˜¶æ®µæ„å»ºï¼ˆé»˜è®¤ï¼‰
```

## 00.13 å½¢å¼åŒ–æ€»ç»“

### 00.13.1 Docker æ¶æ„æ¨¡å‹å½¢å¼åŒ–

è®¾ Docker æ¶æ„ä¸º $D = \{C, D, R\}$ï¼Œå…¶ä¸­ï¼š

- $C$ = æ§åˆ¶è·¯å¾„ï¼ˆControl Pathï¼‰
- $D$ = æ•°æ®å­˜å‚¨ï¼ˆData Storageï¼‰
- $R$ = è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰

**Docker æ¶æ„**ï¼š
$$D = \{docker-cli \rightarrow dockerd \rightarrow containerd \rightarrow shim \rightarrow runc, overlay2, runc\}$$

### 00.13.2 é•œåƒä½“ç§¯æ¨¡å‹

**é•œåƒä½“ç§¯å‡½æ•°**ï¼š $$V(I) = V(\text{base}) + \sum_{i=1}^{n} V(L_i)$$

å…¶ä¸­ï¼š

- $V(I)$ = é•œåƒä½“ç§¯
- $V(\text{base})$ = åŸºç¡€é•œåƒä½“ç§¯
- $V(L_i)$ = ç¬¬ $i$ å±‚ä½“ç§¯
- $n$ = å±‚æ•°

**ä¼˜åŒ–ç›®æ ‡**ï¼š
$$\min_{I} V(I) = \min_{I} \left(V(\text{base}) + \sum_{i=1}^{n} V(L_i)\right)$$

### 00.13.3 æ„å»ºæ€§èƒ½æ¨¡å‹

**æ„å»ºæ—¶é—´å‡½æ•°**ï¼š
$$T(B) = T(\text{download}) + T(\text{build}) + T(\text{upload})$$

å…¶ä¸­ï¼š

- $T(B)$ = æ€»æ„å»ºæ—¶é—´
- $T(\text{download})$ = æ‹‰å–åŸºç¡€é•œåƒæ—¶é—´
- $T(\text{build})$ = æ„å»ºæ—¶é—´ï¼ˆå—ç¼“å­˜å½±å“ï¼‰
- $T(\text{upload})$ = æ¨é€é•œåƒæ—¶é—´

**ä¼˜åŒ–ç›®æ ‡**ï¼š
$$\min_{B} T(B) = \min_{B} \left(T(\text{download}) + T(\text{build}) + T(\text{upload})\right)$$

### 00.13.4 ç¼“å­˜å‘½ä¸­ç‡æ¨¡å‹

**ç¼“å­˜å‘½ä¸­ç‡**ï¼š $$H(C) = \frac{\text{ç¼“å­˜å‘½ä¸­çš„å±‚æ•°}}{\text{æ€»å±‚æ•°}}$$

**ä¼˜åŒ–ç›®æ ‡**ï¼š $$\max_{C} H(C)$$

**å®ç°æ–¹æ³•**ï¼š

- ç¨³å®šå±‚åœ¨åº•å±‚
- å˜åŒ–å±‚åœ¨é¡¶å±‚
- åˆç†é¡ºåºçš„ Dockerfile

## 00.14 å®é™…éƒ¨ç½²æ¡ˆä¾‹

### 00.14.1 æ¡ˆä¾‹ 1ï¼šå¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒ

**åœºæ™¯**ï¼šæ„å»ºä¸€ä¸ª Go Web åº”ç”¨ï¼Œä¼˜åŒ–é•œåƒä½“ç§¯

**ä¼˜åŒ–å‰ Dockerfile**ï¼š

```dockerfile
FROM golang:1.21
WORKDIR /app
COPY . .
RUN go build -o app .
CMD ["./app"]
```

**ä¼˜åŒ–å Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰**ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM golang:1.21 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o app .

# è¿è¡Œé˜¶æ®µ
FROM distroless/base:nonroot
WORKDIR /app
COPY --from=builder /app/app .
USER nonroot:nonroot
CMD ["./app"]
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š

- **é•œåƒä½“ç§¯**ï¼šä» ~800MB å‡å°‘åˆ° ~20MBï¼ˆå‡å°‘ 97.5%ï¼‰
- **å®‰å…¨æ€§**ï¼šä½¿ç”¨ distroless åŸºç¡€é•œåƒï¼Œæœ€å°æ”»å‡»é¢
- **æƒé™**ï¼šä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ

### 00.14.2 æ¡ˆä¾‹ 2ï¼šDocker Compose å¤šå®¹å™¨åº”ç”¨

**åœºæ™¯**ï¼šéƒ¨ç½²åŒ…å« Web åº”ç”¨ã€æ•°æ®åº“å’Œ Redis çš„å®Œæ•´åº”ç”¨æ ˆ

**docker-compose.yml**ï¼š

```yaml
version: "3.8"

services:
  web:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://db:5432/myapp
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    networks:
      - app-network
    volumes:
      - app-data:/app/data

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=myapp
      - POSTGRES_USER=myapp
      - POSTGRES_PASSWORD=secret
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - app-network

volumes:
  app-data:
  postgres-data:
  redis-data:

networks:
  app-network:
    driver: bridge
```

**éƒ¨ç½²å‘½ä»¤**ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f web

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down
```

### 00.14.3 æ¡ˆä¾‹ 3ï¼šDocker ç½‘ç»œé…ç½®

**åœºæ™¯**ï¼šé…ç½®è‡ªå®šä¹‰ç½‘ç»œï¼Œå®ç°å®¹å™¨é—´é€šä¿¡å’Œç½‘ç»œéš”ç¦»

**åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ**ï¼š

```bash
# åˆ›å»º bridge ç½‘ç»œ
docker network create --driver bridge \
  --subnet=172.20.0.0/16 \
  --gateway=172.20.0.1 \
  my-network

# åˆ›å»º overlay ç½‘ç»œï¼ˆSwarm æ¨¡å¼ï¼‰
docker network create --driver overlay \
  --attachable \
  my-overlay-network
```

**ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œ**ï¼š

```bash
# è¿è¡Œå®¹å™¨å¹¶è¿æ¥åˆ°ç½‘ç»œ
docker run -d --name app1 \
  --network my-network \
  nginx:alpine

docker run -d --name app2 \
  --network my-network \
  nginx:alpine

# å®¹å™¨é—´å¯ä»¥é€šè¿‡å®¹å™¨åé€šä¿¡
docker exec app1 ping app2
```

## 00.15 Docker ç»¼åˆæœ€ä½³å®è·µ

### 00.15.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ

**é•œåƒç®¡ç†**ï¼š

- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒä½“ç§¯
- âœ… ä½¿ç”¨ distroless æˆ– scratch åŸºç¡€é•œåƒ
- âœ… å›ºå®šåŸºç¡€é•œåƒç‰ˆæœ¬ï¼ˆé¿å…ä½¿ç”¨ latestï¼‰
- âœ… å®šæœŸæ›´æ–°åŸºç¡€é•œåƒå’Œå®‰å…¨è¡¥ä¸

**å®‰å…¨é…ç½®**ï¼š

- âœ… ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨
- âœ… è®¾ç½®åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆread-only root filesystemï¼‰
- âœ… é™åˆ¶å®¹å™¨èƒ½åŠ›ï¼ˆcapabilitiesï¼‰
- âœ… ä½¿ç”¨é•œåƒç­¾åéªŒè¯ï¼ˆDocker Content Trustï¼‰
- âœ… å®šæœŸæ‰«æé•œåƒæ¼æ´

**èµ„æºç®¡ç†**ï¼š

- âœ… ä¸ºå®¹å™¨è®¾ç½® CPU å’Œå†…å­˜é™åˆ¶
- âœ… ä½¿ç”¨å¥åº·æ£€æŸ¥ï¼ˆhealthcheckï¼‰
- âœ… é…ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥
- âœ… ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ

**æ•°æ®ç®¡ç†**ï¼š

- âœ… ä½¿ç”¨å‘½åå·ï¼ˆnamed volumesï¼‰ç®¡ç†æ•°æ®
- âœ… å®šæœŸå¤‡ä»½é‡è¦æ•°æ®
- âœ… é¿å…ä½¿ç”¨ Bind Mountï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… ä½¿ç”¨ tmpfs å­˜å‚¨ä¸´æ—¶æ•°æ®

### 00.15.2 Docker æ£€æŸ¥æ¸…å•

**é•œåƒæ„å»ºæ£€æŸ¥**ï¼š

- [ ] ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] åŸºç¡€é•œåƒç‰ˆæœ¬å›ºå®šï¼ˆä¸ä½¿ç”¨ latestï¼‰
- [ ] é•œåƒä½“ç§¯åˆç†ï¼ˆ< 500MB ä¼˜å…ˆï¼‰
- [ ] ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
- [ ] Dockerfile å±‚é¡ºåºåˆç†ï¼ˆç¨³å®šå±‚åœ¨åº•å±‚ï¼‰
- [ ] å‡å°‘å±‚æ•°ï¼ˆåˆå¹¶ RUN å‘½ä»¤ï¼‰

**å®‰å…¨é…ç½®æ£€æŸ¥**ï¼š

- [ ] ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨
- [ ] è®¾ç½®åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] é™åˆ¶å®¹å™¨èƒ½åŠ›ï¼ˆcapabilitiesï¼‰
- [ ] é•œåƒå·²ç­¾åï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] é•œåƒå·²æ‰«ææ¼æ´
- [ ] ä¸ä½¿ç”¨ç‰¹æƒæ¨¡å¼ï¼ˆprivilegedï¼‰

**è¿è¡Œæ—¶é…ç½®æ£€æŸ¥**ï¼š

- [ ] CPU å’Œå†…å­˜é™åˆ¶å·²è®¾ç½®
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] è‡ªåŠ¨é‡å¯ç­–ç•¥å·²è®¾ç½®
- [ ] æ—¥å¿—é…ç½®åˆç†ï¼ˆæ—¥å¿—é©±åŠ¨ã€æ—¥å¿—å¤§å°é™åˆ¶ï¼‰
- [ ] ç½‘ç»œé…ç½®æ­£ç¡®ï¼ˆç½‘ç»œæ¨¡å¼ã€ç«¯å£æ˜ å°„ï¼‰
- [ ] æ•°æ®å·é…ç½®æ­£ç¡®ï¼ˆVolume æˆ– Bind Mountï¼‰

**ç›‘æ§å’Œç»´æŠ¤æ£€æŸ¥**ï¼š

- [ ] ç›‘æ§å·¥å…·å·²é…ç½®ï¼ˆå¦‚ Prometheusï¼‰
- [ ] æ—¥å¿—æ”¶é›†å·²é…ç½®ï¼ˆå¦‚ ELK Stackï¼‰
- [ ] å¤‡ä»½ç­–ç•¥å·²åˆ¶å®š
- [ ] æ›´æ–°ç­–ç•¥å·²åˆ¶å®š
- [ ] ç¾éš¾æ¢å¤è®¡åˆ’å·²åˆ¶å®š

---

## 00.16 Docker æ•…éšœæ’æŸ¥

### 00.16.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šå®¹å™¨æ— æ³•å¯åŠ¨**:

```bash
# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker logs <container-id>

# æ£€æŸ¥å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect <container-id>

# æ£€æŸ¥ Docker daemon æ—¥å¿—
journalctl -u docker -f

# æ£€æŸ¥å®¹å™¨å¯åŠ¨å‘½ä»¤
docker run --rm <image> <command>
```

**é—®é¢˜ 2ï¼šé•œåƒæ„å»ºå¤±è´¥**:

```bash
# æ£€æŸ¥æ„å»ºæ—¥å¿—
docker build --progress=plain -t test:latest .

# ä½¿ç”¨ --no-cache é‡æ–°æ„å»º
docker build --no-cache -t test:latest .

# æ£€æŸ¥ Dockerfile è¯­æ³•
docker build --target builder -t test:latest .

# æ£€æŸ¥æ„å»ºä¸Šä¸‹æ–‡
docker build --progress=plain -f Dockerfile .
```

**é—®é¢˜ 3ï¼šå®¹å™¨æ— æ³•è®¿é—®ç½‘ç»œ**:

```bash
# æ£€æŸ¥å®¹å™¨ç½‘ç»œé…ç½®
docker inspect <container-id> | grep -A 20 NetworkSettings

# æ£€æŸ¥ Docker ç½‘ç»œ
docker network ls
docker network inspect <network-name>

# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
iptables -L -n | grep DOCKER

# æµ‹è¯•å®¹å™¨é—´é€šä¿¡
docker exec <container-id> ping <other-container>
```

**é—®é¢˜ 4ï¼šå®¹å™¨ç£ç›˜ç©ºé—´ä¸è¶³**:

```bash
# æ£€æŸ¥ Docker ç£ç›˜ä½¿ç”¨
docker system df

# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune -a

# æ£€æŸ¥ç‰¹å®šå®¹å™¨ç£ç›˜ä½¿ç”¨
docker exec <container-id> df -h

# æ£€æŸ¥é•œåƒå’Œå®¹å™¨å¤§å°
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
docker ps -a --format "table {{.Names}}\t{{.Size}}"
```

**é—®é¢˜ 5ï¼šå®¹å™¨æ€§èƒ½é—®é¢˜**:

```bash
# æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats <container-id>

# æ£€æŸ¥å®¹å™¨è¿›ç¨‹
docker top <container-id>

# æ£€æŸ¥å­˜å‚¨é©±åŠ¨æ€§èƒ½
docker info | grep -i storage

# æ£€æŸ¥ç½‘ç»œæ€§èƒ½
docker exec <container-id> iperf3 -c <target>
```

---

## 00.17 å‚è€ƒ

### 00.17.1 éš”ç¦»æ ˆç›¸å…³æ–‡æ¡£

- **[29. éš”ç¦»æ ˆ](../29-isolation-stack/isolation-stack.md)** - å®Œæ•´çš„éš”ç¦»æ ˆæŠ€æœ¯
  è§£æï¼ŒåŒ…æ‹¬ Docker å’Œ runc
- **[L-3 å®¹å™¨åŒ–å±‚](../29-isolation-stack/layers/L-3-containerization.md)** -
  runcã€containerdã€Docker è¯¦ç»†æ–‡æ¡£
- **[éš”ç¦»å±‚æ¬¡å¯¹æ¯”æ–‡æ¡£](../29-isolation-stack/layers/isolation-comparison.md)** -
  å®¹å™¨åŒ–å±‚æ€§èƒ½å¯¹æ¯”å’ŒæŠ€æœ¯é€‰å‹

### 00.17.2 Docker ç›¸å…³æ–‡æ¡£

- **[01. Kubernetes](../01-kubernetes/kubernetes.md)** - Kubernetes æ¶æ„ä¸å®è·µ
- **[04. ç¼–æ’è¿è¡Œæ—¶](../04-orchestration-runtime/orchestration-runtime.md)** -
  CRI å’Œ RuntimeClass é…ç½®

### 00.17.3 å…¶ä»–ç›¸å…³æ–‡æ¡£

- **[10. æŠ€æœ¯å†³ç­–æ¨¡å‹](../../COGNITIVE/10-decision-models/decision-models.md)** -
  æŠ€æœ¯é€‰å‹å†³ç­–æ¡†æ¶
- **[10. å¿«é€Ÿå‚è€ƒæŒ‡å—](../../COGNITIVE/10-decision-models/QUICK-REFERENCE.md)** -
  è®¾å¤‡è®¿é—®ï¼ˆUSB/PCI/GPUï¼‰å’Œå†…æ ¸ç‰¹æ€§å†³ç­–å¿«é€Ÿå‚è€ƒ
- **[28. æ¶æ„æ¡†æ¶](../28-architecture-framework/architecture-framework.md)** -
  å¤šç»´åº¦æ¶æ„ä½“ç³»ä¸æŠ€æœ¯è§„èŒƒ

### 00.17.4 å¤–éƒ¨å‚è€ƒ

[^docker-architecture]:
    [Docker Architecture](https://docs.docker.com/get-started/overview/)

[^docker-overlay2]:
    [Docker Storage Drivers](https://docs.docker.com/storage/storagedriver/)

[^docker-network]: [Docker Network](https://docs.docker.com/network/)

> å®Œæ•´å‚è€ƒåˆ—è¡¨è§ [REFERENCES.md](../REFERENCES.md)

---

**æœ€åæ›´æ–°**ï¼š2025-11-06 **ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
