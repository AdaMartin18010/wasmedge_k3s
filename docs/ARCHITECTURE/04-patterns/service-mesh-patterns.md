# Service Mesh æ¶æ„æ¨¡å¼

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [1.1 æ ¸å¿ƒæ€æƒ³](#11-æ ¸å¿ƒæ€æƒ³)
- [2. ç›®æ ‡ä¸å®šä¹‰](#2-ç›®æ ‡ä¸å®šä¹‰)
- [2. Service Mesh çš„æ ¸å¿ƒæ¨¡å¼](#2-service-mesh-çš„æ ¸å¿ƒæ¨¡å¼)
  - [2.1 Sidecar æ¨¡å¼](#21-sidecar-æ¨¡å¼)
  - [2.2 Control Plane æ¨¡å¼](#22-control-plane-æ¨¡å¼)
  - [2.3 Data Plane æ¨¡å¼](#23-data-plane-æ¨¡å¼)
- [3. Service Mesh çš„ç»„åˆæ¨¡å¼](#3-service-mesh-çš„ç»„åˆæ¨¡å¼)
  - [3.1 æµé‡è·¯ç”±æ¨¡å¼](#31-æµé‡è·¯ç”±æ¨¡å¼)
  - [3.2 ç†”æ–­æ¨¡å¼](#32-ç†”æ–­æ¨¡å¼)
  - [3.3 é‡è¯•æ¨¡å¼](#33-é‡è¯•æ¨¡å¼)
  - [3.4 è¶…æ—¶æ¨¡å¼](#34-è¶…æ—¶æ¨¡å¼)
  - [3.5 é™æµæ¨¡å¼](#35-é™æµæ¨¡å¼)
- [4. Service Mesh ä¸ NSM çš„ç»„åˆ](#4-service-mesh-ä¸-nsm-çš„ç»„åˆ)
  - [4.1 Service Mesh ä½œä¸º Network Service](#41-service-mesh-ä½œä¸º-network-service)
- [5. Service Mesh ä¸ OPA çš„ç»„åˆ](#5-service-mesh-ä¸-opa-çš„ç»„åˆ)
  - [5.1 ç­–ç•¥å³ä»£ç ](#51-ç­–ç•¥å³ä»£ç )
- [6. Service Mesh æœ€ä½³å®è·µ](#6-service-mesh-æœ€ä½³å®è·µ)
  - [6.1 æ€§èƒ½ä¼˜åŒ–](#61-æ€§èƒ½ä¼˜åŒ–)
  - [6.2 å®‰å…¨å¢å¼º](#62-å®‰å…¨å¢å¼º)
  - [6.3 å¯è§‚æµ‹æ€§](#63-å¯è§‚æµ‹æ€§)
- [7. æ€»ç»“](#7-æ€»ç»“)
  - [æ ¸å¿ƒä»·å€¼](#æ ¸å¿ƒä»·å€¼)
  - [ä¸€å¥è¯å½’çº³](#ä¸€å¥è¯å½’çº³)
- [9. å‚è€ƒèµ„æº](#9-å‚è€ƒèµ„æº)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°**Service Mesh æ¶æ„æ¨¡å¼**åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨ï¼ŒåŒ…æ‹¬
Sidecarã€Control Planeã€Data Plane ç­‰æ ¸å¿ƒæ¨¡å¼ã€‚

### 1.1 æ ¸å¿ƒæ€æƒ³

> **Service Mesh é€šè¿‡ sidecar æ¨¡å¼å°†ç½‘ç»œæ²»ç†ä»ä¸šåŠ¡ä»£ç ä¸­å‰¥ç¦»ï¼Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦»å’Œç»Ÿ
> ä¸€æ²»ç†**

---

## 2. ç›®æ ‡ä¸å®šä¹‰

**Service Mesh æ¶æ„æ¨¡å¼**æ˜¯åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œé€šè¿‡ç‹¬ç«‹çš„ä»£ç†å±‚ï¼ˆsidecarï¼‰å®ç°æœåŠ¡é—´
é€šä¿¡çš„æ²»ç†æ¨¡å¼ã€‚

> **æ ¸å¿ƒæ€æƒ³**ï¼šå°†æœåŠ¡é—´é€šä¿¡çš„å¤æ‚æ€§ï¼ˆå¦‚è´Ÿè½½å‡è¡¡ã€ç†”æ–­ã€é‡è¯•ã€å®‰å…¨ç­‰ï¼‰ä»ä¸šåŠ¡ä»£ç 
> ä¸­å‰¥ç¦»ï¼Œä¸‹æ²‰åˆ°ç‹¬ç«‹çš„ä»£ç†å±‚ï¼ˆsidecarï¼‰ï¼Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦»ã€‚

---

## 2. Service Mesh çš„æ ¸å¿ƒæ¨¡å¼

### 2.1 Sidecar æ¨¡å¼

**å®šä¹‰**ï¼šåœ¨æ¯ä¸ªæœåŠ¡å®ä¾‹æ—è¾¹éƒ¨ç½²ä¸€ä¸ªä»£ç†å®¹å™¨ï¼ˆsidecarï¼‰ï¼Œè´Ÿè´£å¤„ç†è¯¥æœåŠ¡çš„æ‰€æœ‰ç½‘
ç»œé€šä¿¡ã€‚

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Business Pod   â”‚
â”‚  (Service A)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ localhost
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidecar Proxy  â”‚
â”‚  (Envoy)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    Network Layer
```

**ä¼˜åŠ¿**ï¼š

- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šä¸šåŠ¡ä»£ç ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œç½‘ç»œæ²»ç†ç”± sidecar è´Ÿè´£
- **è¯­è¨€æ— å…³**ï¼šsidecar å¯ä»¥ä»£ç†ä»»ä½•è¯­è¨€ç¼–å†™çš„æœåŠ¡
- **ç»Ÿä¸€æ²»ç†**ï¼šæ‰€æœ‰æœåŠ¡çš„ç½‘ç»œé€šä¿¡éƒ½é€šè¿‡ç»Ÿä¸€çš„ä»£ç†å±‚

### 2.2 Control Plane æ¨¡å¼

**å®šä¹‰**ï¼šé€šè¿‡æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ sidecar çš„é…ç½®å’Œç­–ç•¥ã€‚

```text
Control Plane (Istio)
    â”œâ”€ Pilot (æœåŠ¡å‘ç°)
    â”œâ”€ Citadel (å®‰å…¨)
    â”œâ”€ Galley (é…ç½®ç®¡ç†)
    â””â”€ Telemetry (é¥æµ‹)
         â”‚
         â–¼
    Data Plane (Envoy Sidecars)
```

**ä¼˜åŠ¿**ï¼š

- **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰é…ç½®å’Œç­–ç•¥åœ¨æ§åˆ¶å¹³é¢ç»Ÿä¸€ç®¡ç†
- **åŠ¨æ€æ›´æ–°**ï¼šé…ç½®å˜æ›´å¯ä»¥åŠ¨æ€æ¨é€åˆ°æ‰€æœ‰ sidecar
- **ç»Ÿä¸€ç›‘æ§**ï¼šæ‰€æœ‰æœåŠ¡çš„æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ªç»Ÿä¸€æ”¶é›†

### 2.3 Data Plane æ¨¡å¼

**å®šä¹‰**ï¼šæ•°æ®å¹³é¢ï¼ˆData Planeï¼‰ç”±æ‰€æœ‰ sidecar ä»£ç†ç»„æˆï¼Œè´Ÿè´£å®é™…çš„æ•°æ®è½¬å‘å’Œå¤„
ç†ã€‚

```text
Service A â”€â”€> Sidecar A â”€â”€> Sidecar B â”€â”€> Service B
              â”‚                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (mTLS, è·¯ç”±, ç†”æ–­)
```

**ä¼˜åŠ¿**ï¼š

- **é«˜æ€§èƒ½**ï¼šæ•°æ®å¹³é¢å¤„ç†å®é™…æµé‡ï¼Œæ€§èƒ½å…³é”®
- **å¯æ‰©å±•**ï¼šæ¯ä¸ªæœåŠ¡å®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„ sidecarï¼Œå¯ä»¥ç‹¬ç«‹æ‰©å±•
- **å¯è§‚æµ‹**ï¼šæ¯ä¸ª sidecar éƒ½å¯ä»¥æ”¶é›†è¯¦ç»†çš„ç½‘ç»œæŒ‡æ ‡

---

## 3. Service Mesh çš„ç»„åˆæ¨¡å¼

### 3.1 æµé‡è·¯ç”±æ¨¡å¼

**å®šä¹‰**ï¼šé€šè¿‡ VirtualService å’Œ DestinationRule å®šä¹‰æœåŠ¡é—´çš„è·¯ç”±è§„åˆ™ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: orders
spec:
  hosts:
    - orders
  http:
    - match:
        - headers:
            x-canary:
              exact: "1"
      route:
        - destination:
            host: orders
            subset: v2
          weight: 100
    - route:
        - destination:
            host: orders
            subset: v1
          weight: 90
        - destination:
            host: orders
            subset: v2
          weight: 10
```

**åº”ç”¨åœºæ™¯**ï¼š

- **é‡‘ä¸é›€å‘å¸ƒ**ï¼šé€æ­¥å°†æµé‡åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
- **A/B æµ‹è¯•**ï¼šæ ¹æ®ç”¨æˆ·ç‰¹å¾è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬
- **è“ç»¿éƒ¨ç½²**ï¼šå¿«é€Ÿåˆ‡æ¢ç‰ˆæœ¬

### 3.2 ç†”æ–­æ¨¡å¼

**å®šä¹‰**ï¼šå½“æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œè‡ªåŠ¨åœæ­¢å‘è¯¥æœåŠ¡å‘é€è¯·æ±‚ï¼Œé¿å…æ•…éšœä¼ æ’­ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: orders
spec:
  host: orders
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        http2MaxRequests: 10
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
```

**åº”ç”¨åœºæ™¯**ï¼š

- **æ•…éšœéš”ç¦»**ï¼šé˜²æ­¢æ•…éšœæœåŠ¡å½±å“æ•´ä¸ªç³»ç»Ÿ
- **é™çº§å¤„ç†**ï¼šå½“æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè¿”å›é»˜è®¤å“åº”
- **è‡ªåŠ¨æ¢å¤**ï¼šå½“æœåŠ¡æ¢å¤åï¼Œè‡ªåŠ¨æ¢å¤æµé‡

### 3.3 é‡è¯•æ¨¡å¼

**å®šä¹‰**ï¼šå½“è¯·æ±‚å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨é‡è¯•ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: orders
spec:
  hosts:
    - orders
  http:
    - route:
        - destination:
            host: orders
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: "5xx,reset"
```

**åº”ç”¨åœºæ™¯**ï¼š

- **ä¸´æ—¶æ•…éšœå¤„ç†**ï¼šå¤„ç†ç½‘ç»œæŠ–åŠ¨ã€æœåŠ¡é‡å¯ç­‰ä¸´æ—¶æ•…éšœ
- **å¹‚ç­‰æ€§ä¿è¯**ï¼šç¡®ä¿é‡å¤è¯·æ±‚ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
- **è¶…æ—¶æ§åˆ¶**ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…

### 3.4 è¶…æ—¶æ¨¡å¼

**å®šä¹‰**ï¼šè®¾ç½®è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: orders
spec:
  hosts:
    - orders
  http:
    - route:
        - destination:
            host: orders
      timeout: 10s
```

**åº”ç”¨åœºæ™¯**ï¼š

- **å“åº”æ—¶é—´æ§åˆ¶**ï¼šç¡®ä¿æœåŠ¡åœ¨åˆç†æ—¶é—´å†…å“åº”
- **èµ„æºé‡Šæ”¾**ï¼šé¿å…é•¿æ—¶é—´å ç”¨è¿æ¥èµ„æº
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…

### 3.5 é™æµæ¨¡å¼

**å®šä¹‰**ï¼šé™åˆ¶æ¯ä¸ªæœåŠ¡æˆ–ç”¨æˆ·çš„è¯·æ±‚é€Ÿç‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: orders
spec:
  hosts:
    - orders
  http:
    - route:
        - destination:
            host: orders
      fault:
        delay:
          percentage:
            value: 50
          fixedDelay: 5s
```

**åº”ç”¨åœºæ™¯**ï¼š

- **é˜²æ­¢è¿‡è½½**ï¼šé™åˆ¶è¯·æ±‚é€Ÿç‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
- **å…¬å¹³åˆ†é…**ï¼šç¡®ä¿æ‰€æœ‰ç”¨æˆ·å…¬å¹³ä½¿ç”¨èµ„æº
- **æˆæœ¬æ§åˆ¶**ï¼šé™åˆ¶èµ„æºä½¿ç”¨ï¼Œæ§åˆ¶æˆæœ¬

---

## 4. Service Mesh ä¸ NSM çš„ç»„åˆ

### 4.1 Service Mesh ä½œä¸º Network Service

**å®šä¹‰**ï¼šå°† Service Mesh æ³¨å†Œä¸º NSM çš„ Network Serviceï¼Œå®ç°è·¨åŸŸç½‘ç»œèšåˆã€‚

```text
Service Mesh (Istio)
    â”œâ”€ vL3 (è™šæ‹Ÿ L3 ç½‘ç»œ)
    â”œâ”€ Sidecar (Envoy)
    â””â”€ Control Plane (Istio)
         â”‚
         â–¼
    NSM (Network Service Mesh)
         â”‚
         â–¼
    vWire (è™šæ‹Ÿéš§é“)
         â”‚
         â–¼
    Endpoint (Pod/VM/Physical)
```

**åº”ç”¨åœºæ™¯**ï¼š

- **è·¨é›†ç¾¤é€šä¿¡**ï¼šä¸åŒ Kubernetes é›†ç¾¤é—´çš„æœåŠ¡é€šä¿¡
- **å¤šäº‘éƒ¨ç½²**ï¼šè·¨äº‘ç¯å¢ƒä¸‹çš„æœåŠ¡é€šä¿¡
- **æ··åˆäº‘**ï¼šæœ¬åœ°æ•°æ®ä¸­å¿ƒä¸äº‘ç¯å¢ƒé—´çš„æœåŠ¡é€šä¿¡

---

## 5. Service Mesh ä¸ OPA çš„ç»„åˆ

### 5.1 ç­–ç•¥å³ä»£ç 

**å®šä¹‰**ï¼šé€šè¿‡ OPA å®šä¹‰æœåŠ¡é—´çš„è®¿é—®ç­–ç•¥ï¼Œå®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ã€‚

```rego
package mesh.authz

default allow = false

allow {
    input.attributes.destination.principal == "spiffe://A/ns/default/sa/frontend"
    input.attributes.source.principal == "spiffe://B/ns/default/sa/backend"
    input.attributes.request.http.method == "GET"
    input.attributes.request.http.path == "/metrics"
}
```

**åº”ç”¨åœºæ™¯**ï¼š

- **ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼šåŸºäºæœåŠ¡èº«ä»½ã€HTTP æ–¹æ³•ã€è·¯å¾„ç­‰æ§åˆ¶è®¿é—®
- **åŠ¨æ€ç­–ç•¥æ›´æ–°**ï¼šç­–ç•¥å˜æ›´æ— éœ€é‡å¯æœåŠ¡
- **ç»Ÿä¸€ç­–ç•¥ç®¡ç†**ï¼šæ‰€æœ‰ç­–ç•¥åœ¨ OPA ä¸­é›†ä¸­ç®¡ç†

---

## 6. Service Mesh æœ€ä½³å®è·µ

### 6.1 æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–é¡¹     | æ–¹æ³•                       | è¯´æ˜         |
| ---------- | -------------------------- | ------------ |
| **è¿æ¥æ± ** | å¤ç”¨è¿æ¥ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€ | æé«˜ååé‡   |
| **HTTP/2** | ä½¿ç”¨ HTTP/2 å¤šè·¯å¤ç”¨       | å‡å°‘è¿æ¥æ•°   |
| **å‹ç¼©**   | å¯ç”¨ gzip å‹ç¼©             | å‡å°‘ç½‘ç»œä¼ è¾“ |
| **ç¼“å­˜**   | ç¼“å­˜å“åº”æ•°æ®               | å‡å°‘åç«¯è¯·æ±‚ |
| **é™æµ**   | é™åˆ¶è¯·æ±‚é€Ÿç‡               | é˜²æ­¢è¿‡è½½     |

### 6.2 å®‰å…¨å¢å¼º

| å®‰å…¨é¡¹       | æ–¹æ³•                        | è¯´æ˜         |
| ------------ | --------------------------- | ------------ |
| **mTLS**     | æœåŠ¡é—´é€šä¿¡ä½¿ç”¨ mTLS         | åŠ å¯†é€šä¿¡     |
| **èº«ä»½è®¤è¯** | ä½¿ç”¨ SPIFFE è¯ä¹¦            | æœåŠ¡èº«ä»½éªŒè¯ |
| **æˆæƒ**     | ä½¿ç”¨ OPA è¿›è¡Œç»†ç²’åº¦æƒé™æ§åˆ¶ | è®¿é—®æ§åˆ¶     |
| **å®¡è®¡**     | è®°å½•æ‰€æœ‰è®¿é—®æ—¥å¿—            | å®‰å…¨å®¡è®¡     |

### 6.3 å¯è§‚æµ‹æ€§

| å¯è§‚æµ‹é¡¹   | æ–¹æ³•                                | è¯´æ˜         |
| ---------- | ----------------------------------- | ------------ |
| **æŒ‡æ ‡**   | æ”¶é›†å»¶è¿Ÿã€é”™è¯¯ç‡ã€ååé‡ç­‰æŒ‡æ ‡      | Prometheus   |
| **æ—¥å¿—**   | æ”¶é›†è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—              | Loki         |
| **è¿½è¸ª**   | åˆ†å¸ƒå¼è¿½è¸ªè¯·æ±‚é“¾è·¯                  | Jaeger/Tempo |
| **å¯è§†åŒ–** | ä½¿ç”¨ Grafana å¯è§†åŒ–æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ª | Grafana      |

---

## 7. æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šä¸šåŠ¡ä»£ç ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œç½‘ç»œæ²»ç†ç”± Service Mesh è´Ÿè´£
2. **ç»Ÿä¸€æ²»ç†**ï¼šæ‰€æœ‰æœåŠ¡çš„ç½‘ç»œé€šä¿¡éƒ½é€šè¿‡ç»Ÿä¸€çš„ä»£ç†å±‚
3. **å¯è§‚æµ‹æ€§**ï¼šç»Ÿä¸€çš„æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ªæ”¶é›†
4. **å®‰å…¨æ€§**ï¼šmTLSã€èº«ä»½è®¤è¯ã€æˆæƒç­‰å®‰å…¨æœºåˆ¶

### ä¸€å¥è¯å½’çº³

> **Service Mesh é€šè¿‡ sidecar æ¨¡å¼å°†ç½‘ç»œæ²»ç†ä»ä¸šåŠ¡ä»£ç ä¸­å‰¥ç¦»ï¼Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦»å’Œç»Ÿ
> ä¸€æ²»ç†**ã€‚

---

## 9. å‚è€ƒèµ„æº

- **Istio**ï¼š<https://istio.io>
- **Linkerd**ï¼š<https://linkerd.io>
- **Envoy**ï¼š<https://www.envoyproxy.io>
- **Service Mesh æ¨¡
  å¼**ï¼š<https://www.oreilly.com/library/view/service-mesh-patterns/>
- **ç›¸å…³æ–‡æ¡£**ï¼š
  - `04-patterns/nsm-patterns.md` - NSM æ¨¡å¼
  - `04-patterns/opa-patterns.md` - OPA æ¨¡å¼
  - `03-service-mesh-nsm/` - Service Mesh å’Œ NSM è¯¦ç»†æ–‡æ¡£

---

**æ›´æ–°æ—¶é—´**ï¼š2025-11-04 **ç‰ˆæœ¬**ï¼šv1.0 **å‚è€ƒ**ï¼š`architecture_view.md` Service
Mesh æ¨¡å¼éƒ¨åˆ†
