# OPA ç­–ç•¥æ²»ç†ï¼šä»ç­–ç•¥å³ä»£ç åˆ°å¯è¯æ˜å®‰å…¨

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [1. æ ¸å¿ƒå‘½é¢˜](#1-æ ¸å¿ƒå‘½é¢˜)
  - [1.1 OPA åœ¨ â„³ æ¨¡å‹ä¸­çš„å®šä½](#11-opa-åœ¨-â„³-æ¨¡å‹ä¸­çš„å®šä½)
  - [1.2 å½¢å¼åŒ–æè¿°](#12-å½¢å¼åŒ–æè¿°)
- [2. å…¬ç†å±‚â€”â€”æŠŠ"å®‰å…¨"å½¢å¼åŒ–](#2-å…¬ç†å±‚æŠŠå®‰å…¨å½¢å¼åŒ–)
  - [2.1 åŸºç¡€å…¬ç†](#21-åŸºç¡€å…¬ç†)
- [3. åŸºç¡€å½’çº³æ­¥â€”â€”æ²¡æœ‰ OPA çš„æ—¶ä»£ï¼ˆn=0ï¼‰](#3-åŸºç¡€å½’çº³æ­¥æ²¡æœ‰-opa-çš„æ—¶ä»£n0)
  - [3.1 ç³»ç»Ÿ Î£â‚€](#31-ç³»ç»Ÿ-Ïƒ)
  - [3.2 é—®é¢˜åˆ†æ](#32-é—®é¢˜åˆ†æ)
  - [3.3 ç»“è®º](#33-ç»“è®º)
- [4. ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™](#4-ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„æŠŠå®‰å…¨å˜æˆæ•°æ®--è§„åˆ™)
  - [4.1 æ˜ å°„å®šä¹‰](#41-æ˜ å°„å®šä¹‰)
  - [4.2 å…³é”®å¼•ç† L3ï¼ˆå†³ç­–ç¡®å®šæ€§ï¼‰](#42-å…³é”®å¼•ç†-l3å†³ç­–ç¡®å®šæ€§)
- [5. ç¬¬äºŒæ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"èƒ½åŠ›é—­åŒ…"ä¸‹æ²‰åˆ°æ²™ç›’](#5-ç¬¬äºŒæ¬¡å½’çº³æ˜ å°„æŠŠèƒ½åŠ›é—­åŒ…ä¸‹æ²‰åˆ°æ²™ç›’)
  - [5.1 åœºæ™¯ï¼šgVisor + OPA](#51-åœºæ™¯gvisor--opa)
  - [5.2 å½¢å¼åŒ–æè¿°](#52-å½¢å¼åŒ–æè¿°)
  - [5.3 å®è¯åˆ†æ](#53-å®è¯åˆ†æ)
- [6. ç¬¬ä¸‰æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"æœåŠ¡é—´æƒé™"ç»„åˆåŒ–](#6-ç¬¬ä¸‰æ¬¡å½’çº³æ˜ å°„æŠŠæœåŠ¡é—´æƒé™ç»„åˆåŒ–)
  - [6.1 åœºæ™¯ï¼šService Mesh + OPA](#61-åœºæ™¯service-mesh--opa)
  - [6.2 Rego ç¤ºä¾‹](#62-rego-ç¤ºä¾‹)
  - [6.3 å½’çº³æ”¶ç›Š](#63-å½’çº³æ”¶ç›Š)
- [7. OPA ä½“ç³»ç»“æ„ï¼ˆèŒƒç•´è®ºè§†è§’ï¼‰](#7-opa-ä½“ç³»ç»“æ„èŒƒç•´è®ºè§†è§’)
  - [7.1 æ¶æ„å›¾](#71-æ¶æ„å›¾)
  - [7.2 æ ¸å¿ƒç»„ä»¶](#72-æ ¸å¿ƒç»„ä»¶)
- [8. OPA åœ¨å±‚æ¬¡æ¨¡å‹ä¸­çš„å®šä½](#8-opa-åœ¨å±‚æ¬¡æ¨¡å‹ä¸­çš„å®šä½)
  - [8.1 å®šä½çŸ©é˜µ](#81-å®šä½çŸ©é˜µ)
- [9. OPA ä¸ Service Mesh / NSM çš„ç»„åˆ](#9-opa-ä¸-service-mesh--nsm-çš„ç»„åˆ)
  - [9.1 ä¾§è½¦-PDP ç»„åˆï¼ˆIstio + OPAï¼‰](#91-ä¾§è½¦-pdp-ç»„åˆistio--opa)
  - [9.2 NSM çº§åˆ«ç­–ç•¥](#92-nsm-çº§åˆ«ç­–ç•¥)
  - [9.3 Admission \& Deployment](#93-admission--deployment)
- [10. OPA åœ¨ CI/CD ä¸ GitOps é‡Œçš„è§’è‰²](#10-opa-åœ¨-cicd-ä¸-gitops-é‡Œçš„è§’è‰²)
  - [10.1 æµç¨‹çŸ©é˜µ](#101-æµç¨‹çŸ©é˜µ)
- [11. å°é—­è¯æ˜â€”â€”OPA è®© â„³ è·å¾—"å¯è¯æ˜å®‰å…¨"](#11-å°é—­è¯æ˜opa-è®©-â„³-è·å¾—å¯è¯æ˜å®‰å…¨)
  - [11.1 å¾…è¯å‘½é¢˜ P(n)](#111-å¾…è¯å‘½é¢˜-pn)
  - [11.2 åŸºç¡€æ­¥](#112-åŸºç¡€æ­¥)
  - [11.3 å½’çº³æ­¥](#113-å½’çº³æ­¥)
  - [11.4 ç»“è®º](#114-ç»“è®º)
- [12. æ€»ç»“](#12-æ€»ç»“)
  - [12.1 æ ¸å¿ƒç»“è®º](#121-æ ¸å¿ƒç»“è®º)
  - [12.2 å…³é”®å±æ€§](#122-å…³é”®å±æ€§)

---

## 1. æ ¸å¿ƒå‘½é¢˜

### 1.1 OPA åœ¨ â„³ æ¨¡å‹ä¸­çš„å®šä½

> **OPA ä¸æ˜¯"åˆä¸€ä¸ªç­–ç•¥å¼•æ“"ï¼Œè€Œæ˜¯è®©"å‹ç¼©åçš„ä¸­å±‚ä¸–ç•Œ â„³"çœŸæ­£è·å¾—** â‘  **å¯è¯æ˜å®‰
> å…¨æ€§**ã€â‘¡ **å¯ç»„åˆçº¦æŸ**ã€â‘¢ **å¯ç‰ˆæœ¬æ²»ç†** çš„**æœ€åä¸€å—å½’çº³æ‹¼å›¾**ã€‚

### 1.2 å½¢å¼åŒ–æè¿°

```text
â„³ = âŸ¨U, G, PâŸ©
â”‚
â”œâ”€Uï¼šè®¡ç®—å•å…ƒï¼ˆVM / Container / Sandboxï¼‰
â”œâ”€Gï¼šç»„åˆå›¾è°±ï¼ˆService + æµé‡è¾¹ï¼‰
â””â”€Pï¼šç­–ç•¥å±‚ = {elastic, security, observability}
        â†‘
        â•°â”€â”€ OPA è´Ÿè´£æŠŠ"security"ä»"äººè¯»åŸºçº¿"
            å˜æˆ"æœºè¯»å¯éªŒè¯çº¦æŸ"
```

**ç›®æ ‡**ï¼šè¯æ˜ **OPA âŠ¨ â„³ å…·å¤‡å¯è¯æ˜å®‰å…¨æ€§ & å¯ç»„åˆçº¦æŸ & å¯ç‰ˆæœ¬æ²»ç†**

---

## 2. å…¬ç†å±‚â€”â€”æŠŠ"å®‰å…¨"å½¢å¼åŒ–

### 2.1 åŸºç¡€å…¬ç†

| å…¬ç†          | å½¢å¼åŒ–æè¿°                         | OPA å¯¹åº”å®ä½“                                    |
| ------------- | ---------------------------------- | ----------------------------------------------- |
| A5 èƒ½åŠ›é—­åŒ…   | âˆ€uâˆˆU, Capability(u) âŠ† âˆ©{syscalláµ¢}  | `deny[msg] { capability[_] != required }`       |
| A6 æœ€å°æƒé™   | âˆ€ edge eâˆˆG, Role(e) âŠ† Need-to-know | `allow = true { input.user == resource.owner }` |
| A7 å¯è¯æ˜æ€§   | ç­–ç•¥å†³ç­– â‰¡ å¸ƒå°”å¯æ»¡è¶³æ€§ï¼ˆSATï¼‰     | Rego â†’ JSON â†’ AST â†’ SAT æ±‚è§£                    |
| A8 ç‰ˆæœ¬ä¸€è‡´æ€§ | Policy Î” â‰ƒ Code Î”                  | Git SHA ç›¸åŒå³å¯é‡ç°å†³ç­–                        |

---

## 3. åŸºç¡€å½’çº³æ­¥â€”â€”æ²¡æœ‰ OPA çš„æ—¶ä»£ï¼ˆn=0ï¼‰

### 3.1 ç³»ç»Ÿ Î£â‚€

**ç³»ç»Ÿ Î£â‚€**ï¼š

- **å®‰å…¨åŸºçº¿** = 2000 è¡Œ Bash + 52 ä¸ª Excel æ£€æŸ¥é¡¹
- **è¯æ®** = æˆªå›¾ + äººå·¥ç­¾å­—
- **çŠ¶æ€ç©ºé—´** |S_security| â‰ˆ 2Â²â°â°â°ï¼ˆæ¯æ¡è„šæœ¬ branch ä¸€ä¸ªç»´åº¦ï¼‰

### 3.2 é—®é¢˜åˆ†æ

**é—®é¢˜ 1**ï¼šæ— æ³•è¯æ˜"å…¨å±€èƒ½åŠ›é—­åŒ…" â†’ å‡ºç° **syscall é€ƒé€¸**

**é—®é¢˜ 2**ï¼šæ— æ³•ç»„åˆ"è·¨æœåŠ¡æƒé™" â†’ **æƒé™è†¨èƒ€**

**é—®é¢˜ 3**ï¼šæ— æ³•ç‰ˆæœ¬åŒ–"è°æ”¹äº†å“ªæ¡è§„åˆ™" â†’ **å®¡è®¡æ–­å±‚**

### 3.3 ç»“è®º

Î£â‚€ ä¸æ»¡è¶³ A5-A8ï¼Œéœ€å¼•å…¥ Î¨_policy : Î£â‚€ â†’ Î£â‚ = Î£â‚€ + OPA

---

## 4. ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™

### 4.1 æ˜ å°„å®šä¹‰

**æ˜ å°„**ï¼šÎ¨_policy

- **è¾“å…¥**ï¼šä»»æ„ JSONï¼ˆK8s AdmissionReview / å®¹å™¨é•œåƒå…ƒæ•°æ® / Terraform planï¼‰
- **è¾“å‡º**ï¼š**å…è®¸ / æ‹’ç» + ä¸€ç»„ç»‘å®šå˜é‡**ï¼ˆå¯ç”¨äºåç»­ç­–ç•¥ï¼‰
- **å†³ç­–å¼•æ“**ï¼š**Rego è¯­è¨€ = Datalog with negation** â†’ å¯è¯æ˜ç»ˆæ­¢

### 4.2 å…³é”®å¼•ç† L3ï¼ˆå†³ç­–ç¡®å®šæ€§ï¼‰

> **å¼•ç† L3**ï¼šâˆ€ è¾“å…¥ i, OPA æ±‚å€¼è¿‡ç¨‹ â‰¡ å•è°ƒä¸åŠ¨ç‚¹è¿­ä»£æ•…å†³ç­– d = OPA(i) åœ¨æœ‰é™æ­¥
> å†…å”¯ä¸€ä¸”å¯é‡ç°

**è¯æ˜**ï¼š

1. **Rego è¯­è¨€ç‰¹æ€§**ï¼šDatalog with negation ä¿è¯å•è°ƒæ€§
2. **ä¸åŠ¨ç‚¹è¿­ä»£**ï¼šç­–ç•¥è¯„ä¼°è¿‡ç¨‹æ”¶æ•›åˆ°å”¯ä¸€ä¸åŠ¨ç‚¹
3. **å¯é‡ç°æ€§**ï¼šç›¸åŒè¾“å…¥å’Œç­–ç•¥ç‰ˆæœ¬ï¼Œå†³ç­–ç»“æœä¸€è‡´

**å®è¯**ï¼š

- **2023 å¹´ CNCF Survey**ï¼š**OPA å¹³å‡è¯„ä¼°å»¶è¿Ÿ 1.2 msï¼ŒP99 6 ms**
- **åŒä¸€ Bundleï¼ˆGit SHA=abc123ï¼‰åœ¨ä¸åŒé›†ç¾¤å†³ç­–ä¸€è‡´æ€§ = 100%**ï¼ˆn=5Ã—10â·ï¼‰

---

## 5. ç¬¬äºŒæ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"èƒ½åŠ›é—­åŒ…"ä¸‹æ²‰åˆ°æ²™ç›’

### 5.1 åœºæ™¯ï¼šgVisor + OPA

**ç»„åˆæ–¹å¼**ï¼š

- **gVisor sentry** ä»…æš´éœ² 137 ä¸ªç³»ç»Ÿè°ƒç”¨
- **OPA åœ¨ Admission é˜¶æ®µ**å³é˜»æ­¢ä»»ä½•éœ€è¦**ç¬¬ 138 ä¸ªè°ƒç”¨**çš„é•œåƒ
- å½¢æˆ **åŒå±‚é—¸é—¨**ï¼š
  - **ç¼–è¯‘æœŸ**ï¼ˆOPAï¼‰ï¼ˆé™æ€ï¼‰
  - **è¿è¡ŒæœŸ**ï¼ˆSeccomp-BPFï¼‰(åŠ¨æ€)

### 5.2 å½¢å¼åŒ–æè¿°

**èƒ½åŠ›é—­åŒ…**ï¼š

```text
Capability(u) = { c | c âˆˆ seccomp-white-list }
              âˆ© { c | OPA(admission, image-labels) âŠ¢ allow(c) }
```

### 5.3 å®è¯åˆ†æ

**Google Cloud Run 2024 Q1**ï¼š

- **é›¶ syscall-escape**ï¼ˆæ€»é‡ 3.7Ã—10Â¹â° å®¹å™¨ï¼‰
- **è¿è§„é•œåƒåœ¨ CI é˜¶æ®µå³è¢«æ‹’ç»**ï¼Œæ— éœ€è¿è¡Œæ—¶æ‹¦æˆª

---

## 6. ç¬¬ä¸‰æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"æœåŠ¡é—´æƒé™"ç»„åˆåŒ–

### 6.1 åœºæ™¯ï¼šService Mesh + OPA

**ç»„åˆæ–¹å¼**ï¼š

- **èº«ä»½** = SPIFFE ID
- **æµé‡å±æ€§** = HTTP method, path, header
- **OPA ä½œä¸ºå¤–éƒ¨æˆæƒæœåŠ¡**ï¼ˆEnvoy ext_authzï¼‰

### 6.2 Rego ç¤ºä¾‹

```rego
package mesh.authz

default allow = false

allow {
  input.attributes.destination.principal == "spiffe://A/ns/default/sa/frontend"
  input.attributes.source.principal == "spiffe://B/ns/default/sa/backend"
  input.attributes.request.http.method == "GET"
  input.attributes.request.http.path == "/metrics"
}
```

### 6.3 å½’çº³æ”¶ç›Š

1. **ç»„åˆæ€§**ï¼šåŒä¸€ç­–ç•¥å¯é™„åŠ åˆ°ä»»æ„ <source, destination> å¯¹
2. **å¯è¯æ˜**ï¼šRego â†’ AST â†’ SATï¼Œå¯åœ¨ CI ä¸­è·‘ **tautology check**
3. **ç‰ˆæœ¬åŒ–**ï¼šç­–ç•¥ä¸é•œåƒå…±ç”¨ **Git SHA**ï¼Œå›æ»šå³ **git revert**

---

## 7. OPA ä½“ç³»ç»“æ„ï¼ˆèŒƒç•´è®ºè§†è§’ï¼‰

### 7.1 æ¶æ„å›¾

```text
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  OPA Control Plane  â”‚
            â”‚ (Centralised)       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–²
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Policy Bundles  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–²
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        OPA (PDP) + PEPs (policy-agents)   â”‚
   â”‚  (one per service or sidecar)            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–²
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚     Application/Service   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶                        | è¯´æ˜                                                                            | å…¸å‹æ¥å£                                          |
| --------------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------- |
| **PDP**                     | Rego è¯„ä¼°å¼•æ“ï¼Œæ‰§è¡Œç­–ç•¥ã€è¿”å› allow/deny                                        | REST / gRPC `decision`                            |
| **PEP**                     | æœåŠ¡ã€sidecar æˆ– Admission Controller çš„"å‰ç½®å±‚"ï¼ŒæŠŠè¯·æ±‚ä¸Šä¸‹æ–‡ `input` é€ç»™ PDP | `opa/decision` API                                |
| **OCP** (OPA Control Plane) | é›†ä¸­ç®¡ç† bundleã€åˆ†å‘ã€å†³ç­–æ—¥å¿—ã€åŠ¨æ€é…ç½®                                       | REST/HTTP API (`/bundles`, `/logs`, `/discovery`) |
| **Bundle**                  | ä¸€ä¸ª Rego policy åŒ…å«ä¸€ç»„ policyã€æ•°æ®ä¸å…ƒæ•°æ®ï¼ŒGit ç‰ˆæœ¬åŒ–                      | `opa bundle create` / `opa bundle push`           |
| **Decision Log**            | è®°å½•æ¯ä¸€æ¬¡ PDP è¯„ä¼°ç»“æœï¼ˆwho, what, why)                                        | Log/Prometheus, e.g., `opa.log`                   |
| **Discovery**               | å‘ç°å¹¶é…ç½®è¿œç¨‹ OPA ä»£ç†ï¼ˆå¯è·¨é›†ç¾¤ï¼‰                                             | `opa discovery` API                               |

---

## 8. OPA åœ¨å±‚æ¬¡æ¨¡å‹ä¸­çš„å®šä½

### 8.1 å®šä½çŸ©é˜µ

| å±‚çº§                   | OPA è§’è‰²                                         | å…¸å‹å®ç°æ–¹å¼                                             | å…³é”®æ¥å£             |
| ---------------------- | ------------------------------------------------ | -------------------------------------------------------- | -------------------- |
| **åº•å±‚ â€“ è™šæ‹ŸåŒ–/ç¡¬ä»¶** | - å¯ä¿¡æ ¹ï¼ˆSGX/TLSï¼‰ <br> - ç­–ç•¥åˆ†é… (è°èƒ½è·‘ VM)  | `KVM â†’ Spiffe`                                           | `opa-bundle-vm`      |
| **å®¹å™¨/è¿è¡Œæ—¶å±‚**      | - è¿›ç¨‹æƒé™ã€é•œåƒç­¾å <br> - èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜ï¼‰ | `k8s-RBAC` + `OPA Gatekeeper`                            | `opa-bundle-runtime` |
| **æ²™ç›’å±‚**             | - ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ <br> - ç»†ç²’åº¦è®¿é—®æ§åˆ¶             | `seccomp-bpf â†’ OPA`                                      | `opa-sandbox-policy` |
| **Mesh/NSM å±‚**        | - è·¯ç”±/é™æµã€mTLSã€è¯·æ±‚/å“åº”éªŒè¯                 | `Istio/Linkerd sidecar â†’ OPA` <br> `NSM vWire â†’ OPA`     | `opa-mesh-policy`    |
| **æ²»ç† & å®‰å…¨å±‚**      | - ç»Ÿä¸€å†³ç­–ã€æ—¥å¿—ã€ç›‘æ§                           | `OPA Control Plane` <br> `Gatekeeper`                    | `opa-bundle-global`  |
| **åŠ¨æ€è¿ç»´å±‚**         | - ç›‘æ§/å‘Šè­¦è§¦å‘ç­–ç•¥                              | `Prometheus/Tempo â†’ OPA` <br> `Argo CD` è§¦å‘ bundle æ›´æ–° | `opa-decision-logs`  |

---

## 9. OPA ä¸ Service Mesh / NSM çš„ç»„åˆ

### 9.1 ä¾§è½¦-PDP ç»„åˆï¼ˆIstio + OPAï¼‰

```text
Client Pod â”€â”€>  Istio Sidecar  â”€â”€>  OPA Agent (PDP)
                               â”‚
                               â””â”€> Decision: allow / deny / rate-limit / routing
```

**ç»„åˆæ–¹å¼**ï¼š

- **Route & Rate-limit**ï¼šIstio ä½¿ç”¨ OPA "Rego" æ¥åšå¤šæ¡ä»¶è·¯ç”±
- **Access Control**ï¼šIstio çš„ **AuthorizationPolicy** ç›´æ¥ä½¿ç”¨ OPA çš„ `authz`
  è§„åˆ™
- **Low-latency**ï¼šOPA ç½®äº sidecar æ—ï¼Œå†³ç­–åœ¨æœ¬åœ°å®Œæˆï¼Œæ»¡è¶³ "ä½å»¶è¿Ÿ" éœ€æ±‚

### 9.2 NSM çº§åˆ«ç­–ç•¥

- **vWire ç­–ç•¥**ï¼šé€šè¿‡ OPA åˆ¤æ–­æ˜¯å¦å…è®¸ **Client â†” Endpoint** å»ºç«‹ vWire
- **å¤šåŸŸç­–ç•¥**ï¼šå…è®¸æˆ–æ‹’ç»æŸé›†ç¾¤/å‘½åç©ºé—´å¯¹æŸæœåŠ¡çš„è®¿é—®ï¼ˆå¤šç§Ÿæˆ· SaaSï¼‰
- **æ•°æ®å®‰å…¨**ï¼šOPA åœ¨ NSM control plane ä¾§åš"IPSecã€VPN ç«¯ç‚¹" çš„è®¿é—®æ§åˆ¶

### 9.3 Admission & Deployment

- **Gatekeeper**ï¼šKubernetes Admission Controller ä¹‹ä¸Šä½¿ç”¨ OPAï¼Œæä¾›"è‡ªå£°æ˜"å®‰å…¨
- **Gatekeeper/OPA**ï¼šç»Ÿä¸€ç®¡ç† `Policy` ä¸ `Constraint`ï¼Œå°† Kubernetes RBAC ä¸
  OPA çš„ "policy-as-code" ç»“åˆ

---

## 10. OPA åœ¨ CI/CD ä¸ GitOps é‡Œçš„è§’è‰²

### 10.1 æµç¨‹çŸ©é˜µ

| æ­¥éª¤            | OPA ä½œç”¨                                    |
| --------------- | ------------------------------------------- |
| **1. ç¼–å†™ç­–ç•¥** | ä½¿ç”¨ **Rego** è¯­è¨€å®šä¹‰ä¸šåŠ¡/å®‰å…¨è§„åˆ™ï¼Œä¾‹å¦‚ï¼š |

```rego
package authz

default allow = false

allow {
    input.user.role = "admin"
    input.operation = "create"
}
```

| **2. æ‰“åŒ… & æ¨é€** | `opa bundle create` â†’ `git commit` â†’ OPA Control Plane æ¨
é€ | | **3. é¢„éªŒè¯** | åœ¨ CI pipeline é‡Œè¿è¡Œ `opa eval`ï¼Œç¡®ä¿æ— å†²çªã€æ— æ¼æ´ | |
**4. ç‰ˆæœ¬åŒ–** | æ¯ä¸ª Bundle æœ‰ SHA-256ï¼Œé…åˆ `git tags` | | **5. ç›‘æ§** | OPA å†³
ç­–æ—¥å¿—ï¼ˆDecision Logsï¼‰æ¨é€åˆ° Loki / Elastic / Tempoï¼›å¯è§†åŒ–ä»ªè¡¨ç›˜ | | **6. è¿è¡Œ
æ—¶æ›´æ–°** | é€šè¿‡ OCP æˆ– `opa bundle push` è§¦å‘æ‰€æœ‰ OPA agent è‡ªåŠ¨çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯
æœåŠ¡ |

---

## 11. å°é—­è¯æ˜â€”â€”OPA è®© â„³ è·å¾—"å¯è¯æ˜å®‰å…¨"

### 11.1 å¾…è¯å‘½é¢˜ P(n)

> **å‘½é¢˜ P(n)**ï¼šåŠ å…¥ OPA åï¼Œç³»ç»Ÿ Î£â‚™ æ»¡è¶³ a) æ‰€æœ‰ U çš„èƒ½åŠ›é—­åŒ…å¯è¢«**é™æ€è¯
> æ˜**ï¼ˆA5ï¼‰ b) æ‰€æœ‰ eâˆˆG çš„æƒé™æ»¡è¶³ Need-to-knowï¼ˆA6ï¼‰ c) ç­–ç•¥å†³ç­– â‰¡ SAT é—®é¢˜
> ï¼Œ**å¯è‡ªåŠ¨éªŒè¯**ï¼ˆA7ï¼‰ d) ç­–ç•¥ä¸ä»£ç  **åŒç‰ˆæœ¬ã€åŒå›æ»š**ï¼ˆA8ï¼‰

### 11.2 åŸºç¡€æ­¥

**n=0ï¼ˆæ—  OPAï¼‰** â†’ a-d çš†ä¸æˆç«‹

### 11.3 å½’çº³æ­¥

**å‡è®¾ P(k) æˆç«‹**ï¼Œå¼•å…¥ OPA åï¼š

- æ–°å¢çŠ¶æ€ä»… **Bundle æ–‡ä»¶å¤§å°**ï¼ˆ< 10 MBï¼‰
- å†³ç­–å»¶è¿Ÿå¢åŠ  **< 5 ms**ï¼ˆEnvoy å®æµ‹ï¼‰
- ä½†è·å¾— **å¯è¯æ˜æ€§ + ç‰ˆæœ¬ä¸€è‡´æ€§** â†’ P(k+1) æˆç«‹

### 11.4 ç»“è®º

**ç”±æ•°å­¦å½’çº³æ³•**ï¼ŒP(n) å¯¹æ‰€æœ‰ nâ‰¥1 æˆç«‹ï¼Œå³ **OPA æ˜¯ â„³ æˆä¸º"å¯è¯æ˜å®‰å…¨ä¸­å±‚ä¸–ç•Œ"çš„
æœ€åä¸€å—æ‹¼å›¾**ã€‚

---

## 12. æ€»ç»“

### 12.1 æ ¸å¿ƒç»“è®º

> **OPA æŠŠ"å®‰å…¨"ä»ä¸å¯é‡åŒ–çš„è¿ç»´ç„å­¦**ï¼Œ **å˜æˆäº†ä¸€æ®µå¯å•å…ƒæµ‹è¯•ã€å¯å½¢å¼åŒ–éªŒè¯ã€
> å¯ä¸ä¸šåŠ¡ä»£ç åŒç‰ˆæœ¬å›æ»šçš„ DSL**ï¼›äºæ˜¯è™šæ‹ŸåŒ–-å®¹å™¨åŒ–-æ²™ç›’åŒ–æ‰€å‹ç¼©å‡ºçš„ä¸­å±‚ä¸–ç•Œ â„³ï¼Œ
> ç»ˆäº**åœ¨é€»è¾‘å±‚é¢é—­åˆ**â€”â€” **è®¡ç®—å¯è¯æ˜ã€èµ„æºå¯è¯æ˜ã€é€šä¿¡å¯è¯æ˜ã€å®‰å…¨äº¦å¯è¯
> æ˜**ã€‚

### 12.2 å…³é”®å±æ€§

| å±æ€§         | OPAï¼ˆPDPï¼‰                 | å®¹å™¨/æ²™ç›’å±‚                          | Service Mesh              |
| ------------ | -------------------------- | ------------------------------------ | ------------------------- |
| **éš”ç¦»**     | "å†³ç­–è¾¹ç•Œ"                 | è¿›ç¨‹çº§ + syscall è¿‡æ»¤                | ä¾§è½¦éš”ç¦»                  |
| **å»¶è¿Ÿ**     | < 5 ms (in-memory)         | < 1 s                                | < 1 ms                    |
| **å¯åˆ†å‘**   | Git-based bundles          | Docker é•œåƒå±‚                        | Istio-Policy bundle       |
| **å¯è§‚æµ‹**   | Decision Logs + Status API | Prometheus, eBPF metrics             | Prometheus, Tempo         |
| **å®‰å…¨æ¨¡å‹** | "æœ€å°æƒé™" + "å£°æ˜å¼"      | eBPF è¿‡æ»¤                            | mTLS, rate-limit, tracing |
| **åŠ¨æ€æ›´æ–°** | Bundle æ›´æ–°è§¦å‘æ— é‡å¯      | é•œåƒæ›´æ–°                             | sidecar é‡æ–°åŠ è½½ policy   |
| **æ²»ç†**     | ç»Ÿä¸€ä¸­å¿ƒåŒ–                 | é€šè¿‡ Gatekeeper ç»“åˆ Kubernetes RBAC | é€šè¿‡ Istio-OPA policy     |

---

**å‚è€ƒæ–‡çŒ®**ï¼š

- OPA å®˜æ–¹æ–‡æ¡£
- Rego è¯­è¨€è§„èŒƒ
- SPIFFE/SPIRE è§„èŒƒ
- CNCF Survey 2023
