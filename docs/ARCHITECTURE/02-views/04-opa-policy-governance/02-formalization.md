# å®‰å…¨å½¢å¼åŒ–ï¼šæŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™

## ğŸ“‘ ç›®å½•

- [å®‰å…¨å½¢å¼åŒ–ï¼šæŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™](#å®‰å…¨å½¢å¼åŒ–æŠŠå®‰å…¨å˜æˆæ•°æ®--è§„åˆ™)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1 æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ ¸å¿ƒæ€æƒ³](#11-æ ¸å¿ƒæ€æƒ³)
  - [2 å…¬ç†å±‚â€”â€”æŠŠ"å®‰å…¨"å½¢å¼åŒ–](#2-å…¬ç†å±‚æŠŠå®‰å…¨å½¢å¼åŒ–)
    - [2.1 å…¬ç†å®šä¹‰](#21-å…¬ç†å®šä¹‰)
    - [2.2 å…¬ç†è¯´æ˜](#22-å…¬ç†è¯´æ˜)
  - [3 åŸºç¡€å½’çº³æ­¥â€”â€”æ²¡æœ‰ OPA çš„æ—¶ä»£ï¼ˆn=0ï¼‰](#3-åŸºç¡€å½’çº³æ­¥æ²¡æœ‰-opa-çš„æ—¶ä»£n0)
    - [3.1 ç³»ç»Ÿ Î£â‚€](#31-ç³»ç»Ÿ-Ïƒ)
    - [3.2 é—®é¢˜åˆ†æ](#32-é—®é¢˜åˆ†æ)
    - [3.3 ç»“è®º](#33-ç»“è®º)
  - [4 ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™](#4-ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„æŠŠå®‰å…¨å˜æˆæ•°æ®--è§„åˆ™)
    - [4.1 æ˜ å°„å®šä¹‰](#41-æ˜ å°„å®šä¹‰)
    - [4.2 å…³é”®å¼•ç† L3ï¼ˆå†³ç­–ç¡®å®šæ€§ï¼‰](#42-å…³é”®å¼•ç†-l3å†³ç­–ç¡®å®šæ€§)
    - [4.3 å®è¯](#43-å®è¯)
  - [5 Rego è¯­è¨€åŸºç¡€](#5-rego-è¯­è¨€åŸºç¡€)
    - [5.1 Rego è¯­æ³•](#51-rego-è¯­æ³•)
    - [5.2 Rego ç‰¹æ€§](#52-rego-ç‰¹æ€§)
  - [6 OPA å†³ç­–æµç¨‹](#6-opa-å†³ç­–æµç¨‹)
    - [6.1 å†³ç­–æµç¨‹](#61-å†³ç­–æµç¨‹)
    - [6.2 å†³ç­–ç¡®å®šæ€§](#62-å†³ç­–ç¡®å®šæ€§)
  - [7 ç­–ç•¥æµ‹è¯•ä¸éªŒè¯](#7-ç­–ç•¥æµ‹è¯•ä¸éªŒè¯)
    - [7.1 å•å…ƒæµ‹è¯•](#71-å•å…ƒæµ‹è¯•)
    - [7.2 å½¢å¼åŒ–éªŒè¯](#72-å½¢å¼åŒ–éªŒè¯)
    - [7.3 é›†æˆæµ‹è¯•](#73-é›†æˆæµ‹è¯•)
  - [8 ç­–ç•¥ç‰ˆæœ¬åŒ–](#8-ç­–ç•¥ç‰ˆæœ¬åŒ–)
    - [8.1 GitOps é›†æˆ](#81-gitops-é›†æˆ)
    - [8.2 Bundle ç®¡ç†](#82-bundle-ç®¡ç†)
  - [9 ç­–ç•¥å†³ç­–å®¡è®¡](#9-ç­–ç•¥å†³ç­–å®¡è®¡)
    - [9.1 Decision Log](#91-decision-log)
    - [9.2 å®¡è®¡é›†æˆ](#92-å®¡è®¡é›†æˆ)
  - [10 å½¢å¼åŒ–å®šä¹‰](#10-å½¢å¼åŒ–å®šä¹‰)
    - [10.1 OPA æ˜ å°„å®šä¹‰](#101-opa-æ˜ å°„å®šä¹‰)
    - [10.2 å†³ç­–ç¡®å®šæ€§](#102-å†³ç­–ç¡®å®šæ€§)
    - [10.3 ç‰ˆæœ¬ä¸€è‡´æ€§](#103-ç‰ˆæœ¬ä¸€è‡´æ€§)
  - [11 æ€»ç»“](#11-æ€»ç»“)

---

## 1 æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°å¦‚ä½•é€šè¿‡ **OPA** å°†"å®‰å…¨"ä»ä¸å¯é‡åŒ–çš„è¿ç»´ç„å­¦å˜æˆ**å¯å•å…ƒæµ‹è¯•ã€å¯
å½¢å¼åŒ–éªŒè¯ã€å¯ä¸ä¸šåŠ¡ä»£ç åŒç‰ˆæœ¬å›æ»šçš„ DSL**ã€‚

### 1.1 æ ¸å¿ƒæ€æƒ³

> **OPA æŠŠ"å®‰å…¨"ä»ä¸å¯é‡åŒ–çš„è¿ç»´ç„å­¦**ï¼Œ**å˜æˆäº†ä¸€æ®µå¯å•å…ƒæµ‹è¯•ã€å¯å½¢å¼åŒ–éªŒè¯ã€å¯
> ä¸ä¸šåŠ¡ä»£ç åŒç‰ˆæœ¬å›æ»šçš„ DSL**ï¼›äºæ˜¯è™šæ‹ŸåŒ–-å®¹å™¨åŒ–-æ²™ç›’åŒ–æ‰€å‹ç¼©å‡ºçš„ä¸­å±‚ä¸–ç•Œ â„³ï¼Œç»ˆ
> äº**åœ¨é€»è¾‘å±‚é¢é—­åˆ**â€”â€” **è®¡ç®—å¯è¯æ˜ã€èµ„æºå¯è¯æ˜ã€é€šä¿¡å¯è¯æ˜ã€å®‰å…¨äº¦å¯è¯æ˜**ã€‚

## 2 å…¬ç†å±‚â€”â€”æŠŠ"å®‰å…¨"å½¢å¼åŒ–

### 2.1 å…¬ç†å®šä¹‰

| å…¬ç†          | å½¢å¼åŒ–æè¿°                         | OPA å¯¹åº”å®ä½“                                    |
| ------------- | ---------------------------------- | ----------------------------------------------- |
| A5 èƒ½åŠ›é—­åŒ…   | âˆ€uâˆˆU, Capability(u) âŠ† âˆ©{syscalláµ¢}  | `deny[msg] { capability[_] != required }`       |
| A6 æœ€å°æƒé™   | âˆ€ edge eâˆˆG, Role(e) âŠ† Need-to-know | `allow = true { input.user == resource.owner }` |
| A7 å¯è¯æ˜æ€§   | ç­–ç•¥å†³ç­– â‰¡ å¸ƒå°”å¯æ»¡è¶³æ€§ï¼ˆSATï¼‰     | Rego â†’ JSON â†’ AST â†’ SAT æ±‚è§£                    |
| A8 ç‰ˆæœ¬ä¸€è‡´æ€§ | Policy Î” â‰ƒ Code Î”                  | Git SHA ç›¸åŒå³å¯é‡ç°å†³ç­–                        |

### 2.2 å…¬ç†è¯´æ˜

**A5 èƒ½åŠ›é—­åŒ…**ï¼š

- æ¯ä¸ªè®¡ç®—å•å…ƒçš„èƒ½åŠ›é›†åˆæ˜¯å…¶æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„äº¤é›†
- OPA é€šè¿‡ `deny` è§„åˆ™ç¡®ä¿åªæœ‰å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨è¢«å…è®¸

**A6 æœ€å°æƒé™**ï¼š

- æ¯æ¡è¾¹çš„æƒé™é›†åˆæ»¡è¶³æœ€å°æƒé™åŸåˆ™
- OPA é€šè¿‡ `allow` è§„åˆ™ç¡®ä¿åªæœ‰å¿…è¦çš„æƒé™è¢«æˆäºˆ

**A7 å¯è¯æ˜æ€§**ï¼š

- ç­–ç•¥å†³ç­–ç­‰ä»·äºå¸ƒå°”å¯æ»¡è¶³æ€§é—®é¢˜
- OPA é€šè¿‡ Rego â†’ JSON â†’ AST â†’ SAT æ±‚è§£å®ç°å¯è¯æ˜æ€§

**A8 ç‰ˆæœ¬ä¸€è‡´æ€§**ï¼š

- ç­–ç•¥å˜æ›´ä¸ä»£ç å˜æ›´åŒæ­¥
- OPA é€šè¿‡ Git SHA ç¡®ä¿ç­–ç•¥ä¸ä»£ç ç‰ˆæœ¬ä¸€è‡´

## 3 åŸºç¡€å½’çº³æ­¥â€”â€”æ²¡æœ‰ OPA çš„æ—¶ä»£ï¼ˆn=0ï¼‰

### 3.1 ç³»ç»Ÿ Î£â‚€

**ç³»ç»Ÿç‰¹å¾**ï¼š

- å®‰å…¨åŸºçº¿ = 2000 è¡Œ Bash + 52 ä¸ª Excel æ£€æŸ¥é¡¹
- è¯æ® = æˆªå›¾ + äººå·¥ç­¾å­—
- çŠ¶æ€ç©ºé—´ |S_security| â‰ˆ 2Â²â°â°â°ï¼ˆæ¯æ¡è„šæœ¬ branch ä¸€ä¸ªç»´åº¦ï¼‰

### 3.2 é—®é¢˜åˆ†æ

**é—®é¢˜**ï¼š

1. æ— æ³•è¯æ˜"å…¨å±€èƒ½åŠ›é—­åŒ…"â†’ å‡ºç° **syscall é€ƒé€¸**
2. æ— æ³•ç»„åˆ"è·¨æœåŠ¡æƒé™"â†’ **æƒé™è†¨èƒ€**
3. æ— æ³•ç‰ˆæœ¬åŒ–"è°æ”¹äº†å“ªæ¡è§„åˆ™"â†’ **å®¡è®¡æ–­å±‚**

### 3.3 ç»“è®º

Î£â‚€ ä¸æ»¡è¶³ A5-A8ï¼Œéœ€å¼•å…¥ Î¨_policy : Î£â‚€ â†’ Î£â‚ = Î£â‚€ + OPA

## 4 ç¬¬ä¸€æ¬¡å½’çº³æ˜ å°„â€”â€”æŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™

### 4.1 æ˜ å°„å®šä¹‰

**æ˜ å°„**ï¼šÎ¨_policy

- **è¾“å…¥**ï¼šä»»æ„ JSONï¼ˆK8s AdmissionReview / å®¹å™¨é•œåƒå…ƒæ•°æ® / Terraform planï¼‰
- **è¾“å‡º**ï¼š**å…è®¸ / æ‹’ç» + ä¸€ç»„ç»‘å®šå˜é‡**ï¼ˆå¯ç”¨äºåç»­ç­–ç•¥ï¼‰
- **å†³ç­–å¼•æ“**ï¼š**Rego è¯­è¨€ = Datalog with negation** â†’ å¯è¯æ˜ç»ˆæ­¢

### 4.2 å…³é”®å¼•ç† L3ï¼ˆå†³ç­–ç¡®å®šæ€§ï¼‰

> âˆ€ è¾“å…¥ i, OPA æ±‚å€¼è¿‡ç¨‹ â‰¡ å•è°ƒä¸åŠ¨ç‚¹è¿­ä»£æ•…å†³ç­– d = OPA(i) åœ¨æœ‰é™æ­¥å†…å”¯ä¸€ä¸”å¯é‡
> ç°

### 4.3 å®è¯

- **2023 å¹´ CNCF Survey**ï¼š**OPA å¹³å‡è¯„ä¼°å»¶è¿Ÿ 1.2 msï¼ŒP99 6 ms**
- **åŒä¸€ Bundle**ï¼ˆGit SHA=abc123ï¼‰åœ¨**ä¸åŒé›†ç¾¤**å†³ç­–ä¸€è‡´æ€§ = 100 %ï¼ˆn=5Ã—10â·ï¼‰

## 5 Rego è¯­è¨€åŸºç¡€

### 5.1 Rego è¯­æ³•

**Rego** æ˜¯ OPA çš„ç­–ç•¥å®šä¹‰è¯­è¨€ï¼ŒåŸºäº **Datalog with negation**ã€‚

**åŸºæœ¬è¯­æ³•**ï¼š

```rego
package authz

# é»˜è®¤æ‹’ç»
default allow = false

# å…è®¸è§„åˆ™
allow {
  input.user.role == "admin"
  input.operation == "create"
}

# æ‹’ç»è§„åˆ™
deny[msg] {
  input.user.role != "admin"
  msg := "only admin can create"
}
```

### 5.2 Rego ç‰¹æ€§

- **å£°æ˜å¼**ï¼šæè¿°"ä»€ä¹ˆ"è€Œä¸æ˜¯"å¦‚ä½•"
- **å¯ç»„åˆ**ï¼šè§„åˆ™å¯ä»¥ç»„åˆå’Œé‡ç”¨
- **å¯è¯æ˜**ï¼šå†³ç­–è¿‡ç¨‹å¯å½¢å¼åŒ–éªŒè¯

## 6 OPA å†³ç­–æµç¨‹

### 6.1 å†³ç­–æµç¨‹

```text
è¾“å…¥ï¼ˆJSONï¼‰
  â†“
OPA è¯„ä¼°ï¼ˆRegoï¼‰
  â†“
å†³ç­–ï¼ˆallow/deny + å˜é‡ç»‘å®šï¼‰
  â†“
è¾“å‡ºï¼ˆJSONï¼‰
```

### 6.2 å†³ç­–ç¡®å®šæ€§

**å†³ç­–ç¡®å®šæ€§ä¿è¯**ï¼š

- **å•è°ƒä¸åŠ¨ç‚¹è¿­ä»£**ï¼šå†³ç­–è¿‡ç¨‹ä¿è¯æ”¶æ•›
- **æœ‰é™æ­¥ç»ˆæ­¢**ï¼šå†³ç­–åœ¨æœ‰é™æ­¥å†…å®Œæˆ
- **å”¯ä¸€æ€§**ï¼šç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡º
- **å¯é‡ç°æ€§**ï¼šå†³ç­–ç»“æœå¯é‡ç°

## 7 ç­–ç•¥æµ‹è¯•ä¸éªŒè¯

### 7.1 å•å…ƒæµ‹è¯•

**OPA æµ‹è¯•**ï¼š

```rego
package authz

test_admin_can_create {
  allow with input as {
    "user": {"role": "admin"},
    "operation": "create"
  }
}

test_non_admin_cannot_create {
  not allow with input as {
    "user": {"role": "user"},
    "operation": "create"
  }
}
```

### 7.2 å½¢å¼åŒ–éªŒè¯

**SAT æ±‚è§£**ï¼š

- Rego â†’ JSON â†’ AST â†’ SAT æ±‚è§£
- å¯è‡ªåŠ¨éªŒè¯ç­–ç•¥çš„æ­£ç¡®æ€§

### 7.3 é›†æˆæµ‹è¯•

**CI/CD é›†æˆ**ï¼š

```yaml
- name: OPA Test
  run: |
    opa test ./policies
    opa eval --data ./policies --input ./tests/test.json
```

## 8 ç­–ç•¥ç‰ˆæœ¬åŒ–

### 8.1 GitOps é›†æˆ

**ç­–ç•¥ç‰ˆæœ¬åŒ–**ï¼š

- ç­–ç•¥å­˜å‚¨åœ¨ Git ä»“åº“ä¸­
- æ¯ä¸ªç­–ç•¥å˜æ›´éƒ½æœ‰ Git commit SHA
- ç­–ç•¥ä¸ä»£ç åŒæ­¥ç‰ˆæœ¬åŒ–

### 8.2 Bundle ç®¡ç†

**OPA Bundle**ï¼š

- åŒ…å«ç­–ç•¥ã€æ•°æ®ã€å…ƒæ•°æ®
- æ”¯æŒç‰ˆæœ¬åŒ–ï¼ˆGit SHAï¼‰
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯æœåŠ¡ï¼‰

**ç¤ºä¾‹**ï¼š

```bash
# åˆ›å»º Bundle
opa bundle create -o authz.bundle authz.rego

# æ¨é€ Bundle
opa bundle push authz.bundle

# æ›´æ–° Bundle
opa bundle push authz.bundle --revision abc123
```

## 9 ç­–ç•¥å†³ç­–å®¡è®¡

### 9.1 Decision Log

**Decision Log** è®°å½•æ¯æ¬¡ç­–ç•¥å†³ç­–ï¼š

- **Who**ï¼šè°å‘èµ·çš„è¯·æ±‚
- **What**ï¼šè¯·æ±‚çš„å†…å®¹
- **Why**ï¼šå†³ç­–çš„åŸå› ï¼ˆè§„åˆ™åŒ¹é…ï¼‰

### 9.2 å®¡è®¡é›†æˆ

**å®¡è®¡å·¥å…·é›†æˆ**ï¼š

- **Loki**ï¼šæ—¥å¿—èšåˆ
- **Elasticsearch**ï¼šæ—¥å¿—æœç´¢
- **Prometheus**ï¼šæŒ‡æ ‡æ”¶é›†

## 10 å½¢å¼åŒ–å®šä¹‰

### 10.1 OPA æ˜ å°„å®šä¹‰

```text
OPA: Input â†’ Decision
å…¶ä¸­ï¼š
- Input: JSON è¾“å…¥
- Decision: {allow: bool, deny: string[], variables: map}
```

### 10.2 å†³ç­–ç¡®å®šæ€§

```text
âˆ€ i âˆˆ Input, âˆƒ! d âˆˆ Decision
ä½¿å¾— d = OPA(i) ä¸” d åœ¨æœ‰é™æ­¥å†…å”¯ä¸€ä¸”å¯é‡ç°
```

### 10.3 ç‰ˆæœ¬ä¸€è‡´æ€§

```text
Policy Î” â‰ƒ Code Î”
å…¶ä¸­ï¼š
- Policy Î”: ç­–ç•¥å˜æ›´ï¼ˆGit SHAï¼‰
- Code Î”: ä»£ç å˜æ›´ï¼ˆGit SHAï¼‰
- â‰ƒ: ç‰ˆæœ¬ä¸€è‡´
```

## 11 æ€»ç»“

é€šè¿‡**å®‰å…¨å½¢å¼åŒ–**ï¼ŒOPA å®ç°äº†ï¼š

1. **æŠŠ"å®‰å…¨"å˜æˆæ•°æ® + è§„åˆ™**ï¼šä»ä¸å¯é‡åŒ–çš„è¿ç»´ç„å­¦å˜æˆå¯å½¢å¼åŒ–çš„ DSL
2. **å†³ç­–ç¡®å®šæ€§**ï¼šå†³ç­–åœ¨æœ‰é™æ­¥å†…å”¯ä¸€ä¸”å¯é‡ç°
3. **å¯è¯æ˜æ€§**ï¼šç­–ç•¥å†³ç­–ç­‰ä»·äº SAT é—®é¢˜ï¼Œå¯è‡ªåŠ¨éªŒè¯
4. **ç‰ˆæœ¬ä¸€è‡´æ€§**ï¼šç­–ç•¥ä¸ä»£ç åŒæ­¥ç‰ˆæœ¬åŒ–
5. **å¯å®¡è®¡æ€§**ï¼šæ‰€æœ‰å†³ç­–å¯å®¡è®¡å’Œè¿½æº¯

---

**æ›´æ–°æ—¶é—´**ï¼š2025-11-04 **ç‰ˆæœ¬**ï¼šv1.0 **å‚è€ƒ**ï¼š`architecture_view.md` ç¬¬
1992-2007 è¡Œï¼Œå®‰å…¨å½¢å¼åŒ–éƒ¨åˆ†
