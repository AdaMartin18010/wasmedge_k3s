# 可观测性视角：监控、追踪、日志

## 📑 目录

- [可观测性视角：监控、追踪、日志](#可观测性视角监控追踪日志)
  - [📑 目录](#-目录)
  - [1 概述](#1-概述)
    - [1.1 核心思想](#11-核心思想)
  - [2 可观测性视角定义](#2-可观测性视角定义)
    - [2.1 可观测性视角概念](#21-可观测性视角概念)
    - [2.2 可观测性视角特点](#22-可观测性视角特点)
  - [3 虚拟化可观测性](#3-虚拟化可观测性)
    - [3.1 虚拟化监控指标](#31-虚拟化监控指标)
    - [3.2 虚拟化追踪](#32-虚拟化追踪)
  - [4 容器化可观测性](#4-容器化可观测性)
    - [4.1 容器化监控指标](#41-容器化监控指标)
    - [4.2 容器化追踪](#42-容器化追踪)
  - [5 沙盒化可观测性](#5-沙盒化可观测性)
    - [5.1 沙盒化监控指标](#51-沙盒化监控指标)
    - [5.2 沙盒化追踪](#52-沙盒化追踪)
  - [6 Service Mesh 可观测性](#6-service-mesh-可观测性)
    - [6.1 Service Mesh 监控指标](#61-service-mesh-监控指标)
    - [6.2 Service Mesh 追踪](#62-service-mesh-追踪)
    - [6.3 Service Mesh 日志](#63-service-mesh-日志)
  - [7 OPA 可观测性](#7-opa-可观测性)
    - [7.1 OPA 监控指标](#71-opa-监控指标)
    - [7.2 OPA 追踪](#72-opa-追踪)
    - [7.3 OPA 日志](#73-opa-日志)
  - [8 统一可观测性](#8-统一可观测性)
    - [8.1 统一可观测性架构](#81-统一可观测性架构)
    - [8.2 可观测性数据流](#82-可观测性数据流)
  - [9 可观测性最佳实践](#9-可观测性最佳实践)
    - [9.1 指标收集](#91-指标收集)
    - [9.2 日志管理](#92-日志管理)
    - [9.3 追踪链路](#93-追踪链路)
  - [10 形式化定义](#10-形式化定义)
    - [10.1 可观测性定义](#101-可观测性定义)
    - [10.2 指标定义](#102-指标定义)
  - [11 总结](#11-总结)
    - [11.1 相关文档](#111-相关文档)

---

## 1 概述

本文档从**可观测性视角**阐述软件架构，重点关注监控、追踪、日志。

### 1.1 核心思想

> **从可观测性视角理解系统，关注系统的监控、追踪、日志，以及如何通过虚拟化、容器
> 化、沙盒化等技术实现可观测性**

## 2 可观测性视角定义

### 2.1 可观测性视角概念

**可观测性视角**关注监控、追踪、日志，包括：

- **指标监控**：系统的指标监控
- **链路追踪**：分布式链路追踪
- **日志聚合**：日志的聚合和分析
- **可视化**：数据的可视化展示

### 2.2 可观测性视角特点

**可观测性视角特点**：

- **可观测导向**：以可观测性为核心
- **指标分析**：关注系统指标
- **追踪分析**：关注链路追踪
- **日志分析**：关注日志分析

## 3 虚拟化可观测性

### 3.1 虚拟化监控指标

**虚拟化监控指标**：

| 指标类型       | 说明          | 典型实现            |
| -------------- | ------------- | ------------------- |
| **CPU 使用率** | VM CPU 使用率 | vCPU Metrics        |
| **内存使用率** | VM 内存使用率 | Memory Metrics      |
| **磁盘 I/O**   | VM 磁盘 I/O   | Disk I/O Metrics    |
| **网络 I/O**   | VM 网络 I/O   | Network I/O Metrics |

### 3.2 虚拟化追踪

**虚拟化追踪**：

- **VM 生命周期追踪**：VM 创建、启动、停止、删除
- **资源分配追踪**：资源分配和释放
- **迁移追踪**：VM 迁移追踪

## 4 容器化可观测性

### 4.1 容器化监控指标

**容器化监控指标**：

| 指标类型       | 说明                 | 典型实现 |
| -------------- | -------------------- | -------- |
| **CPU 使用率** | Container CPU 使用率 | cAdvisor |
| **内存使用率** | Container 内存使用率 | cAdvisor |
| **网络 I/O**   | Container 网络 I/O   | cAdvisor |
| **文件系统**   | Container 文件系统   | cAdvisor |

### 4.2 容器化追踪

**容器化追踪**：

- **容器生命周期追踪**：容器创建、启动、停止、删除
- **应用追踪**：应用请求追踪
- **资源追踪**：资源使用追踪

## 5 沙盒化可观测性

### 5.1 沙盒化监控指标

**沙盒化监控指标**：

| 指标类型     | 说明                | 典型实现           |
| ------------ | ------------------- | ------------------ |
| **系统调用** | 系统调用统计        | Seccomp-BPF        |
| **能力使用** | Capability 使用统计 | Capability Metrics |
| **安全事件** | 安全事件统计        | Security Metrics   |

### 5.2 沙盒化追踪

**沙盒化追踪**：

- **系统调用追踪**：系统调用追踪
- **安全事件追踪**：安全事件追踪
- **策略决策追踪**：策略决策追踪

## 6 Service Mesh 可观测性

### 6.1 Service Mesh 监控指标

**Service Mesh 监控指标**：

| 指标类型     | 说明     | 典型实现   |
| ------------ | -------- | ---------- |
| **请求速率** | 请求速率 | Prometheus |
| **错误率**   | 错误率   | Prometheus |
| **延迟**     | 请求延迟 | Prometheus |
| **流量分布** | 流量分布 | Prometheus |

### 6.2 Service Mesh 追踪

**Service Mesh 追踪**：

| 追踪类型       | 说明           | 典型实现      |
| -------------- | -------------- | ------------- |
| **分布式追踪** | 分布式链路追踪 | Tempo/Jaeger  |
| **请求追踪**   | 请求链路追踪   | OpenTelemetry |
| **服务追踪**   | 服务调用追踪   | OpenTelemetry |

### 6.3 Service Mesh 日志

**Service Mesh 日志**：

| 日志类型     | 说明         | 典型实现         |
| ------------ | ------------ | ---------------- |
| **访问日志** | 访问日志     | Envoy Access Log |
| **错误日志** | 错误日志     | Envoy Error Log  |
| **配置日志** | 配置变更日志 | Istio Config Log |

## 7 OPA 可观测性

### 7.1 OPA 监控指标

**OPA 监控指标**：

| 指标类型     | 说明         | 典型实现   |
| ------------ | ------------ | ---------- |
| **决策延迟** | 决策延迟     | Prometheus |
| **决策速率** | 决策速率     | Prometheus |
| **策略评估** | 策略评估次数 | Prometheus |

### 7.2 OPA 追踪

**OPA 追踪**：

- **策略评估追踪**：策略评估追踪
- **决策追踪**：决策追踪
- **Bundle 更新追踪**：Bundle 更新追踪

### 7.3 OPA 日志

**OPA 日志**：

| 日志类型     | 说明     | 典型实现     |
| ------------ | -------- | ------------ |
| **决策日志** | 决策日志 | Decision Log |
| **错误日志** | 错误日志 | Error Log    |
| **审计日志** | 审计日志 | Audit Log    |

## 8 统一可观测性

### 8.1 统一可观测性架构

**统一可观测性架构**：

```text
应用层
  ├── OpenTelemetry SDK
  └── 自动注入遥测
  ↓
收集层
  ├── OpenTelemetry Collector
  ├── Prometheus（指标）
  ├── Loki（日志）
  └── Tempo（追踪）
  ↓
存储层
  ├── Prometheus TSDB
  ├── Loki 对象存储
  └── Tempo 对象存储
  ↓
可视化层
  └── Grafana（统一面板）
```

### 8.2 可观测性数据流

**可观测性数据流**：

```text
应用
  ├── Metrics → Prometheus
  ├── Logs → Loki
  └── Traces → Tempo
  ↓
Grafana
  ├── 指标可视化
  ├── 日志查询
  └── 追踪分析
```

## 9 可观测性最佳实践

### 9.1 指标收集

**指标收集最佳实践**：

- **标准化**：使用 OpenTelemetry 标准
- **自动化**：通过 sidecar 自动注入
- **聚合**：在 Collector 层聚合指标

### 9.2 日志管理

**日志管理最佳实践**：

- **结构化**：使用结构化日志格式
- **采样**：对高频日志进行采样
- **压缩**：对日志进行压缩存储

### 9.3 追踪链路

**追踪链路最佳实践**：

- **分布式追踪**：使用 OpenTelemetry 分布式追踪
- **采样策略**：根据业务需求设置采样策略
- **链路分析**：通过 Grafana 分析链路

## 10 形式化定义

### 10.1 可观测性定义

```text
可观测性 O = ⟨metrics, logs, traces, visualization⟩
其中：
- metrics: 指标集合
- logs: 日志集合
- traces: 追踪集合
- visualization: 可视化面板
```

### 10.2 指标定义

```text
指标 M = ⟨name, type, value, timestamp⟩
其中：
- name: 指标名称
- type: 指标类型（Counter/Gauge/Histogram）
- value: 指标值
- timestamp: 时间戳
```

## 11 总结

通过**可观测性视角**，我们理解了：

1. **指标监控**：系统的指标监控机制
2. **链路追踪**：分布式链路追踪机制
3. **日志聚合**：日志的聚合和分析机制
4. **统一可观测性**：统一的可观测性架构
5. **可视化**：数据的可视化展示

### 11.1 相关文档

**扩展阅读**：

- **[eBPF/OTLP 架构视角](07-ebpf-otlp-perspective.md)** ⭐ - 横纵耦合的可观测性
  驱动架构
  - 横纵耦合问题定位模型（OTLP 横向 + eBPF 纵向）
  - 智能系统能力架构（自我感知、自动伸缩、自我治愈）
  - 技术规范与语义模型对齐
- **[32. eBPF/OTLP 扩展技术分析](../../../../TECHNICAL/32-ebpf-otlp-analysis/ebpf-otlp-analysis.md)**
  ⭐ - eBPF/OTLP 扩展技术分析文档
- **[31. eBPF 技术堆栈](../../../../TECHNICAL/31-ebpf-stack/ebpf-stack.md)** -
  eBPF 技术堆栈完整技术参考文档
- **[29. 隔离栈](../../../../TECHNICAL/29-isolation-stack/isolation-stack.md)** -
  问题定位模型、横纵耦合定位方法

---

**更新时间**：2025-11-07 **版本**：v1.1 **参考**：`architecture_view.md` 可观测
性视角部分
