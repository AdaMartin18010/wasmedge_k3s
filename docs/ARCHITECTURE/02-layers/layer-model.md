# 分层架构模型

## 📑 目录

- [📑 目录](#-目录)
- [1. 概述](#1-概述)
  - [1.1 核心思想](#11-核心思想)
- [2. 整体分层模型](#2-整体分层模型)
- [2. 各层职责详解](#2-各层职责详解)
- [3. 层级关系与依赖](#3-层级关系与依赖)
  - [3.1 依赖方向](#31-依赖方向)
  - [3.2 接口契约](#32-接口契约)
- [4. 状态空间压缩](#4-状态空间压缩)
  - [4.1 各层状态空间](#41-各层状态空间)
  - [4.2 压缩收益](#42-压缩收益)
- [5. 跨层组合模式](#5-跨层组合模式)
  - [5.1 垂直组合](#51-垂直组合)
  - [5.2 水平组合](#52-水平组合)
- [6. 裁剪路径](#6-裁剪路径)
  - [裁剪效果](#裁剪效果)
- [7. 典型案例：支付网关](#7-典型案例支付网关)
- [8. 2025 年分层架构趋势](#8-2025-年分层架构趋势)
  - [8.1 轻量化](#81-轻量化)
  - [8.2 边缘计算](#82-边缘计算)
  - [8.3 机密计算](#83-机密计算)
- [10. 参考资源](#10-参考资源)

---

## 1. 概述

本文档阐述从硬件到业务的分层架构模型，包括 9 个主要层级及其职责、依赖关系、状态
空间压缩和组合模式。

### 1.1 核心思想

> **分层架构通过逐层抽象和状态空间压缩，将复杂的硬件-操作系统-网络-应用状态压缩
> 为可管理的、可版本化的、可观测的中间层模型，让架构师聚焦业务逻辑而非底层细节**

---

## 2. 整体分层模型

从硬件到业务，软件架构可以划分为以下层次：

```text
┌────────────────────────────────────────────────────────────┐
│ 9. 应用层 (Application Layer)                               │
│    └─ 业务微服务、API、前端                                  │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 8. Service Mesh 层 (Service Mesh Layer)                    │
│    └─ Istio/Linkerd sidecars、流量治理、mTLS                │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 7. Network Service Mesh 层 (NSM Layer)                     │
│    └─ vL3 + vWire + Network Service Endpoints              │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 6. 沙盒层 (Sandbox Layer)                                  │
│    └─ seccomp-bpf, eBPF, Landlock, AppArmor                │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 5. 容器运行时层 (Container Runtime Layer)                   │
│    └─ runc, Kata, gVisor, Firecracker, WasmEdge            │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 4. 镜像层 (Image Layer)                                    │
│    └─ OCI Image, Index, Layer, SBOM                        │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 3. 编排层 (Orchestration Layer)                            │
│    └─ Kubernetes, Pod, Deployment, Service                 │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 2. Hypervisor/Kernel 层                                    │
│    └─ KVM, Xen, seccomp-bpf, eBPF, cgroup, namespace       │
└────────────────────────────────────────────────────────────┘
                    ▲
┌────────────────────────────────────────────────────────────┐
│ 1. 硬件/固件层 (Hardware/Firmware Layer)                    │
│    └─ CPU, IOMMU, SGX, TPM, microcode                      │
└────────────────────────────────────────────────────────────┘
```

## 2. 各层职责详解

| 层级                     | 主要职责                          | 典型技术                                       | 关注点（被裁剪）       | 让架构师聚焦             |
| ------------------------ | --------------------------------- | ---------------------------------------------- | ---------------------- | ------------------------ |
| **1. 硬件/固件**         | CPU、内存、I/O、可信根            | VT‑x, AMD‑V, SGX, TPM, microcode               | 物理资源调度、功耗     | 设备安全、可信度         |
| **2. Hypervisor/Kernel** | VM 与容器的资源调度、系统调用过滤 | KVM, Xen, seccomp‑bpf, eBPF, cgroup, namespace | VM 资源分配、调度算法  | 资源池化、可扩展性       |
| **3. 编排层**            | 服务调度、复制、生命周期          | Kubernetes, Pod, Deployment, Service           | Pod 生命周期、滚动升级 | 可靠发布、灰度           |
| **4. 镜像层**            | 镜像打包、签名、层化              | OCI Image, Index, Layer, SBOM                  | 镜像压缩、层缓存       | 轻量化部署、快速迭代     |
| **5. 容器运行时**        | 进程隔离、镜像运行                | runc, Kata, gVisor, Firecracker, WasmEdge      | 容器生命周期、镜像压缩 | 轻量化部署、快速迭代     |
| **6. 沙盒层**            | 系统调用过滤、文件系统隔离        | seccomp‑bpf, Landlock, eBPF                    | 进程权限、IO 访问      | 安全模型、合规           |
| **7. NSM 层**            | 跨域网络聚合、虚拟 L3             | vL3, vWire, Network Service Endpoints          | 网络协议、TLS、熔断    | 观测、可观测性、服务治理 |
| **8. Service Mesh**      | 代理、流量治理、监控              | Envoy, Istio, Linkerd                          | 网络协议、TLS、熔断    | 观测、可观测性、服务治理 |
| **9. 应用层**            | 业务逻辑、数据访问                | 微服务、DDD、CQRS                              | 业务流程、数据一致性   | 业务建模、领域专家       |

## 3. 层级关系与依赖

### 3.1 依赖方向

```text
应用层 → Service Mesh → NSM → 沙盒 → 容器 → 镜像 → 编排 → Kernel → 硬件
```

**原则**：上层依赖下层，下层不依赖上层

### 3.2 接口契约

每层通过**接口契约**与相邻层交互：

- **硬件 ↔ Kernel**：系统调用（syscall）
- **Kernel ↔ 容器**：OCI 运行时接口
- **容器 ↔ 编排**：CRI (Container Runtime Interface)
- **编排 ↔ Service Mesh**：Kubernetes API
- **Service Mesh ↔ 应用**：HTTP/gRPC 协议

## 4. 状态空间压缩

### 4.1 各层状态空间

| 层级           | 状态空间大小 | 压缩比 |
| -------------- | ------------ | ------ | ----------- | ---- |
| **硬件层**     |              | Σ₀     | ≈ 2^10^10   | 基准 |
| **虚拟化层**   |              | Σ₁     | ≈ 2^(20+30) | 10^6 |
| **容器层**     |              | Σ₂     | ≈ 10^6      | 10^3 |
| **沙盒层**     |              | Σ₃     | ≈ 10^5      | 10^1 |
| **中层模型 ℳ** |              | ℳ      | ≈ 10^6      | 10^4 |

### 4.2 压缩收益

- **可管理性**：状态空间从不可枚举变为可版本化
- **可观测性**：每层都有清晰的遥测接口
- **可验证性**：每层都可以独立测试和验证

## 5. 跨层组合模式

### 5.1 垂直组合

```text
硬件 → 虚拟化 → 容器 → 沙盒 → Service Mesh → 应用
```

每层都封装下层的复杂性，提供简化的接口。

### 5.2 水平组合

```text
Service Mesh (Istio) + NSM (vWire) + OPA (策略)
```

多个中间件层可以并行工作，各司其职。

## 6. 裁剪路径

```text
硬件 → 虚拟化 → 容器 → 沙箱 → 服务网格 → 业务
```

每层都把上层的"技术细节"隐藏，只保留"接口"和"约束"。

### 裁剪效果

- **硬件层**：物理资源管理 → VM 资源池
- **虚拟化层**：完整操作系统 → 轻量容器
- **容器层**：OS 进程管理 → 沙盒进程
- **沙盒层**：系统调用 → 安全策略
- **Service Mesh 层**：网络协议 → 流量策略

## 7. 典型案例：支付网关

| 层级            | 技术                         | 说明                          |
| --------------- | ---------------------------- | ----------------------------- |
| **1. 虚拟化**   | KVM → 10 台专用 VM（高可用） | 物理资源隔离，支持 99.99% SLA |
| **2. 容器化**   | Docker + Kata (VM‑容器)      | 统一镜像，快速迭代            |
| **3. 沙箱化**   | seccomp + eBPF               | 防止支付服务泄露敏感文件      |
| **4. 服务网格** | Istio + Envoy                | 细粒度路由、MTLS、熔断        |
| **5. 监控**     | OpenTelemetry + Prometheus   | 业务指标、异常告警            |
| **6. CI/CD**    | GitHub Actions + ArgoCD      | 代码 → 镜像 →K8s 自动化       |

## 8. 2025 年分层架构趋势

### 8.1 轻量化

- **K3s**：轻量级 Kubernetes
- **Linkerd**：Rust 重写的轻量 Service Mesh
- **WasmEdge**：WebAssembly 运行时

### 8.2 边缘计算

- **边缘节点**：K3s + Service Mesh
- **边缘存储**：轻量级分布式存储
- **边缘安全**：OPA + 沙盒

### 8.3 机密计算

- **SGX**：可信执行环境
- **SEV**：内存加密
- **机密容器**：运行时加密

## 10. 参考资源

- **C4 Model**：<https://c4model.com>
- **ArchiMate**：<https://archimate.org>
- **Kubernetes 文档**：<https://kubernetes.io/docs/>
- **Istio 文档**：<https://istio.io/latest/docs/>
- **相关文档**：
  - `02-layers/hardware-firmware-layer.md` - 硬件/固件层详细说明
  - `02-layers/hypervisor-kernel-layer.md` - Hypervisor/Kernel 层详细说明
  - `02-layers/runtime-container-layer.md` - 容器运行时层详细说明
  - `02-layers/sandbox-layer.md` - 沙盒层详细说明
  - `02-layers/service-mesh-layer.md` - Service Mesh 层详细说明
  - `02-layers/application-layer.md` - 应用层详细说明
  - `06-formalization/state-space-compression.md` - 状态空间压缩形式化证明

---

**更新时间**：2025-11-04 **版本**：v1.0 **参考**：`architecture_view.md` 第
2.1-2.8 节，分层架构模型部分
