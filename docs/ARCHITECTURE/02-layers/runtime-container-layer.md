# å®¹å™¨è¿è¡Œæ—¶å±‚æ¶æ„è§†å›¾

## ğŸ“‘ ç›®å½•

- [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. å®¹å™¨è¿è¡Œæ—¶å®šä¹‰](#2-å®¹å™¨è¿è¡Œæ—¶å®šä¹‰)
- [3. å®¹å™¨è¿è¡Œæ—¶æ¶æ„](#3-å®¹å™¨è¿è¡Œæ—¶æ¶æ„)
- [4. Namespace éš”ç¦»](#4-namespace-éš”ç¦»)
- [5. Cgroup èµ„æºæ§åˆ¶](#5-cgroup-èµ„æºæ§åˆ¶)
- [6. OverlayFS æ–‡ä»¶ç³»ç»Ÿ](#6-overlayfs-æ–‡ä»¶ç³»ç»Ÿ)
- [7. ç½‘ç»œç®¡ç†](#7-ç½‘ç»œç®¡ç†)
- [8. å®¹å™¨è¿è¡Œæ—¶å®ç°](#8-å®¹å™¨è¿è¡Œæ—¶å®ç°)
- [9. æ€§èƒ½ä¼˜åŒ–](#9-æ€§èƒ½ä¼˜åŒ–)
- [10. å®‰å…¨åŠ å›º](#10-å®‰å…¨åŠ å›º)
- [11. å¯è§‚æµ‹æ€§](#11-å¯è§‚æµ‹æ€§)
- [12. æ€»ç»“](#12-æ€»ç»“)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäº `architecture_view.md` çš„æ ¸å¿ƒæ€æƒ³ï¼Œè¯¦ç»†é˜è¿°å®¹å™¨è¿è¡Œæ—¶å±‚çš„æ¶æ„è®¾è®¡å’ŒæŠ€
æœ¯å®ç°ã€‚

## 2. å®¹å™¨è¿è¡Œæ—¶å®šä¹‰

### 2.1 å½¢å¼åŒ–å®šä¹‰

**å®¹å™¨è¿è¡Œæ—¶**ï¼šC : Image â†’ Container

**å®šä¹‰**ï¼š

```text
Container = âŸ¨
  Image: ImageID,
  Namespace: {pid, mnt, net, ipc, uts, user},
  Cgroup: {cpu, memory, io, pids},
  Rootfs: OverlayFS,
  State: {Created, Running, Stopped, Paused}
âŸ©
```

**å±æ€§**ï¼š

- **éš”ç¦»çº§åˆ«**ï¼šOS-level (namespace, cgroup)
- **èµ„æºå¼€é”€**ï¼šMediumï¼ˆå…±äº«å†…æ ¸ï¼‰
- **å¯åŠ¨æ—¶é—´**ï¼š< 1 s
- **å¯ç§»æ¤æ€§**ï¼šHighï¼ˆé•œåƒå¯è·¨å¹³å°ï¼‰
- **å®‰å…¨æ¨¡å‹**ï¼šéš”ç¦» + Overlay

### 2.2 æ ¸å¿ƒç»„ä»¶

**å®¹å™¨è¿è¡Œæ—¶ç»„ä»¶**ï¼š

1. **é•œåƒç®¡ç†**ï¼šImage çš„æ‹‰å–ã€å­˜å‚¨ã€åˆ é™¤
2. **å®¹å™¨ç”Ÿå‘½å‘¨æœŸ**ï¼šåˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤
3. **èµ„æºéš”ç¦»**ï¼šNamespace å’Œ Cgroup ç®¡ç†
4. **æ–‡ä»¶ç³»ç»Ÿ**ï¼šOverlayFS ç®¡ç†
5. **ç½‘ç»œç®¡ç†**ï¼šCNI æ’ä»¶é›†æˆ

## 3. å®¹å™¨è¿è¡Œæ—¶æ¶æ„

### 3.1 åˆ†å±‚æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer (ä¸šåŠ¡åº”ç”¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container Runtime Layer             â”‚
â”‚  â”œâ”€ containerd / cri-o               â”‚
â”‚  â”œâ”€ runc / crun                      â”‚
â”‚  â”œâ”€ CNI Plugins                      â”‚
â”‚  â””â”€ Storage Drivers                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Host Kernel Layer                   â”‚
â”‚  â”œâ”€ Namespaces (pid, mnt, net, ...) â”‚
â”‚  â”œâ”€ Cgroups (cpu, memory, io, ...)  â”‚
â”‚  â”œâ”€ OverlayFS                        â”‚
â”‚  â””â”€ Seccomp / AppArmor               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hypervisor / Hardware Layer         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å®¹å™¨è¿è¡Œæ—¶æ¥å£

**CRI (Container Runtime Interface)**ï¼š

```yaml
# Pod å®šä¹‰
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
    - name: my-container
      image: my-image:latest
      resources:
        requests:
          cpu: "100m"
          memory: "128Mi"
        limits:
          cpu: "200m"
          memory: "256Mi"
```

**OCI (Open Container Initiative)**ï¼š

```json
{
  "ociVersion": "1.0.0",
  "process": {
    "user": { "uid": 0, "gid": 0 },
    "args": ["/bin/sh"],
    "env": ["PATH=/usr/bin"]
  },
  "root": {
    "path": "rootfs",
    "readonly": true
  },
  "mounts": [
    {
      "destination": "/proc",
      "type": "proc",
      "source": "proc"
    }
  ],
  "linux": {
    "namespaces": [
      { "type": "pid" },
      { "type": "network" },
      { "type": "mount" }
    ],
    "cgroupsPath": "/my-container",
    "resources": {
      "cpu": { "shares": 1024 },
      "memory": { "limit": 268435456 }
    }
  }
}
```

## 4. Namespace éš”ç¦»

### 4.1 Namespace ç±»å‹

**PID Namespace**ï¼š

- **åŠŸèƒ½**ï¼šè¿›ç¨‹éš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ PID ç©ºé—´
- **æ•ˆæœ**ï¼šå®¹å™¨å†…è¿›ç¨‹çœ‹ä¸åˆ°å®¿ä¸»æœºè¿›ç¨‹

**Mount Namespace**ï¼š

- **åŠŸèƒ½**ï¼šæ–‡ä»¶ç³»ç»Ÿéš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„æŒ‚è½½ç‚¹
- **æ•ˆæœ**ï¼šå®¹å™¨å†…æ–‡ä»¶ç³»ç»Ÿç‹¬ç«‹

**Network Namespace**ï¼š

- **åŠŸèƒ½**ï¼šç½‘ç»œéš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ç½‘ç»œæ ˆ
- **æ•ˆæœ**ï¼šå®¹å™¨å†…ç½‘ç»œæ¥å£ç‹¬ç«‹

**IPC Namespace**ï¼š

- **åŠŸèƒ½**ï¼šè¿›ç¨‹é—´é€šä¿¡éš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ IPC ç©ºé—´
- **æ•ˆæœ**ï¼šå®¹å™¨é—´æ— æ³•é€šè¿‡ IPC é€šä¿¡

**UTS Namespace**ï¼š

- **åŠŸèƒ½**ï¼šä¸»æœºåéš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ä¸»æœºå
- **æ•ˆæœ**ï¼šå®¹å™¨å†…ä¸»æœºåç‹¬ç«‹

**User Namespace**ï¼š

- **åŠŸèƒ½**ï¼šç”¨æˆ·éš”ç¦»
- **å®ç°**ï¼šæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´
- **æ•ˆæœ**ï¼šå®¹å™¨å†…ç”¨æˆ· ID æ˜ å°„åˆ°å®¿ä¸»æœº

### 4.2 Namespace å®ç°

**åˆ›å»º Namespace**ï¼š

```c
// åˆ›å»º PID Namespace
int pid_fd = open("/proc/self/ns/pid", O_RDONLY);
unshare(CLONE_NEWPID);
```

**è¿›å…¥ Namespace**ï¼š

```c
// è¿›å…¥ PID Namespace
setns(pid_fd, CLONE_NEWPID);
```

## 5. Cgroup èµ„æºæ§åˆ¶

### 5.1 Cgroup v2 æ¶æ„

**Cgroup v2 å±‚æ¬¡ç»“æ„**ï¼š

```text
/sys/fs/cgroup/
â”œâ”€â”€ cgroup.controllers
â”œâ”€â”€ cgroup.events
â”œâ”€â”€ cgroup.procs
â”œâ”€â”€ cpu.weight
â”œâ”€â”€ memory.max
â”œâ”€â”€ io.weight
â””â”€â”€ pids.max
```

**æ§åˆ¶å™¨**ï¼š

- **CPU**ï¼šcpu.weight, cpu.max
- **Memory**ï¼šmemory.max, memory.swap.max
- **IO**ï¼šio.weight, io.max
- **PIDs**ï¼špids.max

### 5.2 èµ„æºé™åˆ¶ç¤ºä¾‹

**CPU é™åˆ¶**ï¼š

```bash
# è®¾ç½® CPU æƒé‡
echo 1024 > /sys/fs/cgroup/my-container/cpu.weight

# è®¾ç½® CPU æœ€å¤§ä½¿ç”¨ç‡
echo "50000 100000" > /sys/fs/cgroup/my-container/cpu.max
```

**Memory é™åˆ¶**ï¼š

```bash
# è®¾ç½®å†…å­˜é™åˆ¶
echo 268435456 > /sys/fs/cgroup/my-container/memory.max
```

**IO é™åˆ¶**ï¼š

```bash
# è®¾ç½® IO æƒé‡
echo 500 > /sys/fs/cgroup/my-container/io.weight
```

## 6. OverlayFS æ–‡ä»¶ç³»ç»Ÿ

### 6.1 OverlayFS æ¶æ„

**OverlayFS å±‚æ¬¡ç»“æ„**ï¼š

```text
upperdir (å¯å†™å±‚)
    â†‘
lowerdir (åªè¯»å±‚)
    â†“
merged (åˆå¹¶è§†å›¾)
```

**å®ç°**ï¼š

```bash
# æŒ‚è½½ OverlayFS
mount -t overlay overlay \
  -o lowerdir=lower,upperdir=upper,workdir=work \
  merged
```

### 6.2 é•œåƒå±‚åŒ–

**é•œåƒå±‚ç»“æ„**ï¼š

```json
{
  "layers": ["sha256:base-layer", "sha256:app-layer", "sha256:config-layer"],
  "config": {
    "Cmd": ["/bin/sh"],
    "Env": ["PATH=/usr/bin"],
    "WorkingDir": "/app"
  }
}
```

**å±‚åˆå¹¶**ï¼š

```bash
# åˆå¹¶å±‚
lowerdir=layer1:layer2:layer3
upperdir=writable
merged=final
```

## 7. ç½‘ç»œç®¡ç†

### 7.1 CNI (Container Network Interface)

**CNI æ’ä»¶**ï¼š

- **bridge**ï¼šæ¡¥æ¥ç½‘ç»œ
- **host-local**ï¼šæœ¬åœ° IP åˆ†é…
- **portmap**ï¼šç«¯å£æ˜ å°„
- **firewall**ï¼šé˜²ç«å¢™è§„åˆ™

**CNI é…ç½®**ï¼š

```json
{
  "cniVersion": "0.4.0",
  "name": "mynet",
  "type": "bridge",
  "bridge": "cni0",
  "ipam": {
    "type": "host-local",
    "subnet": "10.22.0.0/16"
  }
}
```

### 7.2 ç½‘ç»œæ¨¡å¼

**Bridge æ¨¡å¼**ï¼š

- å®¹å™¨è¿æ¥åˆ°è™šæ‹Ÿç½‘æ¡¥
- é€šè¿‡ NAT è®¿é—®å¤–éƒ¨ç½‘ç»œ
- é»˜è®¤ç½‘ç»œæ¨¡å¼

**Host æ¨¡å¼**ï¼š

- å®¹å™¨å…±äº«å®¿ä¸»æœºç½‘ç»œ
- ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œæ¥å£
- æ€§èƒ½æœ€é«˜

**None æ¨¡å¼**ï¼š

- å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£
- éœ€è¦æ‰‹åŠ¨é…ç½®ç½‘ç»œ
- ç”¨äºç‰¹æ®Šåœºæ™¯

## 8. å®¹å™¨è¿è¡Œæ—¶å®ç°

### 8.1 containerd

**æ¶æ„**ï¼š

```text
containerd
â”œâ”€ CRI Plugin (Kubernetes æ¥å£)
â”œâ”€ Runtime Plugin (runc, Kata, gVisor)
â”œâ”€ Image Service (é•œåƒç®¡ç†)
â”œâ”€ Content Service (å†…å®¹å­˜å‚¨)
â””â”€ Metadata Service (å…ƒæ•°æ®ç®¡ç†)
```

**ç‰¹ç‚¹**ï¼š

- è½»é‡çº§è¿è¡Œæ—¶
- æ”¯æŒå¤šç§è¿è¡Œæ—¶åç«¯
- å®Œæ•´çš„é•œåƒç®¡ç†

### 8.2 cri-o

**æ¶æ„**ï¼š

```text
cri-o
â”œâ”€ CRI Interface (Kubernetes æ¥å£)
â”œâ”€ Runtime (runc, crun)
â”œâ”€ Image Service (é•œåƒç®¡ç†)
â””â”€ Storage Service (å­˜å‚¨ç®¡ç†)
```

**ç‰¹ç‚¹**ï¼š

- ä¸“ä¸º Kubernetes è®¾è®¡
- è½»é‡çº§å®ç°
- å¿«é€Ÿå¯åŠ¨

### 8.3 runc

**æ¶æ„**ï¼š

```text
runc
â”œâ”€ OCI Runtime Spec (OCI æ ‡å‡†)
â”œâ”€ Namespace Management (å‘½åç©ºé—´ç®¡ç†)
â”œâ”€ Cgroup Management (èµ„æºæ§åˆ¶)
â””â”€ Process Management (è¿›ç¨‹ç®¡ç†)
```

**ç‰¹ç‚¹**ï¼š

- OCI æ ‡å‡†å®ç°
- è½»é‡çº§è¿è¡Œæ—¶
- å¹¿æ³›é‡‡ç”¨

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 å¯åŠ¨æ—¶é—´ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **é•œåƒå±‚ç¼“å­˜**ï¼šå¤ç”¨åŸºç¡€é•œåƒå±‚
2. **å»¶è¿ŸæŒ‚è½½**ï¼šæŒ‰éœ€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
3. **è¿›ç¨‹é¢„å¯åŠ¨**ï¼šé¢„çƒ­å®¹å™¨è¿›ç¨‹
4. **é•œåƒå‹ç¼©**ï¼šå‡å°é•œåƒå¤§å°

**ä¼˜åŒ–æ•ˆæœ**ï¼š

- é•œåƒæ‹‰å–æ—¶é—´ï¼šä» 10 s â†’ 2 s
- å®¹å™¨å¯åŠ¨æ—¶é—´ï¼šä» 1 s â†’ 200 ms

### 9.2 èµ„æºåˆ©ç”¨ç‡ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **Cgroup v2**ï¼šç»Ÿä¸€èµ„æºæ§åˆ¶
2. **èµ„æºé…é¢**ï¼šç²¾ç¡®çš„èµ„æºé™åˆ¶
3. **èµ„æºå›æ”¶**ï¼šåŠæ—¶é‡Šæ”¾èµ„æº
4. **èµ„æºé¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹

**ä¼˜åŒ–æ•ˆæœ**ï¼š

- èµ„æºåˆ©ç”¨ç‡ï¼šä» 50% â†’ 70%
- èµ„æºæµªè´¹ï¼šä» 30% â†’ 10%

## 10. å®‰å…¨åŠ å›º

### 10.1 å®‰å…¨ç­–ç•¥

**Seccomp**ï¼š

```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "syscalls": [
    {
      "names": ["read", "write"],
      "action": "SCMP_ACT_ALLOW"
    }
  ]
}
```

**AppArmor**ï¼š

```bash
# åŠ è½½ AppArmor é…ç½®æ–‡ä»¶
apparmor_parser -r /etc/apparmor.d/my-container
```

**SELinux**ï¼š

```bash
# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
chcon -t container_file_t /var/lib/containers/my-container
```

### 10.2 é•œåƒå®‰å…¨

**é•œåƒæ‰«æ**ï¼š

- Trivyï¼šé•œåƒæ¼æ´æ‰«æ
- Clairï¼šé•œåƒå®‰å…¨åˆ†æ
- Falcoï¼šè¿è¡Œæ—¶å®‰å…¨ç›‘æ§

**é•œåƒç­¾å**ï¼š

- Notaryï¼šé•œåƒç­¾åå’ŒéªŒè¯
- Cosignï¼šé•œåƒç­¾åå·¥å…·

## 11. å¯è§‚æµ‹æ€§

### 11.1 æŒ‡æ ‡ç›‘æ§

**cAdvisor**ï¼š

- å®¹å™¨èµ„æºä½¿ç”¨æŒ‡æ ‡
- CPUã€å†…å­˜ã€ç½‘ç»œã€IO ç»Ÿè®¡

**Prometheus**ï¼š

- æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨
- æŸ¥è¯¢å’Œå‘Šè­¦

### 11.2 æ—¥å¿—èšåˆ

**å®¹å™¨æ—¥å¿—**ï¼š

- stdout/stderr æ—¥å¿—
- æ—¥å¿—é©±åŠ¨ï¼ˆjson-file, syslog, journaldï¼‰

**æ—¥å¿—èšåˆ**ï¼š

- Fluentdï¼šæ—¥å¿—æ”¶é›†
- Lokiï¼šæ—¥å¿—èšåˆ
- ELKï¼šæ—¥å¿—åˆ†æ

## 12. æ€»ç»“

å®¹å™¨è¿è¡Œæ—¶å±‚æ˜¯äº‘åŸç”Ÿæ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›äº†ï¼š

1. **èµ„æºéš”ç¦»**ï¼šNamespace å’Œ Cgroup éš”ç¦»
2. **å¿«é€Ÿå¯åŠ¨**ï¼š< 1 s å¯åŠ¨æ—¶é—´
3. **é•œåƒç®¡ç†**ï¼šå±‚åŒ–é•œåƒå’Œ OverlayFS
4. **ç½‘ç»œç®¡ç†**ï¼šCNI æ’ä»¶å’Œç½‘ç»œæ¨¡å¼
5. **å®‰å…¨åŠ å›º**ï¼šSeccompã€AppArmorã€SELinux
6. **å¯è§‚æµ‹æ€§**ï¼šcAdvisorã€Prometheusã€æ—¥å¿—èšåˆ

é€šè¿‡è¿™äº›ç‰¹æ€§ï¼Œå®¹å™¨è¿è¡Œæ—¶å±‚å®ç°äº†ä» VM åˆ° Container çš„æŠ½è±¡ï¼Œä¸ºä¸Šå±‚åº”ç”¨æä¾›äº†è½»é‡
çº§ã€å¿«é€Ÿã€å®‰å…¨çš„è¿è¡Œç¯å¢ƒã€‚

---

**æ›´æ–°æ—¶é—´**ï¼š2025-11-04 **ç‰ˆæœ¬**ï¼šv1.0 **å‚è€ƒ**ï¼š`architecture_view.md` ç¬¬ 3 èŠ‚
